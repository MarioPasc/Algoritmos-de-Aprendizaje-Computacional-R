<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es" xml:lang="es"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mario Pascual González">

<title>Algoritmos de Aprendizaje Computacional</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="AlgoritmosApendizajeCancerMama_files/libs/clipboard/clipboard.min.js"></script>
<script src="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/quarto.js"></script>
<script src="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/popper.min.js"></script>
<script src="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/anchor.min.js"></script>
<link href="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="AlgoritmosApendizajeCancerMama_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="AlgoritmosApendizajeCancerMama_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="AlgoritmosApendizajeCancerMama_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="AlgoritmosApendizajeCancerMama_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="AlgoritmosApendizajeCancerMama_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contenidos</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción" class="nav-link active" data-scroll-target="#introducción"><span class="header-section-number">1</span> Introducción</a>
  <ul class="collapse">
  <li><a href="#objetivos" id="toc-objetivos" class="nav-link" data-scroll-target="#objetivos"><span class="header-section-number">1.1</span> Objetivos</a></li>
  <li><a href="#trabajos-previos" id="toc-trabajos-previos" class="nav-link" data-scroll-target="#trabajos-previos"><span class="header-section-number">1.2</span> Trabajos Previos</a></li>
  </ul></li>
  <li><a href="#metodología" id="toc-metodología" class="nav-link" data-scroll-target="#metodología"><span class="header-section-number">2</span> Metodología</a>
  <ul class="collapse">
  <li><a href="#material" id="toc-material" class="nav-link" data-scroll-target="#material"><span class="header-section-number">2.1</span> Material</a>
  <ul class="collapse">
  <li><a href="#conjunto-de-datos-inicial" id="toc-conjunto-de-datos-inicial" class="nav-link" data-scroll-target="#conjunto-de-datos-inicial"><span class="header-section-number">2.1.1</span> Conjunto de Datos Inicial</a></li>
  <li><a href="#pre-procesamiento" id="toc-pre-procesamiento" class="nav-link" data-scroll-target="#pre-procesamiento"><span class="header-section-number">2.1.2</span> Pre-Procesamiento</a></li>
  </ul></li>
  <li><a href="#métodos" id="toc-métodos" class="nav-link" data-scroll-target="#métodos"><span class="header-section-number">2.2</span> Métodos</a>
  <ul class="collapse">
  <li><a href="#auc-y-rendimiento-aparente" id="toc-auc-y-rendimiento-aparente" class="nav-link" data-scroll-target="#auc-y-rendimiento-aparente"><span class="header-section-number">2.2.1</span> AUC y Rendimiento Aparente</a></li>
  <li><a href="#ajuste-fino-doble-validación-cruzada-5x2" id="toc-ajuste-fino-doble-validación-cruzada-5x2" class="nav-link" data-scroll-target="#ajuste-fino-doble-validación-cruzada-5x2"><span class="header-section-number">2.2.2</span> Ajuste Fino: Doble Validación Cruzada 5x2</a></li>
  <li><a href="#selección-de-características" id="toc-selección-de-características" class="nav-link" data-scroll-target="#selección-de-características"><span class="header-section-number">2.2.3</span> Selección de Características</a></li>
  <li><a href="#modelos-aplicados" id="toc-modelos-aplicados" class="nav-link" data-scroll-target="#modelos-aplicados"><span class="header-section-number">2.2.4</span> Modelos Aplicados</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#resultados" id="toc-resultados" class="nav-link" data-scroll-target="#resultados"><span class="header-section-number">3</span> Resultados</a>
  <ul class="collapse">
  <li><a href="#naive-bayes-1" id="toc-naive-bayes-1" class="nav-link" data-scroll-target="#naive-bayes-1"><span class="header-section-number">3.1</span> Naive Bayes</a>
  <ul class="collapse">
  <li><a href="#aparente" id="toc-aparente" class="nav-link" data-scroll-target="#aparente"><span class="header-section-number">3.1.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables" id="toc-todas-las-variables" class="nav-link" data-scroll-target="#todas-las-variables"><span class="header-section-number">3.1.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación" id="toc-filtrado-asociación" class="nav-link" data-scroll-target="#filtrado-asociación"><span class="header-section-number">3.1.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc" id="toc-wrapped-stepauc" class="nav-link" data-scroll-target="#wrapped-stepauc"><span class="header-section-number">3.1.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso" id="toc-embedded-lasso" class="nav-link" data-scroll-target="#embedded-lasso"><span class="header-section-number">3.1.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  <li><a href="#adaboost-1" id="toc-adaboost-1" class="nav-link" data-scroll-target="#adaboost-1"><span class="header-section-number">3.2</span> Adaboost</a>
  <ul class="collapse">
  <li><a href="#aparente-1" id="toc-aparente-1" class="nav-link" data-scroll-target="#aparente-1"><span class="header-section-number">3.2.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables-1" id="toc-todas-las-variables-1" class="nav-link" data-scroll-target="#todas-las-variables-1"><span class="header-section-number">3.2.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación-1" id="toc-filtrado-asociación-1" class="nav-link" data-scroll-target="#filtrado-asociación-1"><span class="header-section-number">3.2.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc-1" id="toc-wrapped-stepauc-1" class="nav-link" data-scroll-target="#wrapped-stepauc-1"><span class="header-section-number">3.2.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso-1" id="toc-embedded-lasso-1" class="nav-link" data-scroll-target="#embedded-lasso-1"><span class="header-section-number">3.2.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  <li><a href="#random-forest-1" id="toc-random-forest-1" class="nav-link" data-scroll-target="#random-forest-1"><span class="header-section-number">3.3</span> Random Forest</a>
  <ul class="collapse">
  <li><a href="#aparente-2" id="toc-aparente-2" class="nav-link" data-scroll-target="#aparente-2"><span class="header-section-number">3.3.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables-2" id="toc-todas-las-variables-2" class="nav-link" data-scroll-target="#todas-las-variables-2"><span class="header-section-number">3.3.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación-2" id="toc-filtrado-asociación-2" class="nav-link" data-scroll-target="#filtrado-asociación-2"><span class="header-section-number">3.3.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc-2" id="toc-wrapped-stepauc-2" class="nav-link" data-scroll-target="#wrapped-stepauc-2"><span class="header-section-number">3.3.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso-2" id="toc-embedded-lasso-2" class="nav-link" data-scroll-target="#embedded-lasso-2"><span class="header-section-number">3.3.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  <li><a href="#k-nearest-neighbours-1" id="toc-k-nearest-neighbours-1" class="nav-link" data-scroll-target="#k-nearest-neighbours-1"><span class="header-section-number">3.4</span> K-Nearest Neighbours</a>
  <ul class="collapse">
  <li><a href="#aparente-3" id="toc-aparente-3" class="nav-link" data-scroll-target="#aparente-3"><span class="header-section-number">3.4.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables-3" id="toc-todas-las-variables-3" class="nav-link" data-scroll-target="#todas-las-variables-3"><span class="header-section-number">3.4.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación-3" id="toc-filtrado-asociación-3" class="nav-link" data-scroll-target="#filtrado-asociación-3"><span class="header-section-number">3.4.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc-3" id="toc-wrapped-stepauc-3" class="nav-link" data-scroll-target="#wrapped-stepauc-3"><span class="header-section-number">3.4.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso-3" id="toc-embedded-lasso-3" class="nav-link" data-scroll-target="#embedded-lasso-3"><span class="header-section-number">3.4.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  <li><a href="#support-vector-machines" id="toc-support-vector-machines" class="nav-link" data-scroll-target="#support-vector-machines"><span class="header-section-number">3.5</span> Support Vector Machines</a>
  <ul class="collapse">
  <li><a href="#aparente-4" id="toc-aparente-4" class="nav-link" data-scroll-target="#aparente-4"><span class="header-section-number">3.5.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables-4" id="toc-todas-las-variables-4" class="nav-link" data-scroll-target="#todas-las-variables-4"><span class="header-section-number">3.5.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación-4" id="toc-filtrado-asociación-4" class="nav-link" data-scroll-target="#filtrado-asociación-4"><span class="header-section-number">3.5.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc-4" id="toc-wrapped-stepauc-4" class="nav-link" data-scroll-target="#wrapped-stepauc-4"><span class="header-section-number">3.5.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso-4" id="toc-embedded-lasso-4" class="nav-link" data-scroll-target="#embedded-lasso-4"><span class="header-section-number">3.5.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  <li><a href="#artificial-neural-networks-1" id="toc-artificial-neural-networks-1" class="nav-link" data-scroll-target="#artificial-neural-networks-1"><span class="header-section-number">3.6</span> Artificial Neural Networks</a>
  <ul class="collapse">
  <li><a href="#aparente-5" id="toc-aparente-5" class="nav-link" data-scroll-target="#aparente-5"><span class="header-section-number">3.6.1</span> Aparente</a></li>
  <li><a href="#todas-las-variables-5" id="toc-todas-las-variables-5" class="nav-link" data-scroll-target="#todas-las-variables-5"><span class="header-section-number">3.6.2</span> Todas las Variables</a></li>
  <li><a href="#filtrado-asociación-5" id="toc-filtrado-asociación-5" class="nav-link" data-scroll-target="#filtrado-asociación-5"><span class="header-section-number">3.6.3</span> Filtrado (Asociación)</a></li>
  <li><a href="#wrapped-stepauc-5" id="toc-wrapped-stepauc-5" class="nav-link" data-scroll-target="#wrapped-stepauc-5"><span class="header-section-number">3.6.4</span> Wrapped (StepAUC)</a></li>
  <li><a href="#embedded-lasso-5" id="toc-embedded-lasso-5" class="nav-link" data-scroll-target="#embedded-lasso-5"><span class="header-section-number">3.6.5</span> Embedded (Lasso)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#discusión-estudio-de-los-resultados" id="toc-discusión-estudio-de-los-resultados" class="nav-link" data-scroll-target="#discusión-estudio-de-los-resultados"><span class="header-section-number">4</span> Discusión: Estudio de los Resultados</a>
  <ul class="collapse">
  <li><a href="#estabilidad-entre-folds" id="toc-estabilidad-entre-folds" class="nav-link" data-scroll-target="#estabilidad-entre-folds"><span class="header-section-number">4.1</span> Estabilidad entre Folds</a></li>
  <li><a href="#estabilidad-para-hiperparámetros" id="toc-estabilidad-para-hiperparámetros" class="nav-link" data-scroll-target="#estabilidad-para-hiperparámetros"><span class="header-section-number">4.2</span> Estabilidad para Hiperparámetros</a></li>
  <li><a href="#estabilidad-de-variables" id="toc-estabilidad-de-variables" class="nav-link" data-scroll-target="#estabilidad-de-variables"><span class="header-section-number">4.3</span> Estabilidad de Variables</a></li>
  <li><a href="#mejor-modelo" id="toc-mejor-modelo" class="nav-link" data-scroll-target="#mejor-modelo"><span class="header-section-number">4.4</span> “Mejor” Modelo</a></li>
  </ul></li>
  <li><a href="#conclusión" id="toc-conclusión" class="nav-link" data-scroll-target="#conclusión"><span class="header-section-number">5</span> Conclusión</a></li>
  </ul>
<div class="quarto-other-links"><h2>Otros Enlaces</h2><ul><li><a href="https://www.linkedin.com/in/mario-pascual-gonzalez/"><i class="bi bi-linkedin"></i>LinkedIn</a></li><li><a href="mailto:mario.pg02@gmail.com?subject=Contacto desde el informe de Modelado Predictivo"><i class="bi bi-envelope"></i>Correo Electrónico</a></li><li><a href="https://github.com/MarioPasc"><i class="bi bi-github"></i>Perfil de Github</a></li></ul></div><div class="quarto-code-links"><h2>Enlaces de código</h2><ul><li><a href="https://github.com/MarioPasc/Modelado-Predictivo-Cancer-de-Mama-R"><i class="bi bi-file-code"></i>Repositorio del Informe</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Algoritmos de Aprendizaje Computacional</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Expand Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Mostrar todo el código</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Ocultar todo el código</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Ver el código fuente</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-contents">
             <p>Mario Pascual González </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introducción" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introducción</h1>
<section id="objetivos" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="objetivos"><span class="header-section-number">1.1</span> Objetivos</h2>
<p>El principal objetivo de este estudio es obtener un modelo ajustado al conjunto de datos de Metástasis de Cáncer de Mama para poder realizar predicciones efectivas sobre el estado PCR de un paciente dada una serie de variables o características sobre este. Consecuentemente, nace de manera natural un segundo objetivo principal, y es el de la determinación de las características más importantes para la determinación del estado del paciente, es decir, la realización de una <em>selección de características</em>. Todo esto se realizará con la finalidad de poner un modelo en producción, el cual pueda ser usado a través de la interfaz <code>RShiny</code> para la predicción efectiva del estado PCR de un paciente de Cáncer de Mama.</p>
<p>Objetivos secundarios de este proyecto incluyen el estudio de la estabilidad en la selección de características a lo largo de los diferentes métodos y modelos aplicados. Se realizará también una exploración de la estabilidad de los hiperparámetros de un mismo modelo a lo largo de diferentes semillas aleatorias establecidas.</p>
<table class="table">
<colgroup>
<col style="width: 80%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Objetivo</th>
<th>Tipo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Obtener un modelo ajustado al conjunto de datos de Metástasis de Cáncer de Mama</td>
<td>Principal</td>
</tr>
<tr class="even">
<td>Determinación de características más importantes en la predicción del estado PCR del paciente</td>
<td>Principal</td>
</tr>
<tr class="odd">
<td>Poner un modelo en producción, accesible a través de la interfaz <code>RShiny</code></td>
<td>Principal</td>
</tr>
<tr class="even">
<td>Estudiar la estabilidad en las características seleccionadas</td>
<td>Secundario</td>
</tr>
<tr class="odd">
<td>Explorar la estabilidad de los hiperparámetros de un mismo modelo a lo largo de diferentes semillas aleatorias establecidas.</td>
<td>Secundario</td>
</tr>
</tbody>
</table>
</section>
<section id="trabajos-previos" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="trabajos-previos"><span class="header-section-number">1.2</span> Trabajos Previos</h2>
</section>
</section>
<section id="metodología" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Metodología</h1>
<p>A lo largo del desarrollo de este proyecto se han utilizado una serie de datos y se han seguido unas directrices ordenadas. Todo esto queda redactado en este apartado.</p>
<section id="material" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="material"><span class="header-section-number">2.1</span> Material</h2>
<section id="conjunto-de-datos-inicial" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="conjunto-de-datos-inicial"><span class="header-section-number">2.1.1</span> Conjunto de Datos Inicial</h3>
<p>Se nos ha proporcionado un fichero en formato <em>Comma-Separated Values</em> (<code>.csv</code>) gracias al trabajo del Dr.&nbsp;José Manuel Jérez Aragonés. Las características de este dataset quedan descritas en la <a href="#fig-desccol" class="quarto-xref">Figura&nbsp;1</a>.</p>
<div id="fig-desccol" class="quarto-figure quarto-figure-center quarto-float anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-desccol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="Variables.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-desccol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figura&nbsp;1: Variables Originales del Conjunto
</figcaption>
</figure>
</div>
<p>Se puede identificar la variable <strong>PCR</strong> como la variable <em>target</em> u objetivo de este estudio. Consecuentemente, se ha decidido eliminar la variable <code>Muestra</code>, ya que no parece guardar una relevancia clínica, al ser un identificador único para cada paciente, compuesto por un código identificativo del estudio en el que fue obtenido el dato, y una serie de números únicos para cada persona.</p>
</section>
<section id="pre-procesamiento" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="pre-procesamiento"><span class="header-section-number">2.1.2</span> Pre-Procesamiento</h3>
<p>El conjunto de datos del que se hará uso fue curado en un estudio anterior a este, habiéndose imputado los valores faltantes (<code>NA</code>) por la mediana o la moda, si estos provenían de una característica numérica, o de tipo factor, respectivamente <span class="citation" data-cites="gonzalez2024predictive">(<a href="#ref-gonzalez2024predictive" role="doc-biblioref">González 2024</a>)</span>.</p>
<p>Por otra parte, para asegurar que se tiene total control sobre los datos con los que se introducen al modelo, se han creado dos versiones del conjunto de datos. La primera se trata de una versión en la que todas las variables son de tipo factor, y la variable edad ha sido estratificada en diferentes intervalos. Por otra parte, se ha generado un conjunto de datos numérico, el cual es el conjunto de datos de tipo factor codificado mediante técnicas como <em>One-Hot Encoder</em>, o manteniendo las variables con su mismo tipo, si estas eran numéricas originalmente. Se comentan a continuación las modificaciones específicas.</p>
<section id="conjunto-de-datos-factor" class="level4" data-number="2.1.2.1">
<h4 data-number="2.1.2.1" class="anchored" data-anchor-id="conjunto-de-datos-factor"><span class="header-section-number">2.1.2.1</span> Conjunto de Datos Factor</h4>
<p>Este conjunto de datos existe para asegurar la interpretabilidad de los resultados de los modelos. La única variable que puede suponer un problema es la variable <code>Edad</code>, ya que es una variable continua, sin embargo, este problema, como se ha comentado anteriormente, se resolverá estratificándola. La anchura de los bins se calculará siguiendo la regla de Sturges, en la que se toma el logaritmo en base 2 de la cantidad de muestras y el rango de la variable para poder computar la anchura más adecuada.</p>
<p><span class="math display">
k = \frac{max(Edad) - min(Edad)}{\log_2(n) + 1}
</span></p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir la variable 'Edad' a numérica</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data_original<span class="sc">$</span>Edad <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_original<span class="sc">$</span>Edad)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>data_factor <span class="ot">&lt;-</span> data_original</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculando el número de bins con la regla de Sturges</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_factor)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">log2</span>(n) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculando el rango y el tamaño de cada bin</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>minimo <span class="ot">&lt;-</span> <span class="fu">min</span>(data_factor<span class="sc">$</span>Edad)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>maximo <span class="ot">&lt;-</span> <span class="fu">max</span>(data_factor<span class="sc">$</span>Edad)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>ancho_bin <span class="ot">&lt;-</span> (maximo <span class="sc">-</span> minimo) <span class="sc">/</span> k</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Estratificar la variable 'Edad' en grupos</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad_estratificada <span class="ot">&lt;-</span> <span class="fu">cut</span>(data_factor<span class="sc">$</span>Edad, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fu">min</span>(data_factor<span class="sc">$</span>Edad), <span class="fu">max</span>(data_factor<span class="sc">$</span>Edad), <span class="at">by =</span> ancho_bin), </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar nombres de grupo a los niveles de Edad_estratificada</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(data_factor<span class="sc">$</span>Edad_estratificada) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Grupo"</span>, <span class="fu">seq_along</span>(<span class="fu">levels</span>(data_factor<span class="sc">$</span>Edad_estratificada)))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir todas las variables del dataframe a factor, excepto 'Edad'</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>data_factor <span class="ot">&lt;-</span> data_factor <span class="sc">%&gt;%</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="sc">-</span>Edad), as.factor)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Actualizar la variable Edad con los grupos</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad <span class="ot">&lt;-</span> data_factor<span class="sc">$</span>Edad_estratificada</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad_estratificada <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(data_factor, <span class="dv">10</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Edad</th>
<th style="text-align: left;">REst</th>
<th style="text-align: left;">RPro</th>
<th style="text-align: left;">Her2</th>
<th style="text-align: left;">Estadio</th>
<th style="text-align: left;">NodAfec</th>
<th style="text-align: left;">Grado</th>
<th style="text-align: left;">Fenotipo</th>
<th style="text-align: left;">PCR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Grupo3</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">N1</td>
<td style="text-align: left;">II</td>
<td style="text-align: left;">LumA</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grupo5</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T3</td>
<td style="text-align: left;">N1</td>
<td style="text-align: left;">II</td>
<td style="text-align: left;">Normal</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Grupo4</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T3</td>
<td style="text-align: left;">N0</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">Basal</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grupo4</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">N1</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">Basal</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Grupo3</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T3</td>
<td style="text-align: left;">N1</td>
<td style="text-align: left;">II</td>
<td style="text-align: left;">LumA</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grupo6</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T4</td>
<td style="text-align: left;">N0</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">Basal</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Grupo3</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">N0</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">Basal</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grupo6</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T3</td>
<td style="text-align: left;">N1</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">LumA</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Grupo5</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">T3</td>
<td style="text-align: left;">N3</td>
<td style="text-align: left;">III</td>
<td style="text-align: left;">Basal</td>
<td style="text-align: left;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grupo4</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">P</td>
<td style="text-align: left;">T4</td>
<td style="text-align: left;">N3</td>
<td style="text-align: left;">II</td>
<td style="text-align: left;">LumA</td>
<td style="text-align: left;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Esta estratificación se puede justificar con el hecho de que la interpretación de las predicciones del modelo puede ser más adecuada, ya que no estaríamos hablando de un valor concreto de edad que se repite a la hora de analizar los pacientes PCR-positivos, sino que tal vez se podría identificar una tendencia en los pacientes de un determinado rango de edad a sufrir una metástasis.</p>
<table class="table">
<thead>
<tr class="header">
<th>Grupo</th>
<th>Rango de Edad</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Grupo 1</td>
<td>[24,29.1)</td>
</tr>
<tr class="even">
<td>Grupo 2</td>
<td>[29.1,34.2)</td>
</tr>
<tr class="odd">
<td>Grupo 3</td>
<td>[34.2,39.3)</td>
</tr>
<tr class="even">
<td>Grupo 4</td>
<td>[39.3,44.4)</td>
</tr>
<tr class="odd">
<td>Grupo 5</td>
<td>[44.4,49.5)</td>
</tr>
<tr class="even">
<td>Grupo 6</td>
<td>[49.5,54.6)</td>
</tr>
<tr class="odd">
<td>Grupo 7</td>
<td>[54.6,59.7)</td>
</tr>
<tr class="even">
<td>Grupo 8</td>
<td>[59.7,64.8)</td>
</tr>
<tr class="odd">
<td>Grupo 9</td>
<td>[64.8,69.9)</td>
</tr>
<tr class="even">
<td>Grupo 10</td>
<td>[69.9,75)</td>
</tr>
</tbody>
</table>
</section>
<section id="conjunto-de-datos-numérico" class="level4" data-number="2.1.2.2">
<h4 data-number="2.1.2.2" class="anchored" data-anchor-id="conjunto-de-datos-numérico"><span class="header-section-number">2.1.2.2</span> Conjunto de Datos Numérico</h4>
<p>El paradigma de este estudio engloba la búsqueda del algoritmo de aprendizaje computacional que mejor prediga el estado PCR de un paciente no visto, todo desde un punto de vista de la Ingeniería. Debido a esta falta de conocimiento clínico, se ha decidido no asumir un orden de las variables factor a la hora de encontrar su codificación numérica (por ejemplo, se ha decidido no asumir que un valor de <code>Grado: II</code> es más importante o severo que un <code>Grado: I</code>). Es port esto que se ha decidido usar la función <code>dummyVars</code> para realizar una codificación <em>One-Hot</em> a las variables. Este conjunto de datos existe para poder tener siempre presente los datos numéricos que se pasan a los modelos de ML, así como para que se use en algunas implementaciones concretas, sin embargo, la regla será usar el conjunto <code>data_factor</code> como entrada.</p>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación del conjunto de datos numérico</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>encode_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir variables categóricas sin orden en dummies</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">dummyVars</span>(<span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">fullRank =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">predict</span>(data) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asegurar que la variable objetivo esté al final</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> data[[target_name]]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>data_numeric <span class="ot">&lt;-</span> <span class="fu">encode_data</span>(data_original, <span class="st">"PCR"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(data_numeric, <span class="dv">10</span>))</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 2%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Edad</th>
<th style="text-align: right;">REstP</th>
<th style="text-align: right;">RProP</th>
<th style="text-align: right;">Her2P</th>
<th style="text-align: right;">EstadioT2</th>
<th style="text-align: right;">EstadioT3</th>
<th style="text-align: right;">EstadioT4</th>
<th style="text-align: right;">NodAfecN1</th>
<th style="text-align: right;">NodAfecN2</th>
<th style="text-align: right;">NodAfecN3</th>
<th style="text-align: right;">GradoII</th>
<th style="text-align: right;">GradoIII</th>
<th style="text-align: right;">FenotipoHer2</th>
<th style="text-align: right;">FenotipoLumA</th>
<th style="text-align: right;">FenotipoLumB</th>
<th style="text-align: right;">FenotipoNormal</th>
<th style="text-align: right;">PCR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">37.8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">45.8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">40.7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">40.8</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">35.5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">52.2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">38.2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">54.2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">46.6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">40.8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
<section id="métodos" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="métodos"><span class="header-section-number">2.2</span> Métodos</h2>
<p>Todos los objetivos de este proyecto quedarían anulados si no se sigue una metodología estricta, basada en la <em>estimación honesta de parámetros</em> y la rigurosidad para la evaluación del rendimiento de los modelos mediante la selección de una métrica que sea capaz de cuantificar la capacidad predictiva del modelo <em>independientemente del umbral</em> seleccionado para clasificar las muestras -ya que este depende de las necesidades específicas del equipo sanitario. Esta sección sirve como guía para mostrar cuál ha sido esta metodología adoptada, y así demostrar su eficacia y seguridad.</p>
<section id="auc-y-rendimiento-aparente" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="auc-y-rendimiento-aparente"><span class="header-section-number">2.2.1</span> AUC y Rendimiento Aparente</h3>
<p>Para poder estimar el rendimiento cualitativo de un modelo, se necesita tanto una métrica cuantificable que refleje efectivamente su capacidad predictiva, como un valor base (<em>ground truth</em>) con el que comparar. En este estudio se ha decidido utilizar el <strong>AUC (Area Under the Curve)</strong> como métrica representativa del rendimiento de un modelo, porque es una medida independiente del umbral utilizado para clasificar probabilidades calculadas por el modelo, esto es una característica decisiva, ya que, como se comentó anteriormente, el umbral podrá ser decidido por el clínico cuando el modelo sea puesto en producción, para que se ajuste a sus necesidades. Al utilizar el AUC como medida, podremos dar una estimación independiente del umbral a los clínicos, indicando que, elijan el umbral que elijan, el modelo rendirá de una manera preestablecida.</p>
<p>Por otra parte, se ha apostado por tomar el rendimiento aparente del modelo como la métrica base de comparación para un mismo modelo. El rendimiento aparente se calcula mediante el entrenamiento y evaluación del modelo con todo el conjunto de datos, obteniendo una estimación optimista de la capacidad predictiva del modelo, al ser evaluado con los datos que fue entrenado. Una característica que debe quedar clara es la de que esta métrica solo servirá para comparar diferentes métodos de selección de variables, búsqueda de hiperparámetros, o ajuste fino, de un <strong>mismo modelo</strong>, no entre modelos. Para realizar una comparación entre modelos se hará uso de la estimación honesta de parámetros, es decir, la <em>doble validación cruzada 5x2</em>.</p>
</section>
<section id="ajuste-fino-doble-validación-cruzada-5x2" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="ajuste-fino-doble-validación-cruzada-5x2"><span class="header-section-number">2.2.2</span> Ajuste Fino: Doble Validación Cruzada 5x2</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="2CV.png" class="img-fluid figure-img"></p>
<figcaption>Doble Validación Cruzada</figcaption>
</figure>
</div>
<p>El método de doble validación cruzada 5x2 es una técnica robusta para la evaluación de modelos que busca obtener una estimación honesta del rendimiento predictivo de un modelo. Este método se basa en una estructura jerárquica de validación cruzada, compuesta por dos niveles conocidos como <em>inner loop</em> y <em>outer loop</em>.</p>
<section id="outer-loop" class="level4" data-number="2.2.2.1">
<h4 data-number="2.2.2.1" class="anchored" data-anchor-id="outer-loop"><span class="header-section-number">2.2.2.1</span> Outer Loop</h4>
<p>El <em>outer loop</em> se encarga de la evaluación externa del modelo y se basa en la división del conjunto de datos original en 5 pliegues. En cada iteración, uno de estos pliegues se reserva como conjunto de test, mientras que los cuatro pliegues restantes se utilizan para el entrenamiento del modelo. Este proceso se repite cinco veces, de manera que cada pliegue se utiliza una vez como conjunto de test. Es crucial destacar que en el <em>outer loop</em> no se permite ajustar parámetros ni realizar selección de variables utilizando el conjunto de test, garantizando así una evaluación imparcial y honesta del modelo.</p>
</section>
<section id="inner-loop" class="level4" data-number="2.2.2.2">
<h4 data-number="2.2.2.2" class="anchored" data-anchor-id="inner-loop"><span class="header-section-number">2.2.2.2</span> Inner Loop</h4>
<p>Dentro de cada iteración del <em>outer loop</em>, se implementa el <em>inner loop</em>, cuyo objetivo es el ajuste fino de los hiperparámetros del modelo y la selección de las variables más relevantes. El <em>inner loop</em> utiliza una nueva división del conjunto de entrenamiento en pliegues adicionales. Generalmente, se opta por una validación cruzada más sencilla dentro de este bucle interno. Aquí, uno de los pliegues del conjunto de entrenamiento actúa como validación, mientras que los restantes se utilizan para el ajuste del modelo. Este proceso se repite varias veces para identificar la <strong>combinación óptima de hiperparámetros y características que maximicen el rendimiento predictivo en el conjunto de validación</strong>.</p>
</section>
<section id="evaluación-final" class="level4" data-number="2.2.2.3">
<h4 data-number="2.2.2.3" class="anchored" data-anchor-id="evaluación-final"><span class="header-section-number">2.2.2.3</span> Evaluación Final</h4>
<p>Una vez completado el ajuste en el <em>inner loop</em>, se evalúa el modelo ajustado en el conjunto de test reservado en el <em>outer loop</em>. Este enfoque jerárquico asegura que el ajuste de los hiperparámetros y la selección de variables no influyan en la evaluación final del rendimiento del modelo. El rendimiento se cuantifica mediante métricas como el AUC (Área Bajo la Curva), proporcionando una estimación promedio del rendimiento del modelo a lo largo de las iteraciones del <em>outer loop</em>. Este método de doble validación cruzada 5x2 ofrece una estimación más confiable y menos optimista del rendimiento del modelo, adecuada para su implementación en escenarios clínicos donde la precisión es crucial.</p>
</section>
</section>
<section id="selección-de-características" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="selección-de-características"><span class="header-section-number">2.2.3</span> Selección de Características</h3>
<p>La selección de características es un paso fundamental en la construcción de modelos predictivos, ya que permite identificar las variables más relevantes para el problema en cuestión. Este proceso no solo mejora la <em>interpretabilidad del modelo</em>, cosa que permite a los investigadores y clínicos entender mejor qué variables están influyendo en las predicciones del modelo, sino que también reduce significativamente el tiempo computacional y el riesgo de sobreajuste, proporcionando un modelo más eficiente y robusto.</p>
<section id="metodología-de-selección-de-características" class="level4" data-number="2.2.3.1">
<h4 data-number="2.2.3.1" class="anchored" data-anchor-id="metodología-de-selección-de-características"><span class="header-section-number">2.2.3.1</span> Metodología de Selección de Características</h4>
<p>En este estudio, se han realizado cuatro esquemas de selección de características por cada ciclo de doble validación cruzada 5x2 (2CV 5X2). Estos esquemas incluyen tanto métodos de filtrado, como métodos <em>wrapped</em>, y métodos <em>embedded</em>, proporcionando una perspectiva completa sobre las variables más relevantes.</p>
<ol type="1">
<li><p><strong>Todas las Variables del Conjunto</strong>: En este enfoque, se entrena el modelo utilizando todas las variables disponibles en el conjunto de datos, sin realizar ningún tipo de selección previa. Esto sirve como una línea base para comparar la efectividad de los métodos de selección de características.</p></li>
<li><p><strong>Métodos de Filtrado: Análisis de Asociación</strong>: Este método de filtrado se basa en el análisis de asociación, donde se evalúa la relación individual de cada variable con la variable objetivo. Se seleccionan aquellas variables que muestran una fuerte asociación, lo que permite reducir el conjunto de características antes del entrenamiento del modelo.</p></li>
<li><p><strong>Métodos Wrapped: StepAUC Backwards</strong>: En este método, se comienza con todas las variables incluidas en el modelo. Durante el proceso de entrenamiento en el <em>inner loop</em>, se prueban eliminando variables una por una. Si la eliminación de una variable mejora el AUC (Área Bajo la Curva), la variable se elimina permanentemente del conjunto. Este proceso se repite hasta que la eliminación de más variables no resulta en una mejora del AUC, determinando así el conjunto final de características seleccionadas.</p></li>
<li><p><strong>Métodos de Embedded: Modelo Lasso</strong>: El modelo Lasso es un método de regularización que no solo ajusta el modelo, sino que también selecciona automáticamente las variables más importantes. Durante el <em>inner loop</em>, se ajusta un modelo Lasso y se seleccionan las variables con coeficientes diferentes de cero.</p></li>
</ol>
</section>
</section>
<section id="modelos-aplicados" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="modelos-aplicados"><span class="header-section-number">2.2.4</span> Modelos Aplicados</h3>
<p>Con el objetivo de conseguir un modelo ajustado para la predicción efectiva del estado PCR de un paciente en mente, se han seleccionado una serie de algoritmos de Aprendizaje Máquina (<em>Machine Learning</em>, ML) con varios parámetros de customización. Estos modelos se eligen por su capacidad de manejar diferentes tipos de datos y su rendimiento en tareas de clasificación, proporcionando así una evaluación completa y robusta para el problema en cuestión.</p>
<section id="naive-bayes" class="level4" data-number="2.2.4.1">
<h4 data-number="2.2.4.1" class="anchored" data-anchor-id="naive-bayes"><span class="header-section-number">2.2.4.1</span> Naive Bayes</h4>
<p>Naive Bayes es un clasificador probabilístico basado en el teorema de Bayes, asumiendo una independencia condicional entre las características dadas la clase. En este estudio, se ha utilizado la implementación proporcionada en el paquete <code>e1071</code>. Formalmente, el clasificador Naive Bayes asigna una clase <span class="math inline">C_k</span> a una instancia <span class="math inline">x = (x_1, x_2, \ldots, x_n)</span> maximizando la probabilidad posterior <span class="math inline">P(C_k|x)</span>, que se calcula como:</p>
<p><span class="math display"> P(C_k|x) = \frac{P(C_k) \cdot P(x|C_k)}{P(x)}</span></p>
<p>Dado que <span class="math inline">P(x)</span> es constante para todas las clases, se simplifica a:</p>
<p><span class="math display"> P(C_k|x) \propto P(C_k) \prod_{i=1}^{n} P(x_i|C_k) </span></p>
<p>En resumen, el clasificador Naive Bayes es una opción eficiente y efectiva para problemas de clasificación, sin embargo, al <strong>asumir la independencia de las probabilidades condicionales</strong>, puede no dar resultados muy buenos, sin embargo, proporcionará una base sólida para predicciones iniciales, así como una base para la comparación entre modelos.</p>
</section>
<section id="adaboost" class="level4" data-number="2.2.4.2">
<h4 data-number="2.2.4.2" class="anchored" data-anchor-id="adaboost"><span class="header-section-number">2.2.4.2</span> Adaboost</h4>
<p>Adaboost, o Adaptive Boosting, es un algoritmo de aprendizaje automático que combina múltiples clasificadores débiles para crear un clasificador fuerte. En este estudio, se ha utilizado el paquete <code>mboost</code> de R con la configuración <code>family=Binomial()</code>, adaptado para tareas de clasificación binaria. Adaboost trabaja iterativamente, ajustando los pesos de las muestras de entrenamiento para concentrarse en aquellas que fueron clasificadas incorrectamente en iteraciones anteriores.</p>
<p>De esta forma, Adaboost asigna pesos a cada muestra y ajusta un clasificador débil <span class="math inline">h_t(x)</span> en cada iteración <span class="math inline">t</span>. La salida final del clasificador se obtiene mediante una combinación ponderada de estos clasificadores débiles:</p>
<p><span class="math display"> H(x) = \text{sign}\left( \sum_{t=1}^{T} \alpha_t h_t(x) \right) </span></p>
<p>donde <span class="math inline">\alpha_t</span> es el peso asignado al clasificador <span class="math inline">h_t(x)</span> basado en su precisión. En cada iteración, el peso de las muestras mal clasificadas se incrementa, enfocando así el entrenamiento subsecuente en estas muestras.</p>
<p>El principal hiperparámetro ajustado en este estudio ha sido el número de iteraciones <span class="math inline">T</span>. Este parámetro determina cuántos clasificadores débiles se combinarán para formar el clasificador final. Aumentar el número de iteraciones puede mejorar la capacidad del modelo para corregir errores y, por ende, afinar la frontera de decisión, pero también aumenta el riesgo de sobreajuste si el modelo se vuelve demasiado complejo.</p>
</section>
<section id="random-forest" class="level4" data-number="2.2.4.3">
<h4 data-number="2.2.4.3" class="anchored" data-anchor-id="random-forest"><span class="header-section-number">2.2.4.3</span> Random Forest</h4>
<p>Random Forest opera creando una colección de árboles de decisión, cada uno entrenado con un subconjunto aleatorio del conjunto de datos y un subconjunto aleatorio de características. Este enfoque introduce dos tipos de aleatoriedad: aleatoriedad en las muestras y aleatoriedad en las características, lo que ayuda a reducir la varianza del modelo y mitigar el sobreajuste. En el contexto de este estudio, se ha hecho uso del paquete <code>rpart</code> de R.</p>
<p>Los principales hiperparámetros ajustados en este estudio han sido <code>cp_values</code> y <code>minsplit_values</code>.</p>
<ul>
<li><p><strong><code>cp_values</code> (complexity parameter)</strong>: Este parámetro controla la poda de los árboles de decisión individuales. Un valor más alto de <code>cp</code> conduce a una mayor poda, reduciendo la complejidad del árbol y ayudando a prevenir el sobreajuste. Ajustar este parámetro afecta la profundidad de los árboles individuales y, por ende, la precisión del modelo. Una selección óptima de <code>cp_values</code> es crucial para equilibrar el sesgo y la varianza del modelo.</p></li>
<li><p><strong><code>minsplit_values</code></strong>: Este parámetro define el número mínimo de observaciones que debe tener un nodo para ser considerado para una división. Valores más altos de <code>minsplit</code> resultan en árboles más pequeños y menos complejos, mientras que valores más bajos permiten la creación de árboles más detallados. Ajustar <code>minsplit_values</code> permite controlar la granularidad con la que el modelo puede capturar las relaciones en los datos. Un valor adecuado de <code>minsplit</code> asegura que el modelo sea lo suficientemente flexible para capturar patrones relevantes sin sobreajustarse a ruido específico del conjunto de entrenamiento.</p></li>
</ul>
</section>
<section id="k-nearest-neighbours" class="level4" data-number="2.2.4.4">
<h4 data-number="2.2.4.4" class="anchored" data-anchor-id="k-nearest-neighbours"><span class="header-section-number">2.2.4.4</span> K-Nearest Neighbours</h4>
<p>K-Nearest Neighbours (KNN) clasifica una muestra basada en las clases de sus <span class="math inline">k</span> vecinos más cercanos en el espacio de características. En este estudio, se ha utilizado el paquete <code>class</code> de R para implementar KNN, ajustando los parámetros <span class="math inline">k</span> y <span class="math inline">l</span> para optimizar la precisión del modelo en la predicción del estado PCR de los pacientes.</p>
<p>KNN clasifica una muestra <span class="math inline">x</span> basándose en la mayoría de las clases de sus <span class="math inline">k</span> vecinos más cercanos, identificados utilizando una métrica de distancia. La distancia entre las muestras se calcula comúnmente usando la distancia euclidiana, pero se puede generalizar utilizando la distancia de Minkowski, definida como:</p>
<p><span class="math display"> d(x_i, x_j) = \left( \sum_{m=1}^{M} |x_{im} - x_{jm}|^l \right)^{1/l} </span></p>
<p>donde <span class="math inline">l</span> es el parámetro de distancia de Minkowski. Cuando <span class="math inline">l = 2</span>, se corresponde con la distancia euclidiana, y cuando <span class="math inline">l = 1</span>, se convierte en la distancia de Manhattan.</p>
<p>Los principales hiperparámetros ajustados en este estudio son:</p>
<ul>
<li><p><strong><span class="math inline">k</span> (número de vecinos más cercanos)</strong>: Este parámetro define el número de vecinos que se considerarán para determinar la clase de una nueva muestra. Valores pequeños de <span class="math inline">k</span> hacen que el modelo sea más sensible al ruido en los datos, mientras que valores grandes pueden hacer que el modelo sea demasiado general y pierda precisión en detalles locales.</p></li>
<li><p><strong><span class="math inline">l</span> (parámetro de distancia de Minkowski)</strong>: Este parámetro ajusta la métrica de distancia utilizada para identificar los vecinos más cercanos. Aunque el valor predeterminado es <span class="math inline">l = 2</span> (distancia euclidiana), ajustar <span class="math inline">l</span> permite al modelo adaptarse mejor a la geometría del espacio de características. Por ejemplo, un <span class="math inline">l</span> menor puede capturar mejor las relaciones lineales, mientras que un <span class="math inline">l</span> mayor puede ser más adecuado para relaciones más complejas y no lineales.</p></li>
</ul>
<p>Además, el parámetro <code>probes = TRUE</code> se utiliza para devolver las probabilidades de las clases predichas, proporcionando una medida de confianza en las predicciones del modelo.</p>
<p>En resumen, KNN es un algoritmo intuitivo y efectivo para la clasificación, especialmente adecuado para conjuntos de datos donde la estructura local de las muestras es crucial para la precisión de las predicciones. Ajustar los parámetros <span class="math inline">k</span> y <span class="math inline">l</span> permite optimizar el modelo para capturar las relaciones subyacentes en los datos, asegurando predicciones precisas y confiables del estado PCR de los pacientes.</p>
</section>
<section id="support-vector-machine" class="level4" data-number="2.2.4.5">
<h4 data-number="2.2.4.5" class="anchored" data-anchor-id="support-vector-machine"><span class="header-section-number">2.2.4.5</span> Support Vector Machine</h4>
<p>La Máquina de Vectores de Soporte, o, Support Vector Machine (SVM) es una técnica de clasificación que busca encontrar el hiperplano que mejor separa las clases en el espacio de características. En este estudio, se ha utilizado el paquete <code>e1071</code> de R para implementar SVM, ajustando los parámetros del kernel y el coste (C) para optimizar la precisión del modelo en la predicción del estado PCR de los pacientes.</p>
<p>SVM funciona proyectando los datos a un espacio de mayor dimensión donde se puede encontrar un hiperplano que maximiza el margen de separación entre las clases. El hiperplano se define por:</p>
<p><span class="math display"> \mathbf{w} \cdot \mathbf{x} + b = 0 </span></p>
<p>donde <span class="math inline">\mathbf{w}</span> es el vector de pesos y <span class="math inline">b</span> es el sesgo. El objetivo es encontrar <span class="math inline">\mathbf{w}</span> y <span class="math inline">b</span> que maximicen el margen, sujetando a las restricciones de clasificación correcta de las muestras. Formalmente, los principales hiperparámetros ajustados en este estudio han sido:</p>
<ul>
<li><p><strong>Kernel</strong>: Este parámetro define la función de transformación que se utiliza para proyectar los datos en un espacio de mayor dimensión. Los kernels disponibles incluyen:</p>
<ul>
<li><strong>Lineal</strong>: $ K(, ) = $</li>
<li><strong>Sigmoid</strong>: $ K(, ) = ( + r) $</li>
<li><strong>Polinomial</strong>: $ K(, ) = ( + r)^d $</li>
<li><strong>RBF (Radial Basis Function)</strong>: $ K(, ) = (-|| - ||^2) $</li>
</ul>
<p>La elección del kernel afecta directamente la capacidad del SVM para capturar relaciones no lineales en los datos. Por ejemplo, un kernel lineal es adecuado para datos linealmente separables, mientras que un kernel RBF es más flexible y puede modelar relaciones complejas.</p></li>
<li><p><strong>Coste (C)</strong>: Este parámetro controla el margen de tolerancia a errores en la clasificación. Un valor alto de <span class="math inline">C</span> da como resultado un margen más estrecho y menos tolerancia a errores de clasificación, lo que puede llevar a un modelo que sobreajuste los datos de entrenamiento. Por otro lado, un valor bajo de <span class="math inline">C</span> permite un margen más amplio y más errores de clasificación, lo que puede resultar en un modelo más general.</p></li>
</ul>
</section>
<section id="artificial-neural-networks" class="level4" data-number="2.2.4.6">
<h4 data-number="2.2.4.6" class="anchored" data-anchor-id="artificial-neural-networks"><span class="header-section-number">2.2.4.6</span> Artificial Neural Networks</h4>
<p>Las Redes Neuronales Artificiales (ANN) son modelos de aprendizaje automático inspirados en la estructura y funcionamiento del cerebro humano. En este estudio, se ha utilizado la función <code>nnet</code> del paquete <code>nnet</code> de R para implementar un modelo de red neuronal artificial, optimizando los parámetros <code>size</code> y <code>decay</code> para mejorar la precisión en la predicción del estado PCR de los pacientes.</p>
<p>Las redes neuronales consisten en una capa de entrada, una o más capas ocultas, y una capa de salida. Cada neurona en estas capas realiza una operación lineal seguida de una función de activación no lineal. En este estudio, la arquitectura del modelo se definirá principalmente por el número de neuronas en la capa oculta (<code>size</code>) y el método de regularización (<code>weight-decay</code>).</p>
<ul>
<li><p><strong>Tamaño de la Capa Oculta (<code>size</code>)</strong>: Este parámetro especifica el número de neuronas en la capa oculta de la red neuronal. Un mayor número de neuronas (<code>size</code>) puede capturar patrones más complejos en los datos, pero también aumenta el riesgo de sobreajuste si el modelo se vuelve demasiado complejo.</p></li>
<li><p><strong>Parámetro de Regularización (<code>decay</code>)</strong>: El parámetro <code>weight-decay</code> controla la magnitud de la penalización aplicada a los pesos del modelo durante el entrenamiento para prevenir el sobreajuste. Este método de regularización agrega un término a la función de pérdida que penaliza grandes valores de los pesos, manteniendo los pesos más pequeños y el modelo más sencillo. Ajustar el <code>decay</code> afecta la capacidad del modelo para generalizar, ya que valores muy altos pueden resultar en un modelo subajustado, mientras que valores muy bajos pueden no ser suficientes para evitar el sobreajuste.</p></li>
</ul>
</section>
</section>
</section>
</section>
<section id="resultados" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Resultados</h1>
<section id="naive-bayes-1" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="naive-bayes-1"><span class="header-section-number">3.1</span> Naive Bayes</h2>
<section id="aparente" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="aparente"><span class="header-section-number">3.1.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_naiveBayes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, threshold, seed) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="at">seed =</span> seed)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(predicted_classes, actual_classes)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>naiveBayes_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">naiveBayes</span>(<span class="at">formula =</span> formula, <span class="at">data =</span> data)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>resultadosAparentesNaiveBayes <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_naiveBayes</span>(<span class="at">data =</span> data_factor, </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                                                                               <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                                                                              <span class="at">model_func =</span> naiveBayes_model,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                                                                              <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>                                                                              <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>                                                                              <span class="at">seed =</span> <span class="dv">90</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/NaiveBayes_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="todas-las-variables"><span class="header-section-number">3.1.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_naiveBayes <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, variables, threshold, seed) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Skipping outer fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(variables, target_name)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Skipping inner fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        model <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula, <span class="at">data =</span> inner_train_data)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Error in inner fold "</span>, inner_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">&lt;-</span> model</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_NaiveBayes_Asociacion_Todas <span class="ot">&lt;-</span> </span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>performance_naiveBayes_todasVariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_NaiveBayes_Asociacion_Todas</span>(</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_naiveBayes,</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/NaiveBayes_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="filtrado-asociación"><span class="header-section-number">3.1.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>performance_naiveBayes_Asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_NaiveBayes_Asociacion_Todas</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_naiveBayes,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/NaiveBayes_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="wrapped-stepauc"><span class="header-section-number">3.1.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_naiveBayes_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, variables, threshold, seed) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, outer_train_data, target_name, inner_folds) {</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>              model <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data =</span> inner_train_data)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>              inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>              inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>          mean_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_inner_auc) <span class="sc">&amp;&amp;</span> mean_inner_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_inner_auc</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, inner_folds)</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, <span class="at">newdata =</span> inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[, <span class="dv">2</span>]</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_NaiveBayes_stepAUC <span class="ot">&lt;-</span> </span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed)</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>performance_naiveBayes_stepAUC <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_NaiveBayes_stepAUC</span>(</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_naiveBayes_stepAUC,</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/NaiveBayes_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="embedded-lasso"><span class="header-section-number">3.1.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_naiveBayes_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, variables, threshold, seed) {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])  <span class="co"># Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># Convertimos a numérico para Lasso</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Selected variables by Lasso: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, inner_folds) {</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>        auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>          inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>          inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>          selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>          formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Testing with formula: "</span>, <span class="fu">deparse</span>(formula), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>          result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>            model <span class="ot">&lt;-</span> <span class="fu">naiveBayes</span>(formula, <span class="at">data =</span> inner_train_data)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>            predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>            auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"AUC for inner fold "</span>, inner_index, <span class="st">": "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>          }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>            auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>          })</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>        mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Mean AUC: "</span>, mean_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>          best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>          best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>          best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>          improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, inner_folds)</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Inner fold "</span>, inner_index, <span class="st">" AUC: "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Best inner AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)[,<span class="dv">2</span>]</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_NaiveBayes_Lasso <span class="ot">&lt;-</span> </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>performance_naiveBayes_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_NaiveBayes_Lasso</span>(</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_naiveBayes_lasso,</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/NaiveBayes_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="adaboost-1" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="adaboost-1"><span class="header-section-number">3.2</span> Adaboost</h2>
<section id="aparente-1" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="aparente-1"><span class="header-section-number">3.2.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_adaboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, <span class="at">iterations =</span> <span class="dv">100</span>, threshold) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data, iterations)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Predicted =</span> predicted_classes, <span class="at">Actual =</span> actual_classes)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>adaboost_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data, iterations) {</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">glmboost</span>(formula, <span class="at">data =</span> data, <span class="at">family =</span> <span class="fu">Binomial</span>(), <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> iterations))</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  model</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>resultadosAparentesAdaBoost <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_adaboost</span>(<span class="at">data =</span> data_numeric, <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">model_func =</span> adaboost_model,</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="at">threshold =</span> <span class="fl">0.35</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/AdaBoost_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables-1" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="todas-las-variables-1"><span class="header-section-number">3.2.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_adaboost <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Iteration =</span> <span class="fu">integer</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Skipping outer fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    best_iteration <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">iteration =</span> iterations)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(variables, target_name)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Skipping inner fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>          <span class="cf">next</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>          model <span class="ot">&lt;-</span> <span class="fu">blackboost</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">family =</span> <span class="fu">Binomial</span>(), <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> grid<span class="sc">$</span>iteration[params]))</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>          predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>          roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error with parameters: iteration ="</span>, grid<span class="sc">$</span>iteration[params], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">&lt;-</span> model</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>        best_iteration <span class="ot">&lt;-</span> grid<span class="sc">$</span>iteration[params]</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, best_iteration), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_AdaBoost_Asociacion_Todas <span class="ot">&lt;-</span> </span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner,</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>                                   iterations, </span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed)</span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>performance_adaboost_todasvariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_AdaBoost_Asociacion_Todas</span>(</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_adaboost,</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds,</span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>)</span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/AdaBoost_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación-1" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="filtrado-asociación-1"><span class="header-section-number">3.2.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>performance_adaboost_Asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_AdaBoost_Asociacion_Todas</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_adaboost,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> asociacion,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/AdaBoost_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc-1" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="wrapped-stepauc-1"><span class="header-section-number">3.2.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_adaboost_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Iterations =</span> <span class="fu">integer</span>(), <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    best_iterations <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, outer_train_data, target_name, iterations, inner_folds) {</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>      best_inner_iterations <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (iter <span class="cf">in</span> iterations) {</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>              inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>              inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>              result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>                model <span class="ot">&lt;-</span> <span class="fu">glmboost</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data =</span> inner_train_data, <span class="at">family =</span> <span class="fu">Binomial</span>(),</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> iter))</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> inner_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>                roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>              }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>              best_auc_in_step <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>              best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>              best_inner_iterations <span class="ot">&lt;-</span> iter</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>              best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>              improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>           <span class="at">iterations =</span> best_inner_iterations, </span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, iterations, inner_folds)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    best_iterations <span class="ot">&lt;-</span> best_result<span class="sc">$</span>iterations</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, <span class="at">newdata =</span> inner_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>                          best_iterations, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Iterations: %d, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_iterations, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_AdaBoost_stepAUC <span class="ot">&lt;-</span> </span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">iterations =</span> iterations)</span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a>performance_adaboost_stepAUC <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_AdaBoost_stepAUC</span>(</span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_adaboost_stepAUC,</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>),</span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/AdaBoost_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso-1" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="embedded-lasso-1"><span class="header-section-number">3.2.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_adaboost_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Iteration =</span> <span class="fu">integer</span>(), </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])  <span class="co"># Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    best_iteration <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">iteration =</span> iterations)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># Convertimos a numérico para Lasso</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      <span class="co">#cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>      best_inner_iteration <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>          auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Grid parameters - iteration: ", grid$iteration[params], "\n")</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>              model <span class="ot">&lt;-</span> <span class="fu">blackboost</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">family =</span> <span class="fu">Binomial</span>(), </span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">control =</span> <span class="fu">boost_control</span>(<span class="at">mstop =</span> grid<span class="sc">$</span>iteration[params]))</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>              <span class="co">#cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>          mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>          <span class="co">#cat("Mean AUC for params - iteration: ", grid$iteration[params], ": ", mean_auc, "\n")</span></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>            best_inner_iteration <span class="ot">&lt;-</span> grid<span class="sc">$</span>iteration[params]</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>           <span class="at">iteration =</span> best_inner_iteration, <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>    best_iteration <span class="ot">&lt;-</span> best_result<span class="sc">$</span>iteration</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Inner fold "</span>, inner_index, <span class="st">" AUC: "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Best inner AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>                          best_iteration, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Iteration: %d, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_iteration, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_AdaBoost_Lasso <span class="ot">&lt;-</span> </span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">iterations =</span> iterations)</span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>performance_adaboost_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_AdaBoost_stepAUC</span>(</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_adaboost_lasso,</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>),</span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/AdaBoost_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="random-forest-1" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="random-forest-1"><span class="header-section-number">3.3</span> Random Forest</h2>
<section id="aparente-2" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="aparente-2"><span class="header-section-number">3.3.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_rpart <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, <span class="at">threshold =</span> <span class="fl">0.5</span>) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(predicted_classes, actual_classes)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">90</span>)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart</span>(<span class="at">formula =</span> formula, <span class="at">data =</span> data, <span class="at">method =</span> <span class="st">"class"</span>, <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">minsplit =</span> <span class="dv">2</span>, <span class="at">cp =</span> <span class="dv">0</span>))</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>resultadosAparentesRF <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_rpart</span>(<span class="at">data =</span> data_factor, <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">model_func =</span> rf_model,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">threshold =</span> .<span class="dv">35</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/RandomForest_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables-2" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="todas-las-variables-2"><span class="header-section-number">3.3.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_rpart <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, cp_values, minsplit_values, variables, threshold, seed) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_cp =</span> <span class="fu">numeric</span>(), <span class="at">Best_minsplit =</span> <span class="fu">integer</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Imprime la cantidad de instancias de cada clase en el outer train y test set</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    best_cp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    best_minsplit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> cp_values, <span class="at">minsplit =</span> minsplit_values)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>        inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>        inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>        model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(variables, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> inner_train_data, <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> grid<span class="sc">$</span>cp[params], <span class="at">minsplit =</span> grid<span class="sc">$</span>minsplit[params]))</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">=</span> <span class="fu">mean</span>(inner_auc)</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">=</span> model</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        best_cp <span class="ot">=</span> grid<span class="sc">$</span>cp[params]</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        best_minsplit <span class="ot">=</span> grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">=</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, best_cp, best_minsplit), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_RandomForest_TodasVariables_Asociacion <span class="ot">&lt;-</span> </span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cp_values =</span> cp_values,</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">minsplit_values =</span> minsplit_values)</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>performance_rpart_todasvariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_RandomForest_TodasVariables_Asociacion</span>(</span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_rpart,</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp_values =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>),</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit_values =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>),</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/RandomForest_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación-2" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="filtrado-asociación-2"><span class="header-section-number">3.3.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>performance_rpart_Asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_RandomForest_TodasVariables_Asociacion</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_rpart,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp_values =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>),</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit_values =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>),</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> asociacion,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/RandomForest_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc-2" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="wrapped-stepauc-2"><span class="header-section-number">3.3.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_rpart_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, cps, minsplits, variables, threshold, seed) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_CP =</span> <span class="fu">numeric</span>(), <span class="at">Best_Minsplit =</span> <span class="fu">integer</span>(), </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    best_cp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    best_minsplit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> cps, <span class="at">minsplit =</span> minsplits)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>      best_inner_cp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>      best_inner_minsplit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>            auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>              inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>              inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>              result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>                model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> inner_train_data, <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> grid<span class="sc">$</span>cp[params], <span class="at">minsplit =</span> grid<span class="sc">$</span>minsplit[params]))</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>                roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>              }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>              best_auc_in_step <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>              best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>              best_inner_cp <span class="ot">&lt;-</span> grid<span class="sc">$</span>cp[params]</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>              best_inner_minsplit <span class="ot">&lt;-</span> grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>              best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>              improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>           <span class="at">cp =</span> best_inner_cp, <span class="at">minsplit =</span> best_inner_minsplit, </span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>    best_cp <span class="ot">&lt;-</span> best_result<span class="sc">$</span>cp</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>    best_minsplit <span class="ot">&lt;-</span> best_result<span class="sc">$</span>minsplit</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[, <span class="dv">2</span>]</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>                          best_cp, best_minsplit, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best CP: %f, Best Minsplit: %d, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_cp, best_minsplit, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_RandomForest_StepAUC <span class="ot">&lt;-</span> </span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cp_values =</span> cp_values,</span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">minsplit_values =</span> minsplit_values)</span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a>performance_rpart_StepAUC <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_RandomForest_StepAUC</span>(</span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_rpart,</span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp_values =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>),</span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit_values =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>),</span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/RandomForest_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso-2" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="embedded-lasso-2"><span class="header-section-number">3.3.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_rpart_Lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, cps, minsplits, variables, threshold, seed) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_cp =</span> <span class="fu">numeric</span>(), <span class="at">Best_minsplit =</span> <span class="fu">numeric</span>(), </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    best_cp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    best_minsplit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">cp =</span> cps, <span class="at">minsplit =</span> minsplits)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]])</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">#cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>      best_inner_cp <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>      best_inner_minsplit <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>          auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>            selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>            formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Grid parameters - cp: ", grid$cp[params], ", minsplit: ", grid$minsplit[params], "\n")</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>              model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">method =</span> <span class="st">"class"</span>, </span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>                             <span class="at">control =</span> <span class="fu">rpart.control</span>(<span class="at">cp =</span> grid<span class="sc">$</span>cp[params], <span class="at">minsplit =</span> grid<span class="sc">$</span>minsplit[params]))</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>              <span class="co">#cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>          mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>          <span class="co">#cat("Mean AUC for params - cp: ", grid$cp[params], ", minsplit: ", grid$minsplit[params], ": ", mean_auc, "\n")</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>            best_inner_cp <span class="ot">&lt;-</span> grid<span class="sc">$</span>cp[params]</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>            best_inner_minsplit <span class="ot">&lt;-</span> grid<span class="sc">$</span>minsplit[params]</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>           <span class="at">cp =</span> best_inner_cp, <span class="at">minsplit =</span> best_inner_minsplit, </span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>    best_cp <span class="ot">&lt;-</span> best_result<span class="sc">$</span>cp</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>    best_minsplit <span class="ot">&lt;-</span> best_result<span class="sc">$</span>minsplit</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>      <span class="co">#cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Best inner AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"prob"</span>)[,<span class="dv">2</span>]</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>                          best_cp, best_minsplit, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best cp: %f, Best minsplit: %d, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_cp, best_minsplit, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_RandomForest_lasso <span class="ot">&lt;-</span> </span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">cps =</span> cp_values,</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">minsplits =</span> minsplit_values)</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>performance_rpart_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_RandomForest_lasso</span>(</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_rpart_Lasso,</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">cp_values =</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>),</span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">minsplit_values =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>),</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/RandomForest_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="k-nearest-neighbours-1" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="k-nearest-neighbours-1"><span class="header-section-number">3.4</span> K-Nearest Neighbours</h2>
<section id="aparente-3" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="aparente-3"><span class="header-section-number">3.4.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_knn <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, <span class="at">threshold =</span> <span class="fl">0.5</span>) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  train_x <span class="ot">&lt;-</span> model<span class="sc">$</span>train_x</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  train_y <span class="ot">&lt;-</span> model<span class="sc">$</span>train_y</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  test_x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula, data)[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> train_y, <span class="at">k =</span> model<span class="sc">$</span>k, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(predicted_classes, actual_classes)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>knn_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>  train_x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula, data)[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  train_y <span class="ot">&lt;-</span> data[[<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]]]</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">train_x =</span> train_x, <span class="at">train_y =</span> train_y, <span class="at">k =</span> <span class="dv">5</span>)  </span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>resultadosAparentesKNN <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_knn</span>(<span class="at">data =</span> data_numeric, <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">model_func =</span> knn_model,</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">threshold =</span> .<span class="dv">35</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/KNN_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables-3" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="todas-las-variables-3"><span class="header-section-number">3.4.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_knn <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_k =</span> <span class="fu">integer</span>(), <span class="at">Best_l =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Skipping outer fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    best_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    best_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> ks, <span class="at">l =</span> ls)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(variables, target_name)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Skipping inner fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>          <span class="cf">next</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>        train_x <span class="ot">&lt;-</span> inner_train_data[, variables, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>        test_x <span class="ot">&lt;-</span> inner_test_data[, variables, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        train_y <span class="ot">&lt;-</span> inner_train_data[[target_name]]</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        test_y <span class="ot">&lt;-</span> inner_test_data[[target_name]]</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>          predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> train_y, <span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>          probabilities <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>          probabilities <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">==</span> <span class="st">"1"</span>, probabilities, <span class="dv">1</span> <span class="sc">-</span> probabilities)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>          roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(test_y)), probabilities)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error with parameters: k ="</span>, grid<span class="sc">$</span>k[params], <span class="st">", l ="</span>, grid<span class="sc">$</span>l[params], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">train_x =</span> train_x, <span class="at">train_y =</span> train_y, <span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">l =</span> grid<span class="sc">$</span>l[params])</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        best_k <span class="ot">&lt;-</span> grid<span class="sc">$</span>k[params]</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        best_l <span class="ot">&lt;-</span> grid<span class="sc">$</span>l[params]</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>    test_x <span class="ot">&lt;-</span> outer_test_data[, variables, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>    test_y <span class="ot">&lt;-</span> outer_test_data[[target_name]]</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> best_model<span class="sc">$</span>train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> best_model<span class="sc">$</span>train_y, <span class="at">k =</span> best_k, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    probabilities <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>    probabilities <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">==</span> <span class="st">"1"</span>, probabilities, <span class="dv">1</span> <span class="sc">-</span> probabilities)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(probabilities <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> test_y, <span class="at">Predicted =</span> pred_class)</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(test_y, probabilities)<span class="sc">$</span>auc</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, best_k, best_l), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_k, best_l))</span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_KNN_TodasVariables_Asociacion <span class="ot">&lt;-</span> </span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ks =</span> ks,</span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ls =</span> ls)</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>performance_knn_todasvariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_KNN_TodasVariables_Asociacion</span>(</span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_knn,</span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_numeric,</span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>  <span class="at">ks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">32</span>),</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>  <span class="at">ls =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_numeric,</span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/KNN_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación-3" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="filtrado-asociación-3"><span class="header-section-number">3.4.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>performance_knn_Asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_KNN_TodasVariables_Asociacion</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_knn,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_numeric,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">ks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">32</span>),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ls =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> asociacion_numeric,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/KNN_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc-3" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="wrapped-stepauc-3"><span class="header-section-number">3.4.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_knn_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_k =</span> <span class="fu">integer</span>(), <span class="at">Best_l =</span> <span class="fu">numeric</span>(), <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    best_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    best_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> ks, <span class="at">l =</span> ls)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, outer_train_data, target_name, grid, inner_folds) {</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>      best_inner_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>      best_inner_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>            auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>              inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>              inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>              train_x <span class="ot">&lt;-</span> inner_train_data[, temp_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>              test_x <span class="ot">&lt;-</span> inner_test_data[, temp_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a>              train_y <span class="ot">&lt;-</span> inner_train_data[[target_name]]</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>              test_y <span class="ot">&lt;-</span> inner_test_data[[target_name]]</span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>              result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> train_y, <span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">l =</span> grid<span class="sc">$</span>l[params], <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>                probabilities <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>                roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(test_y)), probabilities)</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>              }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>              best_auc_in_step <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>              best_inner_model <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">train_x =</span> train_x, <span class="at">train_y =</span> train_y, <span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">l =</span> grid<span class="sc">$</span>l[params])</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>              best_inner_k <span class="ot">&lt;-</span> grid<span class="sc">$</span>k[params]</span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>              best_inner_l <span class="ot">&lt;-</span> grid<span class="sc">$</span>l[params]</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>              best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>              improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a>           <span class="at">k =</span> best_inner_k, <span class="at">l =</span> best_inner_l, </span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>    best_k <span class="ot">&lt;-</span> best_result<span class="sc">$</span>k</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a>    best_l <span class="ot">&lt;-</span> best_result<span class="sc">$</span>l</span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>      train_x <span class="ot">&lt;-</span> best_model<span class="sc">$</span>train_x</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>      test_x <span class="ot">&lt;-</span> inner_test_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>      train_y <span class="ot">&lt;-</span> best_model<span class="sc">$</span>train_y</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a>      test_y <span class="ot">&lt;-</span> inner_test_data[[target_name]]</span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> train_y, <span class="at">k =</span> best_k, <span class="at">l =</span> best_l, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>      probabilities <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">as.numeric</span>(<span class="fu">as.character</span>(test_y)), probabilities)</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(probabilities <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> test_y, <span class="at">Predicted =</span> pred_class)</span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a>    test_x <span class="ot">&lt;-</span> outer_test_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a>    test_y <span class="ot">&lt;-</span> outer_test_data[[target_name]]</span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(<span class="at">train =</span> best_model<span class="sc">$</span>train_x, <span class="at">test =</span> test_x, <span class="at">cl =</span> best_model<span class="sc">$</span>train_y, <span class="at">k =</span> best_k, <span class="at">l =</span> best_l, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a>    probabilities <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(probabilities <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> test_y, <span class="at">Predicted =</span> pred_class)</span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb39-152"><a href="#cb39-152" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb39-153"><a href="#cb39-153" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb39-154"><a href="#cb39-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-155"><a href="#cb39-155" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(test_y, probabilities)<span class="sc">$</span>auc</span>
<span id="cb39-156"><a href="#cb39-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-157"><a href="#cb39-157" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb39-158"><a href="#cb39-158" aria-hidden="true" tabindex="-1"></a>                          best_k, best_l, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb39-159"><a href="#cb39-159" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb39-160"><a href="#cb39-160" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb39-161"><a href="#cb39-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-162"><a href="#cb39-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb39-163"><a href="#cb39-163" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb39-164"><a href="#cb39-164" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb39-165"><a href="#cb39-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb39-166"><a href="#cb39-166" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb39-167"><a href="#cb39-167" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_k, best_l, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb39-168"><a href="#cb39-168" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-169"><a href="#cb39-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-170"><a href="#cb39-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb39-171"><a href="#cb39-171" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-172"><a href="#cb39-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-173"><a href="#cb39-173" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_KNN_stepAUC <span class="ot">&lt;-</span> </span>
<span id="cb39-174"><a href="#cb39-174" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span>
<span id="cb39-175"><a href="#cb39-175" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb39-176"><a href="#cb39-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-177"><a href="#cb39-177" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb39-178"><a href="#cb39-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb39-179"><a href="#cb39-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-180"><a href="#cb39-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-181"><a href="#cb39-181" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb39-182"><a href="#cb39-182" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb39-183"><a href="#cb39-183" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb39-184"><a href="#cb39-184" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb39-185"><a href="#cb39-185" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb39-186"><a href="#cb39-186" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb39-187"><a href="#cb39-187" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb39-188"><a href="#cb39-188" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ks =</span> ks,</span>
<span id="cb39-189"><a href="#cb39-189" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ls =</span> ls)</span>
<span id="cb39-190"><a href="#cb39-190" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb39-191"><a href="#cb39-191" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-192"><a href="#cb39-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-193"><a href="#cb39-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb39-194"><a href="#cb39-194" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-195"><a href="#cb39-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-196"><a href="#cb39-196" aria-hidden="true" tabindex="-1"></a>performance_knn_stepauc <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_KNN_stepAUC</span>(</span>
<span id="cb39-197"><a href="#cb39-197" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_knn_stepAUC,</span>
<span id="cb39-198"><a href="#cb39-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_numeric,</span>
<span id="cb39-199"><a href="#cb39-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb39-200"><a href="#cb39-200" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb39-201"><a href="#cb39-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb39-202"><a href="#cb39-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">ks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">32</span>),</span>
<span id="cb39-203"><a href="#cb39-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">ls =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb39-204"><a href="#cb39-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_numeric,</span>
<span id="cb39-205"><a href="#cb39-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb39-206"><a href="#cb39-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb39-207"><a href="#cb39-207" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/KNN_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso-3" class="level3" data-number="3.4.5">
<h3 data-number="3.4.5" class="anchored" data-anchor-id="embedded-lasso-3"><span class="header-section-number">3.4.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_knn_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_k =</span> <span class="fu">integer</span>(), <span class="at">Best_l =</span> <span class="fu">integer</span>(), </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    best_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    best_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">k =</span> ks, <span class="at">l =</span> ls)</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]])</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>      <span class="co">#cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>      best_inner_k <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>      best_inner_l <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>          auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>            selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>            formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Grid parameters - k: ", grid$k[params], ", l: ", grid$l[params], "\n")</span></span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>              train_x <span class="ot">&lt;-</span> inner_train_data[, selected_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>              test_x <span class="ot">&lt;-</span> inner_test_data[, selected_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>              train_y <span class="ot">&lt;-</span> inner_train_data[[target_name]]</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a>              test_y <span class="ot">&lt;-</span> inner_test_data[[target_name]]</span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(train_x, test_x, train_y, <span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">l =</span> grid<span class="sc">$</span>l[params], <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>              prob_predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>              prob_predictions <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">==</span> <span class="st">"1"</span>, prob_predictions, <span class="dv">1</span> <span class="sc">-</span> prob_predictions)</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], prob_predictions)</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>              <span class="co">#cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>          mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>          <span class="co">#cat("Mean AUC for params - k: ", grid$k[params], ", l: ", grid$l[params], ": ", mean_auc, "\n")</span></span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">k =</span> grid<span class="sc">$</span>k[params], <span class="at">l =</span> grid<span class="sc">$</span>l[params])</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>            best_inner_k <span class="ot">&lt;-</span> grid<span class="sc">$</span>k[params]</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>            best_inner_l <span class="ot">&lt;-</span> grid<span class="sc">$</span>l[params]</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>           <span class="at">k =</span> best_inner_k, <span class="at">l =</span> best_inner_l, </span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>    best_k <span class="ot">&lt;-</span> best_result<span class="sc">$</span>k</span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>    best_l <span class="ot">&lt;-</span> best_result<span class="sc">$</span>l</span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>      train_x <span class="ot">&lt;-</span> inner_train_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>      test_x <span class="ot">&lt;-</span> inner_test_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>      train_y <span class="ot">&lt;-</span> inner_train_data[[target_name]]</span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>      test_y <span class="ot">&lt;-</span> inner_test_data[[target_name]]</span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(train_x, test_x, train_y, <span class="at">k =</span> best_k, <span class="at">l =</span> best_l, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>      prob_predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>      prob_predictions <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">==</span> <span class="st">"1"</span>, prob_predictions, <span class="dv">1</span> <span class="sc">-</span> prob_predictions)</span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], prob_predictions)</span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Inner fold "</span>, inner_index, <span class="st">" AUC: "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(prob_predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Best inner AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a>    train_x <span class="ot">&lt;-</span> outer_train_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a>    test_x <span class="ot">&lt;-</span> outer_test_data[, best_vars, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>    train_y <span class="ot">&lt;-</span> outer_train_data[[target_name]]</span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>    test_y <span class="ot">&lt;-</span> outer_test_data[[target_name]]</span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">knn</span>(train_x, test_x, train_y, <span class="at">k =</span> best_k, <span class="at">l =</span> best_l, <span class="at">prob =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>    prob_predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"prob"</span>)</span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a>    prob_predictions <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">==</span> <span class="st">"1"</span>, prob_predictions, <span class="dv">1</span> <span class="sc">-</span> prob_predictions)</span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(prob_predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], prob_predictions)<span class="sc">$</span>auc</span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a>                          best_k, best_l, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %d, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_k, best_l, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_KNN_lasso <span class="ot">&lt;-</span> </span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb41-220"><a href="#cb41-220" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb41-221"><a href="#cb41-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb41-222"><a href="#cb41-222" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb41-223"><a href="#cb41-223" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb41-224"><a href="#cb41-224" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb41-225"><a href="#cb41-225" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ks =</span> ks,</span>
<span id="cb41-226"><a href="#cb41-226" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ls =</span> ls)</span>
<span id="cb41-227"><a href="#cb41-227" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb41-228"><a href="#cb41-228" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-229"><a href="#cb41-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-230"><a href="#cb41-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb41-231"><a href="#cb41-231" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb41-232"><a href="#cb41-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-233"><a href="#cb41-233" aria-hidden="true" tabindex="-1"></a>performance_knn_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_KNN_lasso</span>(</span>
<span id="cb41-234"><a href="#cb41-234" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_knn_lasso,</span>
<span id="cb41-235"><a href="#cb41-235" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_numeric,</span>
<span id="cb41-236"><a href="#cb41-236" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb41-237"><a href="#cb41-237" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb41-238"><a href="#cb41-238" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb41-239"><a href="#cb41-239" aria-hidden="true" tabindex="-1"></a>  <span class="at">ks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">30</span>, <span class="dv">32</span>),</span>
<span id="cb41-240"><a href="#cb41-240" aria-hidden="true" tabindex="-1"></a>  <span class="at">ls =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb41-241"><a href="#cb41-241" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_numeric,</span>
<span id="cb41-242"><a href="#cb41-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb41-243"><a href="#cb41-243" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb41-244"><a href="#cb41-244" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/KNN_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="support-vector-machines" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="support-vector-machines"><span class="header-section-number">3.5</span> Support Vector Machines</h2>
<section id="aparente-4" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="aparente-4"><span class="header-section-number">3.5.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_svm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, <span class="at">threshold =</span> <span class="fl">0.5</span>) {</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(predicted_classes, actual_classes)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>svm_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">90</span>)</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(formula, data)</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> data[[<span class="fu">all.vars</span>(formula)[<span class="dv">1</span>]]]</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">factor</span>(y, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svm</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">kernel =</span> <span class="st">"linear"</span>, <span class="at">cost =</span> <span class="dv">100</span>, <span class="at">probability =</span> <span class="cn">TRUE</span>, <span class="at">maxiter=</span><span class="dv">300</span>, <span class="at">random_state=</span><span class="dv">90</span>)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a><span class="co"># svm(x = x, y = y, kernel = "poly", cost = 5, gamma = .5, probability = TRUE, maxiter=150)</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a><span class="co"># svm(x = x, y = y, kernel = "linear", cost = 50, probability = TRUE, maxiter=300, random_state=90)</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>resultadosAparentesSVM <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_svm</span>(<span class="at">data =</span> data_numeric, <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">model_func =</span> svm_model,</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">threshold =</span> .<span class="dv">35</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/SVM_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables-4" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="todas-las-variables-4"><span class="header-section-number">3.5.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_svm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Kernel =</span> <span class="fu">character</span>(), <span class="at">Best_Cost =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Skipping outer fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    best_kernel <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    best_cost <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">kernel =</span> kernels, <span class="at">cost =</span> costs)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>        inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>        inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"0"</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="st">"1"</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Skipping inner fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>          <span class="cf">next</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>          model <span class="ot">&lt;-</span> <span class="fu">svm</span>(<span class="fu">reformulate</span>(variables, target_name), </span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> inner_train_data, <span class="at">kernel =</span> grid<span class="sc">$</span>kernel[params], <span class="at">cost =</span> grid<span class="sc">$</span>cost[params], </span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a>                       <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>          pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>          prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(pred, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>          roc_curve <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(inner_test_data[[target_name]], prob)</span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error with parameters: kernel ="</span>, grid<span class="sc">$</span>kernel[params], <span class="st">", cost ="</span>, grid<span class="sc">$</span>cost[params], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">&lt;-</span> model</span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a>        best_kernel <span class="ot">&lt;-</span> grid<span class="sc">$</span>kernel[params]</span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>        best_cost <span class="ot">&lt;-</span> grid<span class="sc">$</span>cost[params]</span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>    prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(prob <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb45-72"><a href="#cb45-72" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(outer_test_data[[target_name]], pred_class)</span>
<span id="cb45-73"><a href="#cb45-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-74"><a href="#cb45-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb45-75"><a href="#cb45-75" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb45-76"><a href="#cb45-76" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb45-77"><a href="#cb45-77" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb45-78"><a href="#cb45-78" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb45-79"><a href="#cb45-79" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb45-80"><a href="#cb45-80" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb45-81"><a href="#cb45-81" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb45-82"><a href="#cb45-82" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb45-83"><a href="#cb45-83" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb45-84"><a href="#cb45-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-85"><a href="#cb45-85" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(outer_test_data[[target_name]], prob)<span class="sc">$</span>auc</span>
<span id="cb45-86"><a href="#cb45-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-87"><a href="#cb45-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crear un vector con los nombres correctos y convertir a dataframe</span></span>
<span id="cb45-88"><a href="#cb45-88" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, best_kernel, best_cost), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb45-89"><a href="#cb45-89" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb45-90"><a href="#cb45-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-91"><a href="#cb45-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-92"><a href="#cb45-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb45-93"><a href="#cb45-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-94"><a href="#cb45-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-95"><a href="#cb45-95" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_SVM_TodasVariables_Asociacion <span class="ot">&lt;-</span> </span>
<span id="cb45-96"><a href="#cb45-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span>
<span id="cb45-97"><a href="#cb45-97" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-98"><a href="#cb45-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-99"><a href="#cb45-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb45-100"><a href="#cb45-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb45-101"><a href="#cb45-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-102"><a href="#cb45-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-103"><a href="#cb45-103" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb45-104"><a href="#cb45-104" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb45-105"><a href="#cb45-105" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb45-106"><a href="#cb45-106" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb45-107"><a href="#cb45-107" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb45-108"><a href="#cb45-108" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb45-109"><a href="#cb45-109" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb45-110"><a href="#cb45-110" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">kernels =</span> kernels,</span>
<span id="cb45-111"><a href="#cb45-111" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">costs =</span> costs)</span>
<span id="cb45-112"><a href="#cb45-112" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb45-113"><a href="#cb45-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-114"><a href="#cb45-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-115"><a href="#cb45-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb45-116"><a href="#cb45-116" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-117"><a href="#cb45-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-118"><a href="#cb45-118" aria-hidden="true" tabindex="-1"></a>performance_SVM_todasvariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_SVM_TodasVariables_Asociacion</span>(</span>
<span id="cb45-119"><a href="#cb45-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_svm,</span>
<span id="cb45-120"><a href="#cb45-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb45-121"><a href="#cb45-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb45-122"><a href="#cb45-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb45-123"><a href="#cb45-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb45-124"><a href="#cb45-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernels =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"poly"</span>),</span>
<span id="cb45-125"><a href="#cb45-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">costs =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>),</span>
<span id="cb45-126"><a href="#cb45-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb45-127"><a href="#cb45-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb45-128"><a href="#cb45-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb45-129"><a href="#cb45-129" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/SVM_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación-4" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="filtrado-asociación-4"><span class="header-section-number">3.5.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>performance_svm_asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_SVM_TodasVariables_Asociacion</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_svm,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernels =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"poly"</span>),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">costs =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> asociacion,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/SVM_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc-4" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="wrapped-stepauc-4"><span class="header-section-number">3.5.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_svm_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Kernel =</span> <span class="fu">character</span>(), <span class="at">Best_Cost =</span> <span class="fu">numeric</span>(), <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Total: "</span>, <span class="fu">nrow</span>(outer_train_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Total: "</span>, <span class="fu">nrow</span>(outer_test_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>    best_kernel <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    best_cost <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">kernel =</span> kernels, <span class="at">cost =</span> costs)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, outer_train_data, target_name, grid, inner_folds) {</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>      best_inner_kernel <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>      best_inner_cost <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>            auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>              inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>              inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>              result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>                model <span class="ot">&lt;-</span> <span class="fu">svm</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> inner_train_data, <span class="at">kernel =</span> grid<span class="sc">$</span>kernel[params], <span class="at">cost =</span> grid<span class="sc">$</span>cost[params], </span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>                             <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> inner_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>                roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>              }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>              best_auc_in_step <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>              best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>              best_inner_kernel <span class="ot">&lt;-</span> grid<span class="sc">$</span>kernel[params]</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>              best_inner_cost <span class="ot">&lt;-</span> grid<span class="sc">$</span>cost[params]</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>              best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a>              improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a>           <span class="at">kernel =</span> best_inner_kernel, <span class="at">cost =</span> best_inner_cost, </span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a>    best_kernel <span class="ot">&lt;-</span> best_result<span class="sc">$</span>kernel</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a>    best_cost <span class="ot">&lt;-</span> best_result<span class="sc">$</span>cost</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb49-113"><a href="#cb49-113" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-114"><a href="#cb49-114" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, <span class="at">newdata =</span> inner_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-127"><a href="#cb49-127" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb49-128"><a href="#cb49-128" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, <span class="at">newdata =</span> outer_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb49-137"><a href="#cb49-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-138"><a href="#cb49-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb49-149"><a href="#cb49-149" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb49-150"><a href="#cb49-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a>                          best_kernel, best_cost, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb49-160"><a href="#cb49-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Kernel: %s, Best Cost: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb49-161"><a href="#cb49-161" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_kernel, best_cost, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_SVM_stepAUC <span class="ot">&lt;-</span> </span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb49-171"><a href="#cb49-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb49-172"><a href="#cb49-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb49-176"><a href="#cb49-176" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb49-177"><a href="#cb49-177" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb49-178"><a href="#cb49-178" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb49-179"><a href="#cb49-179" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">kernels =</span> kernels,</span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">costs =</span> costs)</span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb49-184"><a href="#cb49-184" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-185"><a href="#cb49-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb49-188"><a href="#cb49-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-189"><a href="#cb49-189" aria-hidden="true" tabindex="-1"></a>performance_SVM_stepauc <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_SVM_stepAUC</span>(</span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_svm_stepAUC,</span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_numeric,</span>
<span id="cb49-192"><a href="#cb49-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb49-193"><a href="#cb49-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernels =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"poly"</span>),</span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a>  <span class="at">costs =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>),</span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_numeric,</span>
<span id="cb49-198"><a href="#cb49-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb49-199"><a href="#cb49-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/SVM_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso-4" class="level3" data-number="3.5.5">
<h3 data-number="3.5.5" class="anchored" data-anchor-id="embedded-lasso-4"><span class="header-section-number">3.5.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_svm_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Kernel =</span> <span class="fu">character</span>(), <span class="at">Best_Cost =</span> <span class="fu">numeric</span>(),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(data[[target_name]])  <span class="co"># Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    best_kernel <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>    best_cost <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">kernel =</span> kernels, <span class="at">cost =</span> costs)</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span>  <span class="co"># Convertimos a numérico para Lasso</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Selected variables by Lasso: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>      best_inner_kernel <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>      best_inner_cost <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>          auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>            selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a>            formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Testing with formula: "</span>, <span class="fu">deparse</span>(formula), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Grid parameters - kernel: "</span>, grid<span class="sc">$</span>kernel[params], <span class="st">", cost: "</span>, grid<span class="sc">$</span>cost[params], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a>              model <span class="ot">&lt;-</span> <span class="fu">svm</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">kernel =</span> grid<span class="sc">$</span>kernel[params], <span class="at">cost =</span> grid<span class="sc">$</span>cost[params], <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a>              predictions_prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions_prob)</span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"AUC for inner fold "</span>, inner_index, <span class="st">": "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a>          mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Mean AUC for params - kernel: "</span>, grid<span class="sc">$</span>kernel[params], <span class="st">", cost: "</span>, grid<span class="sc">$</span>cost[params], <span class="st">": "</span>, mean_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a>            best_inner_kernel <span class="ot">&lt;-</span> grid<span class="sc">$</span>kernel[params]</span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a>            best_inner_cost <span class="ot">&lt;-</span> grid<span class="sc">$</span>cost[params]</span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a>           <span class="at">kernel =</span> best_inner_kernel, <span class="at">cost =</span> best_inner_cost, </span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a>    best_kernel <span class="ot">&lt;-</span> best_result<span class="sc">$</span>kernel</span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a>    best_cost <span class="ot">&lt;-</span> best_result<span class="sc">$</span>cost</span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-128"><a href="#cb51-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb51-129"><a href="#cb51-129" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb51-136"><a href="#cb51-136" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb51-137"><a href="#cb51-137" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a>      predictions_prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions_prob)</span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Inner fold "</span>, inner_index, <span class="st">" AUC: "</span>, roc_curve<span class="sc">$</span>auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions_prob <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)</span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb51-150"><a href="#cb51-150" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb51-151"><a href="#cb51-151" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Best inner AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-159"><a href="#cb51-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-160"><a href="#cb51-160" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">probability =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a>    predictions_prob <span class="ot">&lt;-</span> <span class="fu">attr</span>(predictions, <span class="st">"probabilities"</span>)[, <span class="dv">2</span>]</span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions_prob <span class="sc">&gt;</span> threshold, <span class="st">"1"</span>, <span class="st">"0"</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb51-167"><a href="#cb51-167" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb51-168"><a href="#cb51-168" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb51-169"><a href="#cb51-169" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb51-170"><a href="#cb51-170" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb51-171"><a href="#cb51-171" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb51-172"><a href="#cb51-172" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb51-173"><a href="#cb51-173" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb51-174"><a href="#cb51-174" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb51-175"><a href="#cb51-175" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb51-176"><a href="#cb51-176" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions_prob)<span class="sc">$</span>auc</span>
<span id="cb51-177"><a href="#cb51-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-178"><a href="#cb51-178" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb51-179"><a href="#cb51-179" aria-hidden="true" tabindex="-1"></a>                          best_kernel, best_cost, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb51-180"><a href="#cb51-180" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb51-181"><a href="#cb51-181" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb51-182"><a href="#cb51-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-183"><a href="#cb51-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-184"><a href="#cb51-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb51-185"><a href="#cb51-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb51-186"><a href="#cb51-186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb51-187"><a href="#cb51-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Kernel: %s, Best Cost: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb51-188"><a href="#cb51-188" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_kernel, best_cost, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb51-189"><a href="#cb51-189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-190"><a href="#cb51-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-191"><a href="#cb51-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb51-192"><a href="#cb51-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-193"><a href="#cb51-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-194"><a href="#cb51-194" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_SVM_lasso <span class="ot">&lt;-</span> </span>
<span id="cb51-195"><a href="#cb51-195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span>
<span id="cb51-196"><a href="#cb51-196" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb51-197"><a href="#cb51-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-198"><a href="#cb51-198" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb51-199"><a href="#cb51-199" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb51-200"><a href="#cb51-200" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-201"><a href="#cb51-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-202"><a href="#cb51-202" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb51-203"><a href="#cb51-203" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb51-204"><a href="#cb51-204" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb51-205"><a href="#cb51-205" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb51-206"><a href="#cb51-206" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb51-207"><a href="#cb51-207" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb51-208"><a href="#cb51-208" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb51-209"><a href="#cb51-209" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">kernels =</span> kernels,</span>
<span id="cb51-210"><a href="#cb51-210" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">costs =</span> costs)</span>
<span id="cb51-211"><a href="#cb51-211" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb51-212"><a href="#cb51-212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-213"><a href="#cb51-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-214"><a href="#cb51-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb51-215"><a href="#cb51-215" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-216"><a href="#cb51-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-217"><a href="#cb51-217" aria-hidden="true" tabindex="-1"></a>performance_SVM_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_SVM_lasso</span>(</span>
<span id="cb51-218"><a href="#cb51-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_svm_lasso,</span>
<span id="cb51-219"><a href="#cb51-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb51-220"><a href="#cb51-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb51-221"><a href="#cb51-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb51-222"><a href="#cb51-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb51-223"><a href="#cb51-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">kernels =</span> <span class="fu">c</span>(<span class="st">"linear"</span>, <span class="st">"poly"</span>),</span>
<span id="cb51-224"><a href="#cb51-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">costs =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>),</span>
<span id="cb51-225"><a href="#cb51-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb51-226"><a href="#cb51-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb51-227"><a href="#cb51-227" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb51-228"><a href="#cb51-228" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/SVM_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="artificial-neural-networks-1" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="artificial-neural-networks-1"><span class="header-section-number">3.6</span> Artificial Neural Networks</h2>
<section id="aparente-5" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="aparente-5"><span class="header-section-number">3.6.1</span> Aparente</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>evaluate_aparent_performance_model_nnet <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_var, model_func, <span class="at">vars =</span> <span class="cn">NULL</span>, <span class="at">threshold =</span> <span class="fl">0.5</span>) {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(vars)) {</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_var)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  data[[target_var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(data[[target_var]], <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_var, <span class="st">"~"</span>, <span class="fu">paste</span>(vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">model_func</span>(formula, data)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  actual_classes <span class="ot">&lt;-</span> data[[target_var]]</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  predicted_classes <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  confusion_matrix <span class="ot">&lt;-</span> <span class="fu">table</span>(predicted_classes, actual_classes)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  tp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  tn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  fp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"1"</span>, <span class="st">"0"</span>], <span class="dv">0</span>)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  fn <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="st">"0"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(confusion_matrix) <span class="sc">&amp;&amp;</span> <span class="st">"1"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(confusion_matrix), confusion_matrix[<span class="st">"0"</span>, <span class="st">"1"</span>], <span class="dv">0</span>)</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>  accuracy <span class="ot">&lt;-</span> (tp <span class="sc">+</span> tn) <span class="sc">/</span> (tp <span class="sc">+</span> tn <span class="sc">+</span> fp <span class="sc">+</span> fn)</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  precision <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fp <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fp), <span class="dv">0</span>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  recall <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(tp <span class="sc">+</span> fn <span class="sc">&gt;</span> <span class="dv">0</span>, tp <span class="sc">/</span> (tp <span class="sc">+</span> fn), <span class="dv">0</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  f1_score <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(precision <span class="sc">+</span> recall <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">2</span> <span class="sc">*</span> (precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall), <span class="dv">0</span>)</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  roc_obj <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(actual_classes, predictions)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">confusion_matrix =</span> confusion_matrix, <span class="at">accuracy =</span> accuracy, <span class="at">precision =</span> precision, </span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>       <span class="at">recall =</span> recall, <span class="at">f1_score =</span> f1_score, <span class="at">roc_curve =</span> roc_obj)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>nn_model <span class="ot">&lt;-</span> <span class="cf">function</span>(formula, data) {</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">90</span>)</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nnet</span>(<span class="at">formula =</span> formula, <span class="at">data =</span> data, <span class="at">size =</span> <span class="dv">15</span>, </span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">decay =</span> <span class="fl">0.1</span>, <span class="at">maxit =</span> <span class="dv">100</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>, </span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">linout =</span> <span class="cn">FALSE</span>, <span class="at">random_state =</span> <span class="dv">90</span>)</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>resultadosAparentesNN <span class="ot">&lt;-</span> <span class="fu">evaluate_aparent_performance_model_nnet</span>(<span class="at">data =</span> data_factor, <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">model_func =</span> nn_model,</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">vars =</span> <span class="st">"."</span>,</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>                                                             <span class="at">threshold =</span> .<span class="dv">35</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/ANN_Aparente.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="todas-las-variables-5" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="todas-las-variables-5"><span class="header-section-number">3.6.2</span> Todas las Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_nnet <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, sizes, decays, variables, threshold, seed) {</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Size =</span> <span class="fu">integer</span>(), <span class="at">Best_Decay =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Total: "</span>, <span class="fu">nrow</span>(outer_train_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Total: "</span>, <span class="fu">nrow</span>(outer_test_data), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Skipping outer fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner, <span class="at">list =</span> <span class="cn">TRUE</span>, <span class="at">returnTrain =</span> <span class="cn">FALSE</span>)</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    best_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    best_decay <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> sizes, <span class="at">decay =</span> decays)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">reformulate</span>(variables, target_name)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>      inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>        inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>        inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">sum</span>(inner_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Skipping inner fold due to lack of class diversity</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>          <span class="cf">next</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>          model <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">size =</span> grid<span class="sc">$</span>size[params], <span class="at">decay =</span> grid<span class="sc">$</span>decay[params], <span class="at">linout =</span> <span class="cn">FALSE</span>, <span class="at">maxit =</span> <span class="dv">200</span>)</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>          predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>          roc_curve <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error with parameters: size ="</span>, grid<span class="sc">$</span>size[params], <span class="st">", decay ="</span>, grid<span class="sc">$</span>decay[params], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>          inner_auc[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc) {</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>        best_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>        best_model <span class="ot">&lt;-</span> model</span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>        best_size <span class="ot">&lt;-</span> grid<span class="sc">$</span>size[params]</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>        best_decay <span class="ot">&lt;-</span> grid<span class="sc">$</span>decay[params]</span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> pROC<span class="sc">::</span><span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, best_size, best_decay), <span class="fu">names</span>(performance_metrics))</span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(performance_metrics)</span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_ANN_TodasVariables_Asociacion <span class="ot">&lt;-</span> </span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sizes =</span> sizes,</span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">decays =</span> decays)</span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a>performance_ANN_todasvariables <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_ANN_TodasVariables_Asociacion</span>(</span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_nnet,</span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">sizes =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),</span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">decays =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>),</span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/ANN_TodasVariables.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtrado-asociación-5" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="filtrado-asociación-5"><span class="header-section-number">3.6.3</span> Filtrado (Asociación)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>performance_ANN_asociacion <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_ANN_TodasVariables_Asociacion</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_nnet,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sizes =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">decays =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>),</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> asociacion,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/ANN_Asociacion.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="wrapped-stepauc-5" class="level3" data-number="3.6.4">
<h3 data-number="3.6.4" class="anchored" data-anchor-id="wrapped-stepauc-5"><span class="header-section-number">3.6.4</span> Wrapped (StepAUC)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_nnet_stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, sizes, decays, variables, threshold, seed) {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Size =</span> <span class="fu">integer</span>(), <span class="at">Best_Decay =</span> <span class="fu">numeric</span>(), <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data[outer_folds[[outer_index]], ]</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    best_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    best_decay <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> variables</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> sizes, <span class="at">decay =</span> decays)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>      current_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>      best_inner_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>      best_inner_decay <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> current_vars</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(current_vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (var <span class="cf">in</span> current_vars) {</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>          temp_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_vars, var)</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>          inner_auc <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>            auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>              inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>              inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>              result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>                model <span class="ot">&lt;-</span> <span class="fu">nnet</span>(<span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">"+"</span>))),</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data =</span> inner_train_data, <span class="at">size =</span> grid<span class="sc">$</span>size[params], <span class="at">decay =</span> grid<span class="sc">$</span>decay[params], </span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>                              <span class="at">linout =</span> <span class="cn">FALSE</span>, <span class="at">maxit =</span> <span class="dv">200</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>                predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>                roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Guardar los datos del inner fold</span></span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>                pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a>                confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a>                TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb59-70"><a href="#cb59-70" aria-hidden="true" tabindex="-1"></a>                TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb59-71"><a href="#cb59-71" aria-hidden="true" tabindex="-1"></a>                FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb59-72"><a href="#cb59-72" aria-hidden="true" tabindex="-1"></a>                FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb59-73"><a href="#cb59-73" aria-hidden="true" tabindex="-1"></a>                auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb59-74"><a href="#cb59-74" aria-hidden="true" tabindex="-1"></a>                inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb59-75"><a href="#cb59-75" aria-hidden="true" tabindex="-1"></a>                inner_fold_metrics <span class="ot">&lt;&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb59-76"><a href="#cb59-76" aria-hidden="true" tabindex="-1"></a>              }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb59-77"><a href="#cb59-77" aria-hidden="true" tabindex="-1"></a>                <span class="fu">cat</span>(<span class="st">"Error with variables:"</span>, <span class="fu">paste</span>(temp_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-78"><a href="#cb59-78" aria-hidden="true" tabindex="-1"></a>                auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb59-79"><a href="#cb59-79" aria-hidden="true" tabindex="-1"></a>              })</span>
<span id="cb59-80"><a href="#cb59-80" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb59-81"><a href="#cb59-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb59-82"><a href="#cb59-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb59-83"><a href="#cb59-83" aria-hidden="true" tabindex="-1"></a>              best_auc_in_step <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb59-84"><a href="#cb59-84" aria-hidden="true" tabindex="-1"></a>              best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb59-85"><a href="#cb59-85" aria-hidden="true" tabindex="-1"></a>              best_inner_size <span class="ot">&lt;-</span> grid<span class="sc">$</span>size[params]</span>
<span id="cb59-86"><a href="#cb59-86" aria-hidden="true" tabindex="-1"></a>              best_inner_decay <span class="ot">&lt;-</span> grid<span class="sc">$</span>decay[params]</span>
<span id="cb59-87"><a href="#cb59-87" aria-hidden="true" tabindex="-1"></a>              best_inner_vars <span class="ot">&lt;-</span> temp_vars</span>
<span id="cb59-88"><a href="#cb59-88" aria-hidden="true" tabindex="-1"></a>              improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb59-89"><a href="#cb59-89" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb59-90"><a href="#cb59-90" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb59-91"><a href="#cb59-91" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb59-92"><a href="#cb59-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb59-93"><a href="#cb59-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb59-94"><a href="#cb59-94" aria-hidden="true" tabindex="-1"></a>          current_vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb59-95"><a href="#cb59-95" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb59-96"><a href="#cb59-96" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(current_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-97"><a href="#cb59-97" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, <span class="fu">paste</span>(best_inner_auc), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-98"><a href="#cb59-98" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb59-99"><a href="#cb59-99" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb59-100"><a href="#cb59-100" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb59-101"><a href="#cb59-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb59-102"><a href="#cb59-102" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> best_inner_size, <span class="at">decay =</span> best_inner_decay, </span>
<span id="cb59-103"><a href="#cb59-103" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb59-104"><a href="#cb59-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-105"><a href="#cb59-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-106"><a href="#cb59-106" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(variables, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb59-107"><a href="#cb59-107" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb59-108"><a href="#cb59-108" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb59-109"><a href="#cb59-109" aria-hidden="true" tabindex="-1"></a>    best_size <span class="ot">&lt;-</span> best_result<span class="sc">$</span>size</span>
<span id="cb59-110"><a href="#cb59-110" aria-hidden="true" tabindex="-1"></a>    best_decay <span class="ot">&lt;-</span> best_result<span class="sc">$</span>decay</span>
<span id="cb59-111"><a href="#cb59-111" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb59-112"><a href="#cb59-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-113"><a href="#cb59-113" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb59-114"><a href="#cb59-114" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb59-115"><a href="#cb59-115" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb59-116"><a href="#cb59-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-117"><a href="#cb59-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb59-118"><a href="#cb59-118" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb59-119"><a href="#cb59-119" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb59-120"><a href="#cb59-120" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb59-121"><a href="#cb59-121" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb59-122"><a href="#cb59-122" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb59-123"><a href="#cb59-123" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb59-124"><a href="#cb59-124" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb59-125"><a href="#cb59-125" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb59-126"><a href="#cb59-126" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb59-127"><a href="#cb59-127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-128"><a href="#cb59-128" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">=</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb59-129"><a href="#cb59-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-130"><a href="#cb59-130" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb59-131"><a href="#cb59-131" aria-hidden="true" tabindex="-1"></a>                          best_size, best_decay, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb59-132"><a href="#cb59-132" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb59-133"><a href="#cb59-133" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb59-134"><a href="#cb59-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-135"><a href="#cb59-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:"</span>, <span class="fu">paste</span>(performance_metrics))</span>
<span id="cb59-136"><a href="#cb59-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb59-137"><a href="#cb59-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb59-138"><a href="#cb59-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb59-139"><a href="#cb59-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Size: %d, Best Decay: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb59-140"><a href="#cb59-140" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_size, best_decay, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb59-141"><a href="#cb59-141" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-142"><a href="#cb59-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-143"><a href="#cb59-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb59-144"><a href="#cb59-144" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-145"><a href="#cb59-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-146"><a href="#cb59-146" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_ANN_StepAUC <span class="ot">&lt;-</span> </span>
<span id="cb59-147"><a href="#cb59-147" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span>
<span id="cb59-148"><a href="#cb59-148" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb59-149"><a href="#cb59-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-150"><a href="#cb59-150" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb59-151"><a href="#cb59-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb59-152"><a href="#cb59-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb59-153"><a href="#cb59-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-154"><a href="#cb59-154" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb59-155"><a href="#cb59-155" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb59-156"><a href="#cb59-156" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">variables =</span> vars, </span>
<span id="cb59-157"><a href="#cb59-157" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb59-158"><a href="#cb59-158" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb59-159"><a href="#cb59-159" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb59-160"><a href="#cb59-160" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb59-161"><a href="#cb59-161" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sizes =</span> sizes,</span>
<span id="cb59-162"><a href="#cb59-162" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">decays =</span> decays)</span>
<span id="cb59-163"><a href="#cb59-163" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb59-164"><a href="#cb59-164" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-165"><a href="#cb59-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-166"><a href="#cb59-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb59-167"><a href="#cb59-167" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-168"><a href="#cb59-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-169"><a href="#cb59-169" aria-hidden="true" tabindex="-1"></a>performance_ANN_stepAUC <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_ANN_StepAUC</span>(</span>
<span id="cb59-170"><a href="#cb59-170" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_nnet_stepAUC,</span>
<span id="cb59-171"><a href="#cb59-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb59-172"><a href="#cb59-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb59-173"><a href="#cb59-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb59-174"><a href="#cb59-174" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb59-175"><a href="#cb59-175" aria-hidden="true" tabindex="-1"></a>  <span class="at">sizes =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),</span>
<span id="cb59-176"><a href="#cb59-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">decays =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>),</span>
<span id="cb59-177"><a href="#cb59-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> todas_variables_factor,</span>
<span id="cb59-178"><a href="#cb59-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb59-179"><a href="#cb59-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb59-180"><a href="#cb59-180" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/ANN_StepAUC.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="embedded-lasso-5" class="level3" data-number="3.6.5">
<h3 data-number="3.6.5" class="anchored" data-anchor-id="embedded-lasso-5"><span class="header-section-number">3.6.5</span> Embedded (Lasso)</h3>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>double_cross_validation_nnet_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name, outer, inner, sizes, decays, threshold, seed) {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  performance_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">FP =</span> <span class="fu">integer</span>(), <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">Best_Size =</span> <span class="fu">integer</span>(), <span class="at">Best_Decay =</span> <span class="fu">numeric</span>(), <span class="at">Best_Variables =</span> <span class="fu">character</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Fold =</span> <span class="fu">integer</span>(), <span class="at">Inner_Fold =</span> <span class="fu">integer</span>(), </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">TP =</span> <span class="fu">integer</span>(), <span class="at">TN =</span> <span class="fu">integer</span>(), <span class="at">FP =</span> <span class="fu">integer</span>(), </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">FN =</span> <span class="fu">integer</span>(), <span class="at">AUC =</span> <span class="fu">numeric</span>(), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir las variables del dataset con model.matrix</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>  features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>  data_matrix <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>])  <span class="co"># Eliminar el intercepto</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  data_matrix[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>  outer_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(data_matrix[[target_name]], <span class="at">k =</span> outer)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (outer_index <span class="cf">in</span> <span class="fu">seq_along</span>(outer_folds)) {</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    outer_train_data <span class="ot">&lt;-</span> data_matrix[<span class="sc">-</span>outer_folds[[outer_index]], ]</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    outer_test_data <span class="ot">&lt;-</span> data_matrix[outer_folds[[outer_index]], ]</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Outer Fold %d</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 0: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Training Data - Class 1: "</span>, <span class="fu">sum</span>(outer_train_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 0: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Testing Data - Class 1: "</span>, <span class="fu">sum</span>(outer_test_data[[target_name]] <span class="sc">==</span> <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>    inner_folds <span class="ot">&lt;-</span> <span class="fu">createFolds</span>(outer_train_data[[target_name]], <span class="at">k =</span> inner)</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>    best_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>    best_decay <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> <span class="fu">colnames</span>(outer_train_data)[<span class="sc">!</span><span class="fu">colnames</span>(outer_train_data) <span class="sc">%in%</span> target_name]</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>    grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">size =</span> sizes, <span class="at">decay =</span> decays)</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>    select_vars_lasso <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>      target <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data[[target_name]])</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>      features <span class="ot">&lt;-</span> data[, <span class="fu">setdiff</span>(<span class="fu">names</span>(data), target_name)]</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>      X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> ., <span class="at">data=</span>features)[,<span class="sc">-</span><span class="dv">1</span>]  <span class="co"># Eliminamos el intercepto</span></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> target</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ajustamos el modelo Lasso</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>      lasso_model <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X, y, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>      lasso_coef <span class="ot">&lt;-</span> <span class="fu">coef</span>(lasso_model, <span class="at">s =</span> <span class="st">"lambda.min"</span>)</span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Seleccionamos las variables no nulas</span></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(lasso_coef)[lasso_coef[, <span class="dv">1</span>] <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>      selected_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(selected_vars, <span class="st">"(Intercept)"</span>)</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Selected variables by Lasso: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(selected_vars)</span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>    stepAUC <span class="ot">&lt;-</span> <span class="cf">function</span>(vars, data, target_name, grid, inner_folds) {</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>      best_inner_auc <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a>      best_inner_model <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>      best_inner_size <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>      best_inner_decay <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>      best_inner_vars <span class="ot">&lt;-</span> vars</span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>      improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (improved <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(vars) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a>        improved <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>        best_auc_in_step <span class="ot">&lt;-</span> best_inner_auc</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (params <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid)) {</span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>          auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>            inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>            inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>            selected_vars <span class="ot">&lt;-</span> <span class="fu">select_vars_lasso</span>(inner_train_data, target_name)</span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>            formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(target_name, <span class="st">"~"</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">"+"</span>)))</span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">#cat("Grid parameters - size: ", grid$size[params], ", decay: ", grid$decay[params], "\n")</span></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>            result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>              model <span class="ot">&lt;-</span> <span class="fu">nnet</span>(formula, <span class="at">data =</span> inner_train_data, <span class="at">size =</span> grid<span class="sc">$</span>size[params], </span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>                            <span class="at">decay =</span> grid<span class="sc">$</span>decay[params], <span class="at">linout =</span> <span class="cn">FALSE</span>, <span class="at">maxit =</span> <span class="dv">200</span>, <span class="at">trace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>              predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>              roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>              <span class="co">#cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error with variables: "</span>, <span class="fu">paste</span>(selected_vars, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"Error message: "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>              auc_vals[inner_index] <span class="ot">&lt;-</span> <span class="cn">NA</span>  <span class="co"># Set to NA or some other indicator of failure</span></span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>          mean_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>          <span class="co">#cat("Mean AUC for params - size: ", grid$size[params], ", decay: ", grid$decay[params], ": ", mean_auc, "\n")</span></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(mean_auc) <span class="sc">&amp;&amp;</span> mean_auc <span class="sc">&gt;</span> best_auc_in_step) {</span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a>            best_auc_in_step <span class="ot">&lt;-</span> mean_auc</span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>            best_inner_model <span class="ot">&lt;-</span> model</span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>            best_inner_size <span class="ot">&lt;-</span> grid<span class="sc">$</span>size[params]</span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>            best_inner_decay <span class="ot">&lt;-</span> grid<span class="sc">$</span>decay[params]</span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a>            best_inner_vars <span class="ot">&lt;-</span> selected_vars</span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>            improved <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (improved) {</span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>          vars <span class="ot">&lt;-</span> best_inner_vars</span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>          best_inner_auc <span class="ot">&lt;-</span> best_auc_in_step</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Vars improved: "</span>, <span class="fu">paste</span>(vars, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"AUC: "</span>, best_inner_auc, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">model =</span> best_inner_model, <span class="at">auc =</span> best_inner_auc, </span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> best_inner_size, <span class="at">decay =</span> best_inner_decay, </span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>           <span class="at">vars =</span> best_inner_vars)</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a>    best_result <span class="ot">&lt;-</span> <span class="fu">stepAUC</span>(best_vars, outer_train_data, target_name, grid, inner_folds)</span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a>    best_model <span class="ot">&lt;-</span> best_result<span class="sc">$</span>model</span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>    best_auc <span class="ot">&lt;-</span> best_result<span class="sc">$</span>auc</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>    best_size <span class="ot">&lt;-</span> best_result<span class="sc">$</span>size</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>    best_decay <span class="ot">&lt;-</span> best_result<span class="sc">$</span>decay</span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>    best_vars <span class="ot">&lt;-</span> best_result<span class="sc">$</span>vars</span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(best_model)) {</span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No valid model found for outer fold "</span>, outer_index, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>    inner_auc_vals <span class="ot">&lt;-</span> <span class="fu">numeric</span>()</span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (inner_index <span class="cf">in</span> <span class="fu">seq_along</span>(inner_folds)) {</span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a>      inner_train_data <span class="ot">&lt;-</span> outer_train_data[<span class="sc">-</span>inner_folds[[inner_index]], ]</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>      inner_test_data <span class="ot">&lt;-</span> outer_train_data[inner_folds[[inner_index]], ]</span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>      predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, inner_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>      roc_curve <span class="ot">&lt;-</span> <span class="fu">roc</span>(inner_test_data[[target_name]], predictions)</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>      inner_auc_vals[inner_index] <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a>      <span class="co">#cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>      pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>      confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> inner_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a>      auc <span class="ot">&lt;-</span> roc_curve<span class="sc">$</span>auc</span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>      inner_metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, inner_index, TP, TN, FP, FN, auc), <span class="fu">names</span>(inner_fold_metrics))</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a>      inner_fold_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(inner_fold_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(inner_metrics)))</span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a>    best_inner_auc <span class="ot">&lt;-</span> <span class="fu">mean</span>(inner_auc_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">#cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a>    predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(best_model, outer_test_data, <span class="at">type =</span> <span class="st">"raw"</span>)</span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>    pred_class <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(predictions <span class="sc">&gt;</span> threshold, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># Asignar clases basadas en umbral</span></span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>    confusion <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual =</span> outer_test_data[[target_name]], <span class="at">Predicted =</span> pred_class)</span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">ncol</span>(confusion) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">2</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">1</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span>, confusion[<span class="dv">1</span>, <span class="dv">2</span>], <span class="dv">0</span>)</span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(confusion) <span class="sc">&gt;=</span> <span class="dv">1</span>, confusion[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">2</span>]</span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>      TN <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>      FP <span class="ot">&lt;-</span> confusion[<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>      FN <span class="ot">&lt;-</span> confusion[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>    auc <span class="ot">&lt;-</span> <span class="fu">roc</span>(outer_test_data[[target_name]], predictions)<span class="sc">$</span>auc</span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>    metrics <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(outer_index, TP, TN, FP, FN, auc, </span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>                          best_size, best_decay, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)), </span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">names</span>(performance_metrics))</span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a>    performance_metrics <span class="ot">&lt;-</span> <span class="fu">rbind</span>(performance_metrics, <span class="fu">as.data.frame</span>(<span class="fu">t</span>(metrics)))</span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Performance:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">paste</span>(performance_metrics), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Confusion Matrix for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(confusion)</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metrics for Fold %d:</span><span class="sc">\n</span><span class="st">"</span>, outer_index))</span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Size: %d, Best Decay: %f, Best Variables: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a>                TP, TN, FP, FN, auc, best_size, best_decay, <span class="fu">paste</span>(best_vars, <span class="at">collapse =</span> <span class="st">","</span>)))</span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">performance_metrics =</span> performance_metrics, <span class="at">inner_fold_metrics =</span> inner_fold_metrics)</span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a>evaluate_with_seeds_ANN_lasso <span class="ot">&lt;-</span> </span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a>  results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (seed <span class="cf">in</span> seeds) {</span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Evaluating with seed:"</span>, seed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">evaluation_function</span>(<span class="at">data =</span> data, </span>
<span id="cb61-200"><a href="#cb61-200" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">target_name =</span> target_var, </span>
<span id="cb61-201"><a href="#cb61-201" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">threshold =</span> threshold, </span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">outer =</span> outer, </span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">inner =</span> inner, </span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">seed =</span> seed,</span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">sizes =</span> sizes,</span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">decays =</span> decays)</span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">paste0</span>(<span class="st">"seed_"</span>, seed)]] <span class="ot">&lt;-</span> results</span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results_list)</span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a>performance_ANN_lasso <span class="ot">&lt;-</span> <span class="fu">evaluate_with_seeds_ANN_lasso</span>(</span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">evaluation_function =</span> double_cross_validation_nnet_lasso,</span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_factor,</span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer =</span> <span class="dv">5</span>,</span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner =</span> <span class="dv">2</span>,</span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_var =</span> <span class="st">"PCR"</span>,</span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">sizes =</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>),</span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">decays =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>),</span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">threshold =</span> .<span class="dv">35</span>,</span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">seeds =</span> seeds</span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Código</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"RData_Files_Algorithms/ANN_Lasso.RData"</span>)</span></code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="discusión-estudio-de-los-resultados" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Discusión: Estudio de los Resultados</h1>
<section id="estabilidad-entre-folds" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="estabilidad-entre-folds"><span class="header-section-number">4.1</span> Estabilidad entre Folds</h2>
</section>
<section id="estabilidad-para-hiperparámetros" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="estabilidad-para-hiperparámetros"><span class="header-section-number">4.2</span> Estabilidad para Hiperparámetros</h2>
</section>
<section id="estabilidad-de-variables" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="estabilidad-de-variables"><span class="header-section-number">4.3</span> Estabilidad de Variables</h2>
</section>
<section id="mejor-modelo" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="mejor-modelo"><span class="header-section-number">4.4</span> “Mejor” Modelo</h2>
</section>
</section>
<section id="conclusión" class="level1" data-number="5">

<!-- -->


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">5 Conclusión</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-gonzalez2024predictive" class="csl-entry" role="listitem">
González, Mario Pascual. 2024. <span>«Modelado Predictivo: C<span>á</span>ncer de Mama»</span>. <a href="https://rpubs.com/mariopascuma/informecancermamamineria">https://rpubs.com/mariopascuma/informecancermamamineria</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copiado");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copiado");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb63" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Algoritmos de Aprendizaje Computacional"</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Mario Pascual González"</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">    theme:</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="co">      light: flatly</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="co">      dark: darkly</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: monokai  # Monokai también funciona bien en temas oscuros</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-title: "Contenidos"</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-float:</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="co">      collapsed: false</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="co">      smooth-scroll: true</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="co">    toc_scroll: true</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: </span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="co">      source: true</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: true</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="co">      caption: "Expand Code"</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a><span class="co">      </span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="co">    html-math-method: katex</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="co">    bibliography: references.bib</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a><span class="co">    lang: es</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="co">    other-links:</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="co">      - text: LinkedIn</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a><span class="co">        icon: linkedin</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="co">        href: 'https://www.linkedin.com/in/mario-pascual-gonzalez/'</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="co">      - text: Correo Electrónico</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="co">        icon: envelope</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="co">        href: "mailto:mario.pg02@gmail.com?subject=Contacto desde el informe de Modelado Predictivo"</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a><span class="co">      - text: Perfil de Github</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a><span class="co">        icon: github</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a><span class="co">        href: 'https://github.com/MarioPasc'</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a><span class="co">    code-links:</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a><span class="co">      - text: Repositorio del Informe</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a><span class="co">        icon: file-code</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a><span class="co">        href: 'https://github.com/MarioPasc/Modelado-Predictivo-Cancer-de-Mama-R'</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, echo=FALSE, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a><span class="in">#| output: false</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a><span class="in">#| echo: false</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="in">library(glmnet)</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="in">library(caret)</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a><span class="in">library(readxl)</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a><span class="in">library(readr)</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a><span class="in">library(dplyr)</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a><span class="in">library(broom)</span></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a><span class="in">library(DT)</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a><span class="in">library(reshape2)</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a><span class="in">library(MASS)</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a><span class="in">library(pROC)</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a><span class="in">library(e1071)</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a><span class="in">library(nnet)</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a><span class="in">library(rpart)</span></span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a><span class="in">library(class)</span></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a><span class="in">library(mboost)</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a><span class="in">data_original &lt;- read.csv(file = "./data/datos_limpios.csv", sep = ",", dec=".")</span></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a><span class="in">data_original["X"] &lt;- NULL</span></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a><span class="in">nuevo_orden &lt;- c("Edad", "REst", "RPro", "Her2", "Estadio", "NodAfec", "Grado", "Fenotipo", "PCR")</span></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a><span class="in">data_original &lt;- data_original[, nuevo_orden]</span></span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introducción</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Objetivos</span></span>
<span id="cb63-76"><a href="#cb63-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-77"><a href="#cb63-77" aria-hidden="true" tabindex="-1"></a>El principal objetivo de este estudio es obtener un modelo ajustado al conjunto de datos de Metástasis de Cáncer de Mama para poder realizar predicciones efectivas sobre el estado PCR de un paciente dada una serie de variables o características sobre este. Consecuentemente, nace de manera natural un segundo objetivo principal, y es el de la determinación de las características más importantes para la determinación del estado del paciente, es decir, la realización de una *selección de características*. Todo esto se realizará con la finalidad de poner un modelo en producción, el cual pueda ser usado a través de la interfaz <span class="in">`RShiny`</span> para la predicción efectiva del estado PCR de un paciente de Cáncer de Mama.</span>
<span id="cb63-78"><a href="#cb63-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-79"><a href="#cb63-79" aria-hidden="true" tabindex="-1"></a>Objetivos secundarios de este proyecto incluyen el estudio de la estabilidad en la selección de características a lo largo de los diferentes métodos y modelos aplicados. Se realizará también una exploración de la estabilidad de los hiperparámetros de un mismo modelo a lo largo de diferentes semillas aleatorias establecidas.  </span>
<span id="cb63-80"><a href="#cb63-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-81"><a href="#cb63-81" aria-hidden="true" tabindex="-1"></a>| Objetivo                                                                                                                                                    | Tipo               |</span>
<span id="cb63-82"><a href="#cb63-82" aria-hidden="true" tabindex="-1"></a>|---------------------------------------------------------------------------------|--------------------|</span>
<span id="cb63-83"><a href="#cb63-83" aria-hidden="true" tabindex="-1"></a>| Obtener un modelo ajustado al conjunto de datos de Metástasis de Cáncer de Mama | Principal          |</span>
<span id="cb63-84"><a href="#cb63-84" aria-hidden="true" tabindex="-1"></a>| Determinación de características más importantes en la predicción del estado PCR del paciente  | Principal          |</span>
<span id="cb63-85"><a href="#cb63-85" aria-hidden="true" tabindex="-1"></a>| Poner un modelo en producción, accesible a través de la interfaz <span class="in">`RShiny`</span>       | Principal          |</span>
<span id="cb63-86"><a href="#cb63-86" aria-hidden="true" tabindex="-1"></a>| Estudiar la estabilidad en las características seleccionadas                    | Secundario         |</span>
<span id="cb63-87"><a href="#cb63-87" aria-hidden="true" tabindex="-1"></a>| Explorar la estabilidad de los hiperparámetros de un mismo modelo a lo largo de diferentes semillas aleatorias establecidas.                                 | Secundario         |</span>
<span id="cb63-88"><a href="#cb63-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-89"><a href="#cb63-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-90"><a href="#cb63-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Trabajos Previos</span></span>
<span id="cb63-91"><a href="#cb63-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-92"><a href="#cb63-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-93"><a href="#cb63-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-94"><a href="#cb63-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-95"><a href="#cb63-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-96"><a href="#cb63-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-97"><a href="#cb63-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-98"><a href="#cb63-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-99"><a href="#cb63-99" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metodología</span></span>
<span id="cb63-100"><a href="#cb63-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-101"><a href="#cb63-101" aria-hidden="true" tabindex="-1"></a>A lo largo del desarrollo de este proyecto se han utilizado una serie de datos y se han seguido unas directrices ordenadas. Todo esto queda redactado en este apartado.</span>
<span id="cb63-102"><a href="#cb63-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-103"><a href="#cb63-103" aria-hidden="true" tabindex="-1"></a><span class="fu">## Material</span></span>
<span id="cb63-104"><a href="#cb63-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-105"><a href="#cb63-105" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conjunto de Datos Inicial</span></span>
<span id="cb63-106"><a href="#cb63-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-107"><a href="#cb63-107" aria-hidden="true" tabindex="-1"></a>Se nos ha proporcionado un fichero en formato *Comma-Separated Values* (<span class="in">`.csv`</span>) gracias al trabajo del Dr. José Manuel Jérez Aragonés. Las características de este dataset quedan descritas en la @fig-desccol.</span>
<span id="cb63-108"><a href="#cb63-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-109"><a href="#cb63-109" aria-hidden="true" tabindex="-1"></a><span class="al">![Variables Originales del Conjunto](Variables.png)</span>{#fig-desccol fig-align="center"}</span>
<span id="cb63-110"><a href="#cb63-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-111"><a href="#cb63-111" aria-hidden="true" tabindex="-1"></a>Se puede identificar la variable **PCR** como la variable *target* u objetivo de este estudio. Consecuentemente, se ha decidido eliminar la variable <span class="in">`Muestra`</span>, ya que no parece guardar una relevancia clínica, al ser un identificador único para cada paciente, compuesto por un código identificativo del estudio en el que fue obtenido el dato, y una serie de números únicos para cada persona.</span>
<span id="cb63-112"><a href="#cb63-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-113"><a href="#cb63-113" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-Procesamiento</span></span>
<span id="cb63-114"><a href="#cb63-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-115"><a href="#cb63-115" aria-hidden="true" tabindex="-1"></a>El conjunto de datos del que se hará uso fue curado en un estudio anterior a este, habiéndose imputado los valores faltantes (<span class="in">`NA`</span>) por la mediana o la moda, si estos provenían de una característica numérica, o de tipo factor, respectivamente <span class="co">[</span><span class="ot">@gonzalez2024predictive</span><span class="co">]</span>. </span>
<span id="cb63-116"><a href="#cb63-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-117"><a href="#cb63-117" aria-hidden="true" tabindex="-1"></a>Por otra parte, para asegurar que se tiene total control sobre los datos con los que se introducen al modelo, se han creado dos versiones del conjunto de datos. La primera se trata de una versión en la que todas las variables son de tipo factor, y la variable edad ha sido estratificada en diferentes intervalos. Por otra parte, se ha generado un conjunto de datos numérico, el cual es el conjunto de datos de tipo factor codificado mediante técnicas como *One-Hot Encoder*, o manteniendo las variables con su mismo tipo, si estas eran numéricas originalmente. Se comentan a continuación las modificaciones específicas.</span>
<span id="cb63-118"><a href="#cb63-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-119"><a href="#cb63-119" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conjunto de Datos Factor</span></span>
<span id="cb63-120"><a href="#cb63-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-121"><a href="#cb63-121" aria-hidden="true" tabindex="-1"></a>Este conjunto de datos existe para asegurar la interpretabilidad de los resultados de los modelos. La única variable que puede suponer un problema es la variable <span class="in">`Edad`</span>, ya que es una variable continua, sin embargo, este problema, como se ha comentado anteriormente, se resolverá estratificándola. La anchura de los bins se calculará siguiendo la regla de Sturges, en la que se toma el logaritmo en base 2 de la cantidad de muestras y el rango de la variable para poder computar la anchura más adecuada. </span>
<span id="cb63-122"><a href="#cb63-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-123"><a href="#cb63-123" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-124"><a href="#cb63-124" aria-hidden="true" tabindex="-1"></a>k = \frac{max(Edad) - min(Edad)}{\log_2(n) + 1}</span>
<span id="cb63-125"><a href="#cb63-125" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb63-126"><a href="#cb63-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-129"><a href="#cb63-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-130"><a href="#cb63-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir la variable 'Edad' a numérica</span></span>
<span id="cb63-131"><a href="#cb63-131" aria-hidden="true" tabindex="-1"></a>data_original<span class="sc">$</span>Edad <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(data_original<span class="sc">$</span>Edad)</span>
<span id="cb63-132"><a href="#cb63-132" aria-hidden="true" tabindex="-1"></a>data_factor <span class="ot">&lt;-</span> data_original</span>
<span id="cb63-133"><a href="#cb63-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-134"><a href="#cb63-134" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculando el número de bins con la regla de Sturges</span></span>
<span id="cb63-135"><a href="#cb63-135" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_factor)</span>
<span id="cb63-136"><a href="#cb63-136" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">log2</span>(n) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb63-137"><a href="#cb63-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-138"><a href="#cb63-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculando el rango y el tamaño de cada bin</span></span>
<span id="cb63-139"><a href="#cb63-139" aria-hidden="true" tabindex="-1"></a>minimo <span class="ot">&lt;-</span> <span class="fu">min</span>(data_factor<span class="sc">$</span>Edad)</span>
<span id="cb63-140"><a href="#cb63-140" aria-hidden="true" tabindex="-1"></a>maximo <span class="ot">&lt;-</span> <span class="fu">max</span>(data_factor<span class="sc">$</span>Edad)</span>
<span id="cb63-141"><a href="#cb63-141" aria-hidden="true" tabindex="-1"></a>ancho_bin <span class="ot">&lt;-</span> (maximo <span class="sc">-</span> minimo) <span class="sc">/</span> k</span>
<span id="cb63-142"><a href="#cb63-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-143"><a href="#cb63-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Estratificar la variable 'Edad' en grupos</span></span>
<span id="cb63-144"><a href="#cb63-144" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad_estratificada <span class="ot">&lt;-</span> <span class="fu">cut</span>(data_factor<span class="sc">$</span>Edad, </span>
<span id="cb63-145"><a href="#cb63-145" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="fu">min</span>(data_factor<span class="sc">$</span>Edad), <span class="fu">max</span>(data_factor<span class="sc">$</span>Edad), <span class="at">by =</span> ancho_bin), </span>
<span id="cb63-146"><a href="#cb63-146" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">include.lowest =</span> <span class="cn">TRUE</span>, <span class="at">right =</span> <span class="cn">FALSE</span>)</span>
<span id="cb63-147"><a href="#cb63-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-148"><a href="#cb63-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar nombres de grupo a los niveles de Edad_estratificada</span></span>
<span id="cb63-149"><a href="#cb63-149" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(data_factor<span class="sc">$</span>Edad_estratificada) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Grupo"</span>, <span class="fu">seq_along</span>(<span class="fu">levels</span>(data_factor<span class="sc">$</span>Edad_estratificada)))</span>
<span id="cb63-150"><a href="#cb63-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-151"><a href="#cb63-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Convertir todas las variables del dataframe a factor, excepto 'Edad'</span></span>
<span id="cb63-152"><a href="#cb63-152" aria-hidden="true" tabindex="-1"></a>data_factor <span class="ot">&lt;-</span> data_factor <span class="sc">%&gt;%</span></span>
<span id="cb63-153"><a href="#cb63-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="sc">-</span>Edad), as.factor)</span>
<span id="cb63-154"><a href="#cb63-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-155"><a href="#cb63-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Actualizar la variable Edad con los grupos</span></span>
<span id="cb63-156"><a href="#cb63-156" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad <span class="ot">&lt;-</span> data_factor<span class="sc">$</span>Edad_estratificada</span>
<span id="cb63-157"><a href="#cb63-157" aria-hidden="true" tabindex="-1"></a>data_factor<span class="sc">$</span>Edad_estratificada <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb63-158"><a href="#cb63-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-159"><a href="#cb63-159" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(data_factor, <span class="dv">10</span>))</span>
<span id="cb63-160"><a href="#cb63-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-161"><a href="#cb63-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-162"><a href="#cb63-162" aria-hidden="true" tabindex="-1"></a>Esta estratificación se puede justificar con el hecho de que la interpretación de las predicciones del modelo puede ser más adecuada, ya que no estaríamos hablando de un valor concreto de edad que se repite a la hora de analizar los pacientes PCR-positivos, sino que tal vez se podría identificar una tendencia en los pacientes de un determinado rango de edad a sufrir una metástasis. </span>
<span id="cb63-163"><a href="#cb63-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-164"><a href="#cb63-164" aria-hidden="true" tabindex="-1"></a>| Grupo   | Rango de Edad |</span>
<span id="cb63-165"><a href="#cb63-165" aria-hidden="true" tabindex="-1"></a>|---------|----------------|</span>
<span id="cb63-166"><a href="#cb63-166" aria-hidden="true" tabindex="-1"></a>| Grupo 1 | [24,29.1)      |</span>
<span id="cb63-167"><a href="#cb63-167" aria-hidden="true" tabindex="-1"></a>| Grupo 2 | [29.1,34.2)    |</span>
<span id="cb63-168"><a href="#cb63-168" aria-hidden="true" tabindex="-1"></a>| Grupo 3 | [34.2,39.3)    |</span>
<span id="cb63-169"><a href="#cb63-169" aria-hidden="true" tabindex="-1"></a>| Grupo 4 | [39.3,44.4)    |</span>
<span id="cb63-170"><a href="#cb63-170" aria-hidden="true" tabindex="-1"></a>| Grupo 5 | [44.4,49.5)    |</span>
<span id="cb63-171"><a href="#cb63-171" aria-hidden="true" tabindex="-1"></a>| Grupo 6 | [49.5,54.6)    |</span>
<span id="cb63-172"><a href="#cb63-172" aria-hidden="true" tabindex="-1"></a>| Grupo 7 | [54.6,59.7)    |</span>
<span id="cb63-173"><a href="#cb63-173" aria-hidden="true" tabindex="-1"></a>| Grupo 8 | [59.7,64.8)    |</span>
<span id="cb63-174"><a href="#cb63-174" aria-hidden="true" tabindex="-1"></a>| Grupo 9 | [64.8,69.9)    |</span>
<span id="cb63-175"><a href="#cb63-175" aria-hidden="true" tabindex="-1"></a>| Grupo 10| [69.9,75)      |</span>
<span id="cb63-176"><a href="#cb63-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-177"><a href="#cb63-177" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Conjunto de Datos Numérico</span></span>
<span id="cb63-178"><a href="#cb63-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-179"><a href="#cb63-179" aria-hidden="true" tabindex="-1"></a>El paradigma de este estudio engloba la búsqueda del algoritmo de aprendizaje computacional que mejor prediga el estado PCR de un paciente no visto, todo desde un punto de vista de la Ingeniería. Debido a esta falta de conocimiento clínico, se ha decidido no asumir un orden de las variables factor a la hora de encontrar su codificación numérica (por ejemplo, se ha decidido no asumir que un valor de <span class="in">`Grado: II`</span> es más importante o severo que un <span class="in">`Grado: I`</span>). Es port esto que se ha decidido usar la función <span class="in">`dummyVars`</span> para realizar una codificación *One-Hot* a las variables. Este conjunto de datos existe para poder tener siempre presente los datos numéricos que se pasan a los modelos de ML, así como para que se use en algunas implementaciones concretas, sin embargo, la regla será usar el conjunto <span class="in">`data_factor`</span> como entrada. </span>
<span id="cb63-180"><a href="#cb63-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-183"><a href="#cb63-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb63-184"><a href="#cb63-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Generación del conjunto de datos numérico</span></span>
<span id="cb63-185"><a href="#cb63-185" aria-hidden="true" tabindex="-1"></a>encode_data <span class="ot">&lt;-</span> <span class="cf">function</span>(data, target_name) {</span>
<span id="cb63-186"><a href="#cb63-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convertir variables categóricas sin orden en dummies</span></span>
<span id="cb63-187"><a href="#cb63-187" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">dummyVars</span>(<span class="sc">~</span> ., <span class="at">data =</span> data, <span class="at">fullRank =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">predict</span>(data) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb63-188"><a href="#cb63-188" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Asegurar que la variable objetivo esté al final</span></span>
<span id="cb63-189"><a href="#cb63-189" aria-hidden="true" tabindex="-1"></a>  target <span class="ot">&lt;-</span> data[[target_name]]</span>
<span id="cb63-190"><a href="#cb63-190" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb63-191"><a href="#cb63-191" aria-hidden="true" tabindex="-1"></a>  data[[target_name]] <span class="ot">&lt;-</span> target</span>
<span id="cb63-192"><a href="#cb63-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb63-193"><a href="#cb63-193" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb63-194"><a href="#cb63-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-195"><a href="#cb63-195" aria-hidden="true" tabindex="-1"></a>data_numeric <span class="ot">&lt;-</span> <span class="fu">encode_data</span>(data_original, <span class="st">"PCR"</span>)</span>
<span id="cb63-196"><a href="#cb63-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-197"><a href="#cb63-197" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(data_numeric, <span class="dv">10</span>))</span>
<span id="cb63-198"><a href="#cb63-198" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-199"><a href="#cb63-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-200"><a href="#cb63-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-201"><a href="#cb63-201" aria-hidden="true" tabindex="-1"></a><span class="fu">## Métodos</span></span>
<span id="cb63-202"><a href="#cb63-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-203"><a href="#cb63-203" aria-hidden="true" tabindex="-1"></a>Todos los objetivos de este proyecto quedarían anulados si no se sigue una metodología estricta, basada en la *estimación honesta de parámetros* y la rigurosidad para la evaluación del rendimiento de los modelos mediante la selección de una métrica que sea capaz de cuantificar la capacidad predictiva del modelo *independientemente del umbral* seleccionado para clasificar las muestras -ya que este depende de las necesidades específicas del equipo sanitario. Esta sección sirve como guía para mostrar cuál ha sido esta metodología adoptada, y así demostrar su eficacia y seguridad.</span>
<span id="cb63-204"><a href="#cb63-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-205"><a href="#cb63-205" aria-hidden="true" tabindex="-1"></a><span class="fu">### AUC y Rendimiento Aparente</span></span>
<span id="cb63-206"><a href="#cb63-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-207"><a href="#cb63-207" aria-hidden="true" tabindex="-1"></a>Para poder estimar el rendimiento cualitativo de un modelo, se necesita tanto una métrica cuantificable que refleje efectivamente su capacidad predictiva, como un valor base (*ground truth*) con el que comparar. En este estudio se ha decidido utilizar el **AUC (Area Under the Curve)**  como métrica representativa del rendimiento de un modelo, porque es una medida independiente del umbral utilizado para clasificar probabilidades calculadas por el modelo, esto es una característica decisiva, ya que, como se comentó anteriormente, el umbral podrá ser decidido por el clínico cuando el modelo sea puesto en producción, para que se ajuste a sus necesidades. Al utilizar el AUC como medida, podremos dar una estimación independiente del umbral a los clínicos, indicando que, elijan el umbral que elijan, el modelo rendirá de una manera preestablecida. </span>
<span id="cb63-208"><a href="#cb63-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-209"><a href="#cb63-209" aria-hidden="true" tabindex="-1"></a>Por otra parte, se ha apostado por tomar el rendimiento aparente del modelo como la métrica base de comparación para un mismo modelo. El rendimiento aparente se calcula mediante el entrenamiento y evaluación del modelo con todo el conjunto de datos, obteniendo una estimación optimista de la capacidad predictiva del modelo, al ser evaluado con los datos que fue entrenado. Una característica que debe quedar clara es la de que esta métrica solo servirá para comparar diferentes métodos de selección de variables, búsqueda de hiperparámetros, o ajuste fino, de un **mismo modelo**, no entre modelos. Para realizar una comparación entre modelos se hará uso de la estimación honesta de parámetros, es decir, la *doble validación cruzada 5x2*.</span>
<span id="cb63-210"><a href="#cb63-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-211"><a href="#cb63-211" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ajuste Fino: Doble Validación Cruzada 5x2</span></span>
<span id="cb63-212"><a href="#cb63-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-213"><a href="#cb63-213" aria-hidden="true" tabindex="-1"></a><span class="al">![Doble Validación Cruzada](2CV.png)</span></span>
<span id="cb63-214"><a href="#cb63-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-215"><a href="#cb63-215" aria-hidden="true" tabindex="-1"></a>El método de doble validación cruzada 5x2 es una técnica robusta para la evaluación de modelos que busca obtener una estimación honesta del rendimiento predictivo de un modelo. Este método se basa en una estructura jerárquica de validación cruzada, compuesta por dos niveles conocidos como *inner loop* y *outer loop*.</span>
<span id="cb63-216"><a href="#cb63-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-217"><a href="#cb63-217" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Outer Loop</span></span>
<span id="cb63-218"><a href="#cb63-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-219"><a href="#cb63-219" aria-hidden="true" tabindex="-1"></a>El *outer loop* se encarga de la evaluación externa del modelo y se basa en la división del conjunto de datos original en 5 pliegues. En cada iteración, uno de estos pliegues se reserva como conjunto de test, mientras que los cuatro pliegues restantes se utilizan para el entrenamiento del modelo. Este proceso se repite cinco veces, de manera que cada pliegue se utiliza una vez como conjunto de test. Es crucial destacar que en el *outer loop* no se permite ajustar parámetros ni realizar selección de variables utilizando el conjunto de test, garantizando así una evaluación imparcial y honesta del modelo.</span>
<span id="cb63-220"><a href="#cb63-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-221"><a href="#cb63-221" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Inner Loop</span></span>
<span id="cb63-222"><a href="#cb63-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-223"><a href="#cb63-223" aria-hidden="true" tabindex="-1"></a>Dentro de cada iteración del *outer loop*, se implementa el *inner loop*, cuyo objetivo es el ajuste fino de los hiperparámetros del modelo y la selección de las variables más relevantes. El *inner loop* utiliza una nueva división del conjunto de entrenamiento en pliegues adicionales. Generalmente, se opta por una validación cruzada más sencilla dentro de este bucle interno. Aquí, uno de los pliegues del conjunto de entrenamiento actúa como validación, mientras que los restantes se utilizan para el ajuste del modelo. Este proceso se repite varias veces para identificar la **combinación óptima de hiperparámetros y características que maximicen el rendimiento predictivo en el conjunto de validación**.</span>
<span id="cb63-224"><a href="#cb63-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-225"><a href="#cb63-225" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Evaluación Final</span></span>
<span id="cb63-226"><a href="#cb63-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-227"><a href="#cb63-227" aria-hidden="true" tabindex="-1"></a>Una vez completado el ajuste en el *inner loop*, se evalúa el modelo ajustado en el conjunto de test reservado en el *outer loop*. Este enfoque jerárquico asegura que el ajuste de los hiperparámetros y la selección de variables no influyan en la evaluación final del rendimiento del modelo. El rendimiento se cuantifica mediante métricas como el AUC (Área Bajo la Curva), proporcionando una estimación promedio del rendimiento del modelo a lo largo de las iteraciones del *outer loop*. Este método de doble validación cruzada 5x2 ofrece una estimación más confiable y menos optimista del rendimiento del modelo, adecuada para su implementación en escenarios clínicos donde la precisión es crucial.</span>
<span id="cb63-228"><a href="#cb63-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-229"><a href="#cb63-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-230"><a href="#cb63-230" aria-hidden="true" tabindex="-1"></a><span class="fu">### Selección de Características</span></span>
<span id="cb63-231"><a href="#cb63-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-232"><a href="#cb63-232" aria-hidden="true" tabindex="-1"></a>La selección de características es un paso fundamental en la construcción de modelos predictivos, ya que permite identificar las variables más relevantes para el problema en cuestión. Este proceso no solo mejora la *interpretabilidad del modelo*, cosa que permite a los investigadores y clínicos entender mejor qué variables están influyendo en las predicciones del modelo, sino que también reduce significativamente el tiempo computacional y el riesgo de sobreajuste, proporcionando un modelo más eficiente y robusto.</span>
<span id="cb63-233"><a href="#cb63-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-234"><a href="#cb63-234" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Metodología de Selección de Características</span></span>
<span id="cb63-235"><a href="#cb63-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-236"><a href="#cb63-236" aria-hidden="true" tabindex="-1"></a>En este estudio, se han realizado cuatro esquemas de selección de características por cada ciclo de doble validación cruzada 5x2 (2CV 5X2). Estos esquemas incluyen tanto métodos de filtrado, como métodos *wrapped*, y métodos *embedded*, proporcionando una perspectiva completa sobre las variables más relevantes.</span>
<span id="cb63-237"><a href="#cb63-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-238"><a href="#cb63-238" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Todas las Variables del Conjunto**: En este enfoque, se entrena el modelo utilizando todas las variables disponibles en el conjunto de datos, sin realizar ningún tipo de selección previa. Esto sirve como una línea base para comparar la efectividad de los métodos de selección de características.</span>
<span id="cb63-239"><a href="#cb63-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-240"><a href="#cb63-240" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Métodos de Filtrado: Análisis de Asociación**: Este método de filtrado se basa en el análisis de asociación, donde se evalúa la relación individual de cada variable con la variable objetivo. Se seleccionan aquellas variables que muestran una fuerte asociación, lo que permite reducir el conjunto de características antes del entrenamiento del modelo.</span>
<span id="cb63-241"><a href="#cb63-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-242"><a href="#cb63-242" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Métodos Wrapped: StepAUC Backwards**: En este método, se comienza con todas las variables incluidas en el modelo. Durante el proceso de entrenamiento en el *inner loop*, se prueban eliminando variables una por una. Si la eliminación de una variable mejora el AUC (Área Bajo la Curva), la variable se elimina permanentemente del conjunto. Este proceso se repite hasta que la eliminación de más variables no resulta en una mejora del AUC, determinando así el conjunto final de características seleccionadas.</span>
<span id="cb63-243"><a href="#cb63-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-244"><a href="#cb63-244" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Métodos de Embedded: Modelo Lasso**: El modelo Lasso es un método de regularización que no solo ajusta el modelo, sino que también selecciona automáticamente las variables más importantes. Durante el *inner loop*, se ajusta un modelo Lasso y se seleccionan las variables con coeficientes diferentes de cero. </span>
<span id="cb63-245"><a href="#cb63-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-246"><a href="#cb63-246" aria-hidden="true" tabindex="-1"></a><span class="fu">### Modelos Aplicados</span></span>
<span id="cb63-247"><a href="#cb63-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-248"><a href="#cb63-248" aria-hidden="true" tabindex="-1"></a>Con el objetivo de conseguir un modelo ajustado para la predicción efectiva del estado PCR de un paciente en mente, se han seleccionado una serie de algoritmos de Aprendizaje Máquina (*Machine Learning*, ML) con varios parámetros de customización. Estos modelos se eligen por su capacidad de manejar diferentes tipos de datos y su rendimiento en tareas de clasificación, proporcionando así una evaluación completa y robusta para el problema en cuestión.</span>
<span id="cb63-249"><a href="#cb63-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-250"><a href="#cb63-250" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Naive Bayes</span></span>
<span id="cb63-251"><a href="#cb63-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-252"><a href="#cb63-252" aria-hidden="true" tabindex="-1"></a>Naive Bayes es un clasificador probabilístico basado en el teorema de Bayes, asumiendo una independencia condicional entre las características dadas la clase. En este estudio, se ha utilizado la implementación proporcionada en el paquete <span class="in">`e1071`</span>. Formalmente, el clasificador Naive Bayes asigna una clase $C_k$ a una instancia $x = (x_1, x_2, \ldots, x_n)$ maximizando la probabilidad posterior $P(C_k|x)$, que se calcula como:</span>
<span id="cb63-253"><a href="#cb63-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-254"><a href="#cb63-254" aria-hidden="true" tabindex="-1"></a>$$ P(C_k|x) = \frac{P(C_k) \cdot P(x|C_k)}{P(x)}$$</span>
<span id="cb63-255"><a href="#cb63-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-256"><a href="#cb63-256" aria-hidden="true" tabindex="-1"></a>Dado que $P(x)$ es constante para todas las clases, se simplifica a:</span>
<span id="cb63-257"><a href="#cb63-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-258"><a href="#cb63-258" aria-hidden="true" tabindex="-1"></a>$$ P(C_k|x) \propto P(C_k) \prod_{i=1}^{n} P(x_i|C_k) $$</span>
<span id="cb63-259"><a href="#cb63-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-260"><a href="#cb63-260" aria-hidden="true" tabindex="-1"></a>En resumen, el clasificador Naive Bayes es una opción eficiente y efectiva para problemas de clasificación, sin embargo, al **asumir la independencia de las probabilidades condicionales**, puede no dar resultados muy buenos, sin embargo, proporcionará una base sólida para predicciones iniciales, así como una base para la comparación entre modelos.</span>
<span id="cb63-261"><a href="#cb63-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-262"><a href="#cb63-262" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Adaboost</span></span>
<span id="cb63-263"><a href="#cb63-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-264"><a href="#cb63-264" aria-hidden="true" tabindex="-1"></a>Adaboost, o Adaptive Boosting, es un algoritmo de aprendizaje automático que combina múltiples clasificadores débiles para crear un clasificador fuerte. En este estudio, se ha utilizado el paquete <span class="in">`mboost`</span> de R con la configuración <span class="in">`family=Binomial()`</span>, adaptado para tareas de clasificación binaria. Adaboost trabaja iterativamente, ajustando los pesos de las muestras de entrenamiento para concentrarse en aquellas que fueron clasificadas incorrectamente en iteraciones anteriores.</span>
<span id="cb63-265"><a href="#cb63-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-266"><a href="#cb63-266" aria-hidden="true" tabindex="-1"></a>De esta forma, Adaboost asigna pesos a cada muestra y ajusta un clasificador débil $h_t(x)$ en cada iteración $t$. La salida final del clasificador se obtiene mediante una combinación ponderada de estos clasificadores débiles:</span>
<span id="cb63-267"><a href="#cb63-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-268"><a href="#cb63-268" aria-hidden="true" tabindex="-1"></a>$$ H(x) = \text{sign}\left( \sum_{t=1}^{T} \alpha_t h_t(x) \right) $$</span>
<span id="cb63-269"><a href="#cb63-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-270"><a href="#cb63-270" aria-hidden="true" tabindex="-1"></a>donde $\alpha_t$ es el peso asignado al clasificador $h_t(x)$ basado en su precisión. En cada iteración, el peso de las muestras mal clasificadas se incrementa, enfocando así el entrenamiento subsecuente en estas muestras.</span>
<span id="cb63-271"><a href="#cb63-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-272"><a href="#cb63-272" aria-hidden="true" tabindex="-1"></a>El principal hiperparámetro ajustado en este estudio ha sido el número de iteraciones $T$. Este parámetro determina cuántos clasificadores débiles se combinarán para formar el clasificador final. Aumentar el número de iteraciones puede mejorar la capacidad del modelo para corregir errores y, por ende, afinar la frontera de decisión, pero también aumenta el riesgo de sobreajuste si el modelo se vuelve demasiado complejo.</span>
<span id="cb63-273"><a href="#cb63-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-274"><a href="#cb63-274" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Random Forest </span></span>
<span id="cb63-275"><a href="#cb63-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-276"><a href="#cb63-276" aria-hidden="true" tabindex="-1"></a>Random Forest opera creando una colección de árboles de decisión, cada uno entrenado con un subconjunto aleatorio del conjunto de datos y un subconjunto aleatorio de características. Este enfoque introduce dos tipos de aleatoriedad: aleatoriedad en las muestras y aleatoriedad en las características, lo que ayuda a reducir la varianza del modelo y mitigar el sobreajuste. En el contexto de este estudio, se ha hecho uso del paquete <span class="in">`rpart`</span> de R.</span>
<span id="cb63-277"><a href="#cb63-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-278"><a href="#cb63-278" aria-hidden="true" tabindex="-1"></a>Los principales hiperparámetros ajustados en este estudio han sido <span class="in">`cp_values`</span> y <span class="in">`minsplit_values`</span>. </span>
<span id="cb63-279"><a href="#cb63-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-280"><a href="#cb63-280" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`cp_values` (complexity parameter)**: Este parámetro controla la poda de los árboles de decisión individuales. Un valor más alto de <span class="in">`cp`</span> conduce a una mayor poda, reduciendo la complejidad del árbol y ayudando a prevenir el sobreajuste. Ajustar este parámetro afecta la profundidad de los árboles individuales y, por ende, la precisión del modelo. Una selección óptima de <span class="in">`cp_values`</span> es crucial para equilibrar el sesgo y la varianza del modelo.</span>
<span id="cb63-281"><a href="#cb63-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-282"><a href="#cb63-282" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**`minsplit_values`**: Este parámetro define el número mínimo de observaciones que debe tener un nodo para ser considerado para una división. Valores más altos de <span class="in">`minsplit`</span> resultan en árboles más pequeños y menos complejos, mientras que valores más bajos permiten la creación de árboles más detallados. Ajustar <span class="in">`minsplit_values`</span> permite controlar la granularidad con la que el modelo puede capturar las relaciones en los datos. Un valor adecuado de <span class="in">`minsplit`</span> asegura que el modelo sea lo suficientemente flexible para capturar patrones relevantes sin sobreajustarse a ruido específico del conjunto de entrenamiento.</span>
<span id="cb63-283"><a href="#cb63-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-284"><a href="#cb63-284" aria-hidden="true" tabindex="-1"></a><span class="fu">#### K-Nearest Neighbours</span></span>
<span id="cb63-285"><a href="#cb63-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-286"><a href="#cb63-286" aria-hidden="true" tabindex="-1"></a>K-Nearest Neighbours (KNN) clasifica una muestra basada en las clases de sus $k$ vecinos más cercanos en el espacio de características. En este estudio, se ha utilizado el paquete <span class="in">`class`</span> de R para implementar KNN, ajustando los parámetros $k$ y $l$ para optimizar la precisión del modelo en la predicción del estado PCR de los pacientes.</span>
<span id="cb63-287"><a href="#cb63-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-288"><a href="#cb63-288" aria-hidden="true" tabindex="-1"></a>KNN clasifica una muestra $x$ basándose en la mayoría de las clases de sus $k$ vecinos más cercanos, identificados utilizando una métrica de distancia. La distancia entre las muestras se calcula comúnmente usando la distancia euclidiana, pero se puede generalizar utilizando la distancia de Minkowski, definida como:</span>
<span id="cb63-289"><a href="#cb63-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-290"><a href="#cb63-290" aria-hidden="true" tabindex="-1"></a>$$ d(x_i, x_j) = \left( \sum_{m=1}^{M} |x_{im} - x_{jm}|^l \right)^{1/l} $$</span>
<span id="cb63-291"><a href="#cb63-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-292"><a href="#cb63-292" aria-hidden="true" tabindex="-1"></a>donde $l$ es el parámetro de distancia de Minkowski. Cuando $l = 2$, se corresponde con la distancia euclidiana, y cuando $l = 1$, se convierte en la distancia de Manhattan.</span>
<span id="cb63-293"><a href="#cb63-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-294"><a href="#cb63-294" aria-hidden="true" tabindex="-1"></a>Los principales hiperparámetros ajustados en este estudio son:</span>
<span id="cb63-295"><a href="#cb63-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-296"><a href="#cb63-296" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$k$ (número de vecinos más cercanos)**: Este parámetro define el número de vecinos que se considerarán para determinar la clase de una nueva muestra. Valores pequeños de $k$ hacen que el modelo sea más sensible al ruido en los datos, mientras que valores grandes pueden hacer que el modelo sea demasiado general y pierda precisión en detalles locales. </span>
<span id="cb63-297"><a href="#cb63-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-298"><a href="#cb63-298" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$l$ (parámetro de distancia de Minkowski)**: Este parámetro ajusta la métrica de distancia utilizada para identificar los vecinos más cercanos. Aunque el valor predeterminado es $l = 2$ (distancia euclidiana), ajustar $l$ permite al modelo adaptarse mejor a la geometría del espacio de características. Por ejemplo, un $l$ menor puede capturar mejor las relaciones lineales, mientras que un $l$ mayor puede ser más adecuado para relaciones más complejas y no lineales.</span>
<span id="cb63-299"><a href="#cb63-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-300"><a href="#cb63-300" aria-hidden="true" tabindex="-1"></a>Además, el parámetro <span class="in">`probes = TRUE`</span> se utiliza para devolver las probabilidades de las clases predichas, proporcionando una medida de confianza en las predicciones del modelo.</span>
<span id="cb63-301"><a href="#cb63-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-302"><a href="#cb63-302" aria-hidden="true" tabindex="-1"></a>En resumen, KNN es un algoritmo intuitivo y efectivo para la clasificación, especialmente adecuado para conjuntos de datos donde la estructura local de las muestras es crucial para la precisión de las predicciones. Ajustar los parámetros $k$ y $l$ permite optimizar el modelo para capturar las relaciones subyacentes en los datos, asegurando predicciones precisas y confiables del estado PCR de los pacientes. </span>
<span id="cb63-303"><a href="#cb63-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-304"><a href="#cb63-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-305"><a href="#cb63-305" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Support Vector Machine</span></span>
<span id="cb63-306"><a href="#cb63-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-307"><a href="#cb63-307" aria-hidden="true" tabindex="-1"></a>La Máquina de Vectores de Soporte, o, Support Vector Machine (SVM) es una técnica de clasificación que busca encontrar el hiperplano que mejor separa las clases en el espacio de características. En este estudio, se ha utilizado el paquete <span class="in">`e1071`</span> de R para implementar SVM, ajustando los parámetros del kernel y el coste (C) para optimizar la precisión del modelo en la predicción del estado PCR de los pacientes.</span>
<span id="cb63-308"><a href="#cb63-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-309"><a href="#cb63-309" aria-hidden="true" tabindex="-1"></a>SVM funciona proyectando los datos a un espacio de mayor dimensión donde se puede encontrar un hiperplano que maximiza el margen de separación entre las clases. El hiperplano se define por:</span>
<span id="cb63-310"><a href="#cb63-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-311"><a href="#cb63-311" aria-hidden="true" tabindex="-1"></a>$$ \mathbf{w} \cdot \mathbf{x} + b = 0 $$</span>
<span id="cb63-312"><a href="#cb63-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-313"><a href="#cb63-313" aria-hidden="true" tabindex="-1"></a>donde $\mathbf{w}$ es el vector de pesos y $b$ es el sesgo. El objetivo es encontrar $\mathbf{w}$ y $b$ que maximicen el margen, sujetando a las restricciones de clasificación correcta de las muestras. Formalmente, los principales hiperparámetros ajustados en este estudio han sido:</span>
<span id="cb63-314"><a href="#cb63-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-315"><a href="#cb63-315" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Kernel**: Este parámetro define la función de transformación que se utiliza para proyectar los datos en un espacio de mayor dimensión. Los kernels disponibles incluyen:</span>
<span id="cb63-316"><a href="#cb63-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-317"><a href="#cb63-317" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Lineal**: $ K(\mathbf{x_i}, \mathbf{x_j}) = \mathbf{x_i} \cdot \mathbf{x_j} $</span>
<span id="cb63-318"><a href="#cb63-318" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Sigmoid**: $ K(\mathbf{x_i}, \mathbf{x_j}) = \tanh(\alpha \mathbf{x_i} \cdot \mathbf{x_j} + r) $</span>
<span id="cb63-319"><a href="#cb63-319" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Polinomial**: $ K(\mathbf{x_i}, \mathbf{x_j}) = (\alpha \mathbf{x_i} \cdot \mathbf{x_j} + r)^d $</span>
<span id="cb63-320"><a href="#cb63-320" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**RBF (Radial Basis Function)**: $ K(\mathbf{x_i}, \mathbf{x_j}) = \exp(-\gamma ||\mathbf{x_i} - \mathbf{x_j}||^2) $</span>
<span id="cb63-321"><a href="#cb63-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-322"><a href="#cb63-322" aria-hidden="true" tabindex="-1"></a>  La elección del kernel afecta directamente la capacidad del SVM para capturar relaciones no lineales en los datos. Por ejemplo, un kernel lineal es adecuado para datos linealmente separables, mientras que un kernel RBF es más flexible y puede modelar relaciones complejas.</span>
<span id="cb63-323"><a href="#cb63-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-324"><a href="#cb63-324" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Coste (C)**: Este parámetro controla el margen de tolerancia a errores en la clasificación. Un valor alto de $C$ da como resultado un margen más estrecho y menos tolerancia a errores de clasificación, lo que puede llevar a un modelo que sobreajuste los datos de entrenamiento. Por otro lado, un valor bajo de $C$ permite un margen más amplio y más errores de clasificación, lo que puede resultar en un modelo más general. </span>
<span id="cb63-325"><a href="#cb63-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-326"><a href="#cb63-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-327"><a href="#cb63-327" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Artificial Neural Networks</span></span>
<span id="cb63-328"><a href="#cb63-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-329"><a href="#cb63-329" aria-hidden="true" tabindex="-1"></a>Las Redes Neuronales Artificiales (ANN) son modelos de aprendizaje automático inspirados en la estructura y funcionamiento del cerebro humano. En este estudio, se ha utilizado la función <span class="in">`nnet`</span> del paquete <span class="in">`nnet`</span> de R para implementar un modelo de red neuronal artificial, optimizando los parámetros <span class="in">`size`</span> y <span class="in">`decay`</span> para mejorar la precisión en la predicción del estado PCR de los pacientes.</span>
<span id="cb63-330"><a href="#cb63-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-331"><a href="#cb63-331" aria-hidden="true" tabindex="-1"></a>Las redes neuronales consisten en una capa de entrada, una o más capas ocultas, y una capa de salida. Cada neurona en estas capas realiza una operación lineal seguida de una función de activación no lineal. En este estudio, la arquitectura del modelo se definirá principalmente por el número de neuronas en la capa oculta (<span class="in">`size`</span>) y el método de regularización (<span class="in">`weight-decay`</span>).</span>
<span id="cb63-332"><a href="#cb63-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-333"><a href="#cb63-333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tamaño de la Capa Oculta (`size`)**: Este parámetro especifica el número de neuronas en la capa oculta de la red neuronal. Un mayor número de neuronas (<span class="in">`size`</span>) puede capturar patrones más complejos en los datos, pero también aumenta el riesgo de sobreajuste si el modelo se vuelve demasiado complejo. </span>
<span id="cb63-334"><a href="#cb63-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-335"><a href="#cb63-335" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Parámetro de Regularización (`decay`)**: El parámetro <span class="in">`weight-decay`</span> controla la magnitud de la penalización aplicada a los pesos del modelo durante el entrenamiento para prevenir el sobreajuste. Este método de regularización agrega un término a la función de pérdida que penaliza grandes valores de los pesos, manteniendo los pesos más pequeños y el modelo más sencillo. Ajustar el <span class="in">`decay`</span> afecta la capacidad del modelo para generalizar, ya que valores muy altos pueden resultar en un modelo subajustado, mientras que valores muy bajos pueden no ser suficientes para evitar el sobreajuste.</span>
<span id="cb63-336"><a href="#cb63-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-337"><a href="#cb63-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-338"><a href="#cb63-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-339"><a href="#cb63-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-340"><a href="#cb63-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-341"><a href="#cb63-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-342"><a href="#cb63-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-343"><a href="#cb63-343" aria-hidden="true" tabindex="-1"></a><span class="fu"># Resultados</span></span>
<span id="cb63-344"><a href="#cb63-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-345"><a href="#cb63-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Naive Bayes</span></span>
<span id="cb63-346"><a href="#cb63-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-347"><a href="#cb63-347" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-348"><a href="#cb63-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-349"><a href="#cb63-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-350"><a href="#cb63-350" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_naiveBayes &lt;- function(data, target_var, model_func, vars = NULL, threshold, seed) {</span></span>
<span id="cb63-351"><a href="#cb63-351" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-352"><a href="#cb63-352" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-353"><a href="#cb63-353" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-354"><a href="#cb63-354" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed = seed)</span></span>
<span id="cb63-355"><a href="#cb63-355" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-356"><a href="#cb63-356" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-357"><a href="#cb63-357" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-358"><a href="#cb63-358" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data)</span></span>
<span id="cb63-359"><a href="#cb63-359" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- predict(model, newdata = data, type = "raw")[, 2]</span></span>
<span id="cb63-360"><a href="#cb63-360" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-361"><a href="#cb63-361" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-362"><a href="#cb63-362" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-363"><a href="#cb63-363" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(predicted_classes, actual_classes)</span></span>
<span id="cb63-364"><a href="#cb63-364" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-365"><a href="#cb63-365" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-366"><a href="#cb63-366" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-367"><a href="#cb63-367" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-368"><a href="#cb63-368" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-369"><a href="#cb63-369" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-370"><a href="#cb63-370" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-371"><a href="#cb63-371" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-372"><a href="#cb63-372" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-373"><a href="#cb63-373" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-374"><a href="#cb63-374" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-375"><a href="#cb63-375" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-376"><a href="#cb63-376" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-377"><a href="#cb63-377" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-378"><a href="#cb63-378" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-379"><a href="#cb63-379" aria-hidden="true" tabindex="-1"></a><span class="in">naiveBayes_model &lt;- function(formula, data) {</span></span>
<span id="cb63-380"><a href="#cb63-380" aria-hidden="true" tabindex="-1"></a><span class="in">  naiveBayes(formula = formula, data = data)</span></span>
<span id="cb63-381"><a href="#cb63-381" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-382"><a href="#cb63-382" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesNaiveBayes &lt;- evaluate_aparent_performance_model_naiveBayes(data = data_factor, </span></span>
<span id="cb63-383"><a href="#cb63-383" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                               target_var = "PCR",</span></span>
<span id="cb63-384"><a href="#cb63-384" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                              model_func = naiveBayes_model,</span></span>
<span id="cb63-385"><a href="#cb63-385" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                              vars = ".",</span></span>
<span id="cb63-386"><a href="#cb63-386" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                              threshold = .35,</span></span>
<span id="cb63-387"><a href="#cb63-387" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                              seed = 90)</span></span>
<span id="cb63-388"><a href="#cb63-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-389"><a href="#cb63-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-390"><a href="#cb63-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-391"><a href="#cb63-391" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/NaiveBayes_Aparente.RData")</span></span>
<span id="cb63-392"><a href="#cb63-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-393"><a href="#cb63-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-394"><a href="#cb63-394" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-395"><a href="#cb63-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-396"><a href="#cb63-396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-397"><a href="#cb63-397" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_naiveBayes &lt;- function(data, target_name, outer, inner, variables, threshold, seed) {</span></span>
<span id="cb63-398"><a href="#cb63-398" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-399"><a href="#cb63-399" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-400"><a href="#cb63-400" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-401"><a href="#cb63-401" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-402"><a href="#cb63-402" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-403"><a href="#cb63-403" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-404"><a href="#cb63-404" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-405"><a href="#cb63-405" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-406"><a href="#cb63-406" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-407"><a href="#cb63-407" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-408"><a href="#cb63-408" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-409"><a href="#cb63-409" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-410"><a href="#cb63-410" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-411"><a href="#cb63-411" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-412"><a href="#cb63-412" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-413"><a href="#cb63-413" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-414"><a href="#cb63-414" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-415"><a href="#cb63-415" aria-hidden="true" tabindex="-1"></a><span class="in">    if (sum(outer_train_data[[target_name]] == "0") == 0 || sum(outer_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-416"><a href="#cb63-416" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Skipping outer fold due to lack of class diversity\n")</span></span>
<span id="cb63-417"><a href="#cb63-417" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-418"><a href="#cb63-418" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-419"><a href="#cb63-419" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-420"><a href="#cb63-420" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-421"><a href="#cb63-421" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-422"><a href="#cb63-422" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-423"><a href="#cb63-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-424"><a href="#cb63-424" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- reformulate(variables, target_name)</span></span>
<span id="cb63-425"><a href="#cb63-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-426"><a href="#cb63-426" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-427"><a href="#cb63-427" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-428"><a href="#cb63-428" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-429"><a href="#cb63-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-430"><a href="#cb63-430" aria-hidden="true" tabindex="-1"></a><span class="in">      if (sum(inner_train_data[[target_name]] == "0") == 0 || sum(inner_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-431"><a href="#cb63-431" aria-hidden="true" tabindex="-1"></a><span class="in">        cat("Skipping inner fold due to lack of class diversity\n")</span></span>
<span id="cb63-432"><a href="#cb63-432" aria-hidden="true" tabindex="-1"></a><span class="in">        next</span></span>
<span id="cb63-433"><a href="#cb63-433" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-434"><a href="#cb63-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-435"><a href="#cb63-435" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-436"><a href="#cb63-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-437"><a href="#cb63-437" aria-hidden="true" tabindex="-1"></a><span class="in">      result &lt;- tryCatch({</span></span>
<span id="cb63-438"><a href="#cb63-438" aria-hidden="true" tabindex="-1"></a><span class="in">        model &lt;- naiveBayes(formula, data = inner_train_data)</span></span>
<span id="cb63-439"><a href="#cb63-439" aria-hidden="true" tabindex="-1"></a><span class="in">        predictions &lt;- predict(model, inner_test_data, type = "raw")[, 2]</span></span>
<span id="cb63-440"><a href="#cb63-440" aria-hidden="true" tabindex="-1"></a><span class="in">        roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-441"><a href="#cb63-441" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-442"><a href="#cb63-442" aria-hidden="true" tabindex="-1"></a><span class="in">      }, error = function(e) {</span></span>
<span id="cb63-443"><a href="#cb63-443" aria-hidden="true" tabindex="-1"></a><span class="in">        cat("Error in inner fold ", inner_index, "\n")</span></span>
<span id="cb63-444"><a href="#cb63-444" aria-hidden="true" tabindex="-1"></a><span class="in">        cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-445"><a href="#cb63-445" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_auc[inner_index] &lt;- 0</span></span>
<span id="cb63-446"><a href="#cb63-446" aria-hidden="true" tabindex="-1"></a><span class="in">      })</span></span>
<span id="cb63-447"><a href="#cb63-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-448"><a href="#cb63-448" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc, na.rm = TRUE) &gt; best_auc) {</span></span>
<span id="cb63-449"><a href="#cb63-449" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-450"><a href="#cb63-450" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model &lt;- model</span></span>
<span id="cb63-451"><a href="#cb63-451" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-452"><a href="#cb63-452" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-453"><a href="#cb63-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-454"><a href="#cb63-454" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-455"><a href="#cb63-455" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-456"><a href="#cb63-456" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-457"><a href="#cb63-457" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-458"><a href="#cb63-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-459"><a href="#cb63-459" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")[, 2]</span></span>
<span id="cb63-460"><a href="#cb63-460" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-461"><a href="#cb63-461" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-462"><a href="#cb63-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-463"><a href="#cb63-463" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-464"><a href="#cb63-464" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-465"><a href="#cb63-465" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-466"><a href="#cb63-466" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-467"><a href="#cb63-467" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-468"><a href="#cb63-468" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-469"><a href="#cb63-469" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-470"><a href="#cb63-470" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-471"><a href="#cb63-471" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-472"><a href="#cb63-472" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-473"><a href="#cb63-473" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-474"><a href="#cb63-474" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-475"><a href="#cb63-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-476"><a href="#cb63-476" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc), names(performance_metrics))</span></span>
<span id="cb63-477"><a href="#cb63-477" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-478"><a href="#cb63-478" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-479"><a href="#cb63-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-480"><a href="#cb63-480" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-481"><a href="#cb63-481" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-482"><a href="#cb63-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-483"><a href="#cb63-483" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_NaiveBayes_Asociacion_Todas &lt;- </span></span>
<span id="cb63-484"><a href="#cb63-484" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span></span>
<span id="cb63-485"><a href="#cb63-485" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-486"><a href="#cb63-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-487"><a href="#cb63-487" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-488"><a href="#cb63-488" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-489"><a href="#cb63-489" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-490"><a href="#cb63-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-491"><a href="#cb63-491" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-492"><a href="#cb63-492" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-493"><a href="#cb63-493" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-494"><a href="#cb63-494" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-495"><a href="#cb63-495" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-496"><a href="#cb63-496" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-497"><a href="#cb63-497" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed)</span></span>
<span id="cb63-498"><a href="#cb63-498" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-499"><a href="#cb63-499" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-500"><a href="#cb63-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-501"><a href="#cb63-501" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-502"><a href="#cb63-502" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-503"><a href="#cb63-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-504"><a href="#cb63-504" aria-hidden="true" tabindex="-1"></a><span class="in">performance_naiveBayes_todasVariables &lt;- evaluate_with_seeds_NaiveBayes_Asociacion_Todas(</span></span>
<span id="cb63-505"><a href="#cb63-505" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_naiveBayes,</span></span>
<span id="cb63-506"><a href="#cb63-506" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-507"><a href="#cb63-507" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-508"><a href="#cb63-508" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-509"><a href="#cb63-509" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-510"><a href="#cb63-510" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-511"><a href="#cb63-511" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-512"><a href="#cb63-512" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds)</span></span>
<span id="cb63-513"><a href="#cb63-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-514"><a href="#cb63-514" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-515"><a href="#cb63-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-516"><a href="#cb63-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-517"><a href="#cb63-517" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/NaiveBayes_TodasVariables.RData")</span></span>
<span id="cb63-518"><a href="#cb63-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-519"><a href="#cb63-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-520"><a href="#cb63-520" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-521"><a href="#cb63-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-522"><a href="#cb63-522" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-523"><a href="#cb63-523" aria-hidden="true" tabindex="-1"></a><span class="in">performance_naiveBayes_Asociacion &lt;- evaluate_with_seeds_NaiveBayes_Asociacion_Todas(</span></span>
<span id="cb63-524"><a href="#cb63-524" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_naiveBayes,</span></span>
<span id="cb63-525"><a href="#cb63-525" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-526"><a href="#cb63-526" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-527"><a href="#cb63-527" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-528"><a href="#cb63-528" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-529"><a href="#cb63-529" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-530"><a href="#cb63-530" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-531"><a href="#cb63-531" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds)</span></span>
<span id="cb63-532"><a href="#cb63-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-533"><a href="#cb63-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-534"><a href="#cb63-534" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-535"><a href="#cb63-535" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/NaiveBayes_Asociacion.RData")</span></span>
<span id="cb63-536"><a href="#cb63-536" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-537"><a href="#cb63-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-538"><a href="#cb63-538" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-539"><a href="#cb63-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-540"><a href="#cb63-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-541"><a href="#cb63-541" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_naiveBayes_stepAUC &lt;- function(data, target_name, outer, inner, variables, threshold, seed) {</span></span>
<span id="cb63-542"><a href="#cb63-542" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-543"><a href="#cb63-543" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-544"><a href="#cb63-544" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-545"><a href="#cb63-545" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-546"><a href="#cb63-546" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-547"><a href="#cb63-547" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-548"><a href="#cb63-548" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-549"><a href="#cb63-549" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-550"><a href="#cb63-550" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-551"><a href="#cb63-551" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-552"><a href="#cb63-552" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-553"><a href="#cb63-553" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-554"><a href="#cb63-554" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-555"><a href="#cb63-555" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-556"><a href="#cb63-556" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-557"><a href="#cb63-557" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-558"><a href="#cb63-558" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-559"><a href="#cb63-559" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-560"><a href="#cb63-560" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-561"><a href="#cb63-561" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-562"><a href="#cb63-562" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-563"><a href="#cb63-563" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-564"><a href="#cb63-564" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-565"><a href="#cb63-565" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-566"><a href="#cb63-566" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-567"><a href="#cb63-567" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-568"><a href="#cb63-568" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-569"><a href="#cb63-569" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, outer_train_data, target_name, inner_folds) {</span></span>
<span id="cb63-570"><a href="#cb63-570" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-571"><a href="#cb63-571" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-572"><a href="#cb63-572" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-573"><a href="#cb63-573" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-574"><a href="#cb63-574" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-575"><a href="#cb63-575" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-576"><a href="#cb63-576" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-577"><a href="#cb63-577" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-578"><a href="#cb63-578" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-579"><a href="#cb63-579" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-580"><a href="#cb63-580" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-581"><a href="#cb63-581" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-582"><a href="#cb63-582" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-583"><a href="#cb63-583" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-584"><a href="#cb63-584" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-585"><a href="#cb63-585" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-586"><a href="#cb63-586" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-587"><a href="#cb63-587" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-588"><a href="#cb63-588" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-589"><a href="#cb63-589" aria-hidden="true" tabindex="-1"></a><span class="in">              model &lt;- naiveBayes(as.formula(paste(target_name, "~", paste(temp_vars, collapse = "+"))),</span></span>
<span id="cb63-590"><a href="#cb63-590" aria-hidden="true" tabindex="-1"></a><span class="in">                                  data = inner_train_data)</span></span>
<span id="cb63-591"><a href="#cb63-591" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-592"><a href="#cb63-592" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- predict(model, newdata = inner_test_data, type = "raw")[, 2]</span></span>
<span id="cb63-593"><a href="#cb63-593" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-594"><a href="#cb63-594" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-595"><a href="#cb63-595" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-596"><a href="#cb63-596" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-597"><a href="#cb63-597" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-598"><a href="#cb63-598" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_auc[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-599"><a href="#cb63-599" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-600"><a href="#cb63-600" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-601"><a href="#cb63-601" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-602"><a href="#cb63-602" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_inner_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-603"><a href="#cb63-603" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_inner_auc) &amp;&amp; mean_inner_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-604"><a href="#cb63-604" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_inner_auc</span></span>
<span id="cb63-605"><a href="#cb63-605" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- model</span></span>
<span id="cb63-606"><a href="#cb63-606" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-607"><a href="#cb63-607" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-608"><a href="#cb63-608" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-609"><a href="#cb63-609" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-610"><a href="#cb63-610" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-611"><a href="#cb63-611" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-612"><a href="#cb63-612" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-613"><a href="#cb63-613" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-614"><a href="#cb63-614" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-615"><a href="#cb63-615" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-616"><a href="#cb63-616" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-617"><a href="#cb63-617" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-618"><a href="#cb63-618" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-619"><a href="#cb63-619" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, vars = best_inner_vars)</span></span>
<span id="cb63-620"><a href="#cb63-620" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-621"><a href="#cb63-621" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-622"><a href="#cb63-622" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, inner_folds)</span></span>
<span id="cb63-623"><a href="#cb63-623" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-624"><a href="#cb63-624" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-625"><a href="#cb63-625" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-626"><a href="#cb63-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-627"><a href="#cb63-627" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-628"><a href="#cb63-628" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-629"><a href="#cb63-629" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-630"><a href="#cb63-630" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-631"><a href="#cb63-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-632"><a href="#cb63-632" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-633"><a href="#cb63-633" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-634"><a href="#cb63-634" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-635"><a href="#cb63-635" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-636"><a href="#cb63-636" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-637"><a href="#cb63-637" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-638"><a href="#cb63-638" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, newdata = inner_test_data, type = "raw")[, 2]</span></span>
<span id="cb63-639"><a href="#cb63-639" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-640"><a href="#cb63-640" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-641"><a href="#cb63-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-642"><a href="#cb63-642" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-643"><a href="#cb63-643" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-644"><a href="#cb63-644" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-645"><a href="#cb63-645" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-646"><a href="#cb63-646" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-647"><a href="#cb63-647" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-648"><a href="#cb63-648" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-649"><a href="#cb63-649" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-650"><a href="#cb63-650" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-651"><a href="#cb63-651" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-652"><a href="#cb63-652" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-653"><a href="#cb63-653" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-654"><a href="#cb63-654" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-655"><a href="#cb63-655" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-656"><a href="#cb63-656" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")[, 2]</span></span>
<span id="cb63-657"><a href="#cb63-657" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-658"><a href="#cb63-658" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-659"><a href="#cb63-659" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-660"><a href="#cb63-660" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-661"><a href="#cb63-661" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-662"><a href="#cb63-662" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-663"><a href="#cb63-663" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-664"><a href="#cb63-664" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-665"><a href="#cb63-665" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-666"><a href="#cb63-666" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-667"><a href="#cb63-667" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-668"><a href="#cb63-668" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-669"><a href="#cb63-669" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-670"><a href="#cb63-670" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-671"><a href="#cb63-671" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-672"><a href="#cb63-672" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-673"><a href="#cb63-673" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-674"><a href="#cb63-674" aria-hidden="true" tabindex="-1"></a><span class="in">                          paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-675"><a href="#cb63-675" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-676"><a href="#cb63-676" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-677"><a href="#cb63-677" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-678"><a href="#cb63-678" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-679"><a href="#cb63-679" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-680"><a href="#cb63-680" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-681"><a href="#cb63-681" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-682"><a href="#cb63-682" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Variables: %s\n",</span></span>
<span id="cb63-683"><a href="#cb63-683" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-684"><a href="#cb63-684" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-685"><a href="#cb63-685" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-686"><a href="#cb63-686" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-687"><a href="#cb63-687" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-688"><a href="#cb63-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-689"><a href="#cb63-689" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_NaiveBayes_stepAUC &lt;- </span></span>
<span id="cb63-690"><a href="#cb63-690" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span></span>
<span id="cb63-691"><a href="#cb63-691" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-692"><a href="#cb63-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-693"><a href="#cb63-693" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-694"><a href="#cb63-694" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-695"><a href="#cb63-695" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-696"><a href="#cb63-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-697"><a href="#cb63-697" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-698"><a href="#cb63-698" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-699"><a href="#cb63-699" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-700"><a href="#cb63-700" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-701"><a href="#cb63-701" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-702"><a href="#cb63-702" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-703"><a href="#cb63-703" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed)</span></span>
<span id="cb63-704"><a href="#cb63-704" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-705"><a href="#cb63-705" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-706"><a href="#cb63-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-707"><a href="#cb63-707" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-708"><a href="#cb63-708" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-709"><a href="#cb63-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-710"><a href="#cb63-710" aria-hidden="true" tabindex="-1"></a><span class="in">performance_naiveBayes_stepAUC &lt;- evaluate_with_seeds_NaiveBayes_stepAUC(</span></span>
<span id="cb63-711"><a href="#cb63-711" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_naiveBayes_stepAUC,</span></span>
<span id="cb63-712"><a href="#cb63-712" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-713"><a href="#cb63-713" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-714"><a href="#cb63-714" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-715"><a href="#cb63-715" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-716"><a href="#cb63-716" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-717"><a href="#cb63-717" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-718"><a href="#cb63-718" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-719"><a href="#cb63-719" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-720"><a href="#cb63-720" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-721"><a href="#cb63-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-722"><a href="#cb63-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-723"><a href="#cb63-723" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/NaiveBayes_StepAUC.RData")</span></span>
<span id="cb63-724"><a href="#cb63-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-725"><a href="#cb63-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-726"><a href="#cb63-726" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-727"><a href="#cb63-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-728"><a href="#cb63-728" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-729"><a href="#cb63-729" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_naiveBayes_lasso &lt;- function(data, target_name, outer, inner, variables, threshold, seed) {</span></span>
<span id="cb63-730"><a href="#cb63-730" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-731"><a href="#cb63-731" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-732"><a href="#cb63-732" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-733"><a href="#cb63-733" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-734"><a href="#cb63-734" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-735"><a href="#cb63-735" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-736"><a href="#cb63-736" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-737"><a href="#cb63-737" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-738"><a href="#cb63-738" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-739"><a href="#cb63-739" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-740"><a href="#cb63-740" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.factor(data[[target_name]])  # Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb63-741"><a href="#cb63-741" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-742"><a href="#cb63-742" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-743"><a href="#cb63-743" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-744"><a href="#cb63-744" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-745"><a href="#cb63-745" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-746"><a href="#cb63-746" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-747"><a href="#cb63-747" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-748"><a href="#cb63-748" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-749"><a href="#cb63-749" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-750"><a href="#cb63-750" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-751"><a href="#cb63-751" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-752"><a href="#cb63-752" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-753"><a href="#cb63-753" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-754"><a href="#cb63-754" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-755"><a href="#cb63-755" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-756"><a href="#cb63-756" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-757"><a href="#cb63-757" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-758"><a href="#cb63-758" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-759"><a href="#cb63-759" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-760"><a href="#cb63-760" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-761"><a href="#cb63-761" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-762"><a href="#cb63-762" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-763"><a href="#cb63-763" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]]) - 1  # Convertimos a numérico para Lasso</span></span>
<span id="cb63-764"><a href="#cb63-764" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-765"><a href="#cb63-765" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-766"><a href="#cb63-766" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-767"><a href="#cb63-767" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-768"><a href="#cb63-768" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-769"><a href="#cb63-769" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-770"><a href="#cb63-770" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-771"><a href="#cb63-771" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-772"><a href="#cb63-772" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-773"><a href="#cb63-773" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-774"><a href="#cb63-774" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-775"><a href="#cb63-775" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-776"><a href="#cb63-776" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-777"><a href="#cb63-777" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-778"><a href="#cb63-778" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-779"><a href="#cb63-779" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, inner_folds) {</span></span>
<span id="cb63-780"><a href="#cb63-780" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-781"><a href="#cb63-781" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-782"><a href="#cb63-782" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-783"><a href="#cb63-783" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-784"><a href="#cb63-784" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-785"><a href="#cb63-785" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-786"><a href="#cb63-786" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-787"><a href="#cb63-787" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-788"><a href="#cb63-788" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-789"><a href="#cb63-789" aria-hidden="true" tabindex="-1"></a><span class="in">        auc_vals &lt;- numeric()</span></span>
<span id="cb63-790"><a href="#cb63-790" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-791"><a href="#cb63-791" aria-hidden="true" tabindex="-1"></a><span class="in">        for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-792"><a href="#cb63-792" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-793"><a href="#cb63-793" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-794"><a href="#cb63-794" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-795"><a href="#cb63-795" aria-hidden="true" tabindex="-1"></a><span class="in">          selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-796"><a href="#cb63-796" aria-hidden="true" tabindex="-1"></a><span class="in">          formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-797"><a href="#cb63-797" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-798"><a href="#cb63-798" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-799"><a href="#cb63-799" aria-hidden="true" tabindex="-1"></a><span class="in">          result &lt;- tryCatch({</span></span>
<span id="cb63-800"><a href="#cb63-800" aria-hidden="true" tabindex="-1"></a><span class="in">            model &lt;- naiveBayes(formula, data = inner_train_data)</span></span>
<span id="cb63-801"><a href="#cb63-801" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-802"><a href="#cb63-802" aria-hidden="true" tabindex="-1"></a><span class="in">            predictions &lt;- predict(model, inner_test_data, type = "raw")[,2]</span></span>
<span id="cb63-803"><a href="#cb63-803" aria-hidden="true" tabindex="-1"></a><span class="in">            roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-804"><a href="#cb63-804" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-805"><a href="#cb63-805" aria-hidden="true" tabindex="-1"></a><span class="in">            cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-806"><a href="#cb63-806" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-807"><a href="#cb63-807" aria-hidden="true" tabindex="-1"></a><span class="in">          }, error = function(e) {</span></span>
<span id="cb63-808"><a href="#cb63-808" aria-hidden="true" tabindex="-1"></a><span class="in">            cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-809"><a href="#cb63-809" aria-hidden="true" tabindex="-1"></a><span class="in">            cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-810"><a href="#cb63-810" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-811"><a href="#cb63-811" aria-hidden="true" tabindex="-1"></a><span class="in">          })</span></span>
<span id="cb63-812"><a href="#cb63-812" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-813"><a href="#cb63-813" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-814"><a href="#cb63-814" aria-hidden="true" tabindex="-1"></a><span class="in">        mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-815"><a href="#cb63-815" aria-hidden="true" tabindex="-1"></a><span class="in">        cat("Mean AUC: ", mean_auc, "\n")</span></span>
<span id="cb63-816"><a href="#cb63-816" aria-hidden="true" tabindex="-1"></a><span class="in">        if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-817"><a href="#cb63-817" aria-hidden="true" tabindex="-1"></a><span class="in">          best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-818"><a href="#cb63-818" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_model &lt;- model</span></span>
<span id="cb63-819"><a href="#cb63-819" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-820"><a href="#cb63-820" aria-hidden="true" tabindex="-1"></a><span class="in">          improved &lt;- TRUE</span></span>
<span id="cb63-821"><a href="#cb63-821" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-822"><a href="#cb63-822" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-823"><a href="#cb63-823" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-824"><a href="#cb63-824" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-825"><a href="#cb63-825" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-826"><a href="#cb63-826" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-827"><a href="#cb63-827" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-828"><a href="#cb63-828" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-829"><a href="#cb63-829" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-830"><a href="#cb63-830" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-831"><a href="#cb63-831" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, vars = best_inner_vars)</span></span>
<span id="cb63-832"><a href="#cb63-832" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-833"><a href="#cb63-833" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-834"><a href="#cb63-834" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, inner_folds)</span></span>
<span id="cb63-835"><a href="#cb63-835" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-836"><a href="#cb63-836" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-837"><a href="#cb63-837" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-838"><a href="#cb63-838" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-839"><a href="#cb63-839" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-840"><a href="#cb63-840" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-841"><a href="#cb63-841" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-842"><a href="#cb63-842" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-843"><a href="#cb63-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-844"><a href="#cb63-844" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-845"><a href="#cb63-845" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-846"><a href="#cb63-846" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-847"><a href="#cb63-847" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-848"><a href="#cb63-848" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-849"><a href="#cb63-849" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-850"><a href="#cb63-850" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, type = "raw")[,2]</span></span>
<span id="cb63-851"><a href="#cb63-851" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-852"><a href="#cb63-852" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-853"><a href="#cb63-853" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-854"><a href="#cb63-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-855"><a href="#cb63-855" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-856"><a href="#cb63-856" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-857"><a href="#cb63-857" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-858"><a href="#cb63-858" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-859"><a href="#cb63-859" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-860"><a href="#cb63-860" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-861"><a href="#cb63-861" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-862"><a href="#cb63-862" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-863"><a href="#cb63-863" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-864"><a href="#cb63-864" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-865"><a href="#cb63-865" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-866"><a href="#cb63-866" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-867"><a href="#cb63-867" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-868"><a href="#cb63-868" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-869"><a href="#cb63-869" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-870"><a href="#cb63-870" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")[,2]</span></span>
<span id="cb63-871"><a href="#cb63-871" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-872"><a href="#cb63-872" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-873"><a href="#cb63-873" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-874"><a href="#cb63-874" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-875"><a href="#cb63-875" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-876"><a href="#cb63-876" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-877"><a href="#cb63-877" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-878"><a href="#cb63-878" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-879"><a href="#cb63-879" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-880"><a href="#cb63-880" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-881"><a href="#cb63-881" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-882"><a href="#cb63-882" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-883"><a href="#cb63-883" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-884"><a href="#cb63-884" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-885"><a href="#cb63-885" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-886"><a href="#cb63-886" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-887"><a href="#cb63-887" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-888"><a href="#cb63-888" aria-hidden="true" tabindex="-1"></a><span class="in">                          paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-889"><a href="#cb63-889" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-890"><a href="#cb63-890" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-891"><a href="#cb63-891" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-892"><a href="#cb63-892" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-893"><a href="#cb63-893" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-894"><a href="#cb63-894" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-895"><a href="#cb63-895" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-896"><a href="#cb63-896" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Variables: %s\n",</span></span>
<span id="cb63-897"><a href="#cb63-897" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-898"><a href="#cb63-898" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-899"><a href="#cb63-899" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-900"><a href="#cb63-900" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-901"><a href="#cb63-901" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-902"><a href="#cb63-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-903"><a href="#cb63-903" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_NaiveBayes_Lasso &lt;- </span></span>
<span id="cb63-904"><a href="#cb63-904" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner) {</span></span>
<span id="cb63-905"><a href="#cb63-905" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-906"><a href="#cb63-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-907"><a href="#cb63-907" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-908"><a href="#cb63-908" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-909"><a href="#cb63-909" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-910"><a href="#cb63-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-911"><a href="#cb63-911" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-912"><a href="#cb63-912" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-913"><a href="#cb63-913" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-914"><a href="#cb63-914" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-915"><a href="#cb63-915" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-916"><a href="#cb63-916" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-917"><a href="#cb63-917" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed)</span></span>
<span id="cb63-918"><a href="#cb63-918" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-919"><a href="#cb63-919" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-920"><a href="#cb63-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-921"><a href="#cb63-921" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-922"><a href="#cb63-922" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-923"><a href="#cb63-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-924"><a href="#cb63-924" aria-hidden="true" tabindex="-1"></a><span class="in">performance_naiveBayes_lasso &lt;- evaluate_with_seeds_NaiveBayes_Lasso(</span></span>
<span id="cb63-925"><a href="#cb63-925" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_naiveBayes_lasso,</span></span>
<span id="cb63-926"><a href="#cb63-926" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-927"><a href="#cb63-927" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-928"><a href="#cb63-928" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-929"><a href="#cb63-929" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-930"><a href="#cb63-930" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-931"><a href="#cb63-931" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-932"><a href="#cb63-932" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-933"><a href="#cb63-933" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-934"><a href="#cb63-934" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-935"><a href="#cb63-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-936"><a href="#cb63-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-937"><a href="#cb63-937" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/NaiveBayes_Lasso.RData")</span></span>
<span id="cb63-938"><a href="#cb63-938" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-939"><a href="#cb63-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-940"><a href="#cb63-940" aria-hidden="true" tabindex="-1"></a><span class="fu">## Adaboost</span></span>
<span id="cb63-941"><a href="#cb63-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-942"><a href="#cb63-942" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-943"><a href="#cb63-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-944"><a href="#cb63-944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-945"><a href="#cb63-945" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_adaboost &lt;- function(data, target_var, model_func, vars = NULL, iterations = 100, threshold) {</span></span>
<span id="cb63-946"><a href="#cb63-946" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-947"><a href="#cb63-947" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-948"><a href="#cb63-948" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-949"><a href="#cb63-949" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-950"><a href="#cb63-950" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-951"><a href="#cb63-951" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-952"><a href="#cb63-952" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-953"><a href="#cb63-953" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data, iterations)</span></span>
<span id="cb63-954"><a href="#cb63-954" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- predict(model, newdata = data, type = "response")</span></span>
<span id="cb63-955"><a href="#cb63-955" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-956"><a href="#cb63-956" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-957"><a href="#cb63-957" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-958"><a href="#cb63-958" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(Predicted = predicted_classes, Actual = actual_classes)</span></span>
<span id="cb63-959"><a href="#cb63-959" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-960"><a href="#cb63-960" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-961"><a href="#cb63-961" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-962"><a href="#cb63-962" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-963"><a href="#cb63-963" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-964"><a href="#cb63-964" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-965"><a href="#cb63-965" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-966"><a href="#cb63-966" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-967"><a href="#cb63-967" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-968"><a href="#cb63-968" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-969"><a href="#cb63-969" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-970"><a href="#cb63-970" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-971"><a href="#cb63-971" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-972"><a href="#cb63-972" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-973"><a href="#cb63-973" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-974"><a href="#cb63-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-975"><a href="#cb63-975" aria-hidden="true" tabindex="-1"></a><span class="in">adaboost_model &lt;- function(formula, data, iterations) {</span></span>
<span id="cb63-976"><a href="#cb63-976" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- glmboost(formula, data = data, family = Binomial(), control = boost_control(mstop = iterations))</span></span>
<span id="cb63-977"><a href="#cb63-977" aria-hidden="true" tabindex="-1"></a><span class="in">  model</span></span>
<span id="cb63-978"><a href="#cb63-978" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-979"><a href="#cb63-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-980"><a href="#cb63-980" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesAdaBoost &lt;- evaluate_aparent_performance_model_adaboost(data = data_numeric, target_var = "PCR",</span></span>
<span id="cb63-981"><a href="#cb63-981" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                           model_func = adaboost_model,</span></span>
<span id="cb63-982"><a href="#cb63-982" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                           vars = ".",</span></span>
<span id="cb63-983"><a href="#cb63-983" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                           iterations = 100,</span></span>
<span id="cb63-984"><a href="#cb63-984" aria-hidden="true" tabindex="-1"></a><span class="in">                                                                           threshold = 0.35)</span></span>
<span id="cb63-985"><a href="#cb63-985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-986"><a href="#cb63-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-987"><a href="#cb63-987" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-988"><a href="#cb63-988" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/AdaBoost_Aparente.RData")</span></span>
<span id="cb63-989"><a href="#cb63-989" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-990"><a href="#cb63-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-991"><a href="#cb63-991" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-992"><a href="#cb63-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-993"><a href="#cb63-993" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-994"><a href="#cb63-994" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_adaboost &lt;- function(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span></span>
<span id="cb63-995"><a href="#cb63-995" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-996"><a href="#cb63-996" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-997"><a href="#cb63-997" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(), </span></span>
<span id="cb63-998"><a href="#cb63-998" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Iteration = integer(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-999"><a href="#cb63-999" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1000"><a href="#cb63-1000" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-1001"><a href="#cb63-1001" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-1002"><a href="#cb63-1002" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1003"><a href="#cb63-1003" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1004"><a href="#cb63-1004" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1005"><a href="#cb63-1005" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1006"><a href="#cb63-1006" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1007"><a href="#cb63-1007" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1008"><a href="#cb63-1008" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1009"><a href="#cb63-1009" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1010"><a href="#cb63-1010" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1011"><a href="#cb63-1011" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1012"><a href="#cb63-1012" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1013"><a href="#cb63-1013" aria-hidden="true" tabindex="-1"></a><span class="in">    if (sum(outer_train_data[[target_name]] == "0") == 0 || sum(outer_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-1014"><a href="#cb63-1014" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Skipping outer fold due to lack of class diversity\n")</span></span>
<span id="cb63-1015"><a href="#cb63-1015" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-1016"><a href="#cb63-1016" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1017"><a href="#cb63-1017" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1018"><a href="#cb63-1018" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-1019"><a href="#cb63-1019" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-1020"><a href="#cb63-1020" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-1021"><a href="#cb63-1021" aria-hidden="true" tabindex="-1"></a><span class="in">    best_iteration &lt;- NULL</span></span>
<span id="cb63-1022"><a href="#cb63-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1023"><a href="#cb63-1023" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(iteration = iterations)</span></span>
<span id="cb63-1024"><a href="#cb63-1024" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- reformulate(variables, target_name)</span></span>
<span id="cb63-1025"><a href="#cb63-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1026"><a href="#cb63-1026" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-1027"><a href="#cb63-1027" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-1028"><a href="#cb63-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1029"><a href="#cb63-1029" aria-hidden="true" tabindex="-1"></a><span class="in">      for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1030"><a href="#cb63-1030" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1031"><a href="#cb63-1031" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1032"><a href="#cb63-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1033"><a href="#cb63-1033" aria-hidden="true" tabindex="-1"></a><span class="in">        if (sum(inner_train_data[[target_name]] == "0") == 0 || sum(inner_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-1034"><a href="#cb63-1034" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Skipping inner fold due to lack of class diversity\n")</span></span>
<span id="cb63-1035"><a href="#cb63-1035" aria-hidden="true" tabindex="-1"></a><span class="in">          next</span></span>
<span id="cb63-1036"><a href="#cb63-1036" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1037"><a href="#cb63-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1038"><a href="#cb63-1038" aria-hidden="true" tabindex="-1"></a><span class="in">        result &lt;- tryCatch({</span></span>
<span id="cb63-1039"><a href="#cb63-1039" aria-hidden="true" tabindex="-1"></a><span class="in">          model &lt;- blackboost(formula, data = inner_train_data, family = Binomial(), control = boost_control(mstop = grid$iteration[params]))</span></span>
<span id="cb63-1040"><a href="#cb63-1040" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-1041"><a href="#cb63-1041" aria-hidden="true" tabindex="-1"></a><span class="in">          predictions &lt;- predict(model, inner_test_data, type = "response")</span></span>
<span id="cb63-1042"><a href="#cb63-1042" aria-hidden="true" tabindex="-1"></a><span class="in">          roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1043"><a href="#cb63-1043" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1044"><a href="#cb63-1044" aria-hidden="true" tabindex="-1"></a><span class="in">        }, error = function(e) {</span></span>
<span id="cb63-1045"><a href="#cb63-1045" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error with parameters: iteration =", grid$iteration[params], "\n")</span></span>
<span id="cb63-1046"><a href="#cb63-1046" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-1047"><a href="#cb63-1047" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- 0</span></span>
<span id="cb63-1048"><a href="#cb63-1048" aria-hidden="true" tabindex="-1"></a><span class="in">        })</span></span>
<span id="cb63-1049"><a href="#cb63-1049" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1050"><a href="#cb63-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1051"><a href="#cb63-1051" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc, na.rm = TRUE) &gt; best_auc) {</span></span>
<span id="cb63-1052"><a href="#cb63-1052" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-1053"><a href="#cb63-1053" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model &lt;- model</span></span>
<span id="cb63-1054"><a href="#cb63-1054" aria-hidden="true" tabindex="-1"></a><span class="in">        best_iteration &lt;- grid$iteration[params]</span></span>
<span id="cb63-1055"><a href="#cb63-1055" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1056"><a href="#cb63-1056" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1057"><a href="#cb63-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1058"><a href="#cb63-1058" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-1059"><a href="#cb63-1059" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-1060"><a href="#cb63-1060" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-1061"><a href="#cb63-1061" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1062"><a href="#cb63-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1063"><a href="#cb63-1063" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "response")</span></span>
<span id="cb63-1064"><a href="#cb63-1064" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-1065"><a href="#cb63-1065" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1066"><a href="#cb63-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1067"><a href="#cb63-1067" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-1068"><a href="#cb63-1068" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1069"><a href="#cb63-1069" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1070"><a href="#cb63-1070" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1071"><a href="#cb63-1071" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1072"><a href="#cb63-1072" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-1073"><a href="#cb63-1073" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-1074"><a href="#cb63-1074" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-1075"><a href="#cb63-1075" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-1076"><a href="#cb63-1076" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-1077"><a href="#cb63-1077" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1078"><a href="#cb63-1078" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-1079"><a href="#cb63-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1080"><a href="#cb63-1080" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, best_iteration), names(performance_metrics))</span></span>
<span id="cb63-1081"><a href="#cb63-1081" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-1082"><a href="#cb63-1082" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1083"><a href="#cb63-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1084"><a href="#cb63-1084" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-1085"><a href="#cb63-1085" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1086"><a href="#cb63-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1087"><a href="#cb63-1087" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_AdaBoost_Asociacion_Todas &lt;- </span></span>
<span id="cb63-1088"><a href="#cb63-1088" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span></span>
<span id="cb63-1089"><a href="#cb63-1089" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-1090"><a href="#cb63-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1091"><a href="#cb63-1091" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-1092"><a href="#cb63-1092" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-1093"><a href="#cb63-1093" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-1094"><a href="#cb63-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1095"><a href="#cb63-1095" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-1096"><a href="#cb63-1096" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-1097"><a href="#cb63-1097" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-1098"><a href="#cb63-1098" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-1099"><a href="#cb63-1099" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-1100"><a href="#cb63-1100" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner,</span></span>
<span id="cb63-1101"><a href="#cb63-1101" aria-hidden="true" tabindex="-1"></a><span class="in">                                   iterations, </span></span>
<span id="cb63-1102"><a href="#cb63-1102" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed)</span></span>
<span id="cb63-1103"><a href="#cb63-1103" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-1104"><a href="#cb63-1104" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1105"><a href="#cb63-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1106"><a href="#cb63-1106" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-1107"><a href="#cb63-1107" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1108"><a href="#cb63-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1109"><a href="#cb63-1109" aria-hidden="true" tabindex="-1"></a><span class="in">performance_adaboost_todasvariables &lt;- evaluate_with_seeds_AdaBoost_Asociacion_Todas(</span></span>
<span id="cb63-1110"><a href="#cb63-1110" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_adaboost,</span></span>
<span id="cb63-1111"><a href="#cb63-1111" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1112"><a href="#cb63-1112" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1113"><a href="#cb63-1113" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1114"><a href="#cb63-1114" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1115"><a href="#cb63-1115" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-1116"><a href="#cb63-1116" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1117"><a href="#cb63-1117" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds,</span></span>
<span id="cb63-1118"><a href="#cb63-1118" aria-hidden="true" tabindex="-1"></a><span class="in">  iterations = c(50, 100, 150, 200)</span></span>
<span id="cb63-1119"><a href="#cb63-1119" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1120"><a href="#cb63-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1121"><a href="#cb63-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1122"><a href="#cb63-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1123"><a href="#cb63-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1124"><a href="#cb63-1124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1125"><a href="#cb63-1125" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/AdaBoost_TodasVariables.RData")</span></span>
<span id="cb63-1126"><a href="#cb63-1126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1127"><a href="#cb63-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1128"><a href="#cb63-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-1129"><a href="#cb63-1129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1130"><a href="#cb63-1130" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1131"><a href="#cb63-1131" aria-hidden="true" tabindex="-1"></a><span class="in">performance_adaboost_Asociacion &lt;- evaluate_with_seeds_AdaBoost_Asociacion_Todas(</span></span>
<span id="cb63-1132"><a href="#cb63-1132" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_adaboost,</span></span>
<span id="cb63-1133"><a href="#cb63-1133" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1134"><a href="#cb63-1134" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1135"><a href="#cb63-1135" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1136"><a href="#cb63-1136" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1137"><a href="#cb63-1137" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = asociacion,</span></span>
<span id="cb63-1138"><a href="#cb63-1138" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1139"><a href="#cb63-1139" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds,</span></span>
<span id="cb63-1140"><a href="#cb63-1140" aria-hidden="true" tabindex="-1"></a><span class="in">  iterations = c(50, 100, 150, 200)</span></span>
<span id="cb63-1141"><a href="#cb63-1141" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1142"><a href="#cb63-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1143"><a href="#cb63-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1144"><a href="#cb63-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1145"><a href="#cb63-1145" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/AdaBoost_Asociacion.RData")</span></span>
<span id="cb63-1146"><a href="#cb63-1146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1147"><a href="#cb63-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1148"><a href="#cb63-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-1149"><a href="#cb63-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1150"><a href="#cb63-1150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1151"><a href="#cb63-1151" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_adaboost_stepAUC &lt;- function(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span></span>
<span id="cb63-1152"><a href="#cb63-1152" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-1153"><a href="#cb63-1153" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-1154"><a href="#cb63-1154" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-1155"><a href="#cb63-1155" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Iterations = integer(), Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1156"><a href="#cb63-1156" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1157"><a href="#cb63-1157" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-1158"><a href="#cb63-1158" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-1159"><a href="#cb63-1159" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1160"><a href="#cb63-1160" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1161"><a href="#cb63-1161" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-1162"><a href="#cb63-1162" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-1163"><a href="#cb63-1163" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1164"><a href="#cb63-1164" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1165"><a href="#cb63-1165" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1166"><a href="#cb63-1166" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1167"><a href="#cb63-1167" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1168"><a href="#cb63-1168" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1169"><a href="#cb63-1169" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1170"><a href="#cb63-1170" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1171"><a href="#cb63-1171" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1172"><a href="#cb63-1172" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1173"><a href="#cb63-1173" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1174"><a href="#cb63-1174" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-1175"><a href="#cb63-1175" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-1176"><a href="#cb63-1176" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-1177"><a href="#cb63-1177" aria-hidden="true" tabindex="-1"></a><span class="in">    best_iterations &lt;- NULL</span></span>
<span id="cb63-1178"><a href="#cb63-1178" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-1179"><a href="#cb63-1179" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1180"><a href="#cb63-1180" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, outer_train_data, target_name, iterations, inner_folds) {</span></span>
<span id="cb63-1181"><a href="#cb63-1181" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-1182"><a href="#cb63-1182" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-1183"><a href="#cb63-1183" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-1184"><a href="#cb63-1184" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_iterations &lt;- NULL</span></span>
<span id="cb63-1185"><a href="#cb63-1185" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-1186"><a href="#cb63-1186" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-1187"><a href="#cb63-1187" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1188"><a href="#cb63-1188" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-1189"><a href="#cb63-1189" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-1190"><a href="#cb63-1190" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-1191"><a href="#cb63-1191" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1192"><a href="#cb63-1192" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-1193"><a href="#cb63-1193" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-1194"><a href="#cb63-1194" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-1195"><a href="#cb63-1195" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-1196"><a href="#cb63-1196" aria-hidden="true" tabindex="-1"></a><span class="in">          for (iter in iterations) {</span></span>
<span id="cb63-1197"><a href="#cb63-1197" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals &lt;- numeric()</span></span>
<span id="cb63-1198"><a href="#cb63-1198" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1199"><a href="#cb63-1199" aria-hidden="true" tabindex="-1"></a><span class="in">            for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1200"><a href="#cb63-1200" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1201"><a href="#cb63-1201" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1202"><a href="#cb63-1202" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-1203"><a href="#cb63-1203" aria-hidden="true" tabindex="-1"></a><span class="in">              result &lt;- tryCatch({</span></span>
<span id="cb63-1204"><a href="#cb63-1204" aria-hidden="true" tabindex="-1"></a><span class="in">                model &lt;- glmboost(as.formula(paste(target_name, "~", paste(temp_vars, collapse = "+"))),</span></span>
<span id="cb63-1205"><a href="#cb63-1205" aria-hidden="true" tabindex="-1"></a><span class="in">                                  data = inner_train_data, family = Binomial(),</span></span>
<span id="cb63-1206"><a href="#cb63-1206" aria-hidden="true" tabindex="-1"></a><span class="in">                                  control = boost_control(mstop = iter))</span></span>
<span id="cb63-1207"><a href="#cb63-1207" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-1208"><a href="#cb63-1208" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- predict(model, newdata = inner_test_data, type = "response")</span></span>
<span id="cb63-1209"><a href="#cb63-1209" aria-hidden="true" tabindex="-1"></a><span class="in">                roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1210"><a href="#cb63-1210" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1211"><a href="#cb63-1211" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-1212"><a href="#cb63-1212" aria-hidden="true" tabindex="-1"></a><span class="in">              }, error = function(e) {</span></span>
<span id="cb63-1213"><a href="#cb63-1213" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-1214"><a href="#cb63-1214" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- 0</span></span>
<span id="cb63-1215"><a href="#cb63-1215" aria-hidden="true" tabindex="-1"></a><span class="in">              })</span></span>
<span id="cb63-1216"><a href="#cb63-1216" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-1217"><a href="#cb63-1217" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1218"><a href="#cb63-1218" aria-hidden="true" tabindex="-1"></a><span class="in">            if (mean(auc_vals, na.rm = TRUE) &gt; best_auc_in_step) {</span></span>
<span id="cb63-1219"><a href="#cb63-1219" aria-hidden="true" tabindex="-1"></a><span class="in">              best_auc_in_step &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1220"><a href="#cb63-1220" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_model &lt;- model</span></span>
<span id="cb63-1221"><a href="#cb63-1221" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_iterations &lt;- iter</span></span>
<span id="cb63-1222"><a href="#cb63-1222" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-1223"><a href="#cb63-1223" aria-hidden="true" tabindex="-1"></a><span class="in">              improved &lt;- TRUE</span></span>
<span id="cb63-1224"><a href="#cb63-1224" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-1225"><a href="#cb63-1225" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-1226"><a href="#cb63-1226" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1227"><a href="#cb63-1227" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1228"><a href="#cb63-1228" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-1229"><a href="#cb63-1229" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-1230"><a href="#cb63-1230" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-1231"><a href="#cb63-1231" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-1232"><a href="#cb63-1232" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-1233"><a href="#cb63-1233" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1234"><a href="#cb63-1234" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1235"><a href="#cb63-1235" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1236"><a href="#cb63-1236" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-1237"><a href="#cb63-1237" aria-hidden="true" tabindex="-1"></a><span class="in">           iterations = best_inner_iterations, </span></span>
<span id="cb63-1238"><a href="#cb63-1238" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-1239"><a href="#cb63-1239" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1240"><a href="#cb63-1240" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1241"><a href="#cb63-1241" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, iterations, inner_folds)</span></span>
<span id="cb63-1242"><a href="#cb63-1242" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-1243"><a href="#cb63-1243" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-1244"><a href="#cb63-1244" aria-hidden="true" tabindex="-1"></a><span class="in">    best_iterations &lt;- best_result$iterations</span></span>
<span id="cb63-1245"><a href="#cb63-1245" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-1246"><a href="#cb63-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1247"><a href="#cb63-1247" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-1248"><a href="#cb63-1248" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-1249"><a href="#cb63-1249" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1250"><a href="#cb63-1250" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1251"><a href="#cb63-1251" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1252"><a href="#cb63-1252" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1253"><a href="#cb63-1253" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, newdata = inner_test_data, type = "response")</span></span>
<span id="cb63-1254"><a href="#cb63-1254" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1255"><a href="#cb63-1255" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1256"><a href="#cb63-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1257"><a href="#cb63-1257" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-1258"><a href="#cb63-1258" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1259"><a href="#cb63-1259" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1260"><a href="#cb63-1260" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1261"><a href="#cb63-1261" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1262"><a href="#cb63-1262" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1263"><a href="#cb63-1263" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-1264"><a href="#cb63-1264" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1265"><a href="#cb63-1265" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-1266"><a href="#cb63-1266" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-1267"><a href="#cb63-1267" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1268"><a href="#cb63-1268" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1269"><a href="#cb63-1269" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1270"><a href="#cb63-1270" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1271"><a href="#cb63-1271" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "response")</span></span>
<span id="cb63-1272"><a href="#cb63-1272" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-1273"><a href="#cb63-1273" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1274"><a href="#cb63-1274" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1275"><a href="#cb63-1275" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-1276"><a href="#cb63-1276" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1277"><a href="#cb63-1277" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1278"><a href="#cb63-1278" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1279"><a href="#cb63-1279" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1280"><a href="#cb63-1280" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-1281"><a href="#cb63-1281" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-1282"><a href="#cb63-1282" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-1283"><a href="#cb63-1283" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-1284"><a href="#cb63-1284" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-1285"><a href="#cb63-1285" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1286"><a href="#cb63-1286" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-1287"><a href="#cb63-1287" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1288"><a href="#cb63-1288" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-1289"><a href="#cb63-1289" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_iterations, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-1290"><a href="#cb63-1290" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-1291"><a href="#cb63-1291" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-1292"><a href="#cb63-1292" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1293"><a href="#cb63-1293" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-1294"><a href="#cb63-1294" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1295"><a href="#cb63-1295" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-1296"><a href="#cb63-1296" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1297"><a href="#cb63-1297" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Iterations: %d, Best Variables: %s\n",</span></span>
<span id="cb63-1298"><a href="#cb63-1298" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_iterations, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-1299"><a href="#cb63-1299" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1300"><a href="#cb63-1300" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1301"><a href="#cb63-1301" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-1302"><a href="#cb63-1302" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1303"><a href="#cb63-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1304"><a href="#cb63-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1305"><a href="#cb63-1305" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_AdaBoost_stepAUC &lt;- </span></span>
<span id="cb63-1306"><a href="#cb63-1306" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span></span>
<span id="cb63-1307"><a href="#cb63-1307" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-1308"><a href="#cb63-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1309"><a href="#cb63-1309" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-1310"><a href="#cb63-1310" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-1311"><a href="#cb63-1311" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-1312"><a href="#cb63-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1313"><a href="#cb63-1313" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-1314"><a href="#cb63-1314" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-1315"><a href="#cb63-1315" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-1316"><a href="#cb63-1316" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-1317"><a href="#cb63-1317" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-1318"><a href="#cb63-1318" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-1319"><a href="#cb63-1319" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-1320"><a href="#cb63-1320" aria-hidden="true" tabindex="-1"></a><span class="in">                                   iterations = iterations)</span></span>
<span id="cb63-1321"><a href="#cb63-1321" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-1322"><a href="#cb63-1322" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1323"><a href="#cb63-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1324"><a href="#cb63-1324" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-1325"><a href="#cb63-1325" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1326"><a href="#cb63-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1327"><a href="#cb63-1327" aria-hidden="true" tabindex="-1"></a><span class="in">performance_adaboost_stepAUC &lt;- evaluate_with_seeds_AdaBoost_stepAUC(</span></span>
<span id="cb63-1328"><a href="#cb63-1328" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_adaboost_stepAUC,</span></span>
<span id="cb63-1329"><a href="#cb63-1329" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1330"><a href="#cb63-1330" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1331"><a href="#cb63-1331" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1332"><a href="#cb63-1332" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1333"><a href="#cb63-1333" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-1334"><a href="#cb63-1334" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1335"><a href="#cb63-1335" aria-hidden="true" tabindex="-1"></a><span class="in">  iterations = c(50, 100, 150, 200),</span></span>
<span id="cb63-1336"><a href="#cb63-1336" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-1337"><a href="#cb63-1337" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1338"><a href="#cb63-1338" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1339"><a href="#cb63-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1340"><a href="#cb63-1340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1341"><a href="#cb63-1341" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/AdaBoost_StepAUC.RData")</span></span>
<span id="cb63-1342"><a href="#cb63-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1343"><a href="#cb63-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1344"><a href="#cb63-1344" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-1345"><a href="#cb63-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1346"><a href="#cb63-1346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1347"><a href="#cb63-1347" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_adaboost_lasso &lt;- function(data, target_name, outer, inner, iterations, variables, threshold, seed) {</span></span>
<span id="cb63-1348"><a href="#cb63-1348" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-1349"><a href="#cb63-1349" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-1350"><a href="#cb63-1350" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-1351"><a href="#cb63-1351" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Iteration = integer(), </span></span>
<span id="cb63-1352"><a href="#cb63-1352" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1353"><a href="#cb63-1353" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1354"><a href="#cb63-1354" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-1355"><a href="#cb63-1355" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-1356"><a href="#cb63-1356" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1357"><a href="#cb63-1357" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1358"><a href="#cb63-1358" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-1359"><a href="#cb63-1359" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.factor(data[[target_name]])  # Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb63-1360"><a href="#cb63-1360" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-1361"><a href="#cb63-1361" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-1362"><a href="#cb63-1362" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-1363"><a href="#cb63-1363" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1364"><a href="#cb63-1364" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-1365"><a href="#cb63-1365" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1366"><a href="#cb63-1366" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1367"><a href="#cb63-1367" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1368"><a href="#cb63-1368" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1369"><a href="#cb63-1369" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1370"><a href="#cb63-1370" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1371"><a href="#cb63-1371" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1372"><a href="#cb63-1372" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1373"><a href="#cb63-1373" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1374"><a href="#cb63-1374" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1375"><a href="#cb63-1375" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1376"><a href="#cb63-1376" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-1377"><a href="#cb63-1377" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-1378"><a href="#cb63-1378" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-1379"><a href="#cb63-1379" aria-hidden="true" tabindex="-1"></a><span class="in">    best_iteration &lt;- NULL</span></span>
<span id="cb63-1380"><a href="#cb63-1380" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-1381"><a href="#cb63-1381" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1382"><a href="#cb63-1382" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(iteration = iterations)</span></span>
<span id="cb63-1383"><a href="#cb63-1383" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1384"><a href="#cb63-1384" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-1385"><a href="#cb63-1385" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]]) - 1  # Convertimos a numérico para Lasso</span></span>
<span id="cb63-1386"><a href="#cb63-1386" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-1387"><a href="#cb63-1387" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-1388"><a href="#cb63-1388" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-1389"><a href="#cb63-1389" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1390"><a href="#cb63-1390" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-1391"><a href="#cb63-1391" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-1392"><a href="#cb63-1392" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-1393"><a href="#cb63-1393" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1394"><a href="#cb63-1394" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-1395"><a href="#cb63-1395" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-1396"><a href="#cb63-1396" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-1397"><a href="#cb63-1397" aria-hidden="true" tabindex="-1"></a><span class="in">      #cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-1398"><a href="#cb63-1398" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-1399"><a href="#cb63-1399" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1400"><a href="#cb63-1400" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1401"><a href="#cb63-1401" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-1402"><a href="#cb63-1402" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-1403"><a href="#cb63-1403" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-1404"><a href="#cb63-1404" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_iteration &lt;- NULL</span></span>
<span id="cb63-1405"><a href="#cb63-1405" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-1406"><a href="#cb63-1406" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-1407"><a href="#cb63-1407" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1408"><a href="#cb63-1408" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-1409"><a href="#cb63-1409" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-1410"><a href="#cb63-1410" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-1411"><a href="#cb63-1411" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1412"><a href="#cb63-1412" aria-hidden="true" tabindex="-1"></a><span class="in">        for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-1413"><a href="#cb63-1413" aria-hidden="true" tabindex="-1"></a><span class="in">          auc_vals &lt;- numeric()</span></span>
<span id="cb63-1414"><a href="#cb63-1414" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-1415"><a href="#cb63-1415" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1416"><a href="#cb63-1416" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1417"><a href="#cb63-1417" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1418"><a href="#cb63-1418" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1419"><a href="#cb63-1419" aria-hidden="true" tabindex="-1"></a><span class="in">            selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-1420"><a href="#cb63-1420" aria-hidden="true" tabindex="-1"></a><span class="in">            formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-1421"><a href="#cb63-1421" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-1422"><a href="#cb63-1422" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Grid parameters - iteration: ", grid$iteration[params], "\n")</span></span>
<span id="cb63-1423"><a href="#cb63-1423" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1424"><a href="#cb63-1424" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-1425"><a href="#cb63-1425" aria-hidden="true" tabindex="-1"></a><span class="in">              model &lt;- blackboost(formula, data = inner_train_data, family = Binomial(), </span></span>
<span id="cb63-1426"><a href="#cb63-1426" aria-hidden="true" tabindex="-1"></a><span class="in">                                  control = boost_control(mstop = grid$iteration[params]))</span></span>
<span id="cb63-1427"><a href="#cb63-1427" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-1428"><a href="#cb63-1428" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- predict(model, inner_test_data, type = "response")</span></span>
<span id="cb63-1429"><a href="#cb63-1429" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1430"><a href="#cb63-1430" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1431"><a href="#cb63-1431" aria-hidden="true" tabindex="-1"></a><span class="in">              #cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-1432"><a href="#cb63-1432" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-1433"><a href="#cb63-1433" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-1434"><a href="#cb63-1434" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-1435"><a href="#cb63-1435" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-1436"><a href="#cb63-1436" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-1437"><a href="#cb63-1437" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-1438"><a href="#cb63-1438" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-1439"><a href="#cb63-1439" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-1440"><a href="#cb63-1440" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1441"><a href="#cb63-1441" aria-hidden="true" tabindex="-1"></a><span class="in">          #cat("Mean AUC for params - iteration: ", grid$iteration[params], ": ", mean_auc, "\n")</span></span>
<span id="cb63-1442"><a href="#cb63-1442" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-1443"><a href="#cb63-1443" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-1444"><a href="#cb63-1444" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- model</span></span>
<span id="cb63-1445"><a href="#cb63-1445" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_iteration &lt;- grid$iteration[params]</span></span>
<span id="cb63-1446"><a href="#cb63-1446" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-1447"><a href="#cb63-1447" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-1448"><a href="#cb63-1448" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-1449"><a href="#cb63-1449" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1450"><a href="#cb63-1450" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1451"><a href="#cb63-1451" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-1452"><a href="#cb63-1452" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-1453"><a href="#cb63-1453" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-1454"><a href="#cb63-1454" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-1455"><a href="#cb63-1455" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-1456"><a href="#cb63-1456" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1457"><a href="#cb63-1457" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1458"><a href="#cb63-1458" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1459"><a href="#cb63-1459" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-1460"><a href="#cb63-1460" aria-hidden="true" tabindex="-1"></a><span class="in">           iteration = best_inner_iteration, vars = best_inner_vars)</span></span>
<span id="cb63-1461"><a href="#cb63-1461" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1462"><a href="#cb63-1462" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1463"><a href="#cb63-1463" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-1464"><a href="#cb63-1464" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-1465"><a href="#cb63-1465" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-1466"><a href="#cb63-1466" aria-hidden="true" tabindex="-1"></a><span class="in">    best_iteration &lt;- best_result$iteration</span></span>
<span id="cb63-1467"><a href="#cb63-1467" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-1468"><a href="#cb63-1468" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1469"><a href="#cb63-1469" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-1470"><a href="#cb63-1470" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-1471"><a href="#cb63-1471" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-1472"><a href="#cb63-1472" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1473"><a href="#cb63-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1474"><a href="#cb63-1474" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-1475"><a href="#cb63-1475" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-1476"><a href="#cb63-1476" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1477"><a href="#cb63-1477" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1478"><a href="#cb63-1478" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1479"><a href="#cb63-1479" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1480"><a href="#cb63-1480" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, type = "response")</span></span>
<span id="cb63-1481"><a href="#cb63-1481" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1482"><a href="#cb63-1482" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1483"><a href="#cb63-1483" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-1484"><a href="#cb63-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1485"><a href="#cb63-1485" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-1486"><a href="#cb63-1486" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1487"><a href="#cb63-1487" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1488"><a href="#cb63-1488" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1489"><a href="#cb63-1489" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1490"><a href="#cb63-1490" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1491"><a href="#cb63-1491" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-1492"><a href="#cb63-1492" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1493"><a href="#cb63-1493" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-1494"><a href="#cb63-1494" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-1495"><a href="#cb63-1495" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1496"><a href="#cb63-1496" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1497"><a href="#cb63-1497" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1498"><a href="#cb63-1498" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-1499"><a href="#cb63-1499" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1500"><a href="#cb63-1500" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "response")</span></span>
<span id="cb63-1501"><a href="#cb63-1501" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-1502"><a href="#cb63-1502" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1503"><a href="#cb63-1503" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1504"><a href="#cb63-1504" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-1505"><a href="#cb63-1505" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1506"><a href="#cb63-1506" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1507"><a href="#cb63-1507" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1508"><a href="#cb63-1508" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1509"><a href="#cb63-1509" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-1510"><a href="#cb63-1510" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-1511"><a href="#cb63-1511" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-1512"><a href="#cb63-1512" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-1513"><a href="#cb63-1513" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-1514"><a href="#cb63-1514" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1515"><a href="#cb63-1515" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-1516"><a href="#cb63-1516" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1517"><a href="#cb63-1517" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-1518"><a href="#cb63-1518" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_iteration, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-1519"><a href="#cb63-1519" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-1520"><a href="#cb63-1520" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-1521"><a href="#cb63-1521" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1522"><a href="#cb63-1522" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-1523"><a href="#cb63-1523" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1524"><a href="#cb63-1524" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-1525"><a href="#cb63-1525" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1526"><a href="#cb63-1526" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Iteration: %d, Best Variables: %s\n",</span></span>
<span id="cb63-1527"><a href="#cb63-1527" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_iteration, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-1528"><a href="#cb63-1528" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1529"><a href="#cb63-1529" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1530"><a href="#cb63-1530" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-1531"><a href="#cb63-1531" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1532"><a href="#cb63-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1533"><a href="#cb63-1533" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_AdaBoost_Lasso &lt;- </span></span>
<span id="cb63-1534"><a href="#cb63-1534" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, iterations) {</span></span>
<span id="cb63-1535"><a href="#cb63-1535" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-1536"><a href="#cb63-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1537"><a href="#cb63-1537" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-1538"><a href="#cb63-1538" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-1539"><a href="#cb63-1539" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-1540"><a href="#cb63-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1541"><a href="#cb63-1541" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-1542"><a href="#cb63-1542" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-1543"><a href="#cb63-1543" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-1544"><a href="#cb63-1544" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-1545"><a href="#cb63-1545" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-1546"><a href="#cb63-1546" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-1547"><a href="#cb63-1547" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-1548"><a href="#cb63-1548" aria-hidden="true" tabindex="-1"></a><span class="in">                                   iterations = iterations)</span></span>
<span id="cb63-1549"><a href="#cb63-1549" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-1550"><a href="#cb63-1550" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1551"><a href="#cb63-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1552"><a href="#cb63-1552" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-1553"><a href="#cb63-1553" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1554"><a href="#cb63-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1555"><a href="#cb63-1555" aria-hidden="true" tabindex="-1"></a><span class="in">performance_adaboost_lasso &lt;- evaluate_with_seeds_AdaBoost_stepAUC(</span></span>
<span id="cb63-1556"><a href="#cb63-1556" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_adaboost_lasso,</span></span>
<span id="cb63-1557"><a href="#cb63-1557" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1558"><a href="#cb63-1558" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1559"><a href="#cb63-1559" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1560"><a href="#cb63-1560" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1561"><a href="#cb63-1561" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-1562"><a href="#cb63-1562" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1563"><a href="#cb63-1563" aria-hidden="true" tabindex="-1"></a><span class="in">  iterations = c(50, 100, 150, 200),</span></span>
<span id="cb63-1564"><a href="#cb63-1564" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-1565"><a href="#cb63-1565" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1566"><a href="#cb63-1566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1567"><a href="#cb63-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1568"><a href="#cb63-1568" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1569"><a href="#cb63-1569" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/AdaBoost_Lasso.RData")</span></span>
<span id="cb63-1570"><a href="#cb63-1570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1571"><a href="#cb63-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1572"><a href="#cb63-1572" aria-hidden="true" tabindex="-1"></a><span class="fu">## Random Forest </span></span>
<span id="cb63-1573"><a href="#cb63-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1574"><a href="#cb63-1574" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-1575"><a href="#cb63-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1576"><a href="#cb63-1576" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1577"><a href="#cb63-1577" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_rpart &lt;- function(data, target_var, model_func, vars = NULL, threshold = 0.5) {</span></span>
<span id="cb63-1578"><a href="#cb63-1578" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-1579"><a href="#cb63-1579" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-1580"><a href="#cb63-1580" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1581"><a href="#cb63-1581" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1582"><a href="#cb63-1582" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-1583"><a href="#cb63-1583" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-1584"><a href="#cb63-1584" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1585"><a href="#cb63-1585" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data)</span></span>
<span id="cb63-1586"><a href="#cb63-1586" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- predict(model, newdata = data, type = "prob")[, 2]</span></span>
<span id="cb63-1587"><a href="#cb63-1587" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1588"><a href="#cb63-1588" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-1589"><a href="#cb63-1589" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-1590"><a href="#cb63-1590" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(predicted_classes, actual_classes)</span></span>
<span id="cb63-1591"><a href="#cb63-1591" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1592"><a href="#cb63-1592" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-1593"><a href="#cb63-1593" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-1594"><a href="#cb63-1594" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-1595"><a href="#cb63-1595" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-1596"><a href="#cb63-1596" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1597"><a href="#cb63-1597" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-1598"><a href="#cb63-1598" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-1599"><a href="#cb63-1599" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-1600"><a href="#cb63-1600" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-1601"><a href="#cb63-1601" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-1602"><a href="#cb63-1602" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1603"><a href="#cb63-1603" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-1604"><a href="#cb63-1604" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-1605"><a href="#cb63-1605" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1606"><a href="#cb63-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1607"><a href="#cb63-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1608"><a href="#cb63-1608" aria-hidden="true" tabindex="-1"></a><span class="in">rf_model &lt;- function(formula, data) {</span></span>
<span id="cb63-1609"><a href="#cb63-1609" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(90)</span></span>
<span id="cb63-1610"><a href="#cb63-1610" aria-hidden="true" tabindex="-1"></a><span class="in">  rpart(formula = formula, data = data, method = "class", control = rpart.control(minsplit = 2, cp = 0))</span></span>
<span id="cb63-1611"><a href="#cb63-1611" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1612"><a href="#cb63-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1613"><a href="#cb63-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1614"><a href="#cb63-1614" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesRF &lt;- evaluate_aparent_performance_model_rpart(data = data_factor, target_var = "PCR",</span></span>
<span id="cb63-1615"><a href="#cb63-1615" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             model_func = rf_model,</span></span>
<span id="cb63-1616"><a href="#cb63-1616" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             vars = ".",</span></span>
<span id="cb63-1617"><a href="#cb63-1617" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             threshold = .35)</span></span>
<span id="cb63-1618"><a href="#cb63-1618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1619"><a href="#cb63-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1620"><a href="#cb63-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1621"><a href="#cb63-1621" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/RandomForest_Aparente.RData")</span></span>
<span id="cb63-1622"><a href="#cb63-1622" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1623"><a href="#cb63-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1624"><a href="#cb63-1624" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-1625"><a href="#cb63-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1626"><a href="#cb63-1626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1627"><a href="#cb63-1627" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_rpart &lt;- function(data, target_name, outer, inner, cp_values, minsplit_values, variables, threshold, seed) {</span></span>
<span id="cb63-1628"><a href="#cb63-1628" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-1629"><a href="#cb63-1629" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-1630"><a href="#cb63-1630" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-1631"><a href="#cb63-1631" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_cp = numeric(), Best_minsplit = integer(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1632"><a href="#cb63-1632" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1633"><a href="#cb63-1633" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-1634"><a href="#cb63-1634" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer)</span></span>
<span id="cb63-1635"><a href="#cb63-1635" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1636"><a href="#cb63-1636" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1637"><a href="#cb63-1637" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1638"><a href="#cb63-1638" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1639"><a href="#cb63-1639" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1640"><a href="#cb63-1640" aria-hidden="true" tabindex="-1"></a><span class="in">    # Imprime la cantidad de instancias de cada clase en el outer train y test set</span></span>
<span id="cb63-1641"><a href="#cb63-1641" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1642"><a href="#cb63-1642" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1643"><a href="#cb63-1643" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1644"><a href="#cb63-1644" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1645"><a href="#cb63-1645" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1646"><a href="#cb63-1646" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1647"><a href="#cb63-1647" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-1648"><a href="#cb63-1648" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-1649"><a href="#cb63-1649" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-1650"><a href="#cb63-1650" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cp &lt;- NULL</span></span>
<span id="cb63-1651"><a href="#cb63-1651" aria-hidden="true" tabindex="-1"></a><span class="in">    best_minsplit &lt;- NULL</span></span>
<span id="cb63-1652"><a href="#cb63-1652" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1653"><a href="#cb63-1653" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(cp = cp_values, minsplit = minsplit_values)</span></span>
<span id="cb63-1654"><a href="#cb63-1654" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1655"><a href="#cb63-1655" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-1656"><a href="#cb63-1656" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-1657"><a href="#cb63-1657" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1658"><a href="#cb63-1658" aria-hidden="true" tabindex="-1"></a><span class="in">      for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1659"><a href="#cb63-1659" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1660"><a href="#cb63-1660" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1661"><a href="#cb63-1661" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1662"><a href="#cb63-1662" aria-hidden="true" tabindex="-1"></a><span class="in">        model &lt;- rpart(formula = as.formula(paste(target_name, "~", paste(variables, collapse = "+"))),</span></span>
<span id="cb63-1663"><a href="#cb63-1663" aria-hidden="true" tabindex="-1"></a><span class="in">                       data = inner_train_data, control = rpart.control(cp = grid$cp[params], minsplit = grid$minsplit[params]))</span></span>
<span id="cb63-1664"><a href="#cb63-1664" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1665"><a href="#cb63-1665" aria-hidden="true" tabindex="-1"></a><span class="in">        predictions &lt;- predict(model, inner_test_data, type = "prob")[, 2]</span></span>
<span id="cb63-1666"><a href="#cb63-1666" aria-hidden="true" tabindex="-1"></a><span class="in">        roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1667"><a href="#cb63-1667" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1668"><a href="#cb63-1668" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1669"><a href="#cb63-1669" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1670"><a href="#cb63-1670" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc) &gt; best_auc) {</span></span>
<span id="cb63-1671"><a href="#cb63-1671" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc = mean(inner_auc)</span></span>
<span id="cb63-1672"><a href="#cb63-1672" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model = model</span></span>
<span id="cb63-1673"><a href="#cb63-1673" aria-hidden="true" tabindex="-1"></a><span class="in">        best_cp = grid$cp[params]</span></span>
<span id="cb63-1674"><a href="#cb63-1674" aria-hidden="true" tabindex="-1"></a><span class="in">        best_minsplit = grid$minsplit[params]</span></span>
<span id="cb63-1675"><a href="#cb63-1675" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1676"><a href="#cb63-1676" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1677"><a href="#cb63-1677" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1678"><a href="#cb63-1678" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "prob")[, 2]</span></span>
<span id="cb63-1679"><a href="#cb63-1679" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-1680"><a href="#cb63-1680" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1681"><a href="#cb63-1681" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1682"><a href="#cb63-1682" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-1683"><a href="#cb63-1683" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1684"><a href="#cb63-1684" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1685"><a href="#cb63-1685" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1686"><a href="#cb63-1686" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1687"><a href="#cb63-1687" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-1688"><a href="#cb63-1688" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-1689"><a href="#cb63-1689" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-1690"><a href="#cb63-1690" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-1691"><a href="#cb63-1691" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-1692"><a href="#cb63-1692" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1693"><a href="#cb63-1693" aria-hidden="true" tabindex="-1"></a><span class="in">    auc = roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-1694"><a href="#cb63-1694" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1695"><a href="#cb63-1695" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, best_cp, best_minsplit), names(performance_metrics))</span></span>
<span id="cb63-1696"><a href="#cb63-1696" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-1697"><a href="#cb63-1697" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1698"><a href="#cb63-1698" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1699"><a href="#cb63-1699" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-1700"><a href="#cb63-1700" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1701"><a href="#cb63-1701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1702"><a href="#cb63-1702" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_RandomForest_TodasVariables_Asociacion &lt;- </span></span>
<span id="cb63-1703"><a href="#cb63-1703" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span></span>
<span id="cb63-1704"><a href="#cb63-1704" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-1705"><a href="#cb63-1705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1706"><a href="#cb63-1706" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-1707"><a href="#cb63-1707" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-1708"><a href="#cb63-1708" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-1709"><a href="#cb63-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1710"><a href="#cb63-1710" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-1711"><a href="#cb63-1711" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-1712"><a href="#cb63-1712" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-1713"><a href="#cb63-1713" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-1714"><a href="#cb63-1714" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-1715"><a href="#cb63-1715" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-1716"><a href="#cb63-1716" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-1717"><a href="#cb63-1717" aria-hidden="true" tabindex="-1"></a><span class="in">                                   cp_values = cp_values,</span></span>
<span id="cb63-1718"><a href="#cb63-1718" aria-hidden="true" tabindex="-1"></a><span class="in">                                   minsplit_values = minsplit_values)</span></span>
<span id="cb63-1719"><a href="#cb63-1719" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-1720"><a href="#cb63-1720" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1721"><a href="#cb63-1721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1722"><a href="#cb63-1722" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-1723"><a href="#cb63-1723" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1724"><a href="#cb63-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1725"><a href="#cb63-1725" aria-hidden="true" tabindex="-1"></a><span class="in">performance_rpart_todasvariables &lt;- evaluate_with_seeds_RandomForest_TodasVariables_Asociacion(</span></span>
<span id="cb63-1726"><a href="#cb63-1726" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_rpart,</span></span>
<span id="cb63-1727"><a href="#cb63-1727" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1728"><a href="#cb63-1728" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1729"><a href="#cb63-1729" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1730"><a href="#cb63-1730" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1731"><a href="#cb63-1731" aria-hidden="true" tabindex="-1"></a><span class="in">  cp_values = c(0.001, 0.01, 0.1),</span></span>
<span id="cb63-1732"><a href="#cb63-1732" aria-hidden="true" tabindex="-1"></a><span class="in">  minsplit_values = c(2, 5, 10, 15, 20),</span></span>
<span id="cb63-1733"><a href="#cb63-1733" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-1734"><a href="#cb63-1734" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1735"><a href="#cb63-1735" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-1736"><a href="#cb63-1736" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1737"><a href="#cb63-1737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1738"><a href="#cb63-1738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1739"><a href="#cb63-1739" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1740"><a href="#cb63-1740" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/RandomForest_TodasVariables.RData")</span></span>
<span id="cb63-1741"><a href="#cb63-1741" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1742"><a href="#cb63-1742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1743"><a href="#cb63-1743" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-1744"><a href="#cb63-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1745"><a href="#cb63-1745" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1746"><a href="#cb63-1746" aria-hidden="true" tabindex="-1"></a><span class="in">performance_rpart_Asociacion &lt;- evaluate_with_seeds_RandomForest_TodasVariables_Asociacion(</span></span>
<span id="cb63-1747"><a href="#cb63-1747" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_rpart,</span></span>
<span id="cb63-1748"><a href="#cb63-1748" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1749"><a href="#cb63-1749" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1750"><a href="#cb63-1750" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1751"><a href="#cb63-1751" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1752"><a href="#cb63-1752" aria-hidden="true" tabindex="-1"></a><span class="in">  cp_values = c(0.001, 0.01, 0.1),</span></span>
<span id="cb63-1753"><a href="#cb63-1753" aria-hidden="true" tabindex="-1"></a><span class="in">  minsplit_values = c(2, 5, 10, 15, 20),</span></span>
<span id="cb63-1754"><a href="#cb63-1754" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = asociacion,</span></span>
<span id="cb63-1755"><a href="#cb63-1755" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1756"><a href="#cb63-1756" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-1757"><a href="#cb63-1757" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1758"><a href="#cb63-1758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1759"><a href="#cb63-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1760"><a href="#cb63-1760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1761"><a href="#cb63-1761" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/RandomForest_Asociacion.RData")</span></span>
<span id="cb63-1762"><a href="#cb63-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1763"><a href="#cb63-1763" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-1764"><a href="#cb63-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1765"><a href="#cb63-1765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1766"><a href="#cb63-1766" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_rpart_stepAUC &lt;- function(data, target_name, outer, inner, cps, minsplits, variables, threshold, seed) {</span></span>
<span id="cb63-1767"><a href="#cb63-1767" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-1768"><a href="#cb63-1768" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-1769"><a href="#cb63-1769" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-1770"><a href="#cb63-1770" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_CP = numeric(), Best_Minsplit = integer(), </span></span>
<span id="cb63-1771"><a href="#cb63-1771" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1772"><a href="#cb63-1772" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1773"><a href="#cb63-1773" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-1774"><a href="#cb63-1774" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-1775"><a href="#cb63-1775" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1776"><a href="#cb63-1776" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1777"><a href="#cb63-1777" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-1778"><a href="#cb63-1778" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer)</span></span>
<span id="cb63-1779"><a href="#cb63-1779" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1780"><a href="#cb63-1780" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1781"><a href="#cb63-1781" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1782"><a href="#cb63-1782" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1783"><a href="#cb63-1783" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1784"><a href="#cb63-1784" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1785"><a href="#cb63-1785" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1786"><a href="#cb63-1786" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1787"><a href="#cb63-1787" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-1788"><a href="#cb63-1788" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-1789"><a href="#cb63-1789" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1790"><a href="#cb63-1790" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-1791"><a href="#cb63-1791" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-1792"><a href="#cb63-1792" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-1793"><a href="#cb63-1793" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cp &lt;- NULL</span></span>
<span id="cb63-1794"><a href="#cb63-1794" aria-hidden="true" tabindex="-1"></a><span class="in">    best_minsplit &lt;- NULL</span></span>
<span id="cb63-1795"><a href="#cb63-1795" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-1796"><a href="#cb63-1796" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1797"><a href="#cb63-1797" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(cp = cps, minsplit = minsplits)</span></span>
<span id="cb63-1798"><a href="#cb63-1798" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1799"><a href="#cb63-1799" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-1800"><a href="#cb63-1800" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-1801"><a href="#cb63-1801" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-1802"><a href="#cb63-1802" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-1803"><a href="#cb63-1803" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_cp &lt;- NULL</span></span>
<span id="cb63-1804"><a href="#cb63-1804" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_minsplit &lt;- NULL</span></span>
<span id="cb63-1805"><a href="#cb63-1805" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-1806"><a href="#cb63-1806" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-1807"><a href="#cb63-1807" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1808"><a href="#cb63-1808" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-1809"><a href="#cb63-1809" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-1810"><a href="#cb63-1810" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-1811"><a href="#cb63-1811" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1812"><a href="#cb63-1812" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-1813"><a href="#cb63-1813" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-1814"><a href="#cb63-1814" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-1815"><a href="#cb63-1815" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-1816"><a href="#cb63-1816" aria-hidden="true" tabindex="-1"></a><span class="in">          for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-1817"><a href="#cb63-1817" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals &lt;- numeric()</span></span>
<span id="cb63-1818"><a href="#cb63-1818" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1819"><a href="#cb63-1819" aria-hidden="true" tabindex="-1"></a><span class="in">            for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1820"><a href="#cb63-1820" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1821"><a href="#cb63-1821" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1822"><a href="#cb63-1822" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-1823"><a href="#cb63-1823" aria-hidden="true" tabindex="-1"></a><span class="in">              result &lt;- tryCatch({</span></span>
<span id="cb63-1824"><a href="#cb63-1824" aria-hidden="true" tabindex="-1"></a><span class="in">                model &lt;- rpart(as.formula(paste(target_name, "~", paste(temp_vars, collapse = "+"))),</span></span>
<span id="cb63-1825"><a href="#cb63-1825" aria-hidden="true" tabindex="-1"></a><span class="in">                               data = inner_train_data, control = rpart.control(cp = grid$cp[params], minsplit = grid$minsplit[params]))</span></span>
<span id="cb63-1826"><a href="#cb63-1826" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-1827"><a href="#cb63-1827" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- predict(model, inner_test_data, type = "prob")[, 2]</span></span>
<span id="cb63-1828"><a href="#cb63-1828" aria-hidden="true" tabindex="-1"></a><span class="in">                roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1829"><a href="#cb63-1829" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1830"><a href="#cb63-1830" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-1831"><a href="#cb63-1831" aria-hidden="true" tabindex="-1"></a><span class="in">              }, error = function(e) {</span></span>
<span id="cb63-1832"><a href="#cb63-1832" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-1833"><a href="#cb63-1833" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- 0</span></span>
<span id="cb63-1834"><a href="#cb63-1834" aria-hidden="true" tabindex="-1"></a><span class="in">              })</span></span>
<span id="cb63-1835"><a href="#cb63-1835" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-1836"><a href="#cb63-1836" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-1837"><a href="#cb63-1837" aria-hidden="true" tabindex="-1"></a><span class="in">            if (mean(auc_vals, na.rm = TRUE) &gt; best_auc_in_step) {</span></span>
<span id="cb63-1838"><a href="#cb63-1838" aria-hidden="true" tabindex="-1"></a><span class="in">              best_auc_in_step &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1839"><a href="#cb63-1839" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_model &lt;- model</span></span>
<span id="cb63-1840"><a href="#cb63-1840" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_cp &lt;- grid$cp[params]</span></span>
<span id="cb63-1841"><a href="#cb63-1841" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_minsplit &lt;- grid$minsplit[params]</span></span>
<span id="cb63-1842"><a href="#cb63-1842" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-1843"><a href="#cb63-1843" aria-hidden="true" tabindex="-1"></a><span class="in">              improved &lt;- TRUE</span></span>
<span id="cb63-1844"><a href="#cb63-1844" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-1845"><a href="#cb63-1845" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-1846"><a href="#cb63-1846" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1847"><a href="#cb63-1847" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-1848"><a href="#cb63-1848" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-1849"><a href="#cb63-1849" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-1850"><a href="#cb63-1850" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-1851"><a href="#cb63-1851" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-1852"><a href="#cb63-1852" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-1853"><a href="#cb63-1853" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-1854"><a href="#cb63-1854" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-1855"><a href="#cb63-1855" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1856"><a href="#cb63-1856" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-1857"><a href="#cb63-1857" aria-hidden="true" tabindex="-1"></a><span class="in">           cp = best_inner_cp, minsplit = best_inner_minsplit, </span></span>
<span id="cb63-1858"><a href="#cb63-1858" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-1859"><a href="#cb63-1859" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1860"><a href="#cb63-1860" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1861"><a href="#cb63-1861" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-1862"><a href="#cb63-1862" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-1863"><a href="#cb63-1863" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-1864"><a href="#cb63-1864" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cp &lt;- best_result$cp</span></span>
<span id="cb63-1865"><a href="#cb63-1865" aria-hidden="true" tabindex="-1"></a><span class="in">    best_minsplit &lt;- best_result$minsplit</span></span>
<span id="cb63-1866"><a href="#cb63-1866" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-1867"><a href="#cb63-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1868"><a href="#cb63-1868" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-1869"><a href="#cb63-1869" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-1870"><a href="#cb63-1870" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-1871"><a href="#cb63-1871" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1872"><a href="#cb63-1872" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-1873"><a href="#cb63-1873" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1874"><a href="#cb63-1874" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, type = "prob")[, 2]</span></span>
<span id="cb63-1875"><a href="#cb63-1875" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-1876"><a href="#cb63-1876" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-1877"><a href="#cb63-1877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1878"><a href="#cb63-1878" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-1879"><a href="#cb63-1879" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1880"><a href="#cb63-1880" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1881"><a href="#cb63-1881" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1882"><a href="#cb63-1882" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1883"><a href="#cb63-1883" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1884"><a href="#cb63-1884" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-1885"><a href="#cb63-1885" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-1886"><a href="#cb63-1886" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-1887"><a href="#cb63-1887" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-1888"><a href="#cb63-1888" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1889"><a href="#cb63-1889" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1890"><a href="#cb63-1890" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-1891"><a href="#cb63-1891" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1892"><a href="#cb63-1892" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "prob")[, 2]</span></span>
<span id="cb63-1893"><a href="#cb63-1893" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, "1", "0")</span></span>
<span id="cb63-1894"><a href="#cb63-1894" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-1895"><a href="#cb63-1895" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1896"><a href="#cb63-1896" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-1897"><a href="#cb63-1897" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-1898"><a href="#cb63-1898" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-1899"><a href="#cb63-1899" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-1900"><a href="#cb63-1900" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-1901"><a href="#cb63-1901" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-1902"><a href="#cb63-1902" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-1903"><a href="#cb63-1903" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-1904"><a href="#cb63-1904" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-1905"><a href="#cb63-1905" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-1906"><a href="#cb63-1906" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-1907"><a href="#cb63-1907" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-1908"><a href="#cb63-1908" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1909"><a href="#cb63-1909" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-1910"><a href="#cb63-1910" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_cp, best_minsplit, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-1911"><a href="#cb63-1911" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-1912"><a href="#cb63-1912" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-1913"><a href="#cb63-1913" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1914"><a href="#cb63-1914" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-1915"><a href="#cb63-1915" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1916"><a href="#cb63-1916" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-1917"><a href="#cb63-1917" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-1918"><a href="#cb63-1918" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best CP: %f, Best Minsplit: %d, Best Variables: %s\n",</span></span>
<span id="cb63-1919"><a href="#cb63-1919" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_cp, best_minsplit, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-1920"><a href="#cb63-1920" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1921"><a href="#cb63-1921" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1922"><a href="#cb63-1922" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-1923"><a href="#cb63-1923" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-1924"><a href="#cb63-1924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1925"><a href="#cb63-1925" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_RandomForest_StepAUC &lt;- </span></span>
<span id="cb63-1926"><a href="#cb63-1926" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span></span>
<span id="cb63-1927"><a href="#cb63-1927" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-1928"><a href="#cb63-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1929"><a href="#cb63-1929" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-1930"><a href="#cb63-1930" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-1931"><a href="#cb63-1931" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-1932"><a href="#cb63-1932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1933"><a href="#cb63-1933" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-1934"><a href="#cb63-1934" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-1935"><a href="#cb63-1935" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-1936"><a href="#cb63-1936" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-1937"><a href="#cb63-1937" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-1938"><a href="#cb63-1938" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-1939"><a href="#cb63-1939" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-1940"><a href="#cb63-1940" aria-hidden="true" tabindex="-1"></a><span class="in">                                   cp_values = cp_values,</span></span>
<span id="cb63-1941"><a href="#cb63-1941" aria-hidden="true" tabindex="-1"></a><span class="in">                                   minsplit_values = minsplit_values)</span></span>
<span id="cb63-1942"><a href="#cb63-1942" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-1943"><a href="#cb63-1943" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1944"><a href="#cb63-1944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1945"><a href="#cb63-1945" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-1946"><a href="#cb63-1946" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-1947"><a href="#cb63-1947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1948"><a href="#cb63-1948" aria-hidden="true" tabindex="-1"></a><span class="in">performance_rpart_StepAUC &lt;- evaluate_with_seeds_RandomForest_StepAUC(</span></span>
<span id="cb63-1949"><a href="#cb63-1949" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_rpart,</span></span>
<span id="cb63-1950"><a href="#cb63-1950" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-1951"><a href="#cb63-1951" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-1952"><a href="#cb63-1952" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-1953"><a href="#cb63-1953" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-1954"><a href="#cb63-1954" aria-hidden="true" tabindex="-1"></a><span class="in">  cp_values = c(0.001, 0.01, 0.1),</span></span>
<span id="cb63-1955"><a href="#cb63-1955" aria-hidden="true" tabindex="-1"></a><span class="in">  minsplit_values = c(2, 5, 10, 15, 20),</span></span>
<span id="cb63-1956"><a href="#cb63-1956" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-1957"><a href="#cb63-1957" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-1958"><a href="#cb63-1958" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-1959"><a href="#cb63-1959" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-1960"><a href="#cb63-1960" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1961"><a href="#cb63-1961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1962"><a href="#cb63-1962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-1963"><a href="#cb63-1963" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/RandomForest_StepAUC.RData")</span></span>
<span id="cb63-1964"><a href="#cb63-1964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-1965"><a href="#cb63-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1966"><a href="#cb63-1966" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-1967"><a href="#cb63-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-1968"><a href="#cb63-1968" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-1969"><a href="#cb63-1969" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_rpart_Lasso &lt;- function(data, target_name, outer, inner, cps, minsplits, variables, threshold, seed) {</span></span>
<span id="cb63-1970"><a href="#cb63-1970" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-1971"><a href="#cb63-1971" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-1972"><a href="#cb63-1972" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-1973"><a href="#cb63-1973" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_cp = numeric(), Best_minsplit = numeric(), </span></span>
<span id="cb63-1974"><a href="#cb63-1974" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1975"><a href="#cb63-1975" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1976"><a href="#cb63-1976" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-1977"><a href="#cb63-1977" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-1978"><a href="#cb63-1978" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-1979"><a href="#cb63-1979" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1980"><a href="#cb63-1980" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-1981"><a href="#cb63-1981" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.numeric(data[[target_name]]) - 1</span></span>
<span id="cb63-1982"><a href="#cb63-1982" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-1983"><a href="#cb63-1983" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-1984"><a href="#cb63-1984" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-1985"><a href="#cb63-1985" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1986"><a href="#cb63-1986" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-1987"><a href="#cb63-1987" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-1988"><a href="#cb63-1988" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-1989"><a href="#cb63-1989" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1990"><a href="#cb63-1990" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-1991"><a href="#cb63-1991" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1992"><a href="#cb63-1992" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-1993"><a href="#cb63-1993" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1994"><a href="#cb63-1994" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1995"><a href="#cb63-1995" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-1996"><a href="#cb63-1996" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-1997"><a href="#cb63-1997" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-1998"><a href="#cb63-1998" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-1999"><a href="#cb63-1999" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-2000"><a href="#cb63-2000" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-2001"><a href="#cb63-2001" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cp &lt;- NULL</span></span>
<span id="cb63-2002"><a href="#cb63-2002" aria-hidden="true" tabindex="-1"></a><span class="in">    best_minsplit &lt;- NULL</span></span>
<span id="cb63-2003"><a href="#cb63-2003" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-2004"><a href="#cb63-2004" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2005"><a href="#cb63-2005" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(cp = cps, minsplit = minsplits)</span></span>
<span id="cb63-2006"><a href="#cb63-2006" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2007"><a href="#cb63-2007" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-2008"><a href="#cb63-2008" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]])</span></span>
<span id="cb63-2009"><a href="#cb63-2009" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-2010"><a href="#cb63-2010" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-2011"><a href="#cb63-2011" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-2012"><a href="#cb63-2012" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2013"><a href="#cb63-2013" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-2014"><a href="#cb63-2014" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-2015"><a href="#cb63-2015" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-2016"><a href="#cb63-2016" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2017"><a href="#cb63-2017" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-2018"><a href="#cb63-2018" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-2019"><a href="#cb63-2019" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-2020"><a href="#cb63-2020" aria-hidden="true" tabindex="-1"></a><span class="in">      #cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-2021"><a href="#cb63-2021" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-2022"><a href="#cb63-2022" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2023"><a href="#cb63-2023" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2024"><a href="#cb63-2024" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-2025"><a href="#cb63-2025" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-2026"><a href="#cb63-2026" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-2027"><a href="#cb63-2027" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_cp &lt;- NULL</span></span>
<span id="cb63-2028"><a href="#cb63-2028" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_minsplit &lt;- NULL</span></span>
<span id="cb63-2029"><a href="#cb63-2029" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-2030"><a href="#cb63-2030" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-2031"><a href="#cb63-2031" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2032"><a href="#cb63-2032" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-2033"><a href="#cb63-2033" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-2034"><a href="#cb63-2034" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-2035"><a href="#cb63-2035" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2036"><a href="#cb63-2036" aria-hidden="true" tabindex="-1"></a><span class="in">        for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-2037"><a href="#cb63-2037" aria-hidden="true" tabindex="-1"></a><span class="in">          auc_vals &lt;- numeric()</span></span>
<span id="cb63-2038"><a href="#cb63-2038" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-2039"><a href="#cb63-2039" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2040"><a href="#cb63-2040" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2041"><a href="#cb63-2041" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2042"><a href="#cb63-2042" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2043"><a href="#cb63-2043" aria-hidden="true" tabindex="-1"></a><span class="in">            selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-2044"><a href="#cb63-2044" aria-hidden="true" tabindex="-1"></a><span class="in">            formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-2045"><a href="#cb63-2045" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-2046"><a href="#cb63-2046" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Grid parameters - cp: ", grid$cp[params], ", minsplit: ", grid$minsplit[params], "\n")</span></span>
<span id="cb63-2047"><a href="#cb63-2047" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2048"><a href="#cb63-2048" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-2049"><a href="#cb63-2049" aria-hidden="true" tabindex="-1"></a><span class="in">              model &lt;- rpart(formula, data = inner_train_data, method = "class", </span></span>
<span id="cb63-2050"><a href="#cb63-2050" aria-hidden="true" tabindex="-1"></a><span class="in">                             control = rpart.control(cp = grid$cp[params], minsplit = grid$minsplit[params]))</span></span>
<span id="cb63-2051"><a href="#cb63-2051" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2052"><a href="#cb63-2052" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- predict(model, inner_test_data, type = "prob")[,2]</span></span>
<span id="cb63-2053"><a href="#cb63-2053" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-2054"><a href="#cb63-2054" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2055"><a href="#cb63-2055" aria-hidden="true" tabindex="-1"></a><span class="in">              #cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-2056"><a href="#cb63-2056" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2057"><a href="#cb63-2057" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-2058"><a href="#cb63-2058" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-2059"><a href="#cb63-2059" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-2060"><a href="#cb63-2060" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-2061"><a href="#cb63-2061" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-2062"><a href="#cb63-2062" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-2063"><a href="#cb63-2063" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-2064"><a href="#cb63-2064" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2065"><a href="#cb63-2065" aria-hidden="true" tabindex="-1"></a><span class="in">          #cat("Mean AUC for params - cp: ", grid$cp[params], ", minsplit: ", grid$minsplit[params], ": ", mean_auc, "\n")</span></span>
<span id="cb63-2066"><a href="#cb63-2066" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-2067"><a href="#cb63-2067" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-2068"><a href="#cb63-2068" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- model</span></span>
<span id="cb63-2069"><a href="#cb63-2069" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_cp &lt;- grid$cp[params]</span></span>
<span id="cb63-2070"><a href="#cb63-2070" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_minsplit &lt;- grid$minsplit[params]</span></span>
<span id="cb63-2071"><a href="#cb63-2071" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-2072"><a href="#cb63-2072" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-2073"><a href="#cb63-2073" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-2074"><a href="#cb63-2074" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2075"><a href="#cb63-2075" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2076"><a href="#cb63-2076" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-2077"><a href="#cb63-2077" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-2078"><a href="#cb63-2078" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-2079"><a href="#cb63-2079" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-2080"><a href="#cb63-2080" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-2081"><a href="#cb63-2081" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2082"><a href="#cb63-2082" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-2083"><a href="#cb63-2083" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2084"><a href="#cb63-2084" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-2085"><a href="#cb63-2085" aria-hidden="true" tabindex="-1"></a><span class="in">           cp = best_inner_cp, minsplit = best_inner_minsplit, </span></span>
<span id="cb63-2086"><a href="#cb63-2086" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-2087"><a href="#cb63-2087" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2088"><a href="#cb63-2088" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2089"><a href="#cb63-2089" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-2090"><a href="#cb63-2090" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-2091"><a href="#cb63-2091" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-2092"><a href="#cb63-2092" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cp &lt;- best_result$cp</span></span>
<span id="cb63-2093"><a href="#cb63-2093" aria-hidden="true" tabindex="-1"></a><span class="in">    best_minsplit &lt;- best_result$minsplit</span></span>
<span id="cb63-2094"><a href="#cb63-2094" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-2095"><a href="#cb63-2095" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2096"><a href="#cb63-2096" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-2097"><a href="#cb63-2097" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-2098"><a href="#cb63-2098" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-2099"><a href="#cb63-2099" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2100"><a href="#cb63-2100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2101"><a href="#cb63-2101" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-2102"><a href="#cb63-2102" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-2103"><a href="#cb63-2103" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2104"><a href="#cb63-2104" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2105"><a href="#cb63-2105" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2106"><a href="#cb63-2106" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2107"><a href="#cb63-2107" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, type = "prob")[,2]</span></span>
<span id="cb63-2108"><a href="#cb63-2108" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-2109"><a href="#cb63-2109" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2110"><a href="#cb63-2110" aria-hidden="true" tabindex="-1"></a><span class="in">      #cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-2111"><a href="#cb63-2111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2112"><a href="#cb63-2112" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-2113"><a href="#cb63-2113" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-2114"><a href="#cb63-2114" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2115"><a href="#cb63-2115" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2116"><a href="#cb63-2116" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2117"><a href="#cb63-2117" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2118"><a href="#cb63-2118" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-2119"><a href="#cb63-2119" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2120"><a href="#cb63-2120" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-2121"><a href="#cb63-2121" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-2122"><a href="#cb63-2122" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2123"><a href="#cb63-2123" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2124"><a href="#cb63-2124" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2125"><a href="#cb63-2125" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-2126"><a href="#cb63-2126" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2127"><a href="#cb63-2127" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "prob")[,2]</span></span>
<span id="cb63-2128"><a href="#cb63-2128" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-2129"><a href="#cb63-2129" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-2130"><a href="#cb63-2130" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2131"><a href="#cb63-2131" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-2132"><a href="#cb63-2132" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2133"><a href="#cb63-2133" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2134"><a href="#cb63-2134" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2135"><a href="#cb63-2135" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2136"><a href="#cb63-2136" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-2137"><a href="#cb63-2137" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-2138"><a href="#cb63-2138" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-2139"><a href="#cb63-2139" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-2140"><a href="#cb63-2140" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-2141"><a href="#cb63-2141" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2142"><a href="#cb63-2142" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-2143"><a href="#cb63-2143" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2144"><a href="#cb63-2144" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-2145"><a href="#cb63-2145" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_cp, best_minsplit, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-2146"><a href="#cb63-2146" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-2147"><a href="#cb63-2147" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-2148"><a href="#cb63-2148" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2149"><a href="#cb63-2149" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-2150"><a href="#cb63-2150" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2151"><a href="#cb63-2151" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-2152"><a href="#cb63-2152" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2153"><a href="#cb63-2153" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best cp: %f, Best minsplit: %d, Best Variables: %s\n",</span></span>
<span id="cb63-2154"><a href="#cb63-2154" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_cp, best_minsplit, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-2155"><a href="#cb63-2155" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2156"><a href="#cb63-2156" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2157"><a href="#cb63-2157" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-2158"><a href="#cb63-2158" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2159"><a href="#cb63-2159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2160"><a href="#cb63-2160" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_RandomForest_lasso &lt;- </span></span>
<span id="cb63-2161"><a href="#cb63-2161" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, cp_values, minsplit_values) {</span></span>
<span id="cb63-2162"><a href="#cb63-2162" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-2163"><a href="#cb63-2163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2164"><a href="#cb63-2164" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-2165"><a href="#cb63-2165" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-2166"><a href="#cb63-2166" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-2167"><a href="#cb63-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2168"><a href="#cb63-2168" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-2169"><a href="#cb63-2169" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-2170"><a href="#cb63-2170" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-2171"><a href="#cb63-2171" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-2172"><a href="#cb63-2172" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-2173"><a href="#cb63-2173" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-2174"><a href="#cb63-2174" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-2175"><a href="#cb63-2175" aria-hidden="true" tabindex="-1"></a><span class="in">                                   cps = cp_values,</span></span>
<span id="cb63-2176"><a href="#cb63-2176" aria-hidden="true" tabindex="-1"></a><span class="in">                                   minsplits = minsplit_values)</span></span>
<span id="cb63-2177"><a href="#cb63-2177" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-2178"><a href="#cb63-2178" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2179"><a href="#cb63-2179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2180"><a href="#cb63-2180" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-2181"><a href="#cb63-2181" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2182"><a href="#cb63-2182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2183"><a href="#cb63-2183" aria-hidden="true" tabindex="-1"></a><span class="in">performance_rpart_lasso &lt;- evaluate_with_seeds_RandomForest_lasso(</span></span>
<span id="cb63-2184"><a href="#cb63-2184" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_rpart_Lasso,</span></span>
<span id="cb63-2185"><a href="#cb63-2185" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-2186"><a href="#cb63-2186" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-2187"><a href="#cb63-2187" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-2188"><a href="#cb63-2188" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-2189"><a href="#cb63-2189" aria-hidden="true" tabindex="-1"></a><span class="in">  cp_values = c(0.001, 0.01, 0.1),</span></span>
<span id="cb63-2190"><a href="#cb63-2190" aria-hidden="true" tabindex="-1"></a><span class="in">  minsplit_values = c(2, 5, 10, 15, 20),</span></span>
<span id="cb63-2191"><a href="#cb63-2191" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-2192"><a href="#cb63-2192" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-2193"><a href="#cb63-2193" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-2194"><a href="#cb63-2194" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-2195"><a href="#cb63-2195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2196"><a href="#cb63-2196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2197"><a href="#cb63-2197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2198"><a href="#cb63-2198" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/RandomForest_Lasso.RData")</span></span>
<span id="cb63-2199"><a href="#cb63-2199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2200"><a href="#cb63-2200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2201"><a href="#cb63-2201" aria-hidden="true" tabindex="-1"></a><span class="fu">## K-Nearest Neighbours </span></span>
<span id="cb63-2202"><a href="#cb63-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2203"><a href="#cb63-2203" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-2204"><a href="#cb63-2204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2205"><a href="#cb63-2205" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2206"><a href="#cb63-2206" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_knn &lt;- function(data, target_var, model_func, vars = NULL, threshold = 0.5) {</span></span>
<span id="cb63-2207"><a href="#cb63-2207" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-2208"><a href="#cb63-2208" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-2209"><a href="#cb63-2209" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2210"><a href="#cb63-2210" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2211"><a href="#cb63-2211" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-2212"><a href="#cb63-2212" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-2213"><a href="#cb63-2213" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2214"><a href="#cb63-2214" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data)</span></span>
<span id="cb63-2215"><a href="#cb63-2215" aria-hidden="true" tabindex="-1"></a><span class="in">  train_x &lt;- model$train_x</span></span>
<span id="cb63-2216"><a href="#cb63-2216" aria-hidden="true" tabindex="-1"></a><span class="in">  train_y &lt;- model$train_y</span></span>
<span id="cb63-2217"><a href="#cb63-2217" aria-hidden="true" tabindex="-1"></a><span class="in">  test_x &lt;- model.matrix(formula, data)[, -1]</span></span>
<span id="cb63-2218"><a href="#cb63-2218" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- knn(train = train_x, test = test_x, cl = train_y, k = model$k, prob = TRUE)</span></span>
<span id="cb63-2219"><a href="#cb63-2219" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2220"><a href="#cb63-2220" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2221"><a href="#cb63-2221" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-2222"><a href="#cb63-2222" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-2223"><a href="#cb63-2223" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(predicted_classes, actual_classes)</span></span>
<span id="cb63-2224"><a href="#cb63-2224" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2225"><a href="#cb63-2225" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-2226"><a href="#cb63-2226" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-2227"><a href="#cb63-2227" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-2228"><a href="#cb63-2228" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-2229"><a href="#cb63-2229" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2230"><a href="#cb63-2230" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-2231"><a href="#cb63-2231" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-2232"><a href="#cb63-2232" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-2233"><a href="#cb63-2233" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-2234"><a href="#cb63-2234" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-2235"><a href="#cb63-2235" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2236"><a href="#cb63-2236" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-2237"><a href="#cb63-2237" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-2238"><a href="#cb63-2238" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2239"><a href="#cb63-2239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2240"><a href="#cb63-2240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2241"><a href="#cb63-2241" aria-hidden="true" tabindex="-1"></a><span class="in">knn_model &lt;- function(formula, data) {</span></span>
<span id="cb63-2242"><a href="#cb63-2242" aria-hidden="true" tabindex="-1"></a><span class="in">  train_x &lt;- model.matrix(formula, data)[, -1]</span></span>
<span id="cb63-2243"><a href="#cb63-2243" aria-hidden="true" tabindex="-1"></a><span class="in">  train_y &lt;- data[[all.vars(formula)[1]]]</span></span>
<span id="cb63-2244"><a href="#cb63-2244" aria-hidden="true" tabindex="-1"></a><span class="in">  list(train_x = train_x, train_y = train_y, k = 5)  </span></span>
<span id="cb63-2245"><a href="#cb63-2245" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2246"><a href="#cb63-2246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2247"><a href="#cb63-2247" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesKNN &lt;- evaluate_aparent_performance_model_knn(data = data_numeric, target_var = "PCR",</span></span>
<span id="cb63-2248"><a href="#cb63-2248" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             model_func = knn_model,</span></span>
<span id="cb63-2249"><a href="#cb63-2249" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             vars = ".",</span></span>
<span id="cb63-2250"><a href="#cb63-2250" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             threshold = .35)</span></span>
<span id="cb63-2251"><a href="#cb63-2251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2252"><a href="#cb63-2252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2253"><a href="#cb63-2253" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2254"><a href="#cb63-2254" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/KNN_Aparente.RData")</span></span>
<span id="cb63-2255"><a href="#cb63-2255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2256"><a href="#cb63-2256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2257"><a href="#cb63-2257" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-2258"><a href="#cb63-2258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2259"><a href="#cb63-2259" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2260"><a href="#cb63-2260" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_knn &lt;- function(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span></span>
<span id="cb63-2261"><a href="#cb63-2261" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-2262"><a href="#cb63-2262" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-2263"><a href="#cb63-2263" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-2264"><a href="#cb63-2264" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_k = integer(), Best_l = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2265"><a href="#cb63-2265" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2266"><a href="#cb63-2266" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-2267"><a href="#cb63-2267" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2268"><a href="#cb63-2268" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2269"><a href="#cb63-2269" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-2270"><a href="#cb63-2270" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2271"><a href="#cb63-2271" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2272"><a href="#cb63-2272" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2273"><a href="#cb63-2273" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-2274"><a href="#cb63-2274" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2275"><a href="#cb63-2275" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2276"><a href="#cb63-2276" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2277"><a href="#cb63-2277" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2278"><a href="#cb63-2278" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2279"><a href="#cb63-2279" aria-hidden="true" tabindex="-1"></a><span class="in">    if (sum(outer_train_data[[target_name]] == "0") == 0 || sum(outer_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-2280"><a href="#cb63-2280" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Skipping outer fold due to lack of class diversity\n")</span></span>
<span id="cb63-2281"><a href="#cb63-2281" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-2282"><a href="#cb63-2282" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2283"><a href="#cb63-2283" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2284"><a href="#cb63-2284" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2285"><a href="#cb63-2285" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-2286"><a href="#cb63-2286" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-2287"><a href="#cb63-2287" aria-hidden="true" tabindex="-1"></a><span class="in">    best_k &lt;- NULL</span></span>
<span id="cb63-2288"><a href="#cb63-2288" aria-hidden="true" tabindex="-1"></a><span class="in">    best_l &lt;- NULL</span></span>
<span id="cb63-2289"><a href="#cb63-2289" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2290"><a href="#cb63-2290" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(k = ks, l = ls)</span></span>
<span id="cb63-2291"><a href="#cb63-2291" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- reformulate(variables, target_name)</span></span>
<span id="cb63-2292"><a href="#cb63-2292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2293"><a href="#cb63-2293" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-2294"><a href="#cb63-2294" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-2295"><a href="#cb63-2295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2296"><a href="#cb63-2296" aria-hidden="true" tabindex="-1"></a><span class="in">      for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2297"><a href="#cb63-2297" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2298"><a href="#cb63-2298" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2299"><a href="#cb63-2299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2300"><a href="#cb63-2300" aria-hidden="true" tabindex="-1"></a><span class="in">        if (sum(inner_train_data[[target_name]] == "0") == 0 || sum(inner_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-2301"><a href="#cb63-2301" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Skipping inner fold due to lack of class diversity\n")</span></span>
<span id="cb63-2302"><a href="#cb63-2302" aria-hidden="true" tabindex="-1"></a><span class="in">          next</span></span>
<span id="cb63-2303"><a href="#cb63-2303" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2304"><a href="#cb63-2304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2305"><a href="#cb63-2305" aria-hidden="true" tabindex="-1"></a><span class="in">        train_x &lt;- inner_train_data[, variables, drop = FALSE]</span></span>
<span id="cb63-2306"><a href="#cb63-2306" aria-hidden="true" tabindex="-1"></a><span class="in">        test_x &lt;- inner_test_data[, variables, drop = FALSE]</span></span>
<span id="cb63-2307"><a href="#cb63-2307" aria-hidden="true" tabindex="-1"></a><span class="in">        train_y &lt;- inner_train_data[[target_name]]</span></span>
<span id="cb63-2308"><a href="#cb63-2308" aria-hidden="true" tabindex="-1"></a><span class="in">        test_y &lt;- inner_test_data[[target_name]]</span></span>
<span id="cb63-2309"><a href="#cb63-2309" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2310"><a href="#cb63-2310" aria-hidden="true" tabindex="-1"></a><span class="in">        result &lt;- tryCatch({</span></span>
<span id="cb63-2311"><a href="#cb63-2311" aria-hidden="true" tabindex="-1"></a><span class="in">          predictions &lt;- knn(train = train_x, test = test_x, cl = train_y, k = grid$k[params], prob = TRUE)</span></span>
<span id="cb63-2312"><a href="#cb63-2312" aria-hidden="true" tabindex="-1"></a><span class="in">          probabilities &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2313"><a href="#cb63-2313" aria-hidden="true" tabindex="-1"></a><span class="in">          probabilities &lt;- ifelse(predictions == "1", probabilities, 1 - probabilities)</span></span>
<span id="cb63-2314"><a href="#cb63-2314" aria-hidden="true" tabindex="-1"></a><span class="in">          roc_curve &lt;- roc(as.numeric(as.character(test_y)), probabilities)</span></span>
<span id="cb63-2315"><a href="#cb63-2315" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2316"><a href="#cb63-2316" aria-hidden="true" tabindex="-1"></a><span class="in">        }, error = function(e) {</span></span>
<span id="cb63-2317"><a href="#cb63-2317" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error with parameters: k =", grid$k[params], ", l =", grid$l[params], "\n")</span></span>
<span id="cb63-2318"><a href="#cb63-2318" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-2319"><a href="#cb63-2319" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- 0</span></span>
<span id="cb63-2320"><a href="#cb63-2320" aria-hidden="true" tabindex="-1"></a><span class="in">        })</span></span>
<span id="cb63-2321"><a href="#cb63-2321" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-2322"><a href="#cb63-2322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2323"><a href="#cb63-2323" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc, na.rm = TRUE) &gt; best_auc) {</span></span>
<span id="cb63-2324"><a href="#cb63-2324" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-2325"><a href="#cb63-2325" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model &lt;- list(train_x = train_x, train_y = train_y, k = grid$k[params], l = grid$l[params])</span></span>
<span id="cb63-2326"><a href="#cb63-2326" aria-hidden="true" tabindex="-1"></a><span class="in">        best_k &lt;- grid$k[params]</span></span>
<span id="cb63-2327"><a href="#cb63-2327" aria-hidden="true" tabindex="-1"></a><span class="in">        best_l &lt;- grid$l[params]</span></span>
<span id="cb63-2328"><a href="#cb63-2328" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-2329"><a href="#cb63-2329" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2330"><a href="#cb63-2330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2331"><a href="#cb63-2331" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-2332"><a href="#cb63-2332" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-2333"><a href="#cb63-2333" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-2334"><a href="#cb63-2334" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2335"><a href="#cb63-2335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2336"><a href="#cb63-2336" aria-hidden="true" tabindex="-1"></a><span class="in">    test_x &lt;- outer_test_data[, variables, drop = FALSE]</span></span>
<span id="cb63-2337"><a href="#cb63-2337" aria-hidden="true" tabindex="-1"></a><span class="in">    test_y &lt;- outer_test_data[[target_name]]</span></span>
<span id="cb63-2338"><a href="#cb63-2338" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- knn(train = best_model$train_x, test = test_x, cl = best_model$train_y, k = best_k, prob = TRUE)</span></span>
<span id="cb63-2339"><a href="#cb63-2339" aria-hidden="true" tabindex="-1"></a><span class="in">    probabilities &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2340"><a href="#cb63-2340" aria-hidden="true" tabindex="-1"></a><span class="in">    probabilities &lt;- ifelse(predictions == "1", probabilities, 1 - probabilities)</span></span>
<span id="cb63-2341"><a href="#cb63-2341" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(probabilities &gt; threshold, "1", "0")</span></span>
<span id="cb63-2342"><a href="#cb63-2342" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = test_y, Predicted = pred_class)</span></span>
<span id="cb63-2343"><a href="#cb63-2343" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2344"><a href="#cb63-2344" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-2345"><a href="#cb63-2345" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2346"><a href="#cb63-2346" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2347"><a href="#cb63-2347" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2348"><a href="#cb63-2348" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2349"><a href="#cb63-2349" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-2350"><a href="#cb63-2350" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-2351"><a href="#cb63-2351" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-2352"><a href="#cb63-2352" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-2353"><a href="#cb63-2353" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-2354"><a href="#cb63-2354" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2355"><a href="#cb63-2355" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(test_y, probabilities)$auc</span></span>
<span id="cb63-2356"><a href="#cb63-2356" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2357"><a href="#cb63-2357" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, best_k, best_l), names(performance_metrics))</span></span>
<span id="cb63-2358"><a href="#cb63-2358" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-2359"><a href="#cb63-2359" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2360"><a href="#cb63-2360" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-2361"><a href="#cb63-2361" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2362"><a href="#cb63-2362" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-2363"><a href="#cb63-2363" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2364"><a href="#cb63-2364" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %f\n",</span></span>
<span id="cb63-2365"><a href="#cb63-2365" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_k, best_l))</span></span>
<span id="cb63-2366"><a href="#cb63-2366" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2367"><a href="#cb63-2367" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2368"><a href="#cb63-2368" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-2369"><a href="#cb63-2369" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2370"><a href="#cb63-2370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2371"><a href="#cb63-2371" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_KNN_TodasVariables_Asociacion &lt;- </span></span>
<span id="cb63-2372"><a href="#cb63-2372" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span></span>
<span id="cb63-2373"><a href="#cb63-2373" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-2374"><a href="#cb63-2374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2375"><a href="#cb63-2375" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-2376"><a href="#cb63-2376" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-2377"><a href="#cb63-2377" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-2378"><a href="#cb63-2378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2379"><a href="#cb63-2379" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-2380"><a href="#cb63-2380" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-2381"><a href="#cb63-2381" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-2382"><a href="#cb63-2382" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-2383"><a href="#cb63-2383" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-2384"><a href="#cb63-2384" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-2385"><a href="#cb63-2385" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-2386"><a href="#cb63-2386" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ks = ks,</span></span>
<span id="cb63-2387"><a href="#cb63-2387" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ls = ls)</span></span>
<span id="cb63-2388"><a href="#cb63-2388" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-2389"><a href="#cb63-2389" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2390"><a href="#cb63-2390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2391"><a href="#cb63-2391" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-2392"><a href="#cb63-2392" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2393"><a href="#cb63-2393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2394"><a href="#cb63-2394" aria-hidden="true" tabindex="-1"></a><span class="in">performance_knn_todasvariables &lt;- evaluate_with_seeds_KNN_TodasVariables_Asociacion(</span></span>
<span id="cb63-2395"><a href="#cb63-2395" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_knn,</span></span>
<span id="cb63-2396"><a href="#cb63-2396" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_numeric,</span></span>
<span id="cb63-2397"><a href="#cb63-2397" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-2398"><a href="#cb63-2398" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-2399"><a href="#cb63-2399" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-2400"><a href="#cb63-2400" aria-hidden="true" tabindex="-1"></a><span class="in">  ks = c(10, 16, 20, 25, 30, 32),</span></span>
<span id="cb63-2401"><a href="#cb63-2401" aria-hidden="true" tabindex="-1"></a><span class="in">  ls = c(0, 1, 2),</span></span>
<span id="cb63-2402"><a href="#cb63-2402" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_numeric,</span></span>
<span id="cb63-2403"><a href="#cb63-2403" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-2404"><a href="#cb63-2404" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-2405"><a href="#cb63-2405" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-2406"><a href="#cb63-2406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2407"><a href="#cb63-2407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2408"><a href="#cb63-2408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2409"><a href="#cb63-2409" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/KNN_TodasVariables.RData")</span></span>
<span id="cb63-2410"><a href="#cb63-2410" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2411"><a href="#cb63-2411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2412"><a href="#cb63-2412" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-2413"><a href="#cb63-2413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2414"><a href="#cb63-2414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2415"><a href="#cb63-2415" aria-hidden="true" tabindex="-1"></a><span class="in">performance_knn_Asociacion &lt;- evaluate_with_seeds_KNN_TodasVariables_Asociacion(</span></span>
<span id="cb63-2416"><a href="#cb63-2416" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_knn,</span></span>
<span id="cb63-2417"><a href="#cb63-2417" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_numeric,</span></span>
<span id="cb63-2418"><a href="#cb63-2418" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-2419"><a href="#cb63-2419" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-2420"><a href="#cb63-2420" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-2421"><a href="#cb63-2421" aria-hidden="true" tabindex="-1"></a><span class="in">  ks = c(10, 16, 20, 25, 30, 32),</span></span>
<span id="cb63-2422"><a href="#cb63-2422" aria-hidden="true" tabindex="-1"></a><span class="in">  ls = c(0, 1, 2),</span></span>
<span id="cb63-2423"><a href="#cb63-2423" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = asociacion_numeric,</span></span>
<span id="cb63-2424"><a href="#cb63-2424" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-2425"><a href="#cb63-2425" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-2426"><a href="#cb63-2426" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-2427"><a href="#cb63-2427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2428"><a href="#cb63-2428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2429"><a href="#cb63-2429" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2430"><a href="#cb63-2430" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/KNN_Asociacion.RData")</span></span>
<span id="cb63-2431"><a href="#cb63-2431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2432"><a href="#cb63-2432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2433"><a href="#cb63-2433" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-2434"><a href="#cb63-2434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2435"><a href="#cb63-2435" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2436"><a href="#cb63-2436" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_knn_stepAUC &lt;- function(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span></span>
<span id="cb63-2437"><a href="#cb63-2437" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-2438"><a href="#cb63-2438" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-2439"><a href="#cb63-2439" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-2440"><a href="#cb63-2440" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_k = integer(), Best_l = numeric(), Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2441"><a href="#cb63-2441" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2442"><a href="#cb63-2442" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-2443"><a href="#cb63-2443" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-2444"><a href="#cb63-2444" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2445"><a href="#cb63-2445" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2446"><a href="#cb63-2446" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-2447"><a href="#cb63-2447" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2448"><a href="#cb63-2448" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2449"><a href="#cb63-2449" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-2450"><a href="#cb63-2450" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2451"><a href="#cb63-2451" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2452"><a href="#cb63-2452" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2453"><a href="#cb63-2453" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-2454"><a href="#cb63-2454" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2455"><a href="#cb63-2455" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2456"><a href="#cb63-2456" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2457"><a href="#cb63-2457" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2458"><a href="#cb63-2458" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2459"><a href="#cb63-2459" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2460"><a href="#cb63-2460" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-2461"><a href="#cb63-2461" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-2462"><a href="#cb63-2462" aria-hidden="true" tabindex="-1"></a><span class="in">    best_k &lt;- NULL</span></span>
<span id="cb63-2463"><a href="#cb63-2463" aria-hidden="true" tabindex="-1"></a><span class="in">    best_l &lt;- NULL</span></span>
<span id="cb63-2464"><a href="#cb63-2464" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-2465"><a href="#cb63-2465" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2466"><a href="#cb63-2466" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(k = ks, l = ls)</span></span>
<span id="cb63-2467"><a href="#cb63-2467" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2468"><a href="#cb63-2468" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, outer_train_data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-2469"><a href="#cb63-2469" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-2470"><a href="#cb63-2470" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-2471"><a href="#cb63-2471" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-2472"><a href="#cb63-2472" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_k &lt;- NULL</span></span>
<span id="cb63-2473"><a href="#cb63-2473" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_l &lt;- NULL</span></span>
<span id="cb63-2474"><a href="#cb63-2474" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-2475"><a href="#cb63-2475" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-2476"><a href="#cb63-2476" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2477"><a href="#cb63-2477" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-2478"><a href="#cb63-2478" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-2479"><a href="#cb63-2479" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-2480"><a href="#cb63-2480" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2481"><a href="#cb63-2481" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-2482"><a href="#cb63-2482" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-2483"><a href="#cb63-2483" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-2484"><a href="#cb63-2484" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-2485"><a href="#cb63-2485" aria-hidden="true" tabindex="-1"></a><span class="in">          for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-2486"><a href="#cb63-2486" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals &lt;- numeric()</span></span>
<span id="cb63-2487"><a href="#cb63-2487" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2488"><a href="#cb63-2488" aria-hidden="true" tabindex="-1"></a><span class="in">            for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2489"><a href="#cb63-2489" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2490"><a href="#cb63-2490" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2491"><a href="#cb63-2491" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2492"><a href="#cb63-2492" aria-hidden="true" tabindex="-1"></a><span class="in">              train_x &lt;- inner_train_data[, temp_vars, drop = FALSE]</span></span>
<span id="cb63-2493"><a href="#cb63-2493" aria-hidden="true" tabindex="-1"></a><span class="in">              test_x &lt;- inner_test_data[, temp_vars, drop = FALSE]</span></span>
<span id="cb63-2494"><a href="#cb63-2494" aria-hidden="true" tabindex="-1"></a><span class="in">              train_y &lt;- inner_train_data[[target_name]]</span></span>
<span id="cb63-2495"><a href="#cb63-2495" aria-hidden="true" tabindex="-1"></a><span class="in">              test_y &lt;- inner_test_data[[target_name]]</span></span>
<span id="cb63-2496"><a href="#cb63-2496" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2497"><a href="#cb63-2497" aria-hidden="true" tabindex="-1"></a><span class="in">              result &lt;- tryCatch({</span></span>
<span id="cb63-2498"><a href="#cb63-2498" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- knn(train = train_x, test = test_x, cl = train_y, k = grid$k[params], l = grid$l[params], prob = TRUE)</span></span>
<span id="cb63-2499"><a href="#cb63-2499" aria-hidden="true" tabindex="-1"></a><span class="in">                probabilities &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2500"><a href="#cb63-2500" aria-hidden="true" tabindex="-1"></a><span class="in">                roc_curve &lt;- roc(as.numeric(as.character(test_y)), probabilities)</span></span>
<span id="cb63-2501"><a href="#cb63-2501" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2502"><a href="#cb63-2502" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-2503"><a href="#cb63-2503" aria-hidden="true" tabindex="-1"></a><span class="in">              }, error = function(e) {</span></span>
<span id="cb63-2504"><a href="#cb63-2504" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-2505"><a href="#cb63-2505" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-2506"><a href="#cb63-2506" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- 0  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-2507"><a href="#cb63-2507" aria-hidden="true" tabindex="-1"></a><span class="in">              })</span></span>
<span id="cb63-2508"><a href="#cb63-2508" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-2509"><a href="#cb63-2509" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2510"><a href="#cb63-2510" aria-hidden="true" tabindex="-1"></a><span class="in">            if (mean(auc_vals, na.rm = TRUE) &gt; best_auc_in_step) {</span></span>
<span id="cb63-2511"><a href="#cb63-2511" aria-hidden="true" tabindex="-1"></a><span class="in">              best_auc_in_step &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2512"><a href="#cb63-2512" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_model &lt;- list(train_x = train_x, train_y = train_y, k = grid$k[params], l = grid$l[params])</span></span>
<span id="cb63-2513"><a href="#cb63-2513" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_k &lt;- grid$k[params]</span></span>
<span id="cb63-2514"><a href="#cb63-2514" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_l &lt;- grid$l[params]</span></span>
<span id="cb63-2515"><a href="#cb63-2515" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-2516"><a href="#cb63-2516" aria-hidden="true" tabindex="-1"></a><span class="in">              improved &lt;- TRUE</span></span>
<span id="cb63-2517"><a href="#cb63-2517" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-2518"><a href="#cb63-2518" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-2519"><a href="#cb63-2519" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2520"><a href="#cb63-2520" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2521"><a href="#cb63-2521" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-2522"><a href="#cb63-2522" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-2523"><a href="#cb63-2523" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-2524"><a href="#cb63-2524" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-2525"><a href="#cb63-2525" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-2526"><a href="#cb63-2526" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2527"><a href="#cb63-2527" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-2528"><a href="#cb63-2528" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2529"><a href="#cb63-2529" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-2530"><a href="#cb63-2530" aria-hidden="true" tabindex="-1"></a><span class="in">           k = best_inner_k, l = best_inner_l, </span></span>
<span id="cb63-2531"><a href="#cb63-2531" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-2532"><a href="#cb63-2532" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2533"><a href="#cb63-2533" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2534"><a href="#cb63-2534" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2535"><a href="#cb63-2535" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-2536"><a href="#cb63-2536" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-2537"><a href="#cb63-2537" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-2538"><a href="#cb63-2538" aria-hidden="true" tabindex="-1"></a><span class="in">    best_k &lt;- best_result$k</span></span>
<span id="cb63-2539"><a href="#cb63-2539" aria-hidden="true" tabindex="-1"></a><span class="in">    best_l &lt;- best_result$l</span></span>
<span id="cb63-2540"><a href="#cb63-2540" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-2541"><a href="#cb63-2541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2542"><a href="#cb63-2542" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-2543"><a href="#cb63-2543" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-2544"><a href="#cb63-2544" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2545"><a href="#cb63-2545" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2546"><a href="#cb63-2546" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2547"><a href="#cb63-2547" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2548"><a href="#cb63-2548" aria-hidden="true" tabindex="-1"></a><span class="in">      train_x &lt;- best_model$train_x</span></span>
<span id="cb63-2549"><a href="#cb63-2549" aria-hidden="true" tabindex="-1"></a><span class="in">      test_x &lt;- inner_test_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2550"><a href="#cb63-2550" aria-hidden="true" tabindex="-1"></a><span class="in">      train_y &lt;- best_model$train_y</span></span>
<span id="cb63-2551"><a href="#cb63-2551" aria-hidden="true" tabindex="-1"></a><span class="in">      test_y &lt;- inner_test_data[[target_name]]</span></span>
<span id="cb63-2552"><a href="#cb63-2552" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2553"><a href="#cb63-2553" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- knn(train = train_x, test = test_x, cl = train_y, k = best_k, l = best_l, prob = TRUE)</span></span>
<span id="cb63-2554"><a href="#cb63-2554" aria-hidden="true" tabindex="-1"></a><span class="in">      probabilities &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2555"><a href="#cb63-2555" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(as.numeric(as.character(test_y)), probabilities)</span></span>
<span id="cb63-2556"><a href="#cb63-2556" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2557"><a href="#cb63-2557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2558"><a href="#cb63-2558" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(probabilities &gt; threshold, "1", "0")</span></span>
<span id="cb63-2559"><a href="#cb63-2559" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = test_y, Predicted = pred_class)</span></span>
<span id="cb63-2560"><a href="#cb63-2560" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2561"><a href="#cb63-2561" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2562"><a href="#cb63-2562" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2563"><a href="#cb63-2563" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2564"><a href="#cb63-2564" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-2565"><a href="#cb63-2565" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2566"><a href="#cb63-2566" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-2567"><a href="#cb63-2567" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-2568"><a href="#cb63-2568" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2569"><a href="#cb63-2569" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2570"><a href="#cb63-2570" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2571"><a href="#cb63-2571" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2572"><a href="#cb63-2572" aria-hidden="true" tabindex="-1"></a><span class="in">    test_x &lt;- outer_test_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2573"><a href="#cb63-2573" aria-hidden="true" tabindex="-1"></a><span class="in">    test_y &lt;- outer_test_data[[target_name]]</span></span>
<span id="cb63-2574"><a href="#cb63-2574" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- knn(train = best_model$train_x, test = test_x, cl = best_model$train_y, k = best_k, l = best_l, prob = TRUE)</span></span>
<span id="cb63-2575"><a href="#cb63-2575" aria-hidden="true" tabindex="-1"></a><span class="in">    probabilities &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2576"><a href="#cb63-2576" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(probabilities &gt; threshold, "1", "0")</span></span>
<span id="cb63-2577"><a href="#cb63-2577" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = test_y, Predicted = pred_class)</span></span>
<span id="cb63-2578"><a href="#cb63-2578" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2579"><a href="#cb63-2579" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-2580"><a href="#cb63-2580" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2581"><a href="#cb63-2581" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2582"><a href="#cb63-2582" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2583"><a href="#cb63-2583" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2584"><a href="#cb63-2584" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-2585"><a href="#cb63-2585" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-2586"><a href="#cb63-2586" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-2587"><a href="#cb63-2587" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-2588"><a href="#cb63-2588" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-2589"><a href="#cb63-2589" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2590"><a href="#cb63-2590" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(test_y, probabilities)$auc</span></span>
<span id="cb63-2591"><a href="#cb63-2591" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2592"><a href="#cb63-2592" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-2593"><a href="#cb63-2593" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_k, best_l, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-2594"><a href="#cb63-2594" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-2595"><a href="#cb63-2595" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-2596"><a href="#cb63-2596" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2597"><a href="#cb63-2597" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-2598"><a href="#cb63-2598" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2599"><a href="#cb63-2599" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-2600"><a href="#cb63-2600" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2601"><a href="#cb63-2601" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %f, Best Variables: %s\n",</span></span>
<span id="cb63-2602"><a href="#cb63-2602" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_k, best_l, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-2603"><a href="#cb63-2603" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2604"><a href="#cb63-2604" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2605"><a href="#cb63-2605" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-2606"><a href="#cb63-2606" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2607"><a href="#cb63-2607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2608"><a href="#cb63-2608" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_KNN_stepAUC &lt;- </span></span>
<span id="cb63-2609"><a href="#cb63-2609" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span></span>
<span id="cb63-2610"><a href="#cb63-2610" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-2611"><a href="#cb63-2611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2612"><a href="#cb63-2612" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-2613"><a href="#cb63-2613" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-2614"><a href="#cb63-2614" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-2615"><a href="#cb63-2615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2616"><a href="#cb63-2616" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-2617"><a href="#cb63-2617" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-2618"><a href="#cb63-2618" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-2619"><a href="#cb63-2619" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-2620"><a href="#cb63-2620" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-2621"><a href="#cb63-2621" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-2622"><a href="#cb63-2622" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-2623"><a href="#cb63-2623" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ks = ks,</span></span>
<span id="cb63-2624"><a href="#cb63-2624" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ls = ls)</span></span>
<span id="cb63-2625"><a href="#cb63-2625" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-2626"><a href="#cb63-2626" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2627"><a href="#cb63-2627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2628"><a href="#cb63-2628" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-2629"><a href="#cb63-2629" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2630"><a href="#cb63-2630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2631"><a href="#cb63-2631" aria-hidden="true" tabindex="-1"></a><span class="in">performance_knn_stepauc &lt;- evaluate_with_seeds_KNN_stepAUC(</span></span>
<span id="cb63-2632"><a href="#cb63-2632" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_knn_stepAUC,</span></span>
<span id="cb63-2633"><a href="#cb63-2633" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_numeric,</span></span>
<span id="cb63-2634"><a href="#cb63-2634" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-2635"><a href="#cb63-2635" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-2636"><a href="#cb63-2636" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-2637"><a href="#cb63-2637" aria-hidden="true" tabindex="-1"></a><span class="in">  ks = c(10, 16, 20, 25, 30, 32),</span></span>
<span id="cb63-2638"><a href="#cb63-2638" aria-hidden="true" tabindex="-1"></a><span class="in">  ls = c(0, 1, 2),</span></span>
<span id="cb63-2639"><a href="#cb63-2639" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_numeric,</span></span>
<span id="cb63-2640"><a href="#cb63-2640" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-2641"><a href="#cb63-2641" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-2642"><a href="#cb63-2642" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-2643"><a href="#cb63-2643" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2644"><a href="#cb63-2644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2645"><a href="#cb63-2645" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2646"><a href="#cb63-2646" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/KNN_StepAUC.RData")</span></span>
<span id="cb63-2647"><a href="#cb63-2647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2648"><a href="#cb63-2648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2649"><a href="#cb63-2649" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-2650"><a href="#cb63-2650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2651"><a href="#cb63-2651" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2652"><a href="#cb63-2652" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_knn_lasso &lt;- function(data, target_name, outer, inner, ks, ls, variables, threshold, seed) {</span></span>
<span id="cb63-2653"><a href="#cb63-2653" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-2654"><a href="#cb63-2654" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-2655"><a href="#cb63-2655" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-2656"><a href="#cb63-2656" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_k = integer(), Best_l = integer(), </span></span>
<span id="cb63-2657"><a href="#cb63-2657" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2658"><a href="#cb63-2658" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2659"><a href="#cb63-2659" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-2660"><a href="#cb63-2660" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-2661"><a href="#cb63-2661" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2662"><a href="#cb63-2662" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2663"><a href="#cb63-2663" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-2664"><a href="#cb63-2664" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.numeric(data[[target_name]]) - 1</span></span>
<span id="cb63-2665"><a href="#cb63-2665" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-2666"><a href="#cb63-2666" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-2667"><a href="#cb63-2667" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-2668"><a href="#cb63-2668" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2669"><a href="#cb63-2669" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-2670"><a href="#cb63-2670" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2671"><a href="#cb63-2671" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-2672"><a href="#cb63-2672" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2673"><a href="#cb63-2673" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2674"><a href="#cb63-2674" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2675"><a href="#cb63-2675" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-2676"><a href="#cb63-2676" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-2677"><a href="#cb63-2677" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-2678"><a href="#cb63-2678" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-2679"><a href="#cb63-2679" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-2680"><a href="#cb63-2680" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2681"><a href="#cb63-2681" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-2682"><a href="#cb63-2682" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-2683"><a href="#cb63-2683" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-2684"><a href="#cb63-2684" aria-hidden="true" tabindex="-1"></a><span class="in">    best_k &lt;- NULL</span></span>
<span id="cb63-2685"><a href="#cb63-2685" aria-hidden="true" tabindex="-1"></a><span class="in">    best_l &lt;- NULL</span></span>
<span id="cb63-2686"><a href="#cb63-2686" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-2687"><a href="#cb63-2687" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2688"><a href="#cb63-2688" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(k = ks, l = ls)</span></span>
<span id="cb63-2689"><a href="#cb63-2689" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2690"><a href="#cb63-2690" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-2691"><a href="#cb63-2691" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]])</span></span>
<span id="cb63-2692"><a href="#cb63-2692" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-2693"><a href="#cb63-2693" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-2694"><a href="#cb63-2694" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-2695"><a href="#cb63-2695" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2696"><a href="#cb63-2696" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-2697"><a href="#cb63-2697" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-2698"><a href="#cb63-2698" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-2699"><a href="#cb63-2699" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2700"><a href="#cb63-2700" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-2701"><a href="#cb63-2701" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-2702"><a href="#cb63-2702" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-2703"><a href="#cb63-2703" aria-hidden="true" tabindex="-1"></a><span class="in">      #cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-2704"><a href="#cb63-2704" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-2705"><a href="#cb63-2705" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2706"><a href="#cb63-2706" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2707"><a href="#cb63-2707" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-2708"><a href="#cb63-2708" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-2709"><a href="#cb63-2709" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-2710"><a href="#cb63-2710" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_k &lt;- NULL</span></span>
<span id="cb63-2711"><a href="#cb63-2711" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_l &lt;- NULL</span></span>
<span id="cb63-2712"><a href="#cb63-2712" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-2713"><a href="#cb63-2713" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-2714"><a href="#cb63-2714" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2715"><a href="#cb63-2715" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-2716"><a href="#cb63-2716" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-2717"><a href="#cb63-2717" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-2718"><a href="#cb63-2718" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2719"><a href="#cb63-2719" aria-hidden="true" tabindex="-1"></a><span class="in">        for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-2720"><a href="#cb63-2720" aria-hidden="true" tabindex="-1"></a><span class="in">          auc_vals &lt;- numeric()</span></span>
<span id="cb63-2721"><a href="#cb63-2721" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-2722"><a href="#cb63-2722" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2723"><a href="#cb63-2723" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2724"><a href="#cb63-2724" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2725"><a href="#cb63-2725" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2726"><a href="#cb63-2726" aria-hidden="true" tabindex="-1"></a><span class="in">            selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-2727"><a href="#cb63-2727" aria-hidden="true" tabindex="-1"></a><span class="in">            formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-2728"><a href="#cb63-2728" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-2729"><a href="#cb63-2729" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Grid parameters - k: ", grid$k[params], ", l: ", grid$l[params], "\n")</span></span>
<span id="cb63-2730"><a href="#cb63-2730" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-2731"><a href="#cb63-2731" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-2732"><a href="#cb63-2732" aria-hidden="true" tabindex="-1"></a><span class="in">              train_x &lt;- inner_train_data[, selected_vars, drop = FALSE]</span></span>
<span id="cb63-2733"><a href="#cb63-2733" aria-hidden="true" tabindex="-1"></a><span class="in">              test_x &lt;- inner_test_data[, selected_vars, drop = FALSE]</span></span>
<span id="cb63-2734"><a href="#cb63-2734" aria-hidden="true" tabindex="-1"></a><span class="in">              train_y &lt;- inner_train_data[[target_name]]</span></span>
<span id="cb63-2735"><a href="#cb63-2735" aria-hidden="true" tabindex="-1"></a><span class="in">              test_y &lt;- inner_test_data[[target_name]]</span></span>
<span id="cb63-2736"><a href="#cb63-2736" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2737"><a href="#cb63-2737" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- knn(train_x, test_x, train_y, k = grid$k[params], l = grid$l[params], prob = TRUE)</span></span>
<span id="cb63-2738"><a href="#cb63-2738" aria-hidden="true" tabindex="-1"></a><span class="in">              prob_predictions &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2739"><a href="#cb63-2739" aria-hidden="true" tabindex="-1"></a><span class="in">              prob_predictions &lt;- ifelse(predictions == "1", prob_predictions, 1 - prob_predictions)</span></span>
<span id="cb63-2740"><a href="#cb63-2740" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], prob_predictions)</span></span>
<span id="cb63-2741"><a href="#cb63-2741" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2742"><a href="#cb63-2742" aria-hidden="true" tabindex="-1"></a><span class="in">              #cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-2743"><a href="#cb63-2743" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-2744"><a href="#cb63-2744" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-2745"><a href="#cb63-2745" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-2746"><a href="#cb63-2746" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-2747"><a href="#cb63-2747" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-2748"><a href="#cb63-2748" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-2749"><a href="#cb63-2749" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-2750"><a href="#cb63-2750" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-2751"><a href="#cb63-2751" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2752"><a href="#cb63-2752" aria-hidden="true" tabindex="-1"></a><span class="in">          #cat("Mean AUC for params - k: ", grid$k[params], ", l: ", grid$l[params], ": ", mean_auc, "\n")</span></span>
<span id="cb63-2753"><a href="#cb63-2753" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-2754"><a href="#cb63-2754" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-2755"><a href="#cb63-2755" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- list(k = grid$k[params], l = grid$l[params])</span></span>
<span id="cb63-2756"><a href="#cb63-2756" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_k &lt;- grid$k[params]</span></span>
<span id="cb63-2757"><a href="#cb63-2757" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_l &lt;- grid$l[params]</span></span>
<span id="cb63-2758"><a href="#cb63-2758" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-2759"><a href="#cb63-2759" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-2760"><a href="#cb63-2760" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-2761"><a href="#cb63-2761" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2762"><a href="#cb63-2762" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-2763"><a href="#cb63-2763" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-2764"><a href="#cb63-2764" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-2765"><a href="#cb63-2765" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-2766"><a href="#cb63-2766" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-2767"><a href="#cb63-2767" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-2768"><a href="#cb63-2768" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-2769"><a href="#cb63-2769" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-2770"><a href="#cb63-2770" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2771"><a href="#cb63-2771" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-2772"><a href="#cb63-2772" aria-hidden="true" tabindex="-1"></a><span class="in">           k = best_inner_k, l = best_inner_l, </span></span>
<span id="cb63-2773"><a href="#cb63-2773" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-2774"><a href="#cb63-2774" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2775"><a href="#cb63-2775" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2776"><a href="#cb63-2776" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-2777"><a href="#cb63-2777" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-2778"><a href="#cb63-2778" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-2779"><a href="#cb63-2779" aria-hidden="true" tabindex="-1"></a><span class="in">    best_k &lt;- best_result$k</span></span>
<span id="cb63-2780"><a href="#cb63-2780" aria-hidden="true" tabindex="-1"></a><span class="in">    best_l &lt;- best_result$l</span></span>
<span id="cb63-2781"><a href="#cb63-2781" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-2782"><a href="#cb63-2782" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2783"><a href="#cb63-2783" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-2784"><a href="#cb63-2784" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-2785"><a href="#cb63-2785" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-2786"><a href="#cb63-2786" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2787"><a href="#cb63-2787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2788"><a href="#cb63-2788" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-2789"><a href="#cb63-2789" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-2790"><a href="#cb63-2790" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2791"><a href="#cb63-2791" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2792"><a href="#cb63-2792" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-2793"><a href="#cb63-2793" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2794"><a href="#cb63-2794" aria-hidden="true" tabindex="-1"></a><span class="in">      train_x &lt;- inner_train_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2795"><a href="#cb63-2795" aria-hidden="true" tabindex="-1"></a><span class="in">      test_x &lt;- inner_test_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2796"><a href="#cb63-2796" aria-hidden="true" tabindex="-1"></a><span class="in">      train_y &lt;- inner_train_data[[target_name]]</span></span>
<span id="cb63-2797"><a href="#cb63-2797" aria-hidden="true" tabindex="-1"></a><span class="in">      test_y &lt;- inner_test_data[[target_name]]</span></span>
<span id="cb63-2798"><a href="#cb63-2798" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2799"><a href="#cb63-2799" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- knn(train_x, test_x, train_y, k = best_k, l = best_l, prob = TRUE)</span></span>
<span id="cb63-2800"><a href="#cb63-2800" aria-hidden="true" tabindex="-1"></a><span class="in">      prob_predictions &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2801"><a href="#cb63-2801" aria-hidden="true" tabindex="-1"></a><span class="in">      prob_predictions &lt;- ifelse(predictions == "1", prob_predictions, 1 - prob_predictions)</span></span>
<span id="cb63-2802"><a href="#cb63-2802" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], prob_predictions)</span></span>
<span id="cb63-2803"><a href="#cb63-2803" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-2804"><a href="#cb63-2804" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-2805"><a href="#cb63-2805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2806"><a href="#cb63-2806" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(prob_predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-2807"><a href="#cb63-2807" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-2808"><a href="#cb63-2808" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2809"><a href="#cb63-2809" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2810"><a href="#cb63-2810" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2811"><a href="#cb63-2811" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2812"><a href="#cb63-2812" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-2813"><a href="#cb63-2813" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-2814"><a href="#cb63-2814" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-2815"><a href="#cb63-2815" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-2816"><a href="#cb63-2816" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2817"><a href="#cb63-2817" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2818"><a href="#cb63-2818" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-2819"><a href="#cb63-2819" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-2820"><a href="#cb63-2820" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2821"><a href="#cb63-2821" aria-hidden="true" tabindex="-1"></a><span class="in">    train_x &lt;- outer_train_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2822"><a href="#cb63-2822" aria-hidden="true" tabindex="-1"></a><span class="in">    test_x &lt;- outer_test_data[, best_vars, drop = FALSE]</span></span>
<span id="cb63-2823"><a href="#cb63-2823" aria-hidden="true" tabindex="-1"></a><span class="in">    train_y &lt;- outer_train_data[[target_name]]</span></span>
<span id="cb63-2824"><a href="#cb63-2824" aria-hidden="true" tabindex="-1"></a><span class="in">    test_y &lt;- outer_test_data[[target_name]]</span></span>
<span id="cb63-2825"><a href="#cb63-2825" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2826"><a href="#cb63-2826" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- knn(train_x, test_x, train_y, k = best_k, l = best_l, prob = TRUE)</span></span>
<span id="cb63-2827"><a href="#cb63-2827" aria-hidden="true" tabindex="-1"></a><span class="in">    prob_predictions &lt;- attr(predictions, "prob")</span></span>
<span id="cb63-2828"><a href="#cb63-2828" aria-hidden="true" tabindex="-1"></a><span class="in">    prob_predictions &lt;- ifelse(predictions == "1", prob_predictions, 1 - prob_predictions)</span></span>
<span id="cb63-2829"><a href="#cb63-2829" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(prob_predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-2830"><a href="#cb63-2830" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-2831"><a href="#cb63-2831" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2832"><a href="#cb63-2832" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-2833"><a href="#cb63-2833" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-2834"><a href="#cb63-2834" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-2835"><a href="#cb63-2835" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-2836"><a href="#cb63-2836" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-2837"><a href="#cb63-2837" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-2838"><a href="#cb63-2838" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-2839"><a href="#cb63-2839" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-2840"><a href="#cb63-2840" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-2841"><a href="#cb63-2841" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-2842"><a href="#cb63-2842" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2843"><a href="#cb63-2843" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], prob_predictions)$auc</span></span>
<span id="cb63-2844"><a href="#cb63-2844" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2845"><a href="#cb63-2845" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-2846"><a href="#cb63-2846" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_k, best_l, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-2847"><a href="#cb63-2847" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-2848"><a href="#cb63-2848" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-2849"><a href="#cb63-2849" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2850"><a href="#cb63-2850" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-2851"><a href="#cb63-2851" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2852"><a href="#cb63-2852" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-2853"><a href="#cb63-2853" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-2854"><a href="#cb63-2854" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best k: %d, Best l: %d, Best Variables: %s\n",</span></span>
<span id="cb63-2855"><a href="#cb63-2855" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_k, best_l, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-2856"><a href="#cb63-2856" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2857"><a href="#cb63-2857" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2858"><a href="#cb63-2858" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-2859"><a href="#cb63-2859" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2860"><a href="#cb63-2860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2861"><a href="#cb63-2861" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_KNN_lasso &lt;- </span></span>
<span id="cb63-2862"><a href="#cb63-2862" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, ks, ls) {</span></span>
<span id="cb63-2863"><a href="#cb63-2863" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-2864"><a href="#cb63-2864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2865"><a href="#cb63-2865" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-2866"><a href="#cb63-2866" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-2867"><a href="#cb63-2867" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-2868"><a href="#cb63-2868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2869"><a href="#cb63-2869" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-2870"><a href="#cb63-2870" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-2871"><a href="#cb63-2871" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-2872"><a href="#cb63-2872" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-2873"><a href="#cb63-2873" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-2874"><a href="#cb63-2874" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-2875"><a href="#cb63-2875" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-2876"><a href="#cb63-2876" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ks = ks,</span></span>
<span id="cb63-2877"><a href="#cb63-2877" aria-hidden="true" tabindex="-1"></a><span class="in">                                   ls = ls)</span></span>
<span id="cb63-2878"><a href="#cb63-2878" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-2879"><a href="#cb63-2879" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2880"><a href="#cb63-2880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2881"><a href="#cb63-2881" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-2882"><a href="#cb63-2882" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2883"><a href="#cb63-2883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2884"><a href="#cb63-2884" aria-hidden="true" tabindex="-1"></a><span class="in">performance_knn_lasso &lt;- evaluate_with_seeds_KNN_lasso(</span></span>
<span id="cb63-2885"><a href="#cb63-2885" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_knn_lasso,</span></span>
<span id="cb63-2886"><a href="#cb63-2886" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_numeric,</span></span>
<span id="cb63-2887"><a href="#cb63-2887" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-2888"><a href="#cb63-2888" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-2889"><a href="#cb63-2889" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-2890"><a href="#cb63-2890" aria-hidden="true" tabindex="-1"></a><span class="in">  ks = c(10, 16, 20, 25, 30, 32),</span></span>
<span id="cb63-2891"><a href="#cb63-2891" aria-hidden="true" tabindex="-1"></a><span class="in">  ls = c(0, 1, 2),</span></span>
<span id="cb63-2892"><a href="#cb63-2892" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_numeric,</span></span>
<span id="cb63-2893"><a href="#cb63-2893" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-2894"><a href="#cb63-2894" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-2895"><a href="#cb63-2895" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-2896"><a href="#cb63-2896" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2897"><a href="#cb63-2897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2898"><a href="#cb63-2898" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2899"><a href="#cb63-2899" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/KNN_Lasso.RData")</span></span>
<span id="cb63-2900"><a href="#cb63-2900" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2901"><a href="#cb63-2901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2902"><a href="#cb63-2902" aria-hidden="true" tabindex="-1"></a><span class="fu">## Support Vector Machines</span></span>
<span id="cb63-2903"><a href="#cb63-2903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2904"><a href="#cb63-2904" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-2905"><a href="#cb63-2905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2906"><a href="#cb63-2906" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2907"><a href="#cb63-2907" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_svm &lt;- function(data, target_var, model_func, vars = NULL, threshold = 0.5) {</span></span>
<span id="cb63-2908"><a href="#cb63-2908" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-2909"><a href="#cb63-2909" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-2910"><a href="#cb63-2910" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-2911"><a href="#cb63-2911" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2912"><a href="#cb63-2912" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-2913"><a href="#cb63-2913" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-2914"><a href="#cb63-2914" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2915"><a href="#cb63-2915" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data)</span></span>
<span id="cb63-2916"><a href="#cb63-2916" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- predict(model, newdata = data, probability = TRUE)</span></span>
<span id="cb63-2917"><a href="#cb63-2917" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-2918"><a href="#cb63-2918" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2919"><a href="#cb63-2919" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-2920"><a href="#cb63-2920" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-2921"><a href="#cb63-2921" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(predicted_classes, actual_classes)</span></span>
<span id="cb63-2922"><a href="#cb63-2922" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2923"><a href="#cb63-2923" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-2924"><a href="#cb63-2924" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-2925"><a href="#cb63-2925" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-2926"><a href="#cb63-2926" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-2927"><a href="#cb63-2927" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2928"><a href="#cb63-2928" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-2929"><a href="#cb63-2929" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-2930"><a href="#cb63-2930" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-2931"><a href="#cb63-2931" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-2932"><a href="#cb63-2932" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-2933"><a href="#cb63-2933" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2934"><a href="#cb63-2934" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-2935"><a href="#cb63-2935" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-2936"><a href="#cb63-2936" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2937"><a href="#cb63-2937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2938"><a href="#cb63-2938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2939"><a href="#cb63-2939" aria-hidden="true" tabindex="-1"></a><span class="in">svm_model &lt;- function(formula, data) {</span></span>
<span id="cb63-2940"><a href="#cb63-2940" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(90)</span></span>
<span id="cb63-2941"><a href="#cb63-2941" aria-hidden="true" tabindex="-1"></a><span class="in">  x &lt;- model.matrix(formula, data)</span></span>
<span id="cb63-2942"><a href="#cb63-2942" aria-hidden="true" tabindex="-1"></a><span class="in">  y &lt;- data[[all.vars(formula)[1]]]</span></span>
<span id="cb63-2943"><a href="#cb63-2943" aria-hidden="true" tabindex="-1"></a><span class="in">  y &lt;- factor(y, levels = c(0, 1))</span></span>
<span id="cb63-2944"><a href="#cb63-2944" aria-hidden="true" tabindex="-1"></a><span class="in">  svm(x = x, y = y, kernel = "linear", cost = 100, probability = TRUE, maxiter=300, random_state=90)</span></span>
<span id="cb63-2945"><a href="#cb63-2945" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-2946"><a href="#cb63-2946" aria-hidden="true" tabindex="-1"></a><span class="in"># svm(x = x, y = y, kernel = "poly", cost = 5, gamma = .5, probability = TRUE, maxiter=150)</span></span>
<span id="cb63-2947"><a href="#cb63-2947" aria-hidden="true" tabindex="-1"></a><span class="in"># svm(x = x, y = y, kernel = "linear", cost = 50, probability = TRUE, maxiter=300, random_state=90)</span></span>
<span id="cb63-2948"><a href="#cb63-2948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2949"><a href="#cb63-2949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2950"><a href="#cb63-2950" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesSVM &lt;- evaluate_aparent_performance_model_svm(data = data_numeric, target_var = "PCR",</span></span>
<span id="cb63-2951"><a href="#cb63-2951" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             model_func = svm_model,</span></span>
<span id="cb63-2952"><a href="#cb63-2952" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             vars = ".",</span></span>
<span id="cb63-2953"><a href="#cb63-2953" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             threshold = .35)</span></span>
<span id="cb63-2954"><a href="#cb63-2954" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2955"><a href="#cb63-2955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2956"><a href="#cb63-2956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-2957"><a href="#cb63-2957" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/SVM_Aparente.RData")</span></span>
<span id="cb63-2958"><a href="#cb63-2958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-2959"><a href="#cb63-2959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2960"><a href="#cb63-2960" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-2961"><a href="#cb63-2961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2962"><a href="#cb63-2962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-2963"><a href="#cb63-2963" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_svm &lt;- function(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span></span>
<span id="cb63-2964"><a href="#cb63-2964" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-2965"><a href="#cb63-2965" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-2966"><a href="#cb63-2966" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-2967"><a href="#cb63-2967" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Kernel = character(), Best_Cost = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-2968"><a href="#cb63-2968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2969"><a href="#cb63-2969" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-2970"><a href="#cb63-2970" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2971"><a href="#cb63-2971" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-2972"><a href="#cb63-2972" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-2973"><a href="#cb63-2973" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2974"><a href="#cb63-2974" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-2975"><a href="#cb63-2975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2976"><a href="#cb63-2976" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-2977"><a href="#cb63-2977" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2978"><a href="#cb63-2978" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2979"><a href="#cb63-2979" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == "0"), "\n")</span></span>
<span id="cb63-2980"><a href="#cb63-2980" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == "1"), "\n")</span></span>
<span id="cb63-2981"><a href="#cb63-2981" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-2982"><a href="#cb63-2982" aria-hidden="true" tabindex="-1"></a><span class="in">    if (sum(outer_train_data[[target_name]] == "0") == 0 || sum(outer_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-2983"><a href="#cb63-2983" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Skipping outer fold due to lack of class diversity\n")</span></span>
<span id="cb63-2984"><a href="#cb63-2984" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-2985"><a href="#cb63-2985" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-2986"><a href="#cb63-2986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2987"><a href="#cb63-2987" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-2988"><a href="#cb63-2988" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-2989"><a href="#cb63-2989" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-2990"><a href="#cb63-2990" aria-hidden="true" tabindex="-1"></a><span class="in">    best_kernel &lt;- NULL</span></span>
<span id="cb63-2991"><a href="#cb63-2991" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cost &lt;- NULL</span></span>
<span id="cb63-2992"><a href="#cb63-2992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2993"><a href="#cb63-2993" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(kernel = kernels, cost = costs)</span></span>
<span id="cb63-2994"><a href="#cb63-2994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2995"><a href="#cb63-2995" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-2996"><a href="#cb63-2996" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-2997"><a href="#cb63-2997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-2998"><a href="#cb63-2998" aria-hidden="true" tabindex="-1"></a><span class="in">      for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-2999"><a href="#cb63-2999" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3000"><a href="#cb63-3000" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3001"><a href="#cb63-3001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3002"><a href="#cb63-3002" aria-hidden="true" tabindex="-1"></a><span class="in">        if (sum(inner_train_data[[target_name]] == "0") == 0 || sum(inner_train_data[[target_name]] == "1") == 0) {</span></span>
<span id="cb63-3003"><a href="#cb63-3003" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Skipping inner fold due to lack of class diversity\n")</span></span>
<span id="cb63-3004"><a href="#cb63-3004" aria-hidden="true" tabindex="-1"></a><span class="in">          next</span></span>
<span id="cb63-3005"><a href="#cb63-3005" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3006"><a href="#cb63-3006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3007"><a href="#cb63-3007" aria-hidden="true" tabindex="-1"></a><span class="in">        result &lt;- tryCatch({</span></span>
<span id="cb63-3008"><a href="#cb63-3008" aria-hidden="true" tabindex="-1"></a><span class="in">          model &lt;- svm(reformulate(variables, target_name), </span></span>
<span id="cb63-3009"><a href="#cb63-3009" aria-hidden="true" tabindex="-1"></a><span class="in">                       data = inner_train_data, kernel = grid$kernel[params], cost = grid$cost[params], </span></span>
<span id="cb63-3010"><a href="#cb63-3010" aria-hidden="true" tabindex="-1"></a><span class="in">                       probability = TRUE)</span></span>
<span id="cb63-3011"><a href="#cb63-3011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3012"><a href="#cb63-3012" aria-hidden="true" tabindex="-1"></a><span class="in">          pred &lt;- predict(model, inner_test_data, probability = TRUE)</span></span>
<span id="cb63-3013"><a href="#cb63-3013" aria-hidden="true" tabindex="-1"></a><span class="in">          prob &lt;- attr(pred, "probabilities")[, 2]</span></span>
<span id="cb63-3014"><a href="#cb63-3014" aria-hidden="true" tabindex="-1"></a><span class="in">          roc_curve &lt;- pROC::roc(inner_test_data[[target_name]], prob)</span></span>
<span id="cb63-3015"><a href="#cb63-3015" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3016"><a href="#cb63-3016" aria-hidden="true" tabindex="-1"></a><span class="in">        }, error = function(e) {</span></span>
<span id="cb63-3017"><a href="#cb63-3017" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error with parameters: kernel =", grid$kernel[params], ", cost =", grid$cost[params], "\n")</span></span>
<span id="cb63-3018"><a href="#cb63-3018" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-3019"><a href="#cb63-3019" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- 0</span></span>
<span id="cb63-3020"><a href="#cb63-3020" aria-hidden="true" tabindex="-1"></a><span class="in">        })</span></span>
<span id="cb63-3021"><a href="#cb63-3021" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3022"><a href="#cb63-3022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3023"><a href="#cb63-3023" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc, na.rm = TRUE) &gt; best_auc) {</span></span>
<span id="cb63-3024"><a href="#cb63-3024" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-3025"><a href="#cb63-3025" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model &lt;- model</span></span>
<span id="cb63-3026"><a href="#cb63-3026" aria-hidden="true" tabindex="-1"></a><span class="in">        best_kernel &lt;- grid$kernel[params]</span></span>
<span id="cb63-3027"><a href="#cb63-3027" aria-hidden="true" tabindex="-1"></a><span class="in">        best_cost &lt;- grid$cost[params]</span></span>
<span id="cb63-3028"><a href="#cb63-3028" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3029"><a href="#cb63-3029" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3030"><a href="#cb63-3030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3031"><a href="#cb63-3031" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, probability = TRUE)</span></span>
<span id="cb63-3032"><a href="#cb63-3032" aria-hidden="true" tabindex="-1"></a><span class="in">    prob &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3033"><a href="#cb63-3033" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(prob &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-3034"><a href="#cb63-3034" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(outer_test_data[[target_name]], pred_class)</span></span>
<span id="cb63-3035"><a href="#cb63-3035" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3036"><a href="#cb63-3036" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-3037"><a href="#cb63-3037" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3038"><a href="#cb63-3038" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3039"><a href="#cb63-3039" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3040"><a href="#cb63-3040" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3041"><a href="#cb63-3041" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-3042"><a href="#cb63-3042" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-3043"><a href="#cb63-3043" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-3044"><a href="#cb63-3044" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-3045"><a href="#cb63-3045" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-3046"><a href="#cb63-3046" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3047"><a href="#cb63-3047" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- pROC::roc(outer_test_data[[target_name]], prob)$auc</span></span>
<span id="cb63-3048"><a href="#cb63-3048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3049"><a href="#cb63-3049" aria-hidden="true" tabindex="-1"></a><span class="in">    # Crear un vector con los nombres correctos y convertir a dataframe</span></span>
<span id="cb63-3050"><a href="#cb63-3050" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, best_kernel, best_cost), names(performance_metrics))</span></span>
<span id="cb63-3051"><a href="#cb63-3051" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-3052"><a href="#cb63-3052" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3053"><a href="#cb63-3053" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3054"><a href="#cb63-3054" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-3055"><a href="#cb63-3055" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3056"><a href="#cb63-3056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3057"><a href="#cb63-3057" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_SVM_TodasVariables_Asociacion &lt;- </span></span>
<span id="cb63-3058"><a href="#cb63-3058" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span></span>
<span id="cb63-3059"><a href="#cb63-3059" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-3060"><a href="#cb63-3060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3061"><a href="#cb63-3061" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-3062"><a href="#cb63-3062" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-3063"><a href="#cb63-3063" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-3064"><a href="#cb63-3064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3065"><a href="#cb63-3065" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-3066"><a href="#cb63-3066" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-3067"><a href="#cb63-3067" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-3068"><a href="#cb63-3068" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-3069"><a href="#cb63-3069" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-3070"><a href="#cb63-3070" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-3071"><a href="#cb63-3071" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-3072"><a href="#cb63-3072" aria-hidden="true" tabindex="-1"></a><span class="in">                                   kernels = kernels,</span></span>
<span id="cb63-3073"><a href="#cb63-3073" aria-hidden="true" tabindex="-1"></a><span class="in">                                   costs = costs)</span></span>
<span id="cb63-3074"><a href="#cb63-3074" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-3075"><a href="#cb63-3075" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3076"><a href="#cb63-3076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3077"><a href="#cb63-3077" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-3078"><a href="#cb63-3078" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3079"><a href="#cb63-3079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3080"><a href="#cb63-3080" aria-hidden="true" tabindex="-1"></a><span class="in">performance_SVM_todasvariables &lt;- evaluate_with_seeds_SVM_TodasVariables_Asociacion(</span></span>
<span id="cb63-3081"><a href="#cb63-3081" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_svm,</span></span>
<span id="cb63-3082"><a href="#cb63-3082" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3083"><a href="#cb63-3083" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3084"><a href="#cb63-3084" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3085"><a href="#cb63-3085" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3086"><a href="#cb63-3086" aria-hidden="true" tabindex="-1"></a><span class="in">  kernels = c("linear", "poly"),</span></span>
<span id="cb63-3087"><a href="#cb63-3087" aria-hidden="true" tabindex="-1"></a><span class="in">  costs = c(50, 100, 200),</span></span>
<span id="cb63-3088"><a href="#cb63-3088" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-3089"><a href="#cb63-3089" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3090"><a href="#cb63-3090" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3091"><a href="#cb63-3091" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3092"><a href="#cb63-3092" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3093"><a href="#cb63-3093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3094"><a href="#cb63-3094" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3095"><a href="#cb63-3095" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/SVM_TodasVariables.RData")</span></span>
<span id="cb63-3096"><a href="#cb63-3096" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3097"><a href="#cb63-3097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3098"><a href="#cb63-3098" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-3099"><a href="#cb63-3099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3100"><a href="#cb63-3100" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3101"><a href="#cb63-3101" aria-hidden="true" tabindex="-1"></a><span class="in">performance_svm_asociacion &lt;- evaluate_with_seeds_SVM_TodasVariables_Asociacion(</span></span>
<span id="cb63-3102"><a href="#cb63-3102" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_svm,</span></span>
<span id="cb63-3103"><a href="#cb63-3103" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3104"><a href="#cb63-3104" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3105"><a href="#cb63-3105" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3106"><a href="#cb63-3106" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3107"><a href="#cb63-3107" aria-hidden="true" tabindex="-1"></a><span class="in">  kernels = c("linear", "poly"),</span></span>
<span id="cb63-3108"><a href="#cb63-3108" aria-hidden="true" tabindex="-1"></a><span class="in">  costs = c(50, 100, 200),</span></span>
<span id="cb63-3109"><a href="#cb63-3109" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = asociacion,</span></span>
<span id="cb63-3110"><a href="#cb63-3110" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3111"><a href="#cb63-3111" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3112"><a href="#cb63-3112" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3113"><a href="#cb63-3113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3114"><a href="#cb63-3114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3115"><a href="#cb63-3115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3116"><a href="#cb63-3116" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/SVM_Asociacion.RData")</span></span>
<span id="cb63-3117"><a href="#cb63-3117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3118"><a href="#cb63-3118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3119"><a href="#cb63-3119" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-3120"><a href="#cb63-3120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3121"><a href="#cb63-3121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3122"><a href="#cb63-3122" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_svm_stepAUC &lt;- function(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span></span>
<span id="cb63-3123"><a href="#cb63-3123" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-3124"><a href="#cb63-3124" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-3125"><a href="#cb63-3125" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-3126"><a href="#cb63-3126" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Kernel = character(), Best_Cost = numeric(), Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3127"><a href="#cb63-3127" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3128"><a href="#cb63-3128" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-3129"><a href="#cb63-3129" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-3130"><a href="#cb63-3130" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3131"><a href="#cb63-3131" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3132"><a href="#cb63-3132" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.factor(data[[target_name]])</span></span>
<span id="cb63-3133"><a href="#cb63-3133" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-3134"><a href="#cb63-3134" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3135"><a href="#cb63-3135" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-3136"><a href="#cb63-3136" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3137"><a href="#cb63-3137" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3138"><a href="#cb63-3138" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3139"><a href="#cb63-3139" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-3140"><a href="#cb63-3140" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3141"><a href="#cb63-3141" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3142"><a href="#cb63-3142" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Total: ", nrow(outer_train_data), "\n")</span></span>
<span id="cb63-3143"><a href="#cb63-3143" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3144"><a href="#cb63-3144" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3145"><a href="#cb63-3145" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Total: ", nrow(outer_test_data), "\n")</span></span>
<span id="cb63-3146"><a href="#cb63-3146" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3147"><a href="#cb63-3147" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-3148"><a href="#cb63-3148" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-3149"><a href="#cb63-3149" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-3150"><a href="#cb63-3150" aria-hidden="true" tabindex="-1"></a><span class="in">    best_kernel &lt;- NULL</span></span>
<span id="cb63-3151"><a href="#cb63-3151" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cost &lt;- NULL</span></span>
<span id="cb63-3152"><a href="#cb63-3152" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-3153"><a href="#cb63-3153" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3154"><a href="#cb63-3154" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(kernel = kernels, cost = costs)</span></span>
<span id="cb63-3155"><a href="#cb63-3155" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3156"><a href="#cb63-3156" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, outer_train_data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-3157"><a href="#cb63-3157" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-3158"><a href="#cb63-3158" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-3159"><a href="#cb63-3159" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-3160"><a href="#cb63-3160" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_kernel &lt;- NULL</span></span>
<span id="cb63-3161"><a href="#cb63-3161" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_cost &lt;- NULL</span></span>
<span id="cb63-3162"><a href="#cb63-3162" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-3163"><a href="#cb63-3163" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-3164"><a href="#cb63-3164" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3165"><a href="#cb63-3165" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-3166"><a href="#cb63-3166" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-3167"><a href="#cb63-3167" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-3168"><a href="#cb63-3168" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3169"><a href="#cb63-3169" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-3170"><a href="#cb63-3170" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-3171"><a href="#cb63-3171" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-3172"><a href="#cb63-3172" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-3173"><a href="#cb63-3173" aria-hidden="true" tabindex="-1"></a><span class="in">          for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-3174"><a href="#cb63-3174" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals &lt;- numeric()</span></span>
<span id="cb63-3175"><a href="#cb63-3175" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3176"><a href="#cb63-3176" aria-hidden="true" tabindex="-1"></a><span class="in">            for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3177"><a href="#cb63-3177" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3178"><a href="#cb63-3178" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3179"><a href="#cb63-3179" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-3180"><a href="#cb63-3180" aria-hidden="true" tabindex="-1"></a><span class="in">              result &lt;- tryCatch({</span></span>
<span id="cb63-3181"><a href="#cb63-3181" aria-hidden="true" tabindex="-1"></a><span class="in">                model &lt;- svm(as.formula(paste(target_name, "~", paste(temp_vars, collapse = "+"))),</span></span>
<span id="cb63-3182"><a href="#cb63-3182" aria-hidden="true" tabindex="-1"></a><span class="in">                             data = inner_train_data, kernel = grid$kernel[params], cost = grid$cost[params], </span></span>
<span id="cb63-3183"><a href="#cb63-3183" aria-hidden="true" tabindex="-1"></a><span class="in">                             probability = TRUE)</span></span>
<span id="cb63-3184"><a href="#cb63-3184" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-3185"><a href="#cb63-3185" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- predict(model, newdata = inner_test_data, probability = TRUE)</span></span>
<span id="cb63-3186"><a href="#cb63-3186" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3187"><a href="#cb63-3187" aria-hidden="true" tabindex="-1"></a><span class="in">                roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-3188"><a href="#cb63-3188" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3189"><a href="#cb63-3189" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-3190"><a href="#cb63-3190" aria-hidden="true" tabindex="-1"></a><span class="in">              }, error = function(e) {</span></span>
<span id="cb63-3191"><a href="#cb63-3191" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-3192"><a href="#cb63-3192" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-3193"><a href="#cb63-3193" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- 0  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-3194"><a href="#cb63-3194" aria-hidden="true" tabindex="-1"></a><span class="in">              })</span></span>
<span id="cb63-3195"><a href="#cb63-3195" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-3196"><a href="#cb63-3196" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3197"><a href="#cb63-3197" aria-hidden="true" tabindex="-1"></a><span class="in">            if (mean(auc_vals, na.rm = TRUE) &gt; best_auc_in_step) {</span></span>
<span id="cb63-3198"><a href="#cb63-3198" aria-hidden="true" tabindex="-1"></a><span class="in">              best_auc_in_step &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-3199"><a href="#cb63-3199" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_model &lt;- model</span></span>
<span id="cb63-3200"><a href="#cb63-3200" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_kernel &lt;- grid$kernel[params]</span></span>
<span id="cb63-3201"><a href="#cb63-3201" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_cost &lt;- grid$cost[params]</span></span>
<span id="cb63-3202"><a href="#cb63-3202" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-3203"><a href="#cb63-3203" aria-hidden="true" tabindex="-1"></a><span class="in">              improved &lt;- TRUE</span></span>
<span id="cb63-3204"><a href="#cb63-3204" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-3205"><a href="#cb63-3205" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-3206"><a href="#cb63-3206" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3207"><a href="#cb63-3207" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3208"><a href="#cb63-3208" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-3209"><a href="#cb63-3209" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-3210"><a href="#cb63-3210" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-3211"><a href="#cb63-3211" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-3212"><a href="#cb63-3212" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-3213"><a href="#cb63-3213" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3214"><a href="#cb63-3214" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3215"><a href="#cb63-3215" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3216"><a href="#cb63-3216" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-3217"><a href="#cb63-3217" aria-hidden="true" tabindex="-1"></a><span class="in">           kernel = best_inner_kernel, cost = best_inner_cost, </span></span>
<span id="cb63-3218"><a href="#cb63-3218" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-3219"><a href="#cb63-3219" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3220"><a href="#cb63-3220" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3221"><a href="#cb63-3221" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3222"><a href="#cb63-3222" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-3223"><a href="#cb63-3223" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-3224"><a href="#cb63-3224" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-3225"><a href="#cb63-3225" aria-hidden="true" tabindex="-1"></a><span class="in">    best_kernel &lt;- best_result$kernel</span></span>
<span id="cb63-3226"><a href="#cb63-3226" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cost &lt;- best_result$cost</span></span>
<span id="cb63-3227"><a href="#cb63-3227" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-3228"><a href="#cb63-3228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3229"><a href="#cb63-3229" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-3230"><a href="#cb63-3230" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-3231"><a href="#cb63-3231" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3232"><a href="#cb63-3232" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3233"><a href="#cb63-3233" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3234"><a href="#cb63-3234" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3235"><a href="#cb63-3235" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, newdata = inner_test_data, probability = TRUE)</span></span>
<span id="cb63-3236"><a href="#cb63-3236" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3237"><a href="#cb63-3237" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-3238"><a href="#cb63-3238" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3239"><a href="#cb63-3239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3240"><a href="#cb63-3240" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-3241"><a href="#cb63-3241" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3242"><a href="#cb63-3242" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3243"><a href="#cb63-3243" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3244"><a href="#cb63-3244" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3245"><a href="#cb63-3245" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3246"><a href="#cb63-3246" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-3247"><a href="#cb63-3247" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3248"><a href="#cb63-3248" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-3249"><a href="#cb63-3249" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-3250"><a href="#cb63-3250" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3251"><a href="#cb63-3251" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3252"><a href="#cb63-3252" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-3253"><a href="#cb63-3253" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3254"><a href="#cb63-3254" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, newdata = outer_test_data, probability = TRUE)</span></span>
<span id="cb63-3255"><a href="#cb63-3255" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3256"><a href="#cb63-3256" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-3257"><a href="#cb63-3257" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3258"><a href="#cb63-3258" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3259"><a href="#cb63-3259" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-3260"><a href="#cb63-3260" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3261"><a href="#cb63-3261" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3262"><a href="#cb63-3262" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3263"><a href="#cb63-3263" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3264"><a href="#cb63-3264" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-3265"><a href="#cb63-3265" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-3266"><a href="#cb63-3266" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-3267"><a href="#cb63-3267" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-3268"><a href="#cb63-3268" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-3269"><a href="#cb63-3269" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3270"><a href="#cb63-3270" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-3271"><a href="#cb63-3271" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3272"><a href="#cb63-3272" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-3273"><a href="#cb63-3273" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_kernel, best_cost, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-3274"><a href="#cb63-3274" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-3275"><a href="#cb63-3275" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-3276"><a href="#cb63-3276" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3277"><a href="#cb63-3277" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-3278"><a href="#cb63-3278" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3279"><a href="#cb63-3279" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-3280"><a href="#cb63-3280" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3281"><a href="#cb63-3281" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Kernel: %s, Best Cost: %f, Best Variables: %s\n",</span></span>
<span id="cb63-3282"><a href="#cb63-3282" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_kernel, best_cost, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-3283"><a href="#cb63-3283" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3284"><a href="#cb63-3284" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3285"><a href="#cb63-3285" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-3286"><a href="#cb63-3286" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3287"><a href="#cb63-3287" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_SVM_stepAUC &lt;- </span></span>
<span id="cb63-3288"><a href="#cb63-3288" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span></span>
<span id="cb63-3289"><a href="#cb63-3289" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-3290"><a href="#cb63-3290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3291"><a href="#cb63-3291" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-3292"><a href="#cb63-3292" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-3293"><a href="#cb63-3293" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-3294"><a href="#cb63-3294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3295"><a href="#cb63-3295" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-3296"><a href="#cb63-3296" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-3297"><a href="#cb63-3297" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-3298"><a href="#cb63-3298" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-3299"><a href="#cb63-3299" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-3300"><a href="#cb63-3300" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-3301"><a href="#cb63-3301" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-3302"><a href="#cb63-3302" aria-hidden="true" tabindex="-1"></a><span class="in">                                   kernels = kernels,</span></span>
<span id="cb63-3303"><a href="#cb63-3303" aria-hidden="true" tabindex="-1"></a><span class="in">                                   costs = costs)</span></span>
<span id="cb63-3304"><a href="#cb63-3304" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-3305"><a href="#cb63-3305" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3306"><a href="#cb63-3306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3307"><a href="#cb63-3307" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-3308"><a href="#cb63-3308" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3309"><a href="#cb63-3309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3310"><a href="#cb63-3310" aria-hidden="true" tabindex="-1"></a><span class="in">performance_SVM_stepauc &lt;- evaluate_with_seeds_SVM_stepAUC(</span></span>
<span id="cb63-3311"><a href="#cb63-3311" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_svm_stepAUC,</span></span>
<span id="cb63-3312"><a href="#cb63-3312" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_numeric,</span></span>
<span id="cb63-3313"><a href="#cb63-3313" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3314"><a href="#cb63-3314" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3315"><a href="#cb63-3315" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3316"><a href="#cb63-3316" aria-hidden="true" tabindex="-1"></a><span class="in">  kernels = c("linear", "poly"),</span></span>
<span id="cb63-3317"><a href="#cb63-3317" aria-hidden="true" tabindex="-1"></a><span class="in">  costs = c(50, 100, 200),</span></span>
<span id="cb63-3318"><a href="#cb63-3318" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_numeric,</span></span>
<span id="cb63-3319"><a href="#cb63-3319" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3320"><a href="#cb63-3320" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3321"><a href="#cb63-3321" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3322"><a href="#cb63-3322" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3323"><a href="#cb63-3323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3324"><a href="#cb63-3324" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3325"><a href="#cb63-3325" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/SVM_StepAUC.RData")</span></span>
<span id="cb63-3326"><a href="#cb63-3326" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3327"><a href="#cb63-3327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3328"><a href="#cb63-3328" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-3329"><a href="#cb63-3329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3330"><a href="#cb63-3330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3331"><a href="#cb63-3331" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_svm_lasso &lt;- function(data, target_name, outer, inner, kernels, costs, variables, threshold, seed) {</span></span>
<span id="cb63-3332"><a href="#cb63-3332" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-3333"><a href="#cb63-3333" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-3334"><a href="#cb63-3334" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-3335"><a href="#cb63-3335" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Kernel = character(), Best_Cost = numeric(),</span></span>
<span id="cb63-3336"><a href="#cb63-3336" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3337"><a href="#cb63-3337" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3338"><a href="#cb63-3338" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-3339"><a href="#cb63-3339" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-3340"><a href="#cb63-3340" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3341"><a href="#cb63-3341" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3342"><a href="#cb63-3342" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-3343"><a href="#cb63-3343" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.factor(data[[target_name]])  # Aseguramos que la variable de respuesta sea factor</span></span>
<span id="cb63-3344"><a href="#cb63-3344" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-3345"><a href="#cb63-3345" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-3346"><a href="#cb63-3346" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-3347"><a href="#cb63-3347" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3348"><a href="#cb63-3348" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-3349"><a href="#cb63-3349" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3350"><a href="#cb63-3350" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-3351"><a href="#cb63-3351" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3352"><a href="#cb63-3352" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3353"><a href="#cb63-3353" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3354"><a href="#cb63-3354" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-3355"><a href="#cb63-3355" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3356"><a href="#cb63-3356" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3357"><a href="#cb63-3357" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3358"><a href="#cb63-3358" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3359"><a href="#cb63-3359" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3360"><a href="#cb63-3360" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-3361"><a href="#cb63-3361" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-3362"><a href="#cb63-3362" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-3363"><a href="#cb63-3363" aria-hidden="true" tabindex="-1"></a><span class="in">    best_kernel &lt;- NULL</span></span>
<span id="cb63-3364"><a href="#cb63-3364" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cost &lt;- NULL</span></span>
<span id="cb63-3365"><a href="#cb63-3365" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-3366"><a href="#cb63-3366" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3367"><a href="#cb63-3367" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(kernel = kernels, cost = costs)</span></span>
<span id="cb63-3368"><a href="#cb63-3368" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3369"><a href="#cb63-3369" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-3370"><a href="#cb63-3370" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]]) - 1  # Convertimos a numérico para Lasso</span></span>
<span id="cb63-3371"><a href="#cb63-3371" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-3372"><a href="#cb63-3372" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-3373"><a href="#cb63-3373" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-3374"><a href="#cb63-3374" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3375"><a href="#cb63-3375" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-3376"><a href="#cb63-3376" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-3377"><a href="#cb63-3377" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-3378"><a href="#cb63-3378" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3379"><a href="#cb63-3379" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-3380"><a href="#cb63-3380" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-3381"><a href="#cb63-3381" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-3382"><a href="#cb63-3382" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-3383"><a href="#cb63-3383" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-3384"><a href="#cb63-3384" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3385"><a href="#cb63-3385" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3386"><a href="#cb63-3386" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-3387"><a href="#cb63-3387" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-3388"><a href="#cb63-3388" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-3389"><a href="#cb63-3389" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_kernel &lt;- NULL</span></span>
<span id="cb63-3390"><a href="#cb63-3390" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_cost &lt;- NULL</span></span>
<span id="cb63-3391"><a href="#cb63-3391" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-3392"><a href="#cb63-3392" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-3393"><a href="#cb63-3393" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3394"><a href="#cb63-3394" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-3395"><a href="#cb63-3395" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-3396"><a href="#cb63-3396" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-3397"><a href="#cb63-3397" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3398"><a href="#cb63-3398" aria-hidden="true" tabindex="-1"></a><span class="in">        for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-3399"><a href="#cb63-3399" aria-hidden="true" tabindex="-1"></a><span class="in">          auc_vals &lt;- numeric()</span></span>
<span id="cb63-3400"><a href="#cb63-3400" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-3401"><a href="#cb63-3401" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3402"><a href="#cb63-3402" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3403"><a href="#cb63-3403" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3404"><a href="#cb63-3404" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3405"><a href="#cb63-3405" aria-hidden="true" tabindex="-1"></a><span class="in">            selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-3406"><a href="#cb63-3406" aria-hidden="true" tabindex="-1"></a><span class="in">            formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-3407"><a href="#cb63-3407" aria-hidden="true" tabindex="-1"></a><span class="in">            cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-3408"><a href="#cb63-3408" aria-hidden="true" tabindex="-1"></a><span class="in">            cat("Grid parameters - kernel: ", grid$kernel[params], ", cost: ", grid$cost[params], "\n")</span></span>
<span id="cb63-3409"><a href="#cb63-3409" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3410"><a href="#cb63-3410" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-3411"><a href="#cb63-3411" aria-hidden="true" tabindex="-1"></a><span class="in">              model &lt;- svm(formula, data = inner_train_data, kernel = grid$kernel[params], cost = grid$cost[params], probability = TRUE)</span></span>
<span id="cb63-3412"><a href="#cb63-3412" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-3413"><a href="#cb63-3413" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- predict(model, inner_test_data, probability = TRUE)</span></span>
<span id="cb63-3414"><a href="#cb63-3414" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions_prob &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3415"><a href="#cb63-3415" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], predictions_prob)</span></span>
<span id="cb63-3416"><a href="#cb63-3416" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3417"><a href="#cb63-3417" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-3418"><a href="#cb63-3418" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-3419"><a href="#cb63-3419" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-3420"><a href="#cb63-3420" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-3421"><a href="#cb63-3421" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-3422"><a href="#cb63-3422" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-3423"><a href="#cb63-3423" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-3424"><a href="#cb63-3424" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-3425"><a href="#cb63-3425" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-3426"><a href="#cb63-3426" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-3427"><a href="#cb63-3427" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Mean AUC for params - kernel: ", grid$kernel[params], ", cost: ", grid$cost[params], ": ", mean_auc, "\n")</span></span>
<span id="cb63-3428"><a href="#cb63-3428" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-3429"><a href="#cb63-3429" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-3430"><a href="#cb63-3430" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- model</span></span>
<span id="cb63-3431"><a href="#cb63-3431" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_kernel &lt;- grid$kernel[params]</span></span>
<span id="cb63-3432"><a href="#cb63-3432" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_cost &lt;- grid$cost[params]</span></span>
<span id="cb63-3433"><a href="#cb63-3433" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-3434"><a href="#cb63-3434" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-3435"><a href="#cb63-3435" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-3436"><a href="#cb63-3436" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3437"><a href="#cb63-3437" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3438"><a href="#cb63-3438" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-3439"><a href="#cb63-3439" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-3440"><a href="#cb63-3440" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-3441"><a href="#cb63-3441" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-3442"><a href="#cb63-3442" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-3443"><a href="#cb63-3443" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3444"><a href="#cb63-3444" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3445"><a href="#cb63-3445" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3446"><a href="#cb63-3446" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-3447"><a href="#cb63-3447" aria-hidden="true" tabindex="-1"></a><span class="in">           kernel = best_inner_kernel, cost = best_inner_cost, </span></span>
<span id="cb63-3448"><a href="#cb63-3448" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-3449"><a href="#cb63-3449" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3450"><a href="#cb63-3450" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3451"><a href="#cb63-3451" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-3452"><a href="#cb63-3452" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-3453"><a href="#cb63-3453" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-3454"><a href="#cb63-3454" aria-hidden="true" tabindex="-1"></a><span class="in">    best_kernel &lt;- best_result$kernel</span></span>
<span id="cb63-3455"><a href="#cb63-3455" aria-hidden="true" tabindex="-1"></a><span class="in">    best_cost &lt;- best_result$cost</span></span>
<span id="cb63-3456"><a href="#cb63-3456" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-3457"><a href="#cb63-3457" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3458"><a href="#cb63-3458" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-3459"><a href="#cb63-3459" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-3460"><a href="#cb63-3460" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-3461"><a href="#cb63-3461" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3462"><a href="#cb63-3462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3463"><a href="#cb63-3463" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-3464"><a href="#cb63-3464" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-3465"><a href="#cb63-3465" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3466"><a href="#cb63-3466" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3467"><a href="#cb63-3467" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3468"><a href="#cb63-3468" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3469"><a href="#cb63-3469" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, probability = TRUE)</span></span>
<span id="cb63-3470"><a href="#cb63-3470" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions_prob &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3471"><a href="#cb63-3471" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions_prob)</span></span>
<span id="cb63-3472"><a href="#cb63-3472" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3473"><a href="#cb63-3473" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-3474"><a href="#cb63-3474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3475"><a href="#cb63-3475" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions_prob &gt; threshold, "1", "0")</span></span>
<span id="cb63-3476"><a href="#cb63-3476" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3477"><a href="#cb63-3477" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3478"><a href="#cb63-3478" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3479"><a href="#cb63-3479" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3480"><a href="#cb63-3480" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3481"><a href="#cb63-3481" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-3482"><a href="#cb63-3482" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3483"><a href="#cb63-3483" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-3484"><a href="#cb63-3484" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-3485"><a href="#cb63-3485" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3486"><a href="#cb63-3486" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3487"><a href="#cb63-3487" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-3488"><a href="#cb63-3488" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-3489"><a href="#cb63-3489" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3490"><a href="#cb63-3490" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, probability = TRUE)</span></span>
<span id="cb63-3491"><a href="#cb63-3491" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions_prob &lt;- attr(predictions, "probabilities")[, 2]</span></span>
<span id="cb63-3492"><a href="#cb63-3492" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions_prob &gt; threshold, "1", "0")  # Asignar clases basadas en umbral</span></span>
<span id="cb63-3493"><a href="#cb63-3493" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3494"><a href="#cb63-3494" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3495"><a href="#cb63-3495" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-3496"><a href="#cb63-3496" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3497"><a href="#cb63-3497" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3498"><a href="#cb63-3498" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3499"><a href="#cb63-3499" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3500"><a href="#cb63-3500" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-3501"><a href="#cb63-3501" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-3502"><a href="#cb63-3502" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-3503"><a href="#cb63-3503" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-3504"><a href="#cb63-3504" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-3505"><a href="#cb63-3505" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3506"><a href="#cb63-3506" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions_prob)$auc</span></span>
<span id="cb63-3507"><a href="#cb63-3507" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3508"><a href="#cb63-3508" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-3509"><a href="#cb63-3509" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_kernel, best_cost, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-3510"><a href="#cb63-3510" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-3511"><a href="#cb63-3511" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-3512"><a href="#cb63-3512" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3513"><a href="#cb63-3513" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-3514"><a href="#cb63-3514" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3515"><a href="#cb63-3515" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-3516"><a href="#cb63-3516" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3517"><a href="#cb63-3517" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Kernel: %s, Best Cost: %f, Best Variables: %s\n",</span></span>
<span id="cb63-3518"><a href="#cb63-3518" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_kernel, best_cost, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-3519"><a href="#cb63-3519" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3520"><a href="#cb63-3520" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3521"><a href="#cb63-3521" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-3522"><a href="#cb63-3522" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3523"><a href="#cb63-3523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3524"><a href="#cb63-3524" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_SVM_lasso &lt;- </span></span>
<span id="cb63-3525"><a href="#cb63-3525" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, kernels, costs) {</span></span>
<span id="cb63-3526"><a href="#cb63-3526" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-3527"><a href="#cb63-3527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3528"><a href="#cb63-3528" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-3529"><a href="#cb63-3529" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-3530"><a href="#cb63-3530" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-3531"><a href="#cb63-3531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3532"><a href="#cb63-3532" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-3533"><a href="#cb63-3533" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-3534"><a href="#cb63-3534" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-3535"><a href="#cb63-3535" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-3536"><a href="#cb63-3536" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-3537"><a href="#cb63-3537" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-3538"><a href="#cb63-3538" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-3539"><a href="#cb63-3539" aria-hidden="true" tabindex="-1"></a><span class="in">                                   kernels = kernels,</span></span>
<span id="cb63-3540"><a href="#cb63-3540" aria-hidden="true" tabindex="-1"></a><span class="in">                                   costs = costs)</span></span>
<span id="cb63-3541"><a href="#cb63-3541" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-3542"><a href="#cb63-3542" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3543"><a href="#cb63-3543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3544"><a href="#cb63-3544" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-3545"><a href="#cb63-3545" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3546"><a href="#cb63-3546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3547"><a href="#cb63-3547" aria-hidden="true" tabindex="-1"></a><span class="in">performance_SVM_lasso &lt;- evaluate_with_seeds_SVM_lasso(</span></span>
<span id="cb63-3548"><a href="#cb63-3548" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_svm_lasso,</span></span>
<span id="cb63-3549"><a href="#cb63-3549" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3550"><a href="#cb63-3550" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3551"><a href="#cb63-3551" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3552"><a href="#cb63-3552" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3553"><a href="#cb63-3553" aria-hidden="true" tabindex="-1"></a><span class="in">  kernels = c("linear", "poly"),</span></span>
<span id="cb63-3554"><a href="#cb63-3554" aria-hidden="true" tabindex="-1"></a><span class="in">  costs = c(50, 100, 200),</span></span>
<span id="cb63-3555"><a href="#cb63-3555" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-3556"><a href="#cb63-3556" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3557"><a href="#cb63-3557" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3558"><a href="#cb63-3558" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3559"><a href="#cb63-3559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3560"><a href="#cb63-3560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3561"><a href="#cb63-3561" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3562"><a href="#cb63-3562" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/SVM_Lasso.RData")</span></span>
<span id="cb63-3563"><a href="#cb63-3563" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3564"><a href="#cb63-3564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3565"><a href="#cb63-3565" aria-hidden="true" tabindex="-1"></a><span class="fu">## Artificial Neural Networks</span></span>
<span id="cb63-3566"><a href="#cb63-3566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3567"><a href="#cb63-3567" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aparente</span></span>
<span id="cb63-3568"><a href="#cb63-3568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3569"><a href="#cb63-3569" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3570"><a href="#cb63-3570" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_aparent_performance_model_nnet &lt;- function(data, target_var, model_func, vars = NULL, threshold = 0.5) {</span></span>
<span id="cb63-3571"><a href="#cb63-3571" aria-hidden="true" tabindex="-1"></a><span class="in">  if (is.null(vars)) {</span></span>
<span id="cb63-3572"><a href="#cb63-3572" aria-hidden="true" tabindex="-1"></a><span class="in">    vars &lt;- setdiff(names(data), target_var)</span></span>
<span id="cb63-3573"><a href="#cb63-3573" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3574"><a href="#cb63-3574" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3575"><a href="#cb63-3575" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_var]] &lt;- factor(data[[target_var]], levels = c(0, 1))</span></span>
<span id="cb63-3576"><a href="#cb63-3576" aria-hidden="true" tabindex="-1"></a><span class="in">  formula &lt;- as.formula(paste(target_var, "~", paste(vars, collapse = "+")))</span></span>
<span id="cb63-3577"><a href="#cb63-3577" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3578"><a href="#cb63-3578" aria-hidden="true" tabindex="-1"></a><span class="in">  model &lt;- model_func(formula, data)</span></span>
<span id="cb63-3579"><a href="#cb63-3579" aria-hidden="true" tabindex="-1"></a><span class="in">  predictions &lt;- predict(model, newdata = data, type = "raw")</span></span>
<span id="cb63-3580"><a href="#cb63-3580" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3581"><a href="#cb63-3581" aria-hidden="true" tabindex="-1"></a><span class="in">  actual_classes &lt;- data[[target_var]]</span></span>
<span id="cb63-3582"><a href="#cb63-3582" aria-hidden="true" tabindex="-1"></a><span class="in">  predicted_classes &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-3583"><a href="#cb63-3583" aria-hidden="true" tabindex="-1"></a><span class="in">  confusion_matrix &lt;- table(predicted_classes, actual_classes)</span></span>
<span id="cb63-3584"><a href="#cb63-3584" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3585"><a href="#cb63-3585" aria-hidden="true" tabindex="-1"></a><span class="in">  tp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["1", "1"], 0)</span></span>
<span id="cb63-3586"><a href="#cb63-3586" aria-hidden="true" tabindex="-1"></a><span class="in">  tn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["0", "0"], 0)</span></span>
<span id="cb63-3587"><a href="#cb63-3587" aria-hidden="true" tabindex="-1"></a><span class="in">  fp &lt;- ifelse("1" %in% rownames(confusion_matrix) &amp;&amp; "0" %in% colnames(confusion_matrix), confusion_matrix["1", "0"], 0)</span></span>
<span id="cb63-3588"><a href="#cb63-3588" aria-hidden="true" tabindex="-1"></a><span class="in">  fn &lt;- ifelse("0" %in% rownames(confusion_matrix) &amp;&amp; "1" %in% colnames(confusion_matrix), confusion_matrix["0", "1"], 0)</span></span>
<span id="cb63-3589"><a href="#cb63-3589" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3590"><a href="#cb63-3590" aria-hidden="true" tabindex="-1"></a><span class="in">  accuracy &lt;- (tp + tn) / (tp + tn + fp + fn)</span></span>
<span id="cb63-3591"><a href="#cb63-3591" aria-hidden="true" tabindex="-1"></a><span class="in">  precision &lt;- ifelse(tp + fp &gt; 0, tp / (tp + fp), 0)</span></span>
<span id="cb63-3592"><a href="#cb63-3592" aria-hidden="true" tabindex="-1"></a><span class="in">  recall &lt;- ifelse(tp + fn &gt; 0, tp / (tp + fn), 0)</span></span>
<span id="cb63-3593"><a href="#cb63-3593" aria-hidden="true" tabindex="-1"></a><span class="in">  f1_score &lt;- ifelse(precision + recall &gt; 0, 2 * (precision * recall) / (precision + recall), 0)</span></span>
<span id="cb63-3594"><a href="#cb63-3594" aria-hidden="true" tabindex="-1"></a><span class="in">  roc_obj &lt;- pROC::roc(actual_classes, predictions)</span></span>
<span id="cb63-3595"><a href="#cb63-3595" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3596"><a href="#cb63-3596" aria-hidden="true" tabindex="-1"></a><span class="in">  list(confusion_matrix = confusion_matrix, accuracy = accuracy, precision = precision, </span></span>
<span id="cb63-3597"><a href="#cb63-3597" aria-hidden="true" tabindex="-1"></a><span class="in">       recall = recall, f1_score = f1_score, roc_curve = roc_obj)</span></span>
<span id="cb63-3598"><a href="#cb63-3598" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3599"><a href="#cb63-3599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3600"><a href="#cb63-3600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3601"><a href="#cb63-3601" aria-hidden="true" tabindex="-1"></a><span class="in">nn_model &lt;- function(formula, data) {</span></span>
<span id="cb63-3602"><a href="#cb63-3602" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(90)</span></span>
<span id="cb63-3603"><a href="#cb63-3603" aria-hidden="true" tabindex="-1"></a><span class="in">  nnet(formula = formula, data = data, size = 15, </span></span>
<span id="cb63-3604"><a href="#cb63-3604" aria-hidden="true" tabindex="-1"></a><span class="in">       decay = 0.1, maxit = 100, trace = FALSE, </span></span>
<span id="cb63-3605"><a href="#cb63-3605" aria-hidden="true" tabindex="-1"></a><span class="in">       linout = FALSE, random_state = 90)</span></span>
<span id="cb63-3606"><a href="#cb63-3606" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3607"><a href="#cb63-3607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3608"><a href="#cb63-3608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3609"><a href="#cb63-3609" aria-hidden="true" tabindex="-1"></a><span class="in">resultadosAparentesNN &lt;- evaluate_aparent_performance_model_nnet(data = data_factor, target_var = "PCR",</span></span>
<span id="cb63-3610"><a href="#cb63-3610" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             model_func = nn_model,</span></span>
<span id="cb63-3611"><a href="#cb63-3611" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             vars = ".",</span></span>
<span id="cb63-3612"><a href="#cb63-3612" aria-hidden="true" tabindex="-1"></a><span class="in">                                                             threshold = .35)</span></span>
<span id="cb63-3613"><a href="#cb63-3613" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3614"><a href="#cb63-3614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3615"><a href="#cb63-3615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3616"><a href="#cb63-3616" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/ANN_Aparente.RData")</span></span>
<span id="cb63-3617"><a href="#cb63-3617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3618"><a href="#cb63-3618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3619"><a href="#cb63-3619" aria-hidden="true" tabindex="-1"></a><span class="fu">### Todas las Variables</span></span>
<span id="cb63-3620"><a href="#cb63-3620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3621"><a href="#cb63-3621" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3622"><a href="#cb63-3622" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_nnet &lt;- function(data, target_name, outer, inner, sizes, decays, variables, threshold, seed) {</span></span>
<span id="cb63-3623"><a href="#cb63-3623" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-3624"><a href="#cb63-3624" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-3625"><a href="#cb63-3625" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-3626"><a href="#cb63-3626" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Size = integer(), Best_Decay = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3627"><a href="#cb63-3627" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.numeric(data[[target_name]]) - 1</span></span>
<span id="cb63-3628"><a href="#cb63-3628" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-3629"><a href="#cb63-3629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3630"><a href="#cb63-3630" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-3631"><a href="#cb63-3631" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3632"><a href="#cb63-3632" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3633"><a href="#cb63-3633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3634"><a href="#cb63-3634" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-3635"><a href="#cb63-3635" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3636"><a href="#cb63-3636" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3637"><a href="#cb63-3637" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Total: ", nrow(outer_train_data), "\n")</span></span>
<span id="cb63-3638"><a href="#cb63-3638" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3639"><a href="#cb63-3639" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3640"><a href="#cb63-3640" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Total: ", nrow(outer_test_data), "\n")</span></span>
<span id="cb63-3641"><a href="#cb63-3641" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3642"><a href="#cb63-3642" aria-hidden="true" tabindex="-1"></a><span class="in">    if (sum(outer_train_data[[target_name]] == 0) == 0 || sum(outer_train_data[[target_name]] == 1) == 0) {</span></span>
<span id="cb63-3643"><a href="#cb63-3643" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Skipping outer fold due to lack of class diversity\n")</span></span>
<span id="cb63-3644"><a href="#cb63-3644" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-3645"><a href="#cb63-3645" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3646"><a href="#cb63-3646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3647"><a href="#cb63-3647" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner, list = TRUE, returnTrain = FALSE)</span></span>
<span id="cb63-3648"><a href="#cb63-3648" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-3649"><a href="#cb63-3649" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-3650"><a href="#cb63-3650" aria-hidden="true" tabindex="-1"></a><span class="in">    best_size &lt;- NULL</span></span>
<span id="cb63-3651"><a href="#cb63-3651" aria-hidden="true" tabindex="-1"></a><span class="in">    best_decay &lt;- NULL</span></span>
<span id="cb63-3652"><a href="#cb63-3652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3653"><a href="#cb63-3653" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(size = sizes, decay = decays)</span></span>
<span id="cb63-3654"><a href="#cb63-3654" aria-hidden="true" tabindex="-1"></a><span class="in">    formula &lt;- reformulate(variables, target_name)</span></span>
<span id="cb63-3655"><a href="#cb63-3655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3656"><a href="#cb63-3656" aria-hidden="true" tabindex="-1"></a><span class="in">    for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-3657"><a href="#cb63-3657" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc &lt;- numeric()</span></span>
<span id="cb63-3658"><a href="#cb63-3658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3659"><a href="#cb63-3659" aria-hidden="true" tabindex="-1"></a><span class="in">      for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3660"><a href="#cb63-3660" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3661"><a href="#cb63-3661" aria-hidden="true" tabindex="-1"></a><span class="in">        inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3662"><a href="#cb63-3662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3663"><a href="#cb63-3663" aria-hidden="true" tabindex="-1"></a><span class="in">        if (sum(inner_train_data[[target_name]] == 0) == 0 || sum(inner_train_data[[target_name]] == 1) == 0) {</span></span>
<span id="cb63-3664"><a href="#cb63-3664" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Skipping inner fold due to lack of class diversity\n")</span></span>
<span id="cb63-3665"><a href="#cb63-3665" aria-hidden="true" tabindex="-1"></a><span class="in">          next</span></span>
<span id="cb63-3666"><a href="#cb63-3666" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3667"><a href="#cb63-3667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3668"><a href="#cb63-3668" aria-hidden="true" tabindex="-1"></a><span class="in">        result &lt;- tryCatch({</span></span>
<span id="cb63-3669"><a href="#cb63-3669" aria-hidden="true" tabindex="-1"></a><span class="in">          model &lt;- nnet(formula, data = inner_train_data, size = grid$size[params], decay = grid$decay[params], linout = FALSE, maxit = 200)</span></span>
<span id="cb63-3670"><a href="#cb63-3670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3671"><a href="#cb63-3671" aria-hidden="true" tabindex="-1"></a><span class="in">          predictions &lt;- predict(model, inner_test_data, type = "raw")</span></span>
<span id="cb63-3672"><a href="#cb63-3672" aria-hidden="true" tabindex="-1"></a><span class="in">          roc_curve &lt;- pROC::roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-3673"><a href="#cb63-3673" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3674"><a href="#cb63-3674" aria-hidden="true" tabindex="-1"></a><span class="in">        }, error = function(e) {</span></span>
<span id="cb63-3675"><a href="#cb63-3675" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error with parameters: size =", grid$size[params], ", decay =", grid$decay[params], "\n")</span></span>
<span id="cb63-3676"><a href="#cb63-3676" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-3677"><a href="#cb63-3677" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc[inner_index] &lt;- 0</span></span>
<span id="cb63-3678"><a href="#cb63-3678" aria-hidden="true" tabindex="-1"></a><span class="in">        })</span></span>
<span id="cb63-3679"><a href="#cb63-3679" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3680"><a href="#cb63-3680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3681"><a href="#cb63-3681" aria-hidden="true" tabindex="-1"></a><span class="in">      if (mean(inner_auc, na.rm = TRUE) &gt; best_auc) {</span></span>
<span id="cb63-3682"><a href="#cb63-3682" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc &lt;- mean(inner_auc, na.rm = TRUE)</span></span>
<span id="cb63-3683"><a href="#cb63-3683" aria-hidden="true" tabindex="-1"></a><span class="in">        best_model &lt;- model</span></span>
<span id="cb63-3684"><a href="#cb63-3684" aria-hidden="true" tabindex="-1"></a><span class="in">        best_size &lt;- grid$size[params]</span></span>
<span id="cb63-3685"><a href="#cb63-3685" aria-hidden="true" tabindex="-1"></a><span class="in">        best_decay &lt;- grid$decay[params]</span></span>
<span id="cb63-3686"><a href="#cb63-3686" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3687"><a href="#cb63-3687" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3688"><a href="#cb63-3688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3689"><a href="#cb63-3689" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")</span></span>
<span id="cb63-3690"><a href="#cb63-3690" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-3691"><a href="#cb63-3691" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3692"><a href="#cb63-3692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3693"><a href="#cb63-3693" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-3694"><a href="#cb63-3694" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3695"><a href="#cb63-3695" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3696"><a href="#cb63-3696" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3697"><a href="#cb63-3697" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3698"><a href="#cb63-3698" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-3699"><a href="#cb63-3699" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-3700"><a href="#cb63-3700" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-3701"><a href="#cb63-3701" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-3702"><a href="#cb63-3702" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-3703"><a href="#cb63-3703" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3704"><a href="#cb63-3704" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- pROC::roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-3705"><a href="#cb63-3705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3706"><a href="#cb63-3706" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, best_size, best_decay), names(performance_metrics))</span></span>
<span id="cb63-3707"><a href="#cb63-3707" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-3708"><a href="#cb63-3708" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3709"><a href="#cb63-3709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3710"><a href="#cb63-3710" aria-hidden="true" tabindex="-1"></a><span class="in">  return(performance_metrics)</span></span>
<span id="cb63-3711"><a href="#cb63-3711" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3712"><a href="#cb63-3712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3713"><a href="#cb63-3713" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_ANN_TodasVariables_Asociacion &lt;- </span></span>
<span id="cb63-3714"><a href="#cb63-3714" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span></span>
<span id="cb63-3715"><a href="#cb63-3715" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-3716"><a href="#cb63-3716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3717"><a href="#cb63-3717" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-3718"><a href="#cb63-3718" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-3719"><a href="#cb63-3719" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-3720"><a href="#cb63-3720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3721"><a href="#cb63-3721" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-3722"><a href="#cb63-3722" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-3723"><a href="#cb63-3723" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-3724"><a href="#cb63-3724" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-3725"><a href="#cb63-3725" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-3726"><a href="#cb63-3726" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-3727"><a href="#cb63-3727" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-3728"><a href="#cb63-3728" aria-hidden="true" tabindex="-1"></a><span class="in">                                   sizes = sizes,</span></span>
<span id="cb63-3729"><a href="#cb63-3729" aria-hidden="true" tabindex="-1"></a><span class="in">                                   decays = decays)</span></span>
<span id="cb63-3730"><a href="#cb63-3730" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-3731"><a href="#cb63-3731" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3732"><a href="#cb63-3732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3733"><a href="#cb63-3733" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-3734"><a href="#cb63-3734" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3735"><a href="#cb63-3735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3736"><a href="#cb63-3736" aria-hidden="true" tabindex="-1"></a><span class="in">performance_ANN_todasvariables &lt;- evaluate_with_seeds_ANN_TodasVariables_Asociacion(</span></span>
<span id="cb63-3737"><a href="#cb63-3737" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_nnet,</span></span>
<span id="cb63-3738"><a href="#cb63-3738" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3739"><a href="#cb63-3739" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3740"><a href="#cb63-3740" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3741"><a href="#cb63-3741" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3742"><a href="#cb63-3742" aria-hidden="true" tabindex="-1"></a><span class="in">  sizes = c(5,10,15,20),</span></span>
<span id="cb63-3743"><a href="#cb63-3743" aria-hidden="true" tabindex="-1"></a><span class="in">  decays = c(0.1, 0.2, 0.3),</span></span>
<span id="cb63-3744"><a href="#cb63-3744" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-3745"><a href="#cb63-3745" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3746"><a href="#cb63-3746" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3747"><a href="#cb63-3747" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3748"><a href="#cb63-3748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3749"><a href="#cb63-3749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3750"><a href="#cb63-3750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3751"><a href="#cb63-3751" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3752"><a href="#cb63-3752" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/ANN_TodasVariables.RData")</span></span>
<span id="cb63-3753"><a href="#cb63-3753" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3754"><a href="#cb63-3754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3755"><a href="#cb63-3755" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtrado (Asociación)</span></span>
<span id="cb63-3756"><a href="#cb63-3756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3757"><a href="#cb63-3757" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3758"><a href="#cb63-3758" aria-hidden="true" tabindex="-1"></a><span class="in">performance_ANN_asociacion &lt;- evaluate_with_seeds_ANN_TodasVariables_Asociacion(</span></span>
<span id="cb63-3759"><a href="#cb63-3759" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_nnet,</span></span>
<span id="cb63-3760"><a href="#cb63-3760" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3761"><a href="#cb63-3761" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3762"><a href="#cb63-3762" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3763"><a href="#cb63-3763" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3764"><a href="#cb63-3764" aria-hidden="true" tabindex="-1"></a><span class="in">  sizes = c(5,10,15,20),</span></span>
<span id="cb63-3765"><a href="#cb63-3765" aria-hidden="true" tabindex="-1"></a><span class="in">  decays = c(0.1, 0.2, 0.3),</span></span>
<span id="cb63-3766"><a href="#cb63-3766" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = asociacion,</span></span>
<span id="cb63-3767"><a href="#cb63-3767" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3768"><a href="#cb63-3768" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3769"><a href="#cb63-3769" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3770"><a href="#cb63-3770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3771"><a href="#cb63-3771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3772"><a href="#cb63-3772" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3773"><a href="#cb63-3773" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/ANN_Asociacion.RData")</span></span>
<span id="cb63-3774"><a href="#cb63-3774" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3775"><a href="#cb63-3775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3776"><a href="#cb63-3776" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrapped (StepAUC)</span></span>
<span id="cb63-3777"><a href="#cb63-3777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3778"><a href="#cb63-3778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3779"><a href="#cb63-3779" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_nnet_stepAUC &lt;- function(data, target_name, outer, inner, sizes, decays, variables, threshold, seed) {</span></span>
<span id="cb63-3780"><a href="#cb63-3780" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-3781"><a href="#cb63-3781" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-3782"><a href="#cb63-3782" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-3783"><a href="#cb63-3783" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Size = integer(), Best_Decay = numeric(), Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3784"><a href="#cb63-3784" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3785"><a href="#cb63-3785" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-3786"><a href="#cb63-3786" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-3787"><a href="#cb63-3787" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3788"><a href="#cb63-3788" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3789"><a href="#cb63-3789" aria-hidden="true" tabindex="-1"></a><span class="in">  data[[target_name]] &lt;- as.numeric(data[[target_name]]) - 1</span></span>
<span id="cb63-3790"><a href="#cb63-3790" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data[[target_name]], k = outer)</span></span>
<span id="cb63-3791"><a href="#cb63-3791" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3792"><a href="#cb63-3792" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-3793"><a href="#cb63-3793" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3794"><a href="#cb63-3794" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3795"><a href="#cb63-3795" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3796"><a href="#cb63-3796" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-3797"><a href="#cb63-3797" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3798"><a href="#cb63-3798" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3799"><a href="#cb63-3799" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3800"><a href="#cb63-3800" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3801"><a href="#cb63-3801" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3802"><a href="#cb63-3802" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-3803"><a href="#cb63-3803" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-3804"><a href="#cb63-3804" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-3805"><a href="#cb63-3805" aria-hidden="true" tabindex="-1"></a><span class="in">    best_size &lt;- NULL</span></span>
<span id="cb63-3806"><a href="#cb63-3806" aria-hidden="true" tabindex="-1"></a><span class="in">    best_decay &lt;- NULL</span></span>
<span id="cb63-3807"><a href="#cb63-3807" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- variables</span></span>
<span id="cb63-3808"><a href="#cb63-3808" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3809"><a href="#cb63-3809" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(size = sizes, decay = decays)</span></span>
<span id="cb63-3810"><a href="#cb63-3810" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3811"><a href="#cb63-3811" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-3812"><a href="#cb63-3812" aria-hidden="true" tabindex="-1"></a><span class="in">      current_vars &lt;- vars</span></span>
<span id="cb63-3813"><a href="#cb63-3813" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-3814"><a href="#cb63-3814" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-3815"><a href="#cb63-3815" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_size &lt;- NULL</span></span>
<span id="cb63-3816"><a href="#cb63-3816" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_decay &lt;- NULL</span></span>
<span id="cb63-3817"><a href="#cb63-3817" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- current_vars</span></span>
<span id="cb63-3818"><a href="#cb63-3818" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-3819"><a href="#cb63-3819" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3820"><a href="#cb63-3820" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(current_vars) &gt; 1) {</span></span>
<span id="cb63-3821"><a href="#cb63-3821" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-3822"><a href="#cb63-3822" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-3823"><a href="#cb63-3823" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3824"><a href="#cb63-3824" aria-hidden="true" tabindex="-1"></a><span class="in">        for (var in current_vars) {</span></span>
<span id="cb63-3825"><a href="#cb63-3825" aria-hidden="true" tabindex="-1"></a><span class="in">          temp_vars &lt;- setdiff(current_vars, var)</span></span>
<span id="cb63-3826"><a href="#cb63-3826" aria-hidden="true" tabindex="-1"></a><span class="in">          inner_auc &lt;- numeric()</span></span>
<span id="cb63-3827"><a href="#cb63-3827" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-3828"><a href="#cb63-3828" aria-hidden="true" tabindex="-1"></a><span class="in">          for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-3829"><a href="#cb63-3829" aria-hidden="true" tabindex="-1"></a><span class="in">            auc_vals &lt;- numeric()</span></span>
<span id="cb63-3830"><a href="#cb63-3830" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3831"><a href="#cb63-3831" aria-hidden="true" tabindex="-1"></a><span class="in">            for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-3832"><a href="#cb63-3832" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3833"><a href="#cb63-3833" aria-hidden="true" tabindex="-1"></a><span class="in">              inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-3834"><a href="#cb63-3834" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-3835"><a href="#cb63-3835" aria-hidden="true" tabindex="-1"></a><span class="in">              result &lt;- tryCatch({</span></span>
<span id="cb63-3836"><a href="#cb63-3836" aria-hidden="true" tabindex="-1"></a><span class="in">                model &lt;- nnet(as.formula(paste(target_name, "~", paste(temp_vars, collapse = "+"))),</span></span>
<span id="cb63-3837"><a href="#cb63-3837" aria-hidden="true" tabindex="-1"></a><span class="in">                              data = inner_train_data, size = grid$size[params], decay = grid$decay[params], </span></span>
<span id="cb63-3838"><a href="#cb63-3838" aria-hidden="true" tabindex="-1"></a><span class="in">                              linout = FALSE, maxit = 200, trace = FALSE)</span></span>
<span id="cb63-3839"><a href="#cb63-3839" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-3840"><a href="#cb63-3840" aria-hidden="true" tabindex="-1"></a><span class="in">                predictions &lt;- predict(model, inner_test_data, type = "raw")</span></span>
<span id="cb63-3841"><a href="#cb63-3841" aria-hidden="true" tabindex="-1"></a><span class="in">                roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-3842"><a href="#cb63-3842" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-3843"><a href="#cb63-3843" aria-hidden="true" tabindex="-1"></a><span class="in">                </span></span>
<span id="cb63-3844"><a href="#cb63-3844" aria-hidden="true" tabindex="-1"></a><span class="in">                # Guardar los datos del inner fold</span></span>
<span id="cb63-3845"><a href="#cb63-3845" aria-hidden="true" tabindex="-1"></a><span class="in">                pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-3846"><a href="#cb63-3846" aria-hidden="true" tabindex="-1"></a><span class="in">                confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3847"><a href="#cb63-3847" aria-hidden="true" tabindex="-1"></a><span class="in">                TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3848"><a href="#cb63-3848" aria-hidden="true" tabindex="-1"></a><span class="in">                TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3849"><a href="#cb63-3849" aria-hidden="true" tabindex="-1"></a><span class="in">                FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3850"><a href="#cb63-3850" aria-hidden="true" tabindex="-1"></a><span class="in">                FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3851"><a href="#cb63-3851" aria-hidden="true" tabindex="-1"></a><span class="in">                auc &lt;- roc_curve$auc</span></span>
<span id="cb63-3852"><a href="#cb63-3852" aria-hidden="true" tabindex="-1"></a><span class="in">                inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-3853"><a href="#cb63-3853" aria-hidden="true" tabindex="-1"></a><span class="in">                inner_fold_metrics &lt;&lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-3854"><a href="#cb63-3854" aria-hidden="true" tabindex="-1"></a><span class="in">              }, error = function(e) {</span></span>
<span id="cb63-3855"><a href="#cb63-3855" aria-hidden="true" tabindex="-1"></a><span class="in">                cat("Error with variables:", paste(temp_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-3856"><a href="#cb63-3856" aria-hidden="true" tabindex="-1"></a><span class="in">                auc_vals[inner_index] &lt;- 0  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-3857"><a href="#cb63-3857" aria-hidden="true" tabindex="-1"></a><span class="in">              })</span></span>
<span id="cb63-3858"><a href="#cb63-3858" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-3859"><a href="#cb63-3859" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-3860"><a href="#cb63-3860" aria-hidden="true" tabindex="-1"></a><span class="in">            if (mean(auc_vals, na.rm = TRUE) &gt; best_auc_in_step) {</span></span>
<span id="cb63-3861"><a href="#cb63-3861" aria-hidden="true" tabindex="-1"></a><span class="in">              best_auc_in_step &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-3862"><a href="#cb63-3862" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_model &lt;- model</span></span>
<span id="cb63-3863"><a href="#cb63-3863" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_size &lt;- grid$size[params]</span></span>
<span id="cb63-3864"><a href="#cb63-3864" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_decay &lt;- grid$decay[params]</span></span>
<span id="cb63-3865"><a href="#cb63-3865" aria-hidden="true" tabindex="-1"></a><span class="in">              best_inner_vars &lt;- temp_vars</span></span>
<span id="cb63-3866"><a href="#cb63-3866" aria-hidden="true" tabindex="-1"></a><span class="in">              improved &lt;- TRUE</span></span>
<span id="cb63-3867"><a href="#cb63-3867" aria-hidden="true" tabindex="-1"></a><span class="in">            }</span></span>
<span id="cb63-3868"><a href="#cb63-3868" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-3869"><a href="#cb63-3869" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3870"><a href="#cb63-3870" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-3871"><a href="#cb63-3871" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-3872"><a href="#cb63-3872" aria-hidden="true" tabindex="-1"></a><span class="in">          current_vars &lt;- best_inner_vars</span></span>
<span id="cb63-3873"><a href="#cb63-3873" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-3874"><a href="#cb63-3874" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(current_vars, collapse=", "), "\n")</span></span>
<span id="cb63-3875"><a href="#cb63-3875" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", paste(best_inner_auc), "\n")</span></span>
<span id="cb63-3876"><a href="#cb63-3876" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-3877"><a href="#cb63-3877" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-3878"><a href="#cb63-3878" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-3879"><a href="#cb63-3879" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-3880"><a href="#cb63-3880" aria-hidden="true" tabindex="-1"></a><span class="in">           size = best_inner_size, decay = best_inner_decay, </span></span>
<span id="cb63-3881"><a href="#cb63-3881" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-3882"><a href="#cb63-3882" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3883"><a href="#cb63-3883" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3884"><a href="#cb63-3884" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(variables, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-3885"><a href="#cb63-3885" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-3886"><a href="#cb63-3886" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-3887"><a href="#cb63-3887" aria-hidden="true" tabindex="-1"></a><span class="in">    best_size &lt;- best_result$size</span></span>
<span id="cb63-3888"><a href="#cb63-3888" aria-hidden="true" tabindex="-1"></a><span class="in">    best_decay &lt;- best_result$decay</span></span>
<span id="cb63-3889"><a href="#cb63-3889" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-3890"><a href="#cb63-3890" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3891"><a href="#cb63-3891" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")</span></span>
<span id="cb63-3892"><a href="#cb63-3892" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-3893"><a href="#cb63-3893" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-3894"><a href="#cb63-3894" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3895"><a href="#cb63-3895" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-3896"><a href="#cb63-3896" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-3897"><a href="#cb63-3897" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-3898"><a href="#cb63-3898" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-3899"><a href="#cb63-3899" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-3900"><a href="#cb63-3900" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-3901"><a href="#cb63-3901" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-3902"><a href="#cb63-3902" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-3903"><a href="#cb63-3903" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-3904"><a href="#cb63-3904" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-3905"><a href="#cb63-3905" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-3906"><a href="#cb63-3906" aria-hidden="true" tabindex="-1"></a><span class="in">    auc = roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-3907"><a href="#cb63-3907" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3908"><a href="#cb63-3908" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-3909"><a href="#cb63-3909" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_size, best_decay, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-3910"><a href="#cb63-3910" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-3911"><a href="#cb63-3911" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-3912"><a href="#cb63-3912" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3913"><a href="#cb63-3913" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:", paste(performance_metrics))</span></span>
<span id="cb63-3914"><a href="#cb63-3914" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3915"><a href="#cb63-3915" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-3916"><a href="#cb63-3916" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-3917"><a href="#cb63-3917" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Size: %d, Best Decay: %f, Best Variables: %s\n",</span></span>
<span id="cb63-3918"><a href="#cb63-3918" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_size, best_decay, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-3919"><a href="#cb63-3919" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3920"><a href="#cb63-3920" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3921"><a href="#cb63-3921" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-3922"><a href="#cb63-3922" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-3923"><a href="#cb63-3923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3924"><a href="#cb63-3924" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_ANN_StepAUC &lt;- </span></span>
<span id="cb63-3925"><a href="#cb63-3925" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span></span>
<span id="cb63-3926"><a href="#cb63-3926" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-3927"><a href="#cb63-3927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3928"><a href="#cb63-3928" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-3929"><a href="#cb63-3929" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-3930"><a href="#cb63-3930" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-3931"><a href="#cb63-3931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3932"><a href="#cb63-3932" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-3933"><a href="#cb63-3933" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-3934"><a href="#cb63-3934" aria-hidden="true" tabindex="-1"></a><span class="in">                                   variables = vars, </span></span>
<span id="cb63-3935"><a href="#cb63-3935" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-3936"><a href="#cb63-3936" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-3937"><a href="#cb63-3937" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-3938"><a href="#cb63-3938" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-3939"><a href="#cb63-3939" aria-hidden="true" tabindex="-1"></a><span class="in">                                   sizes = sizes,</span></span>
<span id="cb63-3940"><a href="#cb63-3940" aria-hidden="true" tabindex="-1"></a><span class="in">                                   decays = decays)</span></span>
<span id="cb63-3941"><a href="#cb63-3941" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-3942"><a href="#cb63-3942" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3943"><a href="#cb63-3943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3944"><a href="#cb63-3944" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-3945"><a href="#cb63-3945" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-3946"><a href="#cb63-3946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3947"><a href="#cb63-3947" aria-hidden="true" tabindex="-1"></a><span class="in">performance_ANN_stepAUC &lt;- evaluate_with_seeds_ANN_StepAUC(</span></span>
<span id="cb63-3948"><a href="#cb63-3948" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_nnet_stepAUC,</span></span>
<span id="cb63-3949"><a href="#cb63-3949" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-3950"><a href="#cb63-3950" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-3951"><a href="#cb63-3951" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-3952"><a href="#cb63-3952" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-3953"><a href="#cb63-3953" aria-hidden="true" tabindex="-1"></a><span class="in">  sizes = c(5,10,15,20),</span></span>
<span id="cb63-3954"><a href="#cb63-3954" aria-hidden="true" tabindex="-1"></a><span class="in">  decays = c(0.1, 0.2, 0.3),</span></span>
<span id="cb63-3955"><a href="#cb63-3955" aria-hidden="true" tabindex="-1"></a><span class="in">  vars = todas_variables_factor,</span></span>
<span id="cb63-3956"><a href="#cb63-3956" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-3957"><a href="#cb63-3957" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-3958"><a href="#cb63-3958" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-3959"><a href="#cb63-3959" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3960"><a href="#cb63-3960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3961"><a href="#cb63-3961" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-3962"><a href="#cb63-3962" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/ANN_StepAUC.RData")</span></span>
<span id="cb63-3963"><a href="#cb63-3963" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-3964"><a href="#cb63-3964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3965"><a href="#cb63-3965" aria-hidden="true" tabindex="-1"></a><span class="fu">### Embedded (Lasso)</span></span>
<span id="cb63-3966"><a href="#cb63-3966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3967"><a href="#cb63-3967" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb63-3968"><a href="#cb63-3968" aria-hidden="true" tabindex="-1"></a><span class="in">double_cross_validation_nnet_lasso &lt;- function(data, target_name, outer, inner, sizes, decays, threshold, seed) {</span></span>
<span id="cb63-3969"><a href="#cb63-3969" aria-hidden="true" tabindex="-1"></a><span class="in">  set.seed(seed)</span></span>
<span id="cb63-3970"><a href="#cb63-3970" aria-hidden="true" tabindex="-1"></a><span class="in">  performance_metrics &lt;- data.frame(Fold = integer(), TP = integer(), TN = integer(),</span></span>
<span id="cb63-3971"><a href="#cb63-3971" aria-hidden="true" tabindex="-1"></a><span class="in">                                    FP = integer(), FN = integer(), AUC = numeric(),</span></span>
<span id="cb63-3972"><a href="#cb63-3972" aria-hidden="true" tabindex="-1"></a><span class="in">                                    Best_Size = integer(), Best_Decay = numeric(), Best_Variables = character(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3973"><a href="#cb63-3973" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3974"><a href="#cb63-3974" aria-hidden="true" tabindex="-1"></a><span class="in">  inner_fold_metrics &lt;- data.frame(Fold = integer(), Inner_Fold = integer(), </span></span>
<span id="cb63-3975"><a href="#cb63-3975" aria-hidden="true" tabindex="-1"></a><span class="in">                                   TP = integer(), TN = integer(), FP = integer(), </span></span>
<span id="cb63-3976"><a href="#cb63-3976" aria-hidden="true" tabindex="-1"></a><span class="in">                                   FN = integer(), AUC = numeric(), stringsAsFactors = FALSE)</span></span>
<span id="cb63-3977"><a href="#cb63-3977" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3978"><a href="#cb63-3978" aria-hidden="true" tabindex="-1"></a><span class="in">  # Convertir las variables del dataset con model.matrix</span></span>
<span id="cb63-3979"><a href="#cb63-3979" aria-hidden="true" tabindex="-1"></a><span class="in">  target &lt;- as.numeric(data[[target_name]]) - 1</span></span>
<span id="cb63-3980"><a href="#cb63-3980" aria-hidden="true" tabindex="-1"></a><span class="in">  features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-3981"><a href="#cb63-3981" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix &lt;- as.data.frame(model.matrix(~ ., data=features)[,-1])  # Eliminar el intercepto</span></span>
<span id="cb63-3982"><a href="#cb63-3982" aria-hidden="true" tabindex="-1"></a><span class="in">  data_matrix[[target_name]] &lt;- target</span></span>
<span id="cb63-3983"><a href="#cb63-3983" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3984"><a href="#cb63-3984" aria-hidden="true" tabindex="-1"></a><span class="in">  outer_folds &lt;- createFolds(data_matrix[[target_name]], k = outer)</span></span>
<span id="cb63-3985"><a href="#cb63-3985" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-3986"><a href="#cb63-3986" aria-hidden="true" tabindex="-1"></a><span class="in">  for (outer_index in seq_along(outer_folds)) {</span></span>
<span id="cb63-3987"><a href="#cb63-3987" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_train_data &lt;- data_matrix[-outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3988"><a href="#cb63-3988" aria-hidden="true" tabindex="-1"></a><span class="in">    outer_test_data &lt;- data_matrix[outer_folds[[outer_index]], ]</span></span>
<span id="cb63-3989"><a href="#cb63-3989" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3990"><a href="#cb63-3990" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Outer Fold %d\n", outer_index))</span></span>
<span id="cb63-3991"><a href="#cb63-3991" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 0: ", sum(outer_train_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3992"><a href="#cb63-3992" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Training Data - Class 1: ", sum(outer_train_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3993"><a href="#cb63-3993" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 0: ", sum(outer_test_data[[target_name]] == 0), "\n")</span></span>
<span id="cb63-3994"><a href="#cb63-3994" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Testing Data - Class 1: ", sum(outer_test_data[[target_name]] == 1), "\n")</span></span>
<span id="cb63-3995"><a href="#cb63-3995" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-3996"><a href="#cb63-3996" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_folds &lt;- createFolds(outer_train_data[[target_name]], k = inner)</span></span>
<span id="cb63-3997"><a href="#cb63-3997" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- NULL</span></span>
<span id="cb63-3998"><a href="#cb63-3998" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- 0</span></span>
<span id="cb63-3999"><a href="#cb63-3999" aria-hidden="true" tabindex="-1"></a><span class="in">    best_size &lt;- NULL</span></span>
<span id="cb63-4000"><a href="#cb63-4000" aria-hidden="true" tabindex="-1"></a><span class="in">    best_decay &lt;- NULL</span></span>
<span id="cb63-4001"><a href="#cb63-4001" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- colnames(outer_train_data)[!colnames(outer_train_data) %in% target_name]</span></span>
<span id="cb63-4002"><a href="#cb63-4002" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4003"><a href="#cb63-4003" aria-hidden="true" tabindex="-1"></a><span class="in">    grid &lt;- expand.grid(size = sizes, decay = decays)</span></span>
<span id="cb63-4004"><a href="#cb63-4004" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4005"><a href="#cb63-4005" aria-hidden="true" tabindex="-1"></a><span class="in">    select_vars_lasso &lt;- function(data, target_name) {</span></span>
<span id="cb63-4006"><a href="#cb63-4006" aria-hidden="true" tabindex="-1"></a><span class="in">      target &lt;- as.numeric(data[[target_name]])</span></span>
<span id="cb63-4007"><a href="#cb63-4007" aria-hidden="true" tabindex="-1"></a><span class="in">      features &lt;- data[, setdiff(names(data), target_name)]</span></span>
<span id="cb63-4008"><a href="#cb63-4008" aria-hidden="true" tabindex="-1"></a><span class="in">      X &lt;- model.matrix(~ ., data=features)[,-1]  # Eliminamos el intercepto</span></span>
<span id="cb63-4009"><a href="#cb63-4009" aria-hidden="true" tabindex="-1"></a><span class="in">      y &lt;- target</span></span>
<span id="cb63-4010"><a href="#cb63-4010" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4011"><a href="#cb63-4011" aria-hidden="true" tabindex="-1"></a><span class="in">      # Ajustamos el modelo Lasso</span></span>
<span id="cb63-4012"><a href="#cb63-4012" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_model &lt;- cv.glmnet(X, y, alpha=1)</span></span>
<span id="cb63-4013"><a href="#cb63-4013" aria-hidden="true" tabindex="-1"></a><span class="in">      lasso_coef &lt;- coef(lasso_model, s = "lambda.min")</span></span>
<span id="cb63-4014"><a href="#cb63-4014" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4015"><a href="#cb63-4015" aria-hidden="true" tabindex="-1"></a><span class="in">      # Seleccionamos las variables no nulas</span></span>
<span id="cb63-4016"><a href="#cb63-4016" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- rownames(lasso_coef)[lasso_coef[, 1] != 0]</span></span>
<span id="cb63-4017"><a href="#cb63-4017" aria-hidden="true" tabindex="-1"></a><span class="in">      selected_vars &lt;- setdiff(selected_vars, "(Intercept)")</span></span>
<span id="cb63-4018"><a href="#cb63-4018" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Selected variables by Lasso: ", paste(selected_vars, collapse=", "), "\n")</span></span>
<span id="cb63-4019"><a href="#cb63-4019" aria-hidden="true" tabindex="-1"></a><span class="in">      return(selected_vars)</span></span>
<span id="cb63-4020"><a href="#cb63-4020" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-4021"><a href="#cb63-4021" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4022"><a href="#cb63-4022" aria-hidden="true" tabindex="-1"></a><span class="in">    stepAUC &lt;- function(vars, data, target_name, grid, inner_folds) {</span></span>
<span id="cb63-4023"><a href="#cb63-4023" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_auc &lt;- 0</span></span>
<span id="cb63-4024"><a href="#cb63-4024" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_model &lt;- NULL</span></span>
<span id="cb63-4025"><a href="#cb63-4025" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_size &lt;- NULL</span></span>
<span id="cb63-4026"><a href="#cb63-4026" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_decay &lt;- NULL</span></span>
<span id="cb63-4027"><a href="#cb63-4027" aria-hidden="true" tabindex="-1"></a><span class="in">      best_inner_vars &lt;- vars</span></span>
<span id="cb63-4028"><a href="#cb63-4028" aria-hidden="true" tabindex="-1"></a><span class="in">      improved &lt;- TRUE</span></span>
<span id="cb63-4029"><a href="#cb63-4029" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4030"><a href="#cb63-4030" aria-hidden="true" tabindex="-1"></a><span class="in">      while (improved &amp;&amp; length(vars) &gt; 1) {</span></span>
<span id="cb63-4031"><a href="#cb63-4031" aria-hidden="true" tabindex="-1"></a><span class="in">        improved &lt;- FALSE</span></span>
<span id="cb63-4032"><a href="#cb63-4032" aria-hidden="true" tabindex="-1"></a><span class="in">        best_auc_in_step &lt;- best_inner_auc</span></span>
<span id="cb63-4033"><a href="#cb63-4033" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-4034"><a href="#cb63-4034" aria-hidden="true" tabindex="-1"></a><span class="in">        for (params in 1:nrow(grid)) {</span></span>
<span id="cb63-4035"><a href="#cb63-4035" aria-hidden="true" tabindex="-1"></a><span class="in">          auc_vals &lt;- numeric()</span></span>
<span id="cb63-4036"><a href="#cb63-4036" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-4037"><a href="#cb63-4037" aria-hidden="true" tabindex="-1"></a><span class="in">          for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-4038"><a href="#cb63-4038" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-4039"><a href="#cb63-4039" aria-hidden="true" tabindex="-1"></a><span class="in">            inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-4040"><a href="#cb63-4040" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-4041"><a href="#cb63-4041" aria-hidden="true" tabindex="-1"></a><span class="in">            selected_vars &lt;- select_vars_lasso(inner_train_data, target_name)</span></span>
<span id="cb63-4042"><a href="#cb63-4042" aria-hidden="true" tabindex="-1"></a><span class="in">            formula &lt;- as.formula(paste(target_name, "~", paste(selected_vars, collapse = "+")))</span></span>
<span id="cb63-4043"><a href="#cb63-4043" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Testing with formula: ", deparse(formula), "\n")</span></span>
<span id="cb63-4044"><a href="#cb63-4044" aria-hidden="true" tabindex="-1"></a><span class="in">            #cat("Grid parameters - size: ", grid$size[params], ", decay: ", grid$decay[params], "\n")</span></span>
<span id="cb63-4045"><a href="#cb63-4045" aria-hidden="true" tabindex="-1"></a><span class="in">            </span></span>
<span id="cb63-4046"><a href="#cb63-4046" aria-hidden="true" tabindex="-1"></a><span class="in">            result &lt;- tryCatch({</span></span>
<span id="cb63-4047"><a href="#cb63-4047" aria-hidden="true" tabindex="-1"></a><span class="in">              model &lt;- nnet(formula, data = inner_train_data, size = grid$size[params], </span></span>
<span id="cb63-4048"><a href="#cb63-4048" aria-hidden="true" tabindex="-1"></a><span class="in">                            decay = grid$decay[params], linout = FALSE, maxit = 200, trace = FALSE)</span></span>
<span id="cb63-4049"><a href="#cb63-4049" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-4050"><a href="#cb63-4050" aria-hidden="true" tabindex="-1"></a><span class="in">              predictions &lt;- predict(model, inner_test_data, type = "raw")</span></span>
<span id="cb63-4051"><a href="#cb63-4051" aria-hidden="true" tabindex="-1"></a><span class="in">              roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-4052"><a href="#cb63-4052" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-4053"><a href="#cb63-4053" aria-hidden="true" tabindex="-1"></a><span class="in">              #cat("AUC for inner fold ", inner_index, ": ", roc_curve$auc, "\n")</span></span>
<span id="cb63-4054"><a href="#cb63-4054" aria-hidden="true" tabindex="-1"></a><span class="in">              </span></span>
<span id="cb63-4055"><a href="#cb63-4055" aria-hidden="true" tabindex="-1"></a><span class="in">            }, error = function(e) {</span></span>
<span id="cb63-4056"><a href="#cb63-4056" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error with variables: ", paste(selected_vars, collapse = ", "), "\n")</span></span>
<span id="cb63-4057"><a href="#cb63-4057" aria-hidden="true" tabindex="-1"></a><span class="in">              cat("Error message: ", e$message, "\n")</span></span>
<span id="cb63-4058"><a href="#cb63-4058" aria-hidden="true" tabindex="-1"></a><span class="in">              auc_vals[inner_index] &lt;- NA  # Set to NA or some other indicator of failure</span></span>
<span id="cb63-4059"><a href="#cb63-4059" aria-hidden="true" tabindex="-1"></a><span class="in">            })</span></span>
<span id="cb63-4060"><a href="#cb63-4060" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-4061"><a href="#cb63-4061" aria-hidden="true" tabindex="-1"></a><span class="in">          </span></span>
<span id="cb63-4062"><a href="#cb63-4062" aria-hidden="true" tabindex="-1"></a><span class="in">          mean_auc &lt;- mean(auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-4063"><a href="#cb63-4063" aria-hidden="true" tabindex="-1"></a><span class="in">          #cat("Mean AUC for params - size: ", grid$size[params], ", decay: ", grid$decay[params], ": ", mean_auc, "\n")</span></span>
<span id="cb63-4064"><a href="#cb63-4064" aria-hidden="true" tabindex="-1"></a><span class="in">          if (!is.na(mean_auc) &amp;&amp; mean_auc &gt; best_auc_in_step) {</span></span>
<span id="cb63-4065"><a href="#cb63-4065" aria-hidden="true" tabindex="-1"></a><span class="in">            best_auc_in_step &lt;- mean_auc</span></span>
<span id="cb63-4066"><a href="#cb63-4066" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_model &lt;- model</span></span>
<span id="cb63-4067"><a href="#cb63-4067" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_size &lt;- grid$size[params]</span></span>
<span id="cb63-4068"><a href="#cb63-4068" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_decay &lt;- grid$decay[params]</span></span>
<span id="cb63-4069"><a href="#cb63-4069" aria-hidden="true" tabindex="-1"></a><span class="in">            best_inner_vars &lt;- selected_vars</span></span>
<span id="cb63-4070"><a href="#cb63-4070" aria-hidden="true" tabindex="-1"></a><span class="in">            improved &lt;- TRUE</span></span>
<span id="cb63-4071"><a href="#cb63-4071" aria-hidden="true" tabindex="-1"></a><span class="in">          }</span></span>
<span id="cb63-4072"><a href="#cb63-4072" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-4073"><a href="#cb63-4073" aria-hidden="true" tabindex="-1"></a><span class="in">        </span></span>
<span id="cb63-4074"><a href="#cb63-4074" aria-hidden="true" tabindex="-1"></a><span class="in">        if (improved) {</span></span>
<span id="cb63-4075"><a href="#cb63-4075" aria-hidden="true" tabindex="-1"></a><span class="in">          vars &lt;- best_inner_vars</span></span>
<span id="cb63-4076"><a href="#cb63-4076" aria-hidden="true" tabindex="-1"></a><span class="in">          best_inner_auc &lt;- best_auc_in_step</span></span>
<span id="cb63-4077"><a href="#cb63-4077" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("Vars improved: ", paste(vars, collapse=", "), "\n")</span></span>
<span id="cb63-4078"><a href="#cb63-4078" aria-hidden="true" tabindex="-1"></a><span class="in">          cat("AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-4079"><a href="#cb63-4079" aria-hidden="true" tabindex="-1"></a><span class="in">        }</span></span>
<span id="cb63-4080"><a href="#cb63-4080" aria-hidden="true" tabindex="-1"></a><span class="in">      }</span></span>
<span id="cb63-4081"><a href="#cb63-4081" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4082"><a href="#cb63-4082" aria-hidden="true" tabindex="-1"></a><span class="in">      list(model = best_inner_model, auc = best_inner_auc, </span></span>
<span id="cb63-4083"><a href="#cb63-4083" aria-hidden="true" tabindex="-1"></a><span class="in">           size = best_inner_size, decay = best_inner_decay, </span></span>
<span id="cb63-4084"><a href="#cb63-4084" aria-hidden="true" tabindex="-1"></a><span class="in">           vars = best_inner_vars)</span></span>
<span id="cb63-4085"><a href="#cb63-4085" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-4086"><a href="#cb63-4086" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4087"><a href="#cb63-4087" aria-hidden="true" tabindex="-1"></a><span class="in">    best_result &lt;- stepAUC(best_vars, outer_train_data, target_name, grid, inner_folds)</span></span>
<span id="cb63-4088"><a href="#cb63-4088" aria-hidden="true" tabindex="-1"></a><span class="in">    best_model &lt;- best_result$model</span></span>
<span id="cb63-4089"><a href="#cb63-4089" aria-hidden="true" tabindex="-1"></a><span class="in">    best_auc &lt;- best_result$auc</span></span>
<span id="cb63-4090"><a href="#cb63-4090" aria-hidden="true" tabindex="-1"></a><span class="in">    best_size &lt;- best_result$size</span></span>
<span id="cb63-4091"><a href="#cb63-4091" aria-hidden="true" tabindex="-1"></a><span class="in">    best_decay &lt;- best_result$decay</span></span>
<span id="cb63-4092"><a href="#cb63-4092" aria-hidden="true" tabindex="-1"></a><span class="in">    best_vars &lt;- best_result$vars</span></span>
<span id="cb63-4093"><a href="#cb63-4093" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4094"><a href="#cb63-4094" aria-hidden="true" tabindex="-1"></a><span class="in">    if (is.null(best_model)) {</span></span>
<span id="cb63-4095"><a href="#cb63-4095" aria-hidden="true" tabindex="-1"></a><span class="in">      cat("Error: No valid model found for outer fold ", outer_index, "\n")</span></span>
<span id="cb63-4096"><a href="#cb63-4096" aria-hidden="true" tabindex="-1"></a><span class="in">      next</span></span>
<span id="cb63-4097"><a href="#cb63-4097" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-4098"><a href="#cb63-4098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4099"><a href="#cb63-4099" aria-hidden="true" tabindex="-1"></a><span class="in">    # Evaluar el mejor modelo en el validation split del inner loop</span></span>
<span id="cb63-4100"><a href="#cb63-4100" aria-hidden="true" tabindex="-1"></a><span class="in">    inner_auc_vals &lt;- numeric()</span></span>
<span id="cb63-4101"><a href="#cb63-4101" aria-hidden="true" tabindex="-1"></a><span class="in">    for (inner_index in seq_along(inner_folds)) {</span></span>
<span id="cb63-4102"><a href="#cb63-4102" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_train_data &lt;- outer_train_data[-inner_folds[[inner_index]], ]</span></span>
<span id="cb63-4103"><a href="#cb63-4103" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_test_data &lt;- outer_train_data[inner_folds[[inner_index]], ]</span></span>
<span id="cb63-4104"><a href="#cb63-4104" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4105"><a href="#cb63-4105" aria-hidden="true" tabindex="-1"></a><span class="in">      predictions &lt;- predict(best_model, inner_test_data, type = "raw")</span></span>
<span id="cb63-4106"><a href="#cb63-4106" aria-hidden="true" tabindex="-1"></a><span class="in">      roc_curve &lt;- roc(inner_test_data[[target_name]], predictions)</span></span>
<span id="cb63-4107"><a href="#cb63-4107" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_auc_vals[inner_index] &lt;- roc_curve$auc</span></span>
<span id="cb63-4108"><a href="#cb63-4108" aria-hidden="true" tabindex="-1"></a><span class="in">      #cat("Inner fold ", inner_index, " AUC: ", roc_curve$auc, "\n")</span></span>
<span id="cb63-4109"><a href="#cb63-4109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4110"><a href="#cb63-4110" aria-hidden="true" tabindex="-1"></a><span class="in">      pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)</span></span>
<span id="cb63-4111"><a href="#cb63-4111" aria-hidden="true" tabindex="-1"></a><span class="in">      confusion &lt;- table(Actual = inner_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-4112"><a href="#cb63-4112" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-4113"><a href="#cb63-4113" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-4114"><a href="#cb63-4114" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-4115"><a href="#cb63-4115" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-4116"><a href="#cb63-4116" aria-hidden="true" tabindex="-1"></a><span class="in">      auc &lt;- roc_curve$auc</span></span>
<span id="cb63-4117"><a href="#cb63-4117" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb63-4118"><a href="#cb63-4118" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_metrics &lt;- setNames(c(outer_index, inner_index, TP, TN, FP, FN, auc), names(inner_fold_metrics))</span></span>
<span id="cb63-4119"><a href="#cb63-4119" aria-hidden="true" tabindex="-1"></a><span class="in">      inner_fold_metrics &lt;- rbind(inner_fold_metrics, as.data.frame(t(inner_metrics)))</span></span>
<span id="cb63-4120"><a href="#cb63-4120" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-4121"><a href="#cb63-4121" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4122"><a href="#cb63-4122" aria-hidden="true" tabindex="-1"></a><span class="in">    best_inner_auc &lt;- mean(inner_auc_vals, na.rm = TRUE)</span></span>
<span id="cb63-4123"><a href="#cb63-4123" aria-hidden="true" tabindex="-1"></a><span class="in">    #cat("Best inner AUC: ", best_inner_auc, "\n")</span></span>
<span id="cb63-4124"><a href="#cb63-4124" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4125"><a href="#cb63-4125" aria-hidden="true" tabindex="-1"></a><span class="in">    predictions &lt;- predict(best_model, outer_test_data, type = "raw")</span></span>
<span id="cb63-4126"><a href="#cb63-4126" aria-hidden="true" tabindex="-1"></a><span class="in">    pred_class &lt;- ifelse(predictions &gt; threshold, 1, 0)  # Asignar clases basadas en umbral</span></span>
<span id="cb63-4127"><a href="#cb63-4127" aria-hidden="true" tabindex="-1"></a><span class="in">    confusion &lt;- table(Actual = outer_test_data[[target_name]], Predicted = pred_class)</span></span>
<span id="cb63-4128"><a href="#cb63-4128" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4129"><a href="#cb63-4129" aria-hidden="true" tabindex="-1"></a><span class="in">    if (nrow(confusion) &lt; 2 || ncol(confusion) &lt; 2) {</span></span>
<span id="cb63-4130"><a href="#cb63-4130" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 2, confusion[2, 2], 0)</span></span>
<span id="cb63-4131"><a href="#cb63-4131" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 1, confusion[1, 1], 0)</span></span>
<span id="cb63-4132"><a href="#cb63-4132" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- ifelse(nrow(confusion) &gt;= 1 &amp;&amp; ncol(confusion) &gt;= 2, confusion[1, 2], 0)</span></span>
<span id="cb63-4133"><a href="#cb63-4133" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- ifelse(nrow(confusion) &gt;= 2 &amp;&amp; ncol(confusion) &gt;= 1, confusion[2, 1], 0)</span></span>
<span id="cb63-4134"><a href="#cb63-4134" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb63-4135"><a href="#cb63-4135" aria-hidden="true" tabindex="-1"></a><span class="in">      TP &lt;- confusion[2, 2]</span></span>
<span id="cb63-4136"><a href="#cb63-4136" aria-hidden="true" tabindex="-1"></a><span class="in">      TN &lt;- confusion[1, 1]</span></span>
<span id="cb63-4137"><a href="#cb63-4137" aria-hidden="true" tabindex="-1"></a><span class="in">      FP &lt;- confusion[1, 2]</span></span>
<span id="cb63-4138"><a href="#cb63-4138" aria-hidden="true" tabindex="-1"></a><span class="in">      FN &lt;- confusion[2, 1]</span></span>
<span id="cb63-4139"><a href="#cb63-4139" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb63-4140"><a href="#cb63-4140" aria-hidden="true" tabindex="-1"></a><span class="in">    auc &lt;- roc(outer_test_data[[target_name]], predictions)$auc</span></span>
<span id="cb63-4141"><a href="#cb63-4141" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4142"><a href="#cb63-4142" aria-hidden="true" tabindex="-1"></a><span class="in">    metrics &lt;- setNames(c(outer_index, TP, TN, FP, FN, auc, </span></span>
<span id="cb63-4143"><a href="#cb63-4143" aria-hidden="true" tabindex="-1"></a><span class="in">                          best_size, best_decay, paste(best_vars, collapse = ",")), </span></span>
<span id="cb63-4144"><a href="#cb63-4144" aria-hidden="true" tabindex="-1"></a><span class="in">                        names(performance_metrics))</span></span>
<span id="cb63-4145"><a href="#cb63-4145" aria-hidden="true" tabindex="-1"></a><span class="in">    performance_metrics &lt;- rbind(performance_metrics, as.data.frame(t(metrics)))</span></span>
<span id="cb63-4146"><a href="#cb63-4146" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb63-4147"><a href="#cb63-4147" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Performance:\n", paste(performance_metrics), "\n")</span></span>
<span id="cb63-4148"><a href="#cb63-4148" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Confusion Matrix for Fold %d:\n", outer_index))</span></span>
<span id="cb63-4149"><a href="#cb63-4149" aria-hidden="true" tabindex="-1"></a><span class="in">    print(confusion)</span></span>
<span id="cb63-4150"><a href="#cb63-4150" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("Metrics for Fold %d:\n", outer_index))</span></span>
<span id="cb63-4151"><a href="#cb63-4151" aria-hidden="true" tabindex="-1"></a><span class="in">    cat(sprintf("TP: %d, TN: %d, FP: %d, FN: %d, AUC: %f, Best Size: %d, Best Decay: %f, Best Variables: %s\n",</span></span>
<span id="cb63-4152"><a href="#cb63-4152" aria-hidden="true" tabindex="-1"></a><span class="in">                TP, TN, FP, FN, auc, best_size, best_decay, paste(best_vars, collapse = ",")))</span></span>
<span id="cb63-4153"><a href="#cb63-4153" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-4154"><a href="#cb63-4154" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb63-4155"><a href="#cb63-4155" aria-hidden="true" tabindex="-1"></a><span class="in">  list(performance_metrics = performance_metrics, inner_fold_metrics = inner_fold_metrics)</span></span>
<span id="cb63-4156"><a href="#cb63-4156" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb63-4157"><a href="#cb63-4157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4158"><a href="#cb63-4158" aria-hidden="true" tabindex="-1"></a><span class="in">evaluate_with_seeds_ANN_lasso &lt;- </span></span>
<span id="cb63-4159"><a href="#cb63-4159" aria-hidden="true" tabindex="-1"></a><span class="in">  function(evaluation_function, data, target_var, vars, threshold, seeds, outer, inner, sizes, decays) {</span></span>
<span id="cb63-4160"><a href="#cb63-4160" aria-hidden="true" tabindex="-1"></a><span class="in">  results_list &lt;- list()</span></span>
<span id="cb63-4161"><a href="#cb63-4161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4162"><a href="#cb63-4162" aria-hidden="true" tabindex="-1"></a><span class="in">  for (seed in seeds) {</span></span>
<span id="cb63-4163"><a href="#cb63-4163" aria-hidden="true" tabindex="-1"></a><span class="in">    set.seed(seed)</span></span>
<span id="cb63-4164"><a href="#cb63-4164" aria-hidden="true" tabindex="-1"></a><span class="in">    cat("Evaluating with seed:", seed, "\n")</span></span>
<span id="cb63-4165"><a href="#cb63-4165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4166"><a href="#cb63-4166" aria-hidden="true" tabindex="-1"></a><span class="in">    results &lt;- evaluation_function(data = data, </span></span>
<span id="cb63-4167"><a href="#cb63-4167" aria-hidden="true" tabindex="-1"></a><span class="in">                                   target_name = target_var, </span></span>
<span id="cb63-4168"><a href="#cb63-4168" aria-hidden="true" tabindex="-1"></a><span class="in">                                   threshold = threshold, </span></span>
<span id="cb63-4169"><a href="#cb63-4169" aria-hidden="true" tabindex="-1"></a><span class="in">                                   outer = outer, </span></span>
<span id="cb63-4170"><a href="#cb63-4170" aria-hidden="true" tabindex="-1"></a><span class="in">                                   inner = inner, </span></span>
<span id="cb63-4171"><a href="#cb63-4171" aria-hidden="true" tabindex="-1"></a><span class="in">                                   seed = seed,</span></span>
<span id="cb63-4172"><a href="#cb63-4172" aria-hidden="true" tabindex="-1"></a><span class="in">                                   sizes = sizes,</span></span>
<span id="cb63-4173"><a href="#cb63-4173" aria-hidden="true" tabindex="-1"></a><span class="in">                                   decays = decays)</span></span>
<span id="cb63-4174"><a href="#cb63-4174" aria-hidden="true" tabindex="-1"></a><span class="in">    results_list[[paste0("seed_", seed)]] &lt;- results</span></span>
<span id="cb63-4175"><a href="#cb63-4175" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-4176"><a href="#cb63-4176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4177"><a href="#cb63-4177" aria-hidden="true" tabindex="-1"></a><span class="in">  return(results_list)</span></span>
<span id="cb63-4178"><a href="#cb63-4178" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb63-4179"><a href="#cb63-4179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4180"><a href="#cb63-4180" aria-hidden="true" tabindex="-1"></a><span class="in">performance_ANN_lasso &lt;- evaluate_with_seeds_ANN_lasso(</span></span>
<span id="cb63-4181"><a href="#cb63-4181" aria-hidden="true" tabindex="-1"></a><span class="in">  evaluation_function = double_cross_validation_nnet_lasso,</span></span>
<span id="cb63-4182"><a href="#cb63-4182" aria-hidden="true" tabindex="-1"></a><span class="in">  data = data_factor,</span></span>
<span id="cb63-4183"><a href="#cb63-4183" aria-hidden="true" tabindex="-1"></a><span class="in">  outer = 5,</span></span>
<span id="cb63-4184"><a href="#cb63-4184" aria-hidden="true" tabindex="-1"></a><span class="in">  inner = 2,</span></span>
<span id="cb63-4185"><a href="#cb63-4185" aria-hidden="true" tabindex="-1"></a><span class="in">  target_var = "PCR",</span></span>
<span id="cb63-4186"><a href="#cb63-4186" aria-hidden="true" tabindex="-1"></a><span class="in">  sizes = c(5,10,15,20),</span></span>
<span id="cb63-4187"><a href="#cb63-4187" aria-hidden="true" tabindex="-1"></a><span class="in">  decays = c(0.1, 0.2, 0.3),</span></span>
<span id="cb63-4188"><a href="#cb63-4188" aria-hidden="true" tabindex="-1"></a><span class="in">  threshold = .35,</span></span>
<span id="cb63-4189"><a href="#cb63-4189" aria-hidden="true" tabindex="-1"></a><span class="in">  seeds = seeds</span></span>
<span id="cb63-4190"><a href="#cb63-4190" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb63-4191"><a href="#cb63-4191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-4192"><a href="#cb63-4192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4193"><a href="#cb63-4193" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb63-4194"><a href="#cb63-4194" aria-hidden="true" tabindex="-1"></a><span class="in">load("RData_Files_Algorithms/ANN_Lasso.RData")</span></span>
<span id="cb63-4195"><a href="#cb63-4195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb63-4196"><a href="#cb63-4196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4197"><a href="#cb63-4197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4198"><a href="#cb63-4198" aria-hidden="true" tabindex="-1"></a><span class="fu"># Discusión: Estudio de los Resultados</span></span>
<span id="cb63-4199"><a href="#cb63-4199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4200"><a href="#cb63-4200" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estabilidad entre Folds</span></span>
<span id="cb63-4201"><a href="#cb63-4201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4202"><a href="#cb63-4202" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estabilidad para Hiperparámetros</span></span>
<span id="cb63-4203"><a href="#cb63-4203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4204"><a href="#cb63-4204" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estabilidad de Variables</span></span>
<span id="cb63-4205"><a href="#cb63-4205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4206"><a href="#cb63-4206" aria-hidden="true" tabindex="-1"></a><span class="fu">## "Mejor" Modelo</span></span>
<span id="cb63-4207"><a href="#cb63-4207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4208"><a href="#cb63-4208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4209"><a href="#cb63-4209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4210"><a href="#cb63-4210" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusión</span></span>
<span id="cb63-4211"><a href="#cb63-4211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4212"><a href="#cb63-4212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4213"><a href="#cb63-4213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4214"><a href="#cb63-4214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4215"><a href="#cb63-4215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4216"><a href="#cb63-4216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4217"><a href="#cb63-4217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4218"><a href="#cb63-4218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4219"><a href="#cb63-4219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4220"><a href="#cb63-4220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4221"><a href="#cb63-4221" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>